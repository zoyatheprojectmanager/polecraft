<!DOCTYPE html>
<html lang="en" style="height:100%">
<head>
<meta charset="UTF-8">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PoleCraft">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0f">
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;PoleCraft&quot;,&quot;short_name&quot;:&quot;PoleCraft&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230a0a0f&quot;,&quot;theme_color&quot;:&quot;%230a0a0f&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230a0a0f'/%3E%3Crect x='250' y='60' width='12' height='392' rx='6' fill='%23c9a96e'/%3E%3Ccircle cx='244' cy='160' r='18' fill='%23c9a96e'/%3E%3Cline x1='256' y1='178' x2='220' y2='210' stroke='%23c9a96e' stroke-width='8' stroke-linecap='round'/%3E%3Cline x1='220' y1='210' x2='190' y2='255' stroke='%23c9a96e' stroke-width='7' stroke-linecap='round'/%3E%3Cline x1='220' y1='210' x2='290' y2='170' stroke='%23c9a96e' stroke-width='7' stroke-linecap='round'/%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%230a0a0f'/%3E%3Crect x='248' y='60' width='16' height='392' rx='8' fill='%23c9a96e'/%3E%3Ccircle cx='240' cy='155' r='22' fill='%23c96ea8'/%3E%3Cpath d='M256 177 L210 230 L180 290' stroke='%23c9a96e' stroke-width='10' stroke-linecap='round' fill='none'/%3E%3Cpath d='M256 177 L310 210' stroke='%23c9a96e' stroke-width='10' stroke-linecap='round' fill='none'/%3E%3C/svg%3E">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PoleCraft</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>

:root{
  --bg:#09081a;--bg2:#100f22;--bg3:#18162d;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --accent:#c9a96e;--accent2:#e8c99a;--ag:rgba(201,169,110,0.14);
  --text:#edeaf7;--muted:#8a8698;--dim:#3c3858;
  --l1:#6ec9b0;--l2:#6eafc9;--l3:#c96ea8;--l4:#c96e6e;--l5:#a06ec9;
  --fl:#8ec96e;--pso:#7b9fd4;--red:#e07070;
  --sun:#c9a96e;--mon:#6ec9b0;--tue:#7b9fd4;--thu:#c96ea8;--fri:#a06ec9;
  --ease:cubic-bezier(0.4,0,0.2,1);
  --spring:cubic-bezier(0.34,1.56,0.64,1);
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-xl:28px;--r-full:9999px;
  --shadow-sm:0 2px 10px rgba(0,0,0,0.35);
  --shadow-md:0 6px 24px rgba(0,0,0,0.5);
  --shadow-lg:0 12px 48px rgba(0,0,0,0.65);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:999;opacity:0.5;}
header{padding:26px 40px 20px;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;justify-content:space-between;}
.logo{font-family:'Cormorant Garamond',serif;font-size:34px;font-weight:300;letter-spacing:0.08em;color:var(--accent);line-height:1;}
.logo span{font-style:italic;color:var(--accent2);}
.tagline{color:var(--muted);font-size:10px;letter-spacing:0.2em;text-transform:uppercase;}
.stats-bar{display:flex;border-bottom:1px solid var(--border);background:var(--bg2);}
.stat{display:flex;align-items:center;gap:8px;padding:11px 22px;border-right:1px solid var(--border);}
.stat-num{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--accent);}
.stat-label{color:var(--muted);font-size:9px;letter-spacing:0.1em;text-transform:uppercase;line-height:1.4;}
.nav-tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.nav-tab{padding:12px 16px;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;margin-bottom:-1px;white-space:nowrap;}
.nav-tab:hover{color:var(--accent);}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.page{display:none;}.page.active{display:block;}

/* SHARED */
.section-label{font-size:9px;letter-spacing:0.25em;text-transform:uppercase;color:var(--dim);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.chips{display:flex;flex-wrap:wrap;gap:5px;}
.chip{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;transition:all 0.15s;}
.chip:hover{border-color:var(--accent);color:var(--accent);}
.chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.chip[data-level="1"].active{background:rgba(110,201,176,0.1);border-color:var(--l1);color:var(--l1);}
.chip[data-level="2"].active{background:rgba(110,175,201,0.1);border-color:var(--l2);color:var(--l2);}
.chip[data-level="3"].active{background:rgba(201,110,168,0.1);border-color:var(--l3);color:var(--l3);}
.chip[data-level="4"].active{background:rgba(201,110,110,0.1);border-color:var(--l4);color:var(--l4);}
.chip[data-level="5"].active{background:rgba(160,110,201,0.1);border-color:var(--l5);color:var(--l5);}
.chip[data-level="Floorwork"].active{background:rgba(142,201,110,0.1);border-color:var(--fl);color:var(--fl);}
.badge{font-size:9px;padding:2px 6px;letter-spacing:0.08em;text-transform:uppercase;border:1px solid;white-space:nowrap;}
.lvl-1{color:var(--l1);border-color:rgba(110,201,176,0.3);background:rgba(110,201,176,0.07);}
.lvl-2{color:var(--l2);border-color:rgba(110,175,201,0.3);background:rgba(110,175,201,0.07);}
.lvl-3{color:var(--l3);border-color:rgba(201,110,168,0.3);background:rgba(201,110,168,0.07);}
.lvl-4{color:var(--l4);border-color:rgba(201,110,110,0.3);background:rgba(201,110,110,0.07);}
.lvl-5{color:var(--l5);border-color:rgba(160,110,201,0.3);background:rgba(160,110,201,0.07);}
.lvl-Floor{color:var(--fl);border-color:rgba(142,201,110,0.3);background:rgba(142,201,110,0.07);}
.action-btn{padding:7px 14px;background:transparent;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.action-btn:hover{border-color:var(--accent);color:var(--accent);}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:240px;color:var(--dim);gap:10px;text-align:center;}
.empty-icon{font-family:'Cormorant Garamond',serif;font-size:48px;opacity:0.25;}
.empty-text{font-size:10px;letter-spacing:0.18em;text-transform:uppercase;}
select{background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;padding:6px 24px 6px 9px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M4 5L0 0h8z' fill='%237a7870'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;}
select:focus{border-color:var(--accent);outline:none;}
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg3);border:1px solid var(--accent);color:var(--accent);padding:9px 16px;font-size:10px;letter-spacing:0.1em;animation:tin 0.2s ease,tout 0.2s ease 2.3s both;z-index:9999;}
@keyframes tin{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes tout{to{opacity:0;transform:translateY(6px)}}

/* ===== GENERATOR ===== */
.gen-layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 148px);}
.sidebar{border-right:1px solid var(--border);padding:24px 18px;background:var(--bg2);display:flex;flex-direction:column;gap:20px;overflow-y:auto;}
.range-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.range-val{font-family:'Cormorant Garamond',serif;font-size:24px;color:var(--accent);font-weight:600;}
input[type=range]{width:100%;-webkit-appearance:none;height:2px;background:var(--border2);outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent);cursor:pointer;transform:rotate(45deg);}
.gen-btn{width:100%;padding:12px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:16px;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;text-transform:uppercase;}
.gen-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s ease;}
.gen-btn span{position:relative;z-index:1;}
.gen-btn:hover::before{transform:translateY(0);}
.gen-btn:hover{color:var(--bg);}
.clear-link{background:none;border:none;color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;text-decoration:underline;text-decoration-color:var(--dim);transition:color 0.15s;text-align:center;}
.clear-link:hover{color:var(--accent);}
.content-area{padding:24px 32px;}
.sub-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:22px;}
.sub-tab{padding:9px 14px;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;margin-bottom:-1px;}
.sub-tab:hover{color:var(--accent);}
.sub-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.sub-content{display:none;}.sub-content.active{display:block;}
@keyframes sIn{from{opacity:0;transform:translateX(-5px)}to{opacity:1;transform:translateX(0)}}
@keyframes fUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.combo-fade{animation:fUp 0.3s ease;}
.combo-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:16px;}
.combo-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;color:var(--accent);font-style:italic;}
.combo-meta{font-size:9px;color:var(--muted);letter-spacing:0.1em;}
.moves-list{display:flex;flex-direction:column;gap:2px;margin-bottom:18px;}
.move-item{display:grid;grid-template-columns:28px 1fr auto auto auto;align-items:center;gap:12px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-left:3px solid transparent;transition:all 0.12s;animation:sIn 0.25s ease both;}
.move-item:hover{border-left-color:var(--accent);background:rgba(255,255,255,0.02);}
.move-num{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--dim);font-style:italic;text-align:right;}
.move-name{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--text);}
.cat-badge{font-size:8px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase;white-space:nowrap;}
.arrow-row{padding:0 14px 0 54px;color:var(--dim);font-size:13px;}
.combo-actions{display:flex;gap:8px;flex-wrap:wrap;}
.saved-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:9px;}
.saved-card{background:var(--bg3);border:1px solid var(--border);padding:13px;cursor:pointer;transition:all 0.12s;position:relative;}
.saved-card:hover{border-color:rgba(201,169,110,0.3);}
.saved-card-name{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--accent2);margin-bottom:7px;font-style:italic;}
.saved-card-moves{font-size:9px;color:var(--muted);line-height:1.9;}
.saved-card-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:12px;padding:2px 4px;transition:color 0.12s;}
.saved-card-del:hover{color:var(--red);}
.browse-controls{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.browse-input{flex:1;min-width:140px;background:var(--bg3);border:1px solid var(--border);padding:7px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:10px;outline:none;transition:border-color 0.12s;}
.browse-input:focus{border-color:var(--accent);}
.browse-input::placeholder{color:var(--dim);}
.moves-table{width:100%;border-collapse:collapse;}
.moves-table th{text-align:left;font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);padding:7px 9px;border-bottom:1px solid var(--border);}
.moves-table td{padding:7px 9px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:10px;}
.moves-table tr:hover td{background:rgba(255,255,255,0.012);}
.moves-table .nc{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--text);}

/* ===== ROUTINE BUILDER ===== */
.choreo-layout{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 148px);}
.choreo-sb{border-right:1px solid var(--border);background:var(--bg2);display:flex;flex-direction:column;overflow:hidden;}
.choreo-sb-hdr{padding:16px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.choreo-sb-hdr h3{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);font-style:italic;margin-bottom:8px;}
.move-bank{flex:1;overflow-y:auto;padding:8px;}
.bank-item{display:flex;align-items:center;gap:7px;padding:7px 9px;margin-bottom:2px;background:var(--bg3);border:1px solid var(--border);cursor:grab;transition:all 0.12s;user-select:none;}
.bank-item:hover{border-color:rgba(201,169,110,0.35);}
.bank-item.dragging{opacity:0.35;}
.bi-grip{color:var(--dim);font-size:11px;}
.bi-name{font-family:'Cormorant Garamond',serif;font-size:13px;color:var(--text);flex:1;}
.choreo-main{display:flex;flex-direction:column;overflow:hidden;}
.choreo-tb{padding:14px 20px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex-shrink:0;}
.routine-title-in{background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--accent2);font-family:'Cormorant Garamond',serif;font-size:20px;font-style:italic;outline:none;padding:3px 6px;min-width:200px;transition:border-color 0.12s;}
.routine-title-in:focus{border-bottom-color:var(--accent);}
.routine-title-in::placeholder{color:var(--dim);}
.cstat{text-align:center;}
.cstat-num{font-family:'Cormorant Garamond',serif;font-size:19px;color:var(--accent);font-weight:600;line-height:1;}
.cstat-label{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;}
.choreo-canvas{flex:1;overflow-y:auto;padding:20px;}
.routine-section{margin-bottom:20px;border:1px solid var(--border);background:var(--bg3);}
.sec-hdr{display:flex;align-items:center;gap:8px;padding:9px 12px;border-bottom:1px solid var(--border);background:var(--bg2);}
.sec-color-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.sec-name-in{font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);flex:1;background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;cursor:text;}
.sec-name-in:focus{color:var(--accent);}
.sec-actions{display:flex;gap:2px;}
.sec-presets-bar{display:flex;align-items:center;gap:8px;padding:9px 16px;background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0;}
.sec-presets-label{font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);white-space:nowrap;margin-right:2px;}
.sec-presets-group{display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
.sec-presets-group-lbl{font-size:8px;letter-spacing:0.14em;text-transform:uppercase;color:var(--dim);white-space:nowrap;padding-right:3px;border-right:1px solid var(--border);margin-right:2px;}
.sec-preset-btn{padding:3px 9px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;white-space:nowrap;}
.sec-preset-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.sp-i:hover{border-color:var(--l2);color:var(--l2);background:rgba(110,175,201,0.07);}
.sp-v:hover{border-color:var(--l3);color:var(--l3);background:rgba(201,110,168,0.07);}
.sp-c:hover{border-color:var(--accent);color:var(--accent);background:rgba(201,169,110,0.07);}
.sp-b:hover{border-color:var(--l5);color:var(--l5);background:rgba(160,110,201,0.07);}
.sp-o:hover{border-color:var(--fl);color:var(--fl);background:rgba(142,201,110,0.07);}
.sec-presets-divider{width:1px;height:18px;background:var(--border);flex-shrink:0;}
.add-sec-btn{display:none;}
.sec-grip{color:var(--dim);font-size:13px;cursor:grab;padding:2px 4px;transition:color 0.12s;user-select:none;flex-shrink:0;}
.sec-grip:hover{color:var(--accent);}
.sec-grip:active{cursor:grabbing;}
.routine-section.sec-dragging{opacity:0.35;}
.routine-section.sec-drag-above{border-top:2px solid var(--accent);}
.routine-section.sec-drag-below{border-bottom:2px solid var(--accent);}
.sec-btn{background:none;border:none;color:var(--dim);font-size:12px;cursor:pointer;padding:2px 4px;transition:color 0.12s;font-family:'DM Mono',monospace;}
.sec-btn:hover{color:var(--accent);}
.sec-btn.danger:hover{color:var(--red);}
.drop-zone{min-height:56px;padding:7px;transition:background 0.12s;}
.drop-zone.drag-over{background:rgba(201,169,110,0.05);outline:1px dashed rgba(201,169,110,0.25);}
.dz-empty{display:flex;align-items:center;justify-content:center;height:40px;color:var(--dim);font-size:9px;letter-spacing:0.15em;text-transform:uppercase;border:1px dashed var(--border);margin:3px;}
.routine-move{display:grid;grid-template-columns:18px 24px 1fr auto auto auto auto;align-items:center;gap:9px;padding:8px 11px;margin-bottom:2px;background:var(--bg);border:1px solid var(--border);border-left:3px solid transparent;cursor:grab;user-select:none;transition:all 0.12s;}
.routine-move:hover{border-color:var(--border2);}
.routine-move.dragging{opacity:0.3;}
.routine-move.dta{border-top:2px solid var(--accent);}
.routine-move.dtb{border-bottom:2px solid var(--accent);}
.rm-grip{color:var(--dim);font-size:10px;}
.rm-num{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--dim);font-style:italic;text-align:right;}
.rm-name{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--text);}
.rm-cat{font-size:8px;color:var(--dim);letter-spacing:0.06em;text-transform:uppercase;white-space:nowrap;}
.rm-note{font-size:9px;color:var(--dim);background:transparent;border:none;border-bottom:1px solid transparent;outline:none;font-family:'DM Mono',monospace;width:90px;transition:border-color 0.12s;cursor:text;}
.rm-note:focus{border-bottom-color:var(--border2);color:var(--muted);}
.rm-note::placeholder{color:var(--dim);font-style:italic;}
.rm-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:12px;padding:1px 3px;transition:color 0.12s;}
.rm-del:hover{color:var(--red);}
.sc-i::before{background:var(--l2);} .sc-v::before{background:var(--l3);} .sc-c::before{background:var(--accent);}
.sc-b::before{background:var(--l5);} .sc-o::before{background:var(--fl);}
.routine-section.sc-i .sec-color-dot{background:var(--l2);}
.routine-section.sc-v .sec-color-dot{background:var(--l3);}
.routine-section.sc-c .sec-color-dot{background:var(--accent);}
.routine-section.sc-b .sec-color-dot{background:var(--l5);}
.routine-section.sc-o .sec-color-dot{background:var(--fl);}
.routine-section.sc-i .routine-move{border-left-color:rgba(110,175,201,0.4);}
.routine-section.sc-v .routine-move{border-left-color:rgba(201,110,168,0.4);}
.routine-section.sc-c .routine-move{border-left-color:rgba(201,169,110,0.4);}
.routine-section.sc-b .routine-move{border-left-color:rgba(160,110,201,0.4);}
.routine-section.sc-o .routine-move{border-left-color:rgba(142,201,110,0.4);}
.add-sec-btn{width:100%;padding:8px;border:1px dashed var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;text-transform:uppercase;cursor:pointer;transition:all 0.12s;margin-top:6px;}
.add-sec-btn:hover{border-color:var(--accent);color:var(--accent);}
.routine-lib{padding:16px 20px;border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0;}
.routine-lib h4{font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:10px;}
.saved-routines-row{display:flex;gap:7px;flex-wrap:wrap;}
.srp{padding:5px 10px;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-size:9px;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;gap:5px;}
.srp:hover{border-color:var(--accent);color:var(--accent);}
.filter-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:9px;padding:5px 9px;outline:none;transition:border-color 0.12s;margin-bottom:5px;}
.filter-input:focus{border-color:var(--accent);}
.filter-input::placeholder{color:var(--dim);}
.bank-chip{padding:2px 6px;border:1px solid var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.1s;}
.bank-chip:hover,.bank-chip.active{border-color:var(--accent);color:var(--accent);}
.bank-chip.active{background:var(--ag);}
.export-panel{background:var(--bg3);border:1px solid var(--border);padding:16px;margin-top:16px;}
.export-panel h4{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent2);font-style:italic;margin-bottom:8px;}
.export-text{font-size:10px;color:var(--muted);line-height:2;white-space:pre-wrap;}

/* ===== CONTENT STUDIO ===== */
.studio-page{min-height:calc(100vh - 148px);display:flex;flex-direction:column;overflow-x:auto;}
.studio-tb{display:flex;align-items:center;gap:10px;padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0;}
.studio-tb h3{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--accent2);font-style:italic;flex:1;}
.week-nav{display:flex;align-items:center;gap:7px;}
.week-lbl{font-size:9px;color:var(--muted);letter-spacing:0.08em;min-width:130px;text-align:center;}
.wbtn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;padding:4px 9px;cursor:pointer;transition:all 0.12s;}
.wbtn:hover{border-color:var(--accent);color:var(--accent);}
.studio-legend{display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.leg-i{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);letter-spacing:0.04em;}
.leg-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.studio-week{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;min-height:0;}
.day-col{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;min-width:280px;flex:1;transition:min-width 0.22s ease,max-width 0.22s ease,flex 0.22s ease;}
.day-col:last-child{border-right:none;}
.day-col.collapsed{min-width:42px;max-width:42px;flex:0 0 42px;}
.day-col.collapsed .day-body,.day-col.collapsed .day-desc,.day-col.collapsed .day-type{display:none;}
.day-col.collapsed .day-hdr{padding:10px 0;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;}
.day-col.collapsed .day-title{writing-mode:vertical-rl;text-orientation:mixed;font-size:13px;letter-spacing:0.12em;white-space:nowrap;transform:rotate(180deg);}
.day-col.collapsed .day-toggle{transform:rotate(90deg);}
.day-hdr{padding:10px 12px 8px;border-bottom:1px solid var(--border);flex-shrink:0;cursor:default;}
.day-hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;}
.day-toggle{background:none;border:none;color:var(--dim);cursor:pointer;font-size:13px;padding:2px 4px;transition:transform 0.22s,color 0.12s;line-height:1;flex-shrink:0;}
.day-toggle:hover{color:var(--accent);}
.day-title{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:300;font-style:italic;flex:1;}
.day-type{font-size:8px;letter-spacing:0.2em;text-transform:uppercase;margin-bottom:3px;}
.day-desc{font-size:9px;color:var(--dim);line-height:1.45;}
.day-body{flex:1;padding:8px;overflow-y:auto;display:flex;flex-direction:column;gap:7px;min-height:260px;}
.day-body.drag-over-day{background:rgba(201,169,110,0.04);outline:1px dashed rgba(201,169,110,0.2);}

/* Day color themes */
.dc-sun .day-hdr{background:rgba(201,169,110,0.06);} .dc-sun .day-title{color:var(--sun);} .dc-sun .day-type{color:var(--sun);}
.dc-mon .day-hdr{background:rgba(110,201,176,0.06);} .dc-mon .day-title{color:var(--mon);} .dc-mon .day-type{color:var(--mon);}
.dc-tue .day-hdr{background:rgba(123,159,212,0.06);} .dc-tue .day-title{color:var(--tue);} .dc-tue .day-type{color:var(--tue);}
.dc-wed .day-hdr{background:rgba(201,169,110,0.04);} .dc-wed .day-title{color:#b89a5e;} .dc-wed .day-type{color:#b89a5e;}
.dc-thu .day-hdr{background:rgba(201,110,168,0.06);} .dc-thu .day-title{color:var(--thu);} .dc-thu .day-type{color:var(--thu);}
.dc-fri .day-hdr{background:rgba(160,110,201,0.06);} .dc-fri .day-title{color:var(--fri);} .dc-fri .day-type{color:var(--fri);}
.dc-sat .day-hdr{background:rgba(110,201,176,0.04);} .dc-sat .day-title{color:#5eb8a0;} .dc-sat .day-type{color:#5eb8a0;}

/* VIDEO CARD */

/* ===== REDESIGNED VIDEO INDEX CARD ===== */
.vid-card{background:var(--bg3);border:1px solid var(--border);border-top:3px solid var(--accent);padding:0;position:relative;cursor:default;transition:border-color 0.15s,box-shadow 0.15s;}
.vid-card:hover{box-shadow:0 4px 18px rgba(0,0,0,0.35);}
.vid-card.dragging{opacity:0.25;box-shadow:none;transform:scale(0.97);}
.vid-card.drag-target-above{border-top:3px solid var(--accent);box-shadow:0 -3px 0 var(--accent);}
.vid-card.drag-target-below{border-bottom:3px solid var(--accent);}

/* Card header strip */
.vc-header{display:flex;align-items:center;gap:6px;padding:7px 10px 6px;border-bottom:1px solid var(--border);background:var(--bg2);}
.vc-drag-grip{color:var(--dim);font-size:12px;cursor:grab;flex-shrink:0;letter-spacing:-1px;user-select:none;}
.vc-drag-grip:active{cursor:grabbing;}
.vc-status-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;cursor:pointer;transition:transform 0.12s;}
.vc-status-dot:hover{transform:scale(1.3);}
.vc-title-in{background:transparent;border:none;color:var(--text);font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;outline:none;flex:1;min-width:0;padding:0;transition:color 0.12s;}
.vc-title-in:focus{color:var(--accent2);}
.vc-title-in::placeholder{color:var(--dim);font-style:italic;}
.vc-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:11px;flex-shrink:0;padding:2px 3px;transition:color 0.12s;}
.vc-del:hover{color:var(--red);}

/* Status select */
.vc-status-row{padding:5px 10px;border-bottom:1px solid var(--border);}
.vc-status-sel{width:100%;background:var(--bg2);border:none;color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.1em;padding:3px 4px;outline:none;cursor:pointer;}
.vc-status-sel:focus{outline:none;}

/* Index card body â€” the key new section */
.vc-index{padding:9px 10px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.vc-field{display:flex;flex-direction:column;gap:2px;}
.vc-field.full{grid-column:1/-1;}
.vc-field-lbl{font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);}
.vc-field-val{background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:4px 7px;outline:none;width:100%;transition:border-color 0.12s;}
.vc-field-val:focus{border-color:var(--accent);color:var(--text);}
.vc-field-val::placeholder{color:var(--dim);}
.vc-field-sel{background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:4px 7px;outline:none;width:100%;cursor:pointer;transition:border-color 0.12s;}
.vc-field-sel:focus{border-color:var(--accent);}

/* Level badge in card */
.vc-level-badge{display:inline-block;font-size:8px;padding:2px 7px;border:1px solid;letter-spacing:0.1em;text-transform:uppercase;border-radius:1px;}

/* Sections */
.vc-section{padding:7px 10px;border-bottom:1px solid var(--border);}
.vc-section:last-child{border-bottom:none;}
.vc-section-lbl{font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:5px;display:flex;align-items:center;gap:5px;}
.vc-section-lbl::after{content:'';flex:1;height:1px;background:var(--border);}
.vc-row{display:flex;align-items:center;gap:5px;margin-bottom:3px;}
.vc-row-icon{font-size:10px;color:var(--dim);width:14px;text-align:center;flex-shrink:0;}
.vc-in{background:transparent;border:none;border-bottom:1px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;outline:none;flex:1;min-width:0;transition:border-color 0.12s;padding:2px 0;}
.vc-in:focus{border-bottom-color:var(--border2);color:var(--text);}
.vc-in::placeholder{color:var(--dim);}
.vc-date-in{background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;padding:3px 6px;outline:none;flex:1;transition:border-color 0.12s;}
.vc-date-in:focus{border-color:var(--accent);}
.vc-combo-slot{display:flex;align-items:center;gap:5px;padding:3px 7px;background:var(--bg2);border:1px solid var(--border);font-size:9px;color:var(--muted);margin-bottom:2px;}
.vc-cs-name{flex:1;font-family:'Cormorant Garamond',serif;font-size:11px;color:var(--text);}
.vc-cs-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:9px;padding:0 2px;transition:color 0.12s;}
.vc-cs-del:hover{color:var(--red);}
.vc-combo-dz{border:1px dashed var(--dim);padding:4px 7px;text-align:center;font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;transition:all 0.12s;margin-top:2px;cursor:default;}
.vc-combo-dz.drag-over{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.vc-inspo-link{display:flex;align-items:center;gap:5px;padding:3px 6px;background:var(--bg2);border:1px solid var(--border);font-size:8px;color:var(--muted);margin-bottom:2px;overflow:hidden;}
.vc-inspo-txt{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;color:var(--muted);}
.vc-inspo-txt:hover{color:var(--accent);}
.vc-inspo-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:9px;padding:0 2px;transition:color 0.12s;}
.vc-inspo-del:hover{color:var(--red);}
.vc-add-inspo{display:flex;gap:5px;margin-top:4px;}
.vc-add-in{flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:4px 7px;outline:none;}
.vc-add-in:focus{border-color:var(--accent);}
.vc-add-in::placeholder{color:var(--dim);}
.vc-add-btn{background:none;border:1px solid var(--border);color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;padding:4px 8px;cursor:pointer;transition:all 0.12s;white-space:nowrap;}
.vc-add-btn:hover{border-color:var(--accent);color:var(--accent);}
.vc-notes{background:var(--bg2);border:1px solid var(--border);padding:5px 8px;font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);outline:none;resize:none;width:100%;min-height:36px;transition:border-color 0.12s;line-height:1.6;}
.vc-notes:focus{border-color:var(--accent);}
.vc-notes::placeholder{color:var(--dim);font-style:italic;}

/* Day card count badge */
.day-card-count{font-size:8px;color:var(--dim);background:var(--bg3);border:1px solid var(--border);padding:1px 6px;letter-spacing:0.08em;margin-left:auto;}

.vid-fields{display:flex;flex-direction:column;gap:4px;}
.vid-frow{display:flex;align-items:flex-start;gap:5px;}
.vid-ficon{font-size:10px;color:var(--dim);flex-shrink:0;margin-top:2px;width:13px;text-align:center;}
.vfi{background:transparent;border:none;border-bottom:1px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;outline:none;flex:1;min-width:0;transition:border-color 0.12s;padding:1px 0;}
.vfi:focus{border-bottom-color:var(--border2);}
.vfi::placeholder{color:var(--dim);}
textarea.vfi{resize:none;min-height:26px;overflow:hidden;line-height:1.5;}
.combo-slots{margin-top:6px;display:flex;flex-direction:column;gap:2px;}
.combo-slot{display:flex;align-items:center;gap:5px;padding:4px 7px;background:var(--bg2);border:1px solid var(--border);font-size:9px;color:var(--muted);}
.cs-name{flex:1;font-family:'Cormorant Garamond',serif;font-size:11px;color:var(--text);}
.cs-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:9px;padding:0 2px;transition:color 0.12s;}
.cs-del:hover{color:var(--red);}
.combo-dz{border:1px dashed var(--dim);padding:4px 7px;text-align:center;font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;transition:all 0.12s;margin-top:3px;}
.combo-dz.drag-over{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.inspo-row{margin-top:5px;display:flex;flex-direction:column;gap:2px;}
.inspo-link{display:flex;align-items:center;gap:5px;padding:3px 6px;background:var(--bg2);border:1px solid var(--border);font-size:8px;color:var(--muted);text-decoration:none;overflow:hidden;transition:border-color 0.12s;}
.inspo-link:hover{border-color:var(--accent);color:var(--accent);}
.inspo-link-txt{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.inspo-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:10px;padding:0 2px;flex-shrink:0;transition:color 0.12s;}
.inspo-del:hover{color:var(--red);}
.vid-section-lbl{font-size:7px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-top:7px;margin-bottom:3px;}
.vid-notes-area{background:var(--bg2);border:1px solid var(--border);padding:6px 8px;font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);outline:none;resize:none;width:100%;min-height:40px;transition:border-color 0.12s;line-height:1.6;}
.vid-notes-area:focus{border-color:var(--accent);}
.vid-notes-area::placeholder{color:var(--dim);font-style:italic;}
.add-vid-btn{width:100%;padding:7px;border:1px dashed var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.14em;text-transform:uppercase;cursor:pointer;transition:all 0.12s;}
.add-vid-btn:hover{border-color:var(--accent);color:var(--accent);}
.vid-sched-row{display:flex;gap:5px;align-items:center;margin-top:5px;}
.vid-date-in{background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:3px 6px;outline:none;flex:1;}
.vid-date-in:focus{border-color:var(--accent);}
.add-inspo-row{display:flex;gap:5px;margin-top:5px;}
.add-inspo-in{background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:4px 7px;outline:none;flex:1;}
.add-inspo-in:focus{border-color:var(--accent);}
.add-inspo-btn{background:none;border:1px solid var(--border);color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;padding:4px 8px;cursor:pointer;transition:all 0.12s;white-space:nowrap;}
.add-inspo-btn:hover{border-color:var(--accent);color:var(--accent);}

/* ===== WARM-UP RANDOMIZER ===== */
.wu-page{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 148px);}
.wu-sidebar{border-right:1px solid var(--border);background:var(--bg2);padding:20px 18px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.wu-sidebar h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;}
.wu-main{display:flex;flex-direction:column;overflow:hidden;}
.wu-controls{padding:16px 24px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.wu-controls h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;flex:1;}
.wu-stats{display:flex;gap:16px;}
.wu-stat{text-align:center;}
.wu-stat-n{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);font-weight:600;line-height:1;}
.wu-stat-l{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;}
.wu-body{flex:1;overflow-y:auto;padding:20px 24px;}
.wu-section-hdr{display:flex;align-items:center;gap:10px;margin-bottom:10px;margin-top:22px;}
.wu-section-hdr:first-child{margin-top:0;}
.wu-section-title{font-size:9px;letter-spacing:0.24em;text-transform:uppercase;color:var(--accent);flex:1;}
.wu-section-line{flex:1;height:1px;background:var(--border);}
.wu-section-time{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--dim);font-style:italic;}
.wu-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:18px;}
.wu-card{background:var(--bg3);border:1px solid var(--border);border-left:3px solid transparent;padding:14px;position:relative;transition:all 0.15s;animation:fUp 0.3s ease both;}
.wu-card:hover{border-color:var(--border2);}
.wu-card-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);margin-bottom:5px;}
.wu-card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
.wu-tag{font-size:7px;padding:2px 6px;letter-spacing:0.1em;text-transform:uppercase;border:1px solid var(--border);color:var(--dim);}
.wu-tag.muscle{border-color:rgba(110,175,201,0.3);color:var(--l2);}
.wu-tag.type{border-color:rgba(201,169,110,0.25);color:var(--accent);}
.wu-tag.pole-link{border-color:rgba(201,110,168,0.3);color:var(--l3);}
.wu-time-row{display:flex;align-items:center;gap:7px;}
.wu-timer-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;gap:4px;}
.wu-timer-btn:hover{border-color:var(--accent);color:var(--accent);}
.wu-timer-btn.running{border-color:var(--l1);color:var(--l1);animation:pulse 1.2s ease infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.wu-duration{font-size:9px;color:var(--muted);}
.wu-reps{font-size:9px;color:var(--dim);}
.wu-card-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;transition:color 0.12s;padding:1px 4px;}
.wu-card-del:hover{color:var(--red);}
.wu-card-note{font-size:9px;color:var(--dim);line-height:1.5;margin-top:6px;border-top:1px solid var(--border);padding-top:6px;font-style:italic;}
/* muscle colors */
.mc-grip{border-left-color:rgba(201,169,110,0.6)!important;}
.mc-shoulder{border-left-color:rgba(110,175,201,0.6)!important;}
.mc-core{border-left-color:rgba(201,110,168,0.6)!important;}
.mc-back{border-left-color:rgba(160,110,201,0.6)!important;}
.mc-legs{border-left-color:rgba(142,201,110,0.6)!important;}
.mc-hip{border-left-color:rgba(201,110,110,0.6)!important;}
.mc-flex{border-left-color:rgba(110,201,176,0.6)!important;}
.mc-cardio{border-left-color:rgba(255,200,100,0.6)!important;}
/* Timer overlay */
.timer-overlay{position:fixed;inset:0;background:rgba(10,10,15,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000;cursor:pointer;}
.timer-overlay.hidden{display:none;}
.timer-exercise{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent2);font-style:italic;margin-bottom:8px;text-align:center;}
.timer-set{font-size:10px;color:var(--muted);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:30px;}
.timer-circle{width:180px;height:180px;border-radius:50%;border:3px solid var(--border);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:24px;}
.timer-circle svg{position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg);}
.timer-circle circle{fill:none;stroke:var(--accent);stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 1s linear;}
.timer-digits{font-family:'Cormorant Garamond',serif;font-size:64px;font-weight:300;color:var(--text);line-height:1;}
.timer-label{font-size:9px;color:var(--dim);letter-spacing:0.2em;text-transform:uppercase;margin-top:2px;}
.timer-actions{display:flex;gap:10px;margin-top:16px;}
.timer-note{font-size:10px;color:var(--muted);font-style:italic;margin-top:12px;max-width:280px;text-align:center;}
/* Focus filter chips */
.focus-chip{padding:5px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;text-transform:uppercase;letter-spacing:0.1em;}
.focus-chip:hover{border-color:var(--accent);color:var(--accent);}
.focus-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.focus-chip[data-f="grip"].active{background:rgba(201,169,110,0.1);border-color:var(--accent);color:var(--accent);}
.focus-chip[data-f="shoulder"].active{background:rgba(110,175,201,0.1);border-color:var(--l2);color:var(--l2);}
.focus-chip[data-f="core"].active{background:rgba(201,110,168,0.1);border-color:var(--l3);color:var(--l3);}
.focus-chip[data-f="back"].active{background:rgba(160,110,201,0.1);border-color:var(--l5);color:var(--l5);}
.focus-chip[data-f="legs"].active{background:rgba(142,201,110,0.1);border-color:var(--fl);color:var(--fl);}
.focus-chip[data-f="hip"].active{background:rgba(201,110,110,0.1);border-color:var(--l4);color:var(--l4);}
.focus-chip[data-f="flex"].active{background:rgba(110,201,176,0.1);border-color:var(--l1);color:var(--l1);}
.focus-chip[data-f="cardio"].active{background:rgba(255,200,100,0.1);border-color:#ffc864;color:#ffc864;}
.wu-generate-btn{width:100%;padding:13px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:17px;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;text-transform:uppercase;}
.wu-generate-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s ease;}
.wu-generate-btn span{position:relative;z-index:1;}
.wu-generate-btn:hover::before{transform:translateY(0);}
.wu-generate-btn:hover{color:var(--bg);}
.wu-total-bar{background:var(--bg3);border:1px solid var(--border);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;margin-top:20px;}
.wu-total-bar-txt{font-size:10px;color:var(--muted);}
.wu-total-bar-min{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent);font-weight:600;}
.wu-start-all-btn{padding:9px 20px;background:var(--accent);border:none;color:var(--bg);font-family:'Cormorant Garamond',serif;font-size:15px;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.wu-start-all-btn:hover{background:var(--accent2);}
.wu-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;color:var(--dim);gap:12px;text-align:center;}
.wu-empty-icon{font-family:'Cormorant Garamond',serif;font-size:52px;opacity:0.2;}
.wu-empty-txt{font-size:10px;letter-spacing:0.2em;text-transform:uppercase;}
.rest-card{background:rgba(110,201,176,0.04);border:1px solid rgba(110,201,176,0.15);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:18px;}
.rest-icon{font-size:18px;}
.rest-txt{font-size:9px;color:var(--l1);letter-spacing:0.12em;text-transform:uppercase;}
.rest-dur{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--l1);}
/* ===== CLASS SCHEDULE ===== */
.sched-page{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 148px);}
.sched-sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:22px 18px;display:flex;flex-direction:column;gap:20px;overflow-y:auto;}
.sched-sidebar h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;margin-bottom:2px;}
.sched-main{padding:24px 30px;overflow-y:auto;}
.sched-form{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:22px;}
.sched-form-title{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--accent2);font-style:italic;margin-bottom:14px;}
.sfi{background:var(--bg2);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:7px 10px;outline:none;width:100%;transition:border-color 0.15s;}
.sfi:focus{border-color:var(--accent);}
.sfi::placeholder{color:var(--dim);}
.sfl{font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:3px;margin-top:10px;}
.sfl:first-child{margin-top:0;}
.sched-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.sched-row.three{grid-template-columns:1fr 1fr 1fr;}
.class-type-chips{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;}
.ct-chip{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;}
.ct-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.recur-chip{padding:3px 8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;}
.recur-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.sched-add-btn{width:100%;padding:11px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:15px;letter-spacing:0.12em;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;text-transform:uppercase;margin-top:14px;}
.sched-add-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s;}
.sched-add-btn span{position:relative;z-index:1;}
.sched-add-btn:hover::before{transform:translateY(0);}
.sched-add-btn:hover{color:var(--bg);}

/* Week grid */
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border:1px solid var(--border);margin-bottom:22px;}
.wg-day-hdr{padding:8px 10px;background:var(--bg2);border-bottom:1px solid var(--border);border-right:1px solid var(--border);text-align:center;}
.wg-day-hdr:last-child{border-right:none;}
.wg-day-name{font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);}
.wg-day-num{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--muted);line-height:1.2;}
.wg-day-num.today{color:var(--accent);}
.wg-col{border-right:1px solid var(--border);min-height:120px;padding:5px;display:flex;flex-direction:column;gap:3px;vertical-align:top;}
.wg-col:last-child{border-right:none;}
.wg-class-pill{padding:4px 7px;font-size:8px;border-left:3px solid;background:var(--bg3);border-top:1px solid var(--border);border-right:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;transition:all 0.12s;position:relative;}
.wg-class-pill:hover{filter:brightness(1.2);}
.wg-class-time{color:var(--muted);margin-bottom:1px;}
.wg-class-name{font-family:'Cormorant Garamond',serif;font-size:11px;color:var(--text);}
.wg-class-loc{color:var(--dim);font-size:8px;}
.wg-class-del{position:absolute;top:3px;right:4px;background:none;border:none;color:var(--dim);font-size:9px;cursor:pointer;opacity:0;transition:opacity 0.12s;}
.wg-class-pill:hover .wg-class-del{opacity:1;}
.wg-class-del:hover{color:var(--red);}
.wg-add-btn{padding:3px 5px;font-size:8px;color:var(--dim);background:none;border:1px dashed var(--border);width:100%;cursor:pointer;font-family:'DM Mono',monospace;transition:all 0.12s;margin-top:auto;}
.wg-add-btn:hover{border-color:var(--accent);color:var(--accent);}

/* Upcoming list */
.upcoming-section{margin-bottom:28px;}
.upcoming-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:7px;border-bottom:1px solid var(--border);}
.upcoming-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent);font-style:italic;}
.class-card{display:grid;grid-template-columns:60px 1fr auto;gap:14px;align-items:start;padding:13px 16px;background:var(--bg3);border:1px solid var(--border);border-left:3px solid;margin-bottom:6px;transition:all 0.12s;cursor:pointer;}
.class-card:hover{border-color:var(--border2);}
.cc-date-block{text-align:center;}
.cc-month{font-size:8px;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);}
.cc-day{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;line-height:1;color:var(--accent);}
.cc-dow{font-size:8px;color:var(--dim);letter-spacing:0.1em;}
.cc-info{}
.cc-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);margin-bottom:3px;}
.cc-meta{font-size:9px;color:var(--muted);display:flex;flex-wrap:wrap;gap:8px;}
.cc-actions{display:flex;flex-direction:column;gap:5px;align-items:flex-end;}
.cc-type-badge{font-size:8px;padding:2px 7px;border:1px solid;letter-spacing:0.08em;text-transform:uppercase;white-space:nowrap;}
.recur-badge{font-size:7px;color:var(--dim);border:1px solid var(--border);padding:1px 5px;letter-spacing:0.08em;}

/* Export / integration */
.integ-section{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:16px;}
.integ-title{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent2);font-style:italic;margin-bottom:12px;}
.integ-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;}
.integ-btn{padding:9px 16px;background:transparent;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;display:flex;align-items:center;gap:7px;}
.integ-btn:hover{border-color:var(--accent);color:var(--accent);}
.integ-btn.gcal{border-color:rgba(66,133,244,0.35);color:#4285f4;}
.integ-btn.gcal:hover{background:rgba(66,133,244,0.08);}
.integ-btn.mb{border-color:rgba(110,201,176,0.35);color:var(--l1);}
.integ-btn.mb:hover{background:rgba(110,201,176,0.08);}
.integ-btn.ical{border-color:rgba(201,169,110,0.35);color:var(--accent);}
.integ-btn.ical:hover{background:rgba(201,169,110,0.08);}
.integ-note{font-size:9px;color:var(--dim);line-height:1.6;margin-top:6px;}
.integ-input-row{display:flex;gap:8px;align-items:center;margin-top:8px;}
.integ-url-in{flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:6px 10px;outline:none;transition:border-color 0.15s;}
.integ-url-in:focus{border-color:var(--accent);}
.integ-url-in::placeholder{color:var(--dim);}
.copy-ical-btn{padding:6px 12px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.copy-ical-btn:hover{background:var(--ag);}

/* Class type colors */
.ct-pole{border-color:#c96ea8 !important;} .ct-pole .cc-type-badge,.ct-pole .wg-class-name{color:#c96ea8;}
.ct-stretch{border-color:#6ec9b0 !important;} .ct-stretch .cc-type-badge,.ct-stretch .wg-class-name{color:#6ec9b0;}
.ct-conditioning{border-color:#6eafc9 !important;} .ct-conditioning .cc-type-badge,.ct-conditioning .wg-class-name{color:#6eafc9;}
.ct-floorwork{border-color:#a06ec9 !important;} .ct-floorwork .cc-type-badge,.ct-floorwork .wg-class-name{color:#a06ec9;}
.ct-private{border-color:#c9a96e !important;} .ct-private .cc-type-badge,.ct-private .wg-class-name{color:#c9a96e;}
.ct-performance{border-color:#c96e6e !important;} .ct-performance .cc-type-badge,.ct-performance .wg-class-name{color:#c96e6e;}
.ct-other{border-color:#7a7870 !important;} .ct-other .cc-type-badge,.ct-other .wg-class-name{color:#7a7870;}

/* ===== VIDEO LIBRARY ===== */
.vl-page{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 148px);}
.vl-sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
.vl-sidebar h3{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--accent2);font-style:italic;margin-bottom:8px;}
.vl-cat-btn{background:none;border:none;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;padding:7px 10px;text-align:left;transition:all 0.13s;border-left:2px solid transparent;display:flex;align-items:center;gap:8px;width:100%;}
.vl-cat-btn:hover{color:var(--accent);background:var(--ag);}
.vl-cat-btn.active{color:var(--accent);border-left-color:var(--accent);background:var(--ag);}
.vl-cat-btn .vl-count{margin-left:auto;font-size:8px;color:var(--dim);background:var(--bg3);padding:1px 5px;}
.vl-cat-group-lbl{font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);padding:12px 10px 4px;border-top:1px solid var(--border);margin-top:4px;}
.vl-cat-group-lbl:first-child{border-top:none;margin-top:0;padding-top:0;}
.vl-main{display:flex;flex-direction:column;overflow:hidden;}
.vl-toolbar{display:flex;align-items:center;gap:10px;padding:14px 22px;background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0;}
.vl-search{flex:1;min-width:180px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:7px 12px;outline:none;transition:border-color 0.15s;}
.vl-search:focus{border-color:var(--accent);}
.vl-search::placeholder{color:var(--dim);}
.vl-filter-chips{display:flex;gap:5px;flex-wrap:wrap;}
.vl-chip{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;}
.vl-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.vl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;padding:22px;overflow-y:auto;flex:1;}
.vl-card{background:var(--bg3);border:1px solid var(--border);transition:border-color 0.15s;position:relative;display:flex;flex-direction:column;}
.vl-card:hover{border-color:var(--border2);}
.vl-thumb{width:100%;aspect-ratio:16/9;background:var(--bg2);overflow:hidden;position:relative;cursor:pointer;}
.vl-thumb-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:36px;}
.vl-play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.25);opacity:0;transition:opacity 0.2s;}
.vl-thumb:hover .vl-play-overlay{opacity:1;}
.vl-play-btn{width:50px;height:50px;border-radius:50%;background:rgba(201,169,110,0.92);display:flex;align-items:center;justify-content:center;font-size:18px;}
.vl-body{padding:12px 14px;flex:1;display:flex;flex-direction:column;gap:6px;}
.vl-move-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);line-height:1.2;}
.vl-meta{display:flex;flex-wrap:wrap;gap:5px;align-items:center;}
.vl-level-badge{font-size:8px;padding:2px 6px;border:1px solid;letter-spacing:0.08em;text-transform:uppercase;}
.vl-cat-tag{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;}
.vl-desc{font-size:9px;color:var(--muted);line-height:1.6;flex:1;}
.vl-sources{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.vl-src-btn{padding:4px 9px;font-size:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.12s;text-decoration:none;display:inline-flex;align-items:center;gap:4px;letter-spacing:0.06em;}
.vl-src-btn:hover{border-color:var(--accent);color:var(--accent);}
.vl-src-btn.yt{border-color:rgba(255,80,80,0.3);color:#ff7070;}
.vl-src-btn.yt:hover{background:rgba(255,80,80,0.08);}
.vl-src-btn.site{border-color:rgba(110,175,201,0.3);color:var(--l2);}
.vl-src-btn.site:hover{background:rgba(110,175,201,0.08);}
.vl-src-btn.search{border-color:rgba(201,169,110,0.3);color:var(--accent);}
.vl-src-btn.search:hover{background:var(--ag);}
.vl-mylinks{padding:8px 14px 12px;border-top:1px solid var(--border);display:flex;gap:6px;align-items:center;}
.vl-my-in{flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:5px 8px;outline:none;}
.vl-my-in:focus{border-color:var(--accent);}
.vl-my-in::placeholder{color:var(--dim);}
.vl-my-add{padding:5px 10px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;}
.vl-my-add:hover{background:var(--ag);}
.vl-my-saved{display:flex;flex-wrap:wrap;gap:4px;padding:0 14px 10px;}
.vl-my-link{font-size:8px;padding:3px 7px;background:var(--bg2);border:1px solid var(--border);color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:4px;text-decoration:none;}
.vl-my-link:hover{border-color:var(--accent);color:var(--accent);}
.vl-empty{display:flex;align-items:center;justify-content:center;height:300px;color:var(--dim);font-size:11px;letter-spacing:0.1em;}

/* ===== USER PORTAL ===== */
.portal-overlay{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px;}
.portal-box{width:100%;max-width:480px;background:var(--bg2);border:1px solid var(--border2);padding:48px 40px;position:relative;}
.portal-logo{font-family:'Cormorant Garamond',serif;font-size:42px;font-weight:300;color:var(--accent);text-align:center;letter-spacing:0.08em;margin-bottom:4px;}
.portal-logo span{font-style:italic;color:var(--accent2);}
.portal-tagline{text-align:center;font-size:9px;letter-spacing:0.3em;text-transform:uppercase;color:var(--dim);margin-bottom:40px;}
.portal-section-lbl{font-size:8px;letter-spacing:0.22em;text-transform:uppercase;color:var(--dim);margin-bottom:5px;margin-top:18px;}
.portal-section-lbl:first-of-type{margin-top:0;}
.portal-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:11px;padding:10px 14px;outline:none;transition:border-color 0.15s;}
.portal-input:focus{border-color:var(--accent);}
.portal-input::placeholder{color:var(--dim);}
.portal-level-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px;}
.portal-level-chip{padding:5px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;letter-spacing:0.08em;}
.portal-level-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.portal-level-chip[data-l='1'].active{background:rgba(110,201,176,0.1);border-color:var(--l1);color:var(--l1);}
.portal-level-chip[data-l='2'].active{background:rgba(110,175,201,0.1);border-color:var(--l2);color:var(--l2);}
.portal-level-chip[data-l='3'].active{background:rgba(201,110,168,0.1);border-color:var(--l3);color:var(--l3);}
.portal-level-chip[data-l='4'].active{background:rgba(201,110,110,0.1);border-color:var(--l4);color:var(--l4);}
.portal-level-chip[data-l='5'].active{background:rgba(160,110,201,0.1);border-color:var(--l5);color:var(--l5);}
.portal-enter-btn{width:100%;margin-top:30px;padding:14px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:18px;letter-spacing:0.2em;text-transform:uppercase;cursor:pointer;position:relative;overflow:hidden;transition:color 0.2s;}
.portal-enter-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s;}
.portal-enter-btn span{position:relative;z-index:1;}
.portal-enter-btn:hover::before{transform:translateY(0);}
.portal-enter-btn:hover{color:var(--bg);}
.portal-avatar-row{display:flex;gap:10px;align-items:center;margin-bottom:6px;}
.portal-avatar-preview{width:52px;height:52px;border-radius:50%;background:var(--ag);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;overflow:hidden;flex-shrink:0;}
.portal-avatar-preview img{width:100%;height:100%;object-fit:cover;}
.portal-avatar-emoji-grid{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;}
.portal-avatar-emoji{font-size:20px;cursor:pointer;padding:4px;border:1px solid transparent;border-radius:2px;transition:all 0.1s;}
.portal-avatar-emoji:hover,.portal-avatar-emoji.sel{border-color:var(--accent);background:var(--ag);}
.portal-skip{text-align:center;margin-top:14px;font-size:9px;color:var(--dim);cursor:pointer;letter-spacing:0.12em;text-transform:uppercase;transition:color 0.12s;}
.portal-skip:hover{color:var(--muted);}

/* Profile button in header */
.profile-btn{display:flex;align-items:center;gap:9px;background:none;border:1px solid var(--border);padding:6px 12px 6px 8px;cursor:pointer;transition:all 0.15s;color:var(--muted);}
.profile-btn:hover{border-color:var(--accent);color:var(--accent);}
.profile-avatar{width:30px;height:30px;border-radius:50%;background:var(--ag);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:15px;overflow:hidden;flex-shrink:0;}
.profile-avatar img{width:100%;height:100%;object-fit:cover;}
.profile-name-hdr{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;}
.profile-level-hdr{font-size:8px;letter-spacing:0.08em;color:var(--dim);}

/* Profile drawer */
.profile-drawer{position:fixed;top:0;right:0;bottom:0;width:340px;background:var(--bg2);border-left:1px solid var(--border2);z-index:1500;transform:translateX(100%);transition:transform 0.25s ease;display:flex;flex-direction:column;overflow:hidden;}
.profile-drawer.open{transform:translateX(0);}
.profile-drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1499;opacity:0;pointer-events:none;transition:opacity 0.25s;}
.profile-drawer-overlay.open{opacity:1;pointer-events:all;}
.pd-header{padding:28px 24px 20px;border-bottom:1px solid var(--border);flex-shrink:0;}
.pd-title{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent2);font-style:italic;margin-bottom:2px;}
.pd-close{position:absolute;top:20px;right:20px;background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;padding:4px;}
.pd-close:hover{color:var(--text);}
.pd-body{padding:22px 24px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:18px;}
.pd-avatar-big{width:72px;height:72px;border-radius:50%;background:var(--ag);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 8px;overflow:hidden;cursor:pointer;}
.pd-avatar-big img{width:100%;height:100%;object-fit:cover;}
.pd-name-display{font-family:'Cormorant Garamond',serif;font-size:24px;color:var(--text);text-align:center;line-height:1.2;}
.pd-level-display{text-align:center;font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.pd-section{border-top:1px solid var(--border);padding-top:16px;}
.pd-section-lbl{font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:10px;}
.pd-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.pd-stat-card{background:var(--bg3);border:1px solid var(--border);padding:12px;text-align:center;}
.pd-stat-n{font-family:'Cormorant Garamond',serif;font-size:26px;color:var(--accent);line-height:1;}
.pd-stat-l{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;margin-top:2px;}
.pd-goal-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);}
.pd-goal-row:last-child{border-bottom:none;}
.pd-goal-check{width:16px;height:16px;border:1px solid var(--border);background:transparent;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all 0.12s;}
.pd-goal-check.done{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.pd-goal-text{font-size:10px;color:var(--muted);flex:1;line-height:1.4;}
.pd-goal-text.done{text-decoration:line-through;color:var(--dim);}
.pd-goal-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:10px;padding:2px 4px;}
.pd-goal-del:hover{color:var(--red);}
.pd-add-goal-row{display:flex;gap:6px;margin-top:6px;}
.pd-goal-in{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:9px;padding:6px 10px;outline:none;}
.pd-goal-in:focus{border-color:var(--accent);}
.pd-goal-in::placeholder{color:var(--dim);}
.pd-goal-add-btn{padding:6px 12px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;}
.pd-goal-add-btn:hover{background:var(--ag);}
.pd-edit-btn{width:100%;padding:9px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;margin-top:4px;}
.pd-edit-btn:hover{border-color:var(--accent);color:var(--accent);}
.pd-signout-btn{width:100%;padding:9px;border:1px solid rgba(224,112,112,0.25);background:transparent;color:var(--red);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;}
.pd-signout-btn:hover{background:rgba(224,112,112,0.07);}
.pd-milestone-row{display:flex;align-items:center;gap:8px;padding:5px 0;}
.pd-milestone-icon{font-size:16px;flex-shrink:0;}
.pd-milestone-text{font-size:9px;color:var(--muted);flex:1;}
.pd-milestone-date{font-size:8px;color:var(--dim);}
.pd-badges{display:flex;flex-wrap:wrap;gap:6px;}
.pd-badge{padding:4px 10px;border:1px solid var(--border);font-size:8px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);}
.pd-badge.earned{border-color:var(--accent);color:var(--accent);background:var(--ag);}

/* ===== GAMES ===== */
.games-page{padding:24px 28px;max-width:900px;}
.games-hub{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:28px;}
.game-card{background:var(--bg3);border:1px solid var(--border);padding:20px;cursor:pointer;transition:all 0.18s;position:relative;overflow:hidden;}
.game-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.18s;}
.game-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.4);}
.game-card:hover::before{opacity:1;}
.game-card.gc-alpha::before{background:linear-gradient(135deg,rgba(201,169,110,0.06),transparent);}
.game-card.gc-spell::before{background:linear-gradient(135deg,rgba(201,110,168,0.06),transparent);}
.game-card.gc-30day::before{background:linear-gradient(135deg,rgba(110,201,176,0.06),transparent);}
.game-card.gc-roulette::before{background:linear-gradient(135deg,rgba(160,110,201,0.06),transparent);}
.game-card.gc-dare::before{background:linear-gradient(135deg,rgba(201,110,110,0.06),transparent);}
.game-emoji{font-size:32px;margin-bottom:10px;display:block;}
.game-title{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent2);font-style:italic;margin-bottom:5px;}
.game-desc{font-size:9px;color:var(--dim);line-height:1.7;letter-spacing:0.04em;}
.game-tag{display:inline-block;font-size:7px;letter-spacing:0.15em;text-transform:uppercase;border:1px solid var(--border);color:var(--dim);padding:2px 7px;margin-top:8px;}

/* Active game area */
.active-game{background:var(--bg2);border:1px solid var(--border);padding:24px 28px;margin-top:0;}
.ag-back{background:none;border:none;color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;padding:0 0 18px;display:flex;align-items:center;gap:5px;text-transform:uppercase;transition:color 0.12s;}
.ag-back:hover{color:var(--accent);}
.ag-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;margin-bottom:4px;}
.ag-subtitle{font-size:9px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;margin-bottom:22px;}

/* AlphaPole */
.alpha-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px;margin-bottom:20px;}
.alpha-cell{background:var(--bg3);border:1px solid var(--border);padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.15s;position:relative;}
.alpha-cell:hover{border-color:var(--accent);background:var(--ag);}
.alpha-cell.done{border-color:var(--l1);background:rgba(110,201,176,0.08);}
.alpha-cell.active-letter{border-color:var(--accent);background:var(--ag);box-shadow:0 0 12px rgba(201,169,110,0.2);}
.alpha-letter{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent);font-weight:600;line-height:1;}
.alpha-move{font-size:7px;color:var(--muted);letter-spacing:0.06em;margin-top:3px;line-height:1.3;min-height:18px;}
.alpha-check{position:absolute;top:3px;right:4px;font-size:9px;color:var(--l1);}
.alpha-detail{background:var(--bg3);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px 20px;margin-bottom:16px;}
.alpha-detail-letter{font-family:'Cormorant Garamond',serif;font-size:48px;color:var(--accent);line-height:1;float:left;margin-right:16px;margin-top:-4px;}
.alpha-detail-move{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--text);margin-bottom:4px;}
.alpha-detail-alts{font-size:9px;color:var(--dim);line-height:1.7;margin-bottom:10px;}
.alpha-done-btn{padding:8px 18px;background:transparent;border:1px solid var(--l1);color:var(--l1);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.alpha-done-btn:hover{background:rgba(110,201,176,0.1);}
.alpha-done-btn.marked{background:rgba(110,201,176,0.15);border-color:var(--l1);}
.alpha-progress{background:var(--bg3);border:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.alpha-prog-bar{flex:1;height:4px;background:var(--border);position:relative;}
.alpha-prog-fill{height:100%;background:var(--l1);transition:width 0.3s;}
.alpha-prog-text{font-size:9px;color:var(--muted);white-space:nowrap;}

/* Spell It */
.spell-area{margin-bottom:20px;}
.spell-input-row{display:flex;gap:10px;align-items:center;margin-bottom:16px;}
.spell-in{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:22px;font-style:italic;padding:10px 16px;outline:none;transition:border-color 0.15s;letter-spacing:0.12em;}
.spell-in:focus{border-color:var(--accent);}
.spell-in::placeholder{color:var(--dim);font-style:italic;}
.spell-go-btn{padding:10px 24px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:16px;letter-spacing:0.1em;cursor:pointer;position:relative;overflow:hidden;transition:color 0.2s;white-space:nowrap;}
.spell-go-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s;}
.spell-go-btn span{position:relative;z-index:1;}
.spell-go-btn:hover::before{transform:translateY(0);}
.spell-go-btn:hover{color:var(--bg);}
.spell-result{display:flex;flex-direction:column;gap:8px;}
.spell-letter-row{display:flex;align-items:center;gap:14px;padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-left:3px solid var(--accent);animation:fUp 0.25s ease both;}
.spell-ltr{font-family:'Cormorant Garamond',serif;font-size:32px;color:var(--accent);width:36px;text-align:center;flex-shrink:0;font-weight:600;}
.spell-move-name{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--text);flex:1;}
.spell-move-meta{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;}
.spell-alt-btn{font-size:8px;padding:3px 8px;border:1px solid var(--border);background:transparent;color:var(--dim);cursor:pointer;font-family:'DM Mono',monospace;transition:all 0.12s;flex-shrink:0;}
.spell-alt-btn:hover{border-color:var(--accent);color:var(--accent);}
.spell-presets{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.spell-preset{padding:5px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;letter-spacing:0.06em;}
.spell-preset:hover{border-color:var(--accent);color:var(--accent);}

/* 30-Day Challenge */
.challenge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:20px;}
.ch-day{background:var(--bg3);border:1px solid var(--border);padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.15s;}
.ch-day:hover{border-color:var(--border2);}
.ch-day.done{border-color:var(--l1);background:rgba(110,201,176,0.07);}
.ch-day.today{border-color:var(--accent);box-shadow:0 0 10px rgba(201,169,110,0.15);}
.ch-day-num{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--dim);margin-bottom:2px;}
.ch-day.today .ch-day-num{color:var(--accent);}
.ch-day.done .ch-day-num{color:var(--l1);}
.ch-day-move{font-size:8px;color:var(--muted);line-height:1.4;}
.ch-day-check{font-size:12px;color:var(--l1);margin-top:4px;}
.ch-progress{background:var(--bg3);border:1px solid var(--border);padding:12px 18px;display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.ch-prog-nums{font-family:'Cormorant Garamond',serif;font-size:26px;color:var(--accent);line-height:1;}
.ch-prog-lbl{font-size:8px;color:var(--dim);letter-spacing:0.12em;text-transform:uppercase;}
.ch-prog-bar{flex:1;height:5px;background:var(--border);}
.ch-prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--l3));transition:width 0.4s;}
.ch-regen-btn{padding:5px 12px;border:1px solid var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.12s;text-transform:uppercase;letter-spacing:0.1em;}
.ch-regen-btn:hover{border-color:var(--accent);color:var(--accent);}

/* Spin Roulette */
.roulette-area{display:flex;flex-direction:column;align-items:center;gap:20px;padding:20px 0;}
.roulette-wheel{width:280px;height:280px;border-radius:50%;border:3px solid var(--accent);position:relative;overflow:hidden;cursor:pointer;transition:transform 0.05s;}
.roulette-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;z-index:10;pointer-events:none;}
.roulette-spin-btn{padding:14px 36px;background:transparent;border:2px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:20px;letter-spacing:0.12em;cursor:pointer;position:relative;overflow:hidden;transition:color 0.2s;}
.roulette-spin-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.25s;}
.roulette-spin-btn span{position:relative;z-index:1;}
.roulette-spin-btn:hover::before{transform:translateY(0);}
.roulette-spin-btn:hover{color:var(--bg);}
.roulette-result{background:var(--bg3);border:1px solid var(--border);border-left:4px solid var(--accent);padding:20px 24px;width:100%;max-width:480px;text-align:center;animation:fUp 0.3s ease;}
.roulette-result-move{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--text);margin-bottom:6px;}
.roulette-result-meta{font-size:9px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;margin-bottom:12px;}
.roulette-result-desc{font-size:10px;color:var(--muted);line-height:1.7;}
.roulette-categories{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:16px;}
.roulette-cat-chip{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.12s;}
.roulette-cat-chip.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.roulette-spinning .roulette-result{opacity:0.3;}

/* Dare Mode */
.dare-area{display:flex;flex-direction:column;gap:16px;}
.dare-card{background:var(--bg3);border:1px solid var(--border);border-top:3px solid var(--l3);padding:24px;text-align:center;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;}
.dare-emoji{font-size:40px;}
.dare-text{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--text);font-style:italic;line-height:1.4;max-width:440px;}
.dare-sub{font-size:9px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;}
.dare-draw-btn{padding:12px 32px;background:transparent;border:2px solid var(--l3);color:var(--l3);font-family:'Cormorant Garamond',serif;font-size:18px;letter-spacing:0.1em;cursor:pointer;position:relative;overflow:hidden;transition:color 0.2s;}
.dare-draw-btn::before{content:'';position:absolute;inset:0;background:var(--l3);transform:translateY(100%);transition:transform 0.22s;}
.dare-draw-btn span{position:relative;z-index:1;}
.dare-draw-btn:hover::before{transform:translateY(0);}
.dare-draw-btn:hover{color:var(--bg);}
.dare-history{margin-top:8px;}
.dare-hist-item{padding:7px 12px;background:var(--bg3);border:1px solid var(--border);font-size:9px;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:10px;}
.dare-hist-num{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--dim);width:20px;text-align:right;flex-shrink:0;}
.dare-type-chips{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:8px;}
.dare-chip{padding:4px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.12s;}
.dare-chip.active{background:rgba(201,110,168,0.12);border-color:var(--l3);color:var(--l3);}

/* ===== JOURNAL & TRACKER ===== */
.journal-layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 148px);}
.journal-sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:20px;}
.journal-nav{display:flex;flex-direction:column;gap:4px;}
.jnav-btn{display:flex;align-items:center;gap:10px;padding:10px 14px;background:none;border:1px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;text-align:left;}
.jnav-btn:hover{color:var(--text);border-color:var(--border);}
.jnav-btn.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.jnav-icon{font-size:13px;flex-shrink:0;}
.journal-streak-card{background:var(--bg3);border:1px solid var(--border);padding:16px;flex-shrink:0;}
.jsc-title{font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:10px;}
.jsc-streak{font-family:'Cormorant Garamond',serif;font-size:42px;color:var(--accent);line-height:1;text-align:center;}
.jsc-streak-lbl{font-size:8px;color:var(--dim);text-align:center;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:12px;}
.jsc-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.jsc-stat{background:var(--bg2);border:1px solid var(--border);padding:8px 6px;text-align:center;}
.jsc-stat-n{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);line-height:1;}
.jsc-stat-l{font-size:7px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;margin-top:2px;}

.journal-main{overflow-y:auto;}
.journal-section{display:none;padding:28px 32px;}
.journal-section.active{display:block;}

/* â”€â”€ CONSISTENCY TRACKER â”€â”€ */
.tracker-header{display:flex;align-items:center;gap:14px;margin-bottom:24px;}
.tracker-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.tracker-month-nav{display:flex;align-items:center;gap:8px;}
.tracker-month-lbl{font-size:10px;color:var(--muted);letter-spacing:0.12em;min-width:120px;text-align:center;}
.tracker-nav-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;padding:4px 10px;cursor:pointer;transition:all 0.12s;}
.tracker-nav-btn:hover{border-color:var(--accent);color:var(--accent);}

/* Legend */
.tracker-legend{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:18px;}
.tleg{display:flex;align-items:center;gap:5px;font-size:8px;color:var(--muted);letter-spacing:0.08em;}
.tleg-dot{width:12px;height:12px;border-radius:50%;}

/* Day of week headers */
.tracker-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;}
.tracker-dow-lbl{text-align:center;font-size:8px;color:var(--dim);letter-spacing:0.12em;text-transform:uppercase;padding:4px 0;}

/* Calendar bubbles */
.tracker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:28px;}
.tracker-bubble{aspect-ratio:1;border-radius:50%;border:1px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.18s;position:relative;flex-direction:column;font-size:10px;}
.tracker-bubble:hover{border-color:var(--border2);transform:scale(1.08);}
.tracker-bubble.tb-empty{border-color:transparent;background:transparent;cursor:default;pointer-events:none;}
.tracker-bubble.tb-today{box-shadow:0 0 0 2px var(--accent);}
.tracker-bubble.tb-future{opacity:0.3;cursor:default;}
.tracker-bubble.tb-trained{background:rgba(201,169,110,0.18);border-color:var(--accent);}
.tracker-bubble.tb-filmed{background:rgba(160,110,201,0.18);border-color:var(--l5);}
.tracker-bubble.tb-stretched{background:rgba(110,201,176,0.18);border-color:var(--l1);}
.tracker-bubble.tb-rest{background:rgba(123,159,212,0.18);border-color:var(--l2);}
.tracker-bubble.tb-multi{background:linear-gradient(135deg,rgba(201,169,110,0.2),rgba(160,110,201,0.15));border-color:var(--accent);}
.tracker-date-num{font-size:11px;color:var(--muted);font-family:'Cormorant Garamond',serif;font-weight:400;line-height:1;}
.tracker-bubble.tb-trained .tracker-date-num,
.tracker-bubble.tb-filmed .tracker-date-num,
.tracker-bubble.tb-stretched .tracker-date-num,
.tracker-bubble.tb-rest .tracker-date-num,
.tracker-bubble.tb-multi .tracker-date-num{color:var(--text);}
.tracker-bubble-icons{font-size:8px;line-height:1;margin-top:1px;}

/* Day detail popup */
.tracker-day-panel{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--accent);padding:20px 24px;margin-bottom:24px;animation:fUp 0.2s ease;}
.tdp-date{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent2);font-style:italic;margin-bottom:14px;}
.tdp-activity-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px;}
.tdp-act{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:all 0.15s;}
.tdp-act:hover{border-color:var(--border2);}
.tdp-act.active-trained{border-color:var(--accent);background:rgba(201,169,110,0.1);}
.tdp-act.active-filmed{border-color:var(--l5);background:rgba(160,110,201,0.1);}
.tdp-act.active-stretched{border-color:var(--l1);background:rgba(110,201,176,0.1);}
.tdp-act.active-rest{border-color:var(--l2);background:rgba(123,159,212,0.1);}
.tdp-act-icon{font-size:16px;}
.tdp-act-lbl{font-size:9px;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;}
.tdp-note-in{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:8px 12px;outline:none;resize:none;line-height:1.7;transition:border-color 0.12s;}
.tdp-note-in:focus{border-color:var(--accent);color:var(--text);}
.tdp-note-in::placeholder{color:var(--dim);font-style:italic;}
.tdp-save-btn{margin-top:8px;padding:7px 18px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.tdp-save-btn:hover{background:var(--ag);}

/* â”€â”€ SESSION JOURNAL â”€â”€ */
.sj-header{display:flex;align-items:center;gap:14px;margin-bottom:24px;}
.sj-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.sj-new-btn{padding:9px 20px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.sj-new-btn:hover{background:var(--ag);}

/* New entry form */
.sj-form{background:var(--bg2);border:1px solid var(--border);padding:24px;margin-bottom:24px;animation:fUp 0.2s ease;}
.sj-form-title{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent2);font-style:italic;margin-bottom:18px;}
.sj-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;}
.sj-field{display:flex;flex-direction:column;gap:5px;}
.sj-field.full{grid-column:1/-1;}
.sj-lbl{font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);}
.sj-in{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:8px 12px;outline:none;transition:border-color 0.15s;}
.sj-in:focus{border-color:var(--accent);}
.sj-in::placeholder{color:var(--dim);}

/* Photo upload */
.sj-photo-area{border:1px dashed var(--border);padding:20px;text-align:center;cursor:pointer;transition:all 0.15s;position:relative;overflow:hidden;min-height:100px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;}
.sj-photo-area:hover{border-color:var(--accent);background:var(--ag);}
.sj-photo-area img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.7;}
.sj-photo-label{font-size:9px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;position:relative;z-index:1;}
.sj-photo-icon{font-size:20px;position:relative;z-index:1;}

/* Feeling chart */
.feeling-block{background:var(--bg3);border:1px solid var(--border);padding:16px 18px;margin-bottom:14px;}
.feeling-title{font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.feeling-title::after{content:'';flex:1;height:1px;background:var(--border);}
.feeling-emoji-row{display:flex;justify-content:space-between;margin-bottom:10px;}
.feeling-emoji-btn{font-size:22px;background:none;border:2px solid transparent;border-radius:50%;padding:4px;cursor:pointer;transition:all 0.15s;opacity:0.45;}
.feeling-emoji-btn:hover{opacity:0.8;transform:scale(1.1);}
.feeling-emoji-btn.sel{opacity:1;border-color:var(--accent);background:var(--ag);transform:scale(1.15);}
.feeling-energy{margin-bottom:10px;}
.feeling-energy-lbl{display:flex;justify-content:space-between;font-size:8px;color:var(--dim);margin-bottom:4px;}
.feeling-energy-slider{width:100%;accent-color:var(--accent);}
.feeling-words{display:flex;flex-wrap:wrap;gap:5px;}
.feeling-word{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.12s;letter-spacing:0.08em;}
.feeling-word.sel{border-color:var(--accent);color:var(--accent);background:var(--ag);}

/* Notes textarea */
.sj-notes{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;padding:12px 14px;outline:none;resize:vertical;min-height:90px;line-height:1.8;transition:border-color 0.15s;}
.sj-notes:focus{border-color:var(--accent);color:var(--text);}
.sj-notes::placeholder{color:var(--dim);font-style:italic;}
.sj-submit-row{display:flex;justify-content:flex-end;gap:10px;margin-top:14px;}
.sj-cancel-btn{padding:9px 18px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.sj-cancel-btn:hover{border-color:var(--red);color:var(--red);}
.sj-save-entry-btn{padding:9px 24px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.sj-save-entry-btn:hover{background:var(--ag);}

/* Entry cards */
.sj-entries{display:flex;flex-direction:column;gap:16px;}
.sj-entry-card{background:var(--bg2);border:1px solid var(--border);overflow:hidden;transition:border-color 0.15s;}
.sj-entry-card:hover{border-color:var(--border2);}
.sj-entry-top{display:grid;grid-template-columns:1fr auto;gap:16px;padding:18px 20px 14px;}
.sj-entry-photo{width:80px;height:80px;object-fit:cover;border:1px solid var(--border);flex-shrink:0;}
.sj-entry-date{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--accent2);font-style:italic;margin-bottom:4px;}
.sj-entry-mood-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.sj-entry-mood{font-size:18px;}
.sj-entry-words{display:flex;flex-wrap:wrap;gap:3px;}
.sj-entry-word{font-size:7px;padding:2px 6px;border:1px solid var(--border);color:var(--dim);letter-spacing:0.08em;}
.sj-entry-notes{font-size:10px;color:var(--muted);line-height:1.7;padding:0 20px 16px;border-top:1px solid var(--border);padding-top:12px;}
.sj-entry-del{background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;padding:4px;transition:color 0.12s;align-self:flex-start;}
.sj-entry-del:hover{color:var(--red);}
.sj-entry-feeling-compare{display:flex;gap:20px;padding:12px 20px;background:var(--bg3);border-top:1px solid var(--border);}
.sj-efc-block{flex:1;}
.sj-efc-lbl{font-size:7px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:4px;}
.sj-efc-val{font-size:11px;color:var(--muted);}

/* â”€â”€ POLE GOALS â”€â”€ */
.goals-header{display:flex;align-items:center;gap:14px;margin-bottom:24px;}
.goals-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.goals-add-btn{padding:9px 20px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.goals-add-btn:hover{background:var(--ag);}
.goals-tier{margin-bottom:28px;}
.goals-tier-hdr{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.goals-tier-title{font-size:9px;letter-spacing:0.24em;text-transform:uppercase;color:var(--accent);}
.goals-tier-line{flex:1;height:1px;background:var(--border);}
.goals-tier-count{font-size:8px;color:var(--dim);}
.goal-item{background:var(--bg3);border:1px solid var(--border);border-left:3px solid transparent;padding:14px 16px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px;transition:all 0.15s;position:relative;}
.goal-item:hover{border-color:var(--border2);}
.goal-item.gs-inprogress{border-left-color:var(--accent);}
.goal-item.gs-landed{border-left-color:var(--l1);opacity:0.7;}
.goal-status-btn{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;transition:all 0.15s;}
.goal-status-btn:hover{border-color:var(--accent);}
.goal-status-btn.gs-inprogress{border-color:var(--accent);background:var(--ag);}
.goal-status-btn.gs-landed{border-color:var(--l1);background:rgba(110,201,176,0.15);}
.goal-body{flex:1;min-width:0;}
.goal-text{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--text);margin-bottom:3px;line-height:1.3;}
.goal-item.gs-landed .goal-text{text-decoration:line-through;color:var(--dim);}
.goal-note{font-size:9px;color:var(--dim);line-height:1.5;}
.goal-landed-date{font-size:8px;color:var(--l1);letter-spacing:0.1em;margin-top:3px;}
.goal-del{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 4px;transition:color 0.12s;flex-shrink:0;}
.goal-del:hover{color:var(--red);}
.goal-add-form{background:var(--bg2);border:1px solid var(--border);padding:16px;margin-bottom:14px;animation:fUp 0.2s ease;display:none;}
.goal-add-form.open{display:block;}
.goal-add-row{display:flex;gap:8px;margin-bottom:8px;}
.goal-add-in{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;padding:9px 14px;outline:none;transition:border-color 0.15s;}
.goal-add-in:focus{border-color:var(--accent);}
.goal-add-in::placeholder{color:var(--dim);font-style:italic;}
.goal-tier-sel{background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:9px 12px;outline:none;cursor:pointer;}
.goal-add-note-in{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:7px 12px;outline:none;transition:border-color 0.15s;}
.goal-add-note-in:focus{border-color:var(--accent);}
.goal-add-note-in::placeholder{color:var(--dim);}
.goal-add-save{padding:8px 18px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.goal-add-save:hover{background:var(--ag);}
.goals-archive-toggle{font-size:8px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;cursor:pointer;padding:4px 0;transition:color 0.12s;}
.goals-archive-toggle:hover{color:var(--muted);}

/* â”€â”€ DRAGGABLE NAV â”€â”€ */
.nav-tab{padding:12px 16px;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;margin-bottom:-1px;white-space:nowrap;user-select:none;position:relative;}
.nav-tab:hover{color:var(--accent);}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.nav-tab.nav-dragging{opacity:0.3;cursor:grabbing;}
.nav-tab.nav-drag-over{border-left:2px solid var(--accent);}
.nav-tab-grip{display:inline-block;margin-right:5px;color:var(--dim);font-size:9px;cursor:grab;opacity:0;transition:opacity 0.12s;}
.nav-tab:hover .nav-tab-grip{opacity:1;}
.nav-customize-btn{padding:8px 14px;background:none;border:none;border-bottom:2px solid transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;margin-bottom:-1px;white-space:nowrap;transition:color 0.12s;margin-left:auto;flex-shrink:0;}
.nav-customize-btn:hover{color:var(--accent);}
.nav-customize-btn.active{color:var(--accent);}
.nav-customize-hint{font-size:8px;color:var(--dim);padding:0 16px;display:flex;align-items:center;letter-spacing:0.1em;white-space:nowrap;border-bottom:1px solid var(--border);background:var(--bg2);animation:fUp 0.15s ease;}

/* â”€â”€ MULTI-PROFILE â”€â”€ */
.profile-switcher{padding:14px 16px;border-bottom:1px solid var(--border);}
.ps-title{font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:8px;}
.ps-list{display:flex;flex-direction:column;gap:5px;}
.ps-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:all 0.15s;}
.ps-item:hover{border-color:var(--border2);}
.ps-item.ps-active{border-color:var(--accent);background:var(--ag);}
.ps-avatar{width:28px;height:28px;border-radius:50%;background:var(--ag);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;overflow:hidden;}
.ps-avatar img{width:100%;height:100%;object-fit:cover;}
.ps-name{font-size:10px;color:var(--muted);flex:1;font-family:'DM Mono',monospace;}
.ps-item.ps-active .ps-name{color:var(--accent);}
.ps-level{font-size:8px;color:var(--dim);}
.ps-add-btn{display:flex;align-items:center;gap:6px;padding:7px 10px;border:1px dashed var(--border);background:transparent;color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.12s;width:100%;margin-top:4px;letter-spacing:0.08em;}
.ps-add-btn:hover{border-color:var(--accent);color:var(--accent);}
.ps-del-btn{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 4px;transition:color 0.12s;flex-shrink:0;}
.ps-del-btn:hover{color:var(--red);}

/* ============================================================
   MOBILE & PWA â€” full responsive overhaul
   ============================================================ */

/* PWA safe areas */
:root {
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

/* â”€â”€ HEADER â”€â”€ */
@media(max-width:768px){
  header{padding:10px 16px 10px;flex-wrap:nowrap;gap:8px;}
  .logo{font-size:26px;}
  header > div:first-child > div:last-child{display:none;}/* hide subtitle */
  .tagline{font-size:8px;letter-spacing:0.12em;}
  .profile-btn{padding:5px 8px 5px 6px;}
  .profile-name-hdr{font-size:8px;}
  .profile-level-hdr{display:none;}
}

/* â”€â”€ STATS BAR â”€â”€ */
@media(max-width:768px){
  .stats-bar{overflow-x:auto;}
  .stat{padding:8px 14px;flex-shrink:0;}
  .stat-num{font-size:18px;}
  .stat-label{font-size:7px;}
}

/* â”€â”€ NAV TABS â”€â”€ */
@media(max-width:768px){
  .nav-tabs{padding:0 8px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
  .nav-tabs::-webkit-scrollbar{display:none;}.nav-tabs::-webkit-scrollbar{display:none;}
  .nav-tab{padding:10px 10px;font-size:9px;letter-spacing:0.06em;}
  .nav-customize-btn{font-size:8px;padding:8px 8px;}
}

/* â”€â”€ GENERATOR â”€â”€ */
@media(max-width:768px){
  .gen-layout{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .sidebar{border-right:none;border-bottom:1px solid var(--border);padding:14px 16px;max-height:none;}
  .sidebar details{display:block;}
  .content-area{padding:0;}
  .sub-tabs{padding:0 14px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
  .sub-tabs::-webkit-scrollbar{display:none;}
  .sub-content{padding:14px 16px;}
  .sub-tab{font-size:9px;padding:10px 10px;}
  .combo-actions{gap:6px;}
  .action-btn{font-size:9px;padding:8px 12px;}
  .move-item{padding:10px 12px;}
  .move-name{font-size:13px;}
  .saved-grid{grid-template-columns:1fr;}
  .browse-controls{flex-direction:column;}
  .browse-controls input,.browse-controls select{width:100%;}
}

/* â”€â”€ GAMES â”€â”€ */
@media(max-width:768px){
  .games-page{padding:16px;}
  .games-hub{grid-template-columns:1fr;}
  .active-game{padding:16px;}
  .alpha-grid{grid-template-columns:repeat(5,1fr);gap:5px;}
  .alpha-letter{font-size:18px;}
  .spell-input-row{flex-direction:column;}
  .spell-in{font-size:16px;}
  .spell-go-btn{width:100%;}
  .challenge-grid{grid-template-columns:repeat(3,1fr);}
  .roulette-area{padding:10px 0;}
}

/* â”€â”€ ROUTINE BUILDER â”€â”€ */
@media(max-width:768px){
  .choreo-layout{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .choreo-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:260px;overflow-y:auto;}
  .sec-header{padding:10px 14px;}
  .section-body{padding:10px 14px;}
  .sec-actions{flex-wrap:wrap;}
}

/* â”€â”€ CONTENT STUDIO â”€â”€ */
@media(max-width:768px){
  .studio-tb{padding:10px 12px;gap:6px;}
  .studio-tb h3{font-size:14px;}
  .studio-week{min-height:0;}
  .day-col{min-width:260px;}
  .week-nav{gap:5px;}
  .week-lbl{font-size:8px;min-width:100px;}
}

/* â”€â”€ WARM-UP â”€â”€ */
@media(max-width:768px){
  .wu-page{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .wu-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:220px;overflow-y:auto;padding:14px;}
  .wu-controls{padding:12px 16px;gap:8px;}
  .wu-controls h3{font-size:15px;}
  .wu-body{padding:14px 16px;}
  .wu-cards{grid-template-columns:1fr;}
}

/* â”€â”€ VIDEO LIBRARY â”€â”€ */
@media(max-width:768px){
  .vl-page{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .vl-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:180px;overflow-y:auto;}
  .vl-sidebar-cats{display:flex;flex-wrap:wrap;gap:4px;padding:10px;}
  .vl-cat-btn{padding:4px 10px;font-size:8px;}
  .vl-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:14px;}
  .vl-toolbar{padding:10px 14px;gap:6px;flex-wrap:wrap;}
}

/* â”€â”€ CLASS SCHEDULE â”€â”€ */
@media(max-width:768px){
  .sched-page{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .sched-sidebar{border-right:none;border-bottom:1px solid var(--border);}
  .sched-main{padding:14px;}
}

/* â”€â”€ PSO TRAINING â”€â”€ */
@media(max-width:768px){
  .pso-layout{display:flex;flex-direction:column;}
  .pso-sidebar{border-right:none;border-bottom:1px solid var(--border);padding:14px;}
  .pso-main{padding:14px;}
  .score-grid{grid-template-columns:1fr!important;}
  .deduct-grid{grid-template-columns:1fr!important;}
}

/* â”€â”€ JOURNAL â”€â”€ */
@media(max-width:768px){
  .journal-layout{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .journal-sidebar{border-right:none;border-bottom:1px solid var(--border);padding:12px 14px;}
  .journal-nav{flex-direction:row;flex-wrap:wrap;gap:5px;}
  .jnav-btn{flex:1;min-width:100px;font-size:8px;padding:8px 10px;justify-content:center;}
  .journal-streak-card{display:none;}/* shown inline on mobile instead */
  .journal-main{overflow-y:auto;}
  .journal-section{padding:16px;}
  .tracker-grid{gap:4px;}
  .tracker-bubble{font-size:9px;}
  .tracker-date-num{font-size:9px;}
  .tracker-bubble-icons{font-size:7px;}
  .tdp-activity-grid{grid-template-columns:1fr 1fr;}
  .sj-form-grid{grid-template-columns:1fr;}
  .sj-form{padding:16px;}
  .feeling-emoji-btn{font-size:18px;}
  .goals-tier-hdr{flex-wrap:wrap;}
}

/* â”€â”€ PROFILE PORTAL â”€â”€ */
@media(max-width:768px){
  .portal-overlay{padding:12px;align-items:flex-start;padding-top:env(safe-area-inset-top,20px);overflow-y:auto;}
  .portal-box{padding:28px 20px;max-height:none;}
  .portal-logo{font-size:32px;}
  .profile-drawer{width:100%;max-width:100%;}
  .pd-body{padding:16px;}
}

/* â”€â”€ BOTTOM NAV (mobile) â”€â”€ */
@media(max-width:768px){
  .mobile-bottom-nav{display:flex!important;}
  body{padding-bottom:calc(60px + var(--safe-bot));}
}

.mobile-bottom-nav{
  display:none;
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:calc(60px + env(safe-area-inset-bottom,0px));
  padding-bottom:env(safe-area-inset-bottom,0px);
  background:var(--bg2);
  border-top:1px solid var(--border);
  z-index:500;
  overflow:visible;
  flex-direction:row;
  align-items:stretch;
}
.mobile-bottom-nav::-webkit-scrollbar{display:none;}
.mbn-inner{display:flex;height:60px;flex:1;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;min-width:0;}
.mbn-inner::-webkit-scrollbar{display:none;}
.mbn-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:6px 14px;background:none;border:none;color:var(--dim);font-family:'DM Mono',monospace;font-size:7px;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;transition:color 0.15s;min-width:60px;flex-shrink:0;border-top:2px solid transparent;}
.mbn-btn:hover,.mbn-btn.active{color:var(--accent);border-top-color:var(--accent);}
.mbn-icon{font-size:18px;line-height:1;}
.mbn-sync-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:6px 14px;background:rgba(201,169,110,0.1);border:none;border-left:1px solid var(--border);color:var(--accent);font-family:'DM Mono',monospace;font-size:7px;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;flex-shrink:0;min-width:60px;height:60px;}
.mbn-sync-dot{width:8px;height:8px;border-radius:50%;background:var(--dim);margin-bottom:1px;}
.mbn-sync-dot.synced{background:var(--l1);}
.mbn-sync-dot.syncing{background:var(--accent);animation:pulse 1s infinite;}

/* â”€â”€ TOUCH TARGETS â”€â”€ */
@media(max-width:768px){
  button{min-height:36px;}
  .chip{padding:7px 12px;}
  input[type="range"]{height:36px;}
  .tracker-bubble{cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .game-card{padding:16px;}
  .alpha-cell{min-height:56px;}
  select{font-size:16px!important;}/* prevents iOS zoom */
  input[type="text"],input[type="date"],textarea{font-size:16px!important;}/* prevents iOS zoom */
}

/* â”€â”€ GENERAL MOBILE PADDING â”€â”€ */
@media(max-width:480px){
  .journal-section{padding:12px;}
  .games-page{padding:12px;}
  .active-game{padding:12px 14px;}
  .tracker-grid{gap:3px;}
  .alpha-grid{grid-template-columns:repeat(4,1fr);}
  .challenge-grid{grid-template-columns:repeat(2,1fr);}
}

/* Smooth scrolling everywhere */
*{-webkit-overflow-scrolling:touch;}
/* â”€â”€ EXTRA MOBILE POLISH â”€â”€ */
@media(max-width:768px){
  /* Sub content full bleed */
  .sub-content{padding:12px 14px !important;}
  /* Combo output */
  #comboOutput{padding:0;}
  .combo-header{flex-direction:column;align-items:flex-start;gap:8px;}
  /* Move cards bigger touch target */
  .move-item{padding:12px 14px;min-height:44px;}
  /* Saved grid single col */
  .saved-grid{grid-template-columns:1fr !important;}
  /* Section preset bar wraps nicely */
  .sec-preset-bar{overflow-x:auto;padding:10px 14px;gap:5px;-webkit-overflow-scrolling:touch;}
  /* Choreo section header */
  .sec-header{padding:10px 12px;gap:6px;}
  .sec-header-left{gap:6px;}
  /* Nav hint bar */
  .nav-customize-hint{padding:8px 14px;font-size:8px;}
  /* Profile drawer full screen on mobile */
  .profile-drawer{height:100dvh !important;top:0 !important;right:0 !important;}
  /* Portal box full screen */
  .portal-overlay{padding:0 !important;}
  .portal-box{min-height:100dvh;border-radius:0;border:none;padding:28px 20px 40px;}
  /* Bottom nav icons bigger */
  .mbn-icon{font-size:20px;}
  .mbn-btn{min-width:60px;padding:4px 10px;}
  /* Stats bar scroll */
  .stats-bar{gap:0;padding:0;}
  .stat{padding:8px 12px;border-right:1px solid var(--border);flex-shrink:0;}
  /* Warm-up cards full width */
  .wu-cards{grid-template-columns:1fr !important;}
  /* VL grid 2-col on tablet, 1-col on phone */
  .vl-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr)) !important;}
  .vl-card{padding:10px;}
  .vl-card-title{font-size:11px;}
  /* Journal sections better spacing */
  .journal-section{padding:14px 16px !important;}
  .tracker-header{flex-direction:column;align-items:flex-start;gap:10px;}
  .tracker-month-nav{align-self:flex-end;}
  /* Goals full width */
  .goal-item{padding:10px 12px;}
  .goal-text{font-size:15px;}
  /* Session journal form */
  .sj-submit-row{flex-direction:column;}
  .sj-save-entry-btn,.sj-cancel-btn{width:100%;text-align:center;}
  /* Dare card bigger text */
  .dare-text{font-size:18px;}
  /* Roulette centered */
  .roulette-area{align-items:center;}
  /* Alpha grid letters bigger on phone */
  .alpha-letter{font-size:20px !important;}
  .alpha-move{font-size:6px;}
  /* PSO layout */
  .pso-layout,.pso-page{display:flex !important;flex-direction:column !important;}
  .pso-main{padding:14px 16px !important;}
  /* Schedule */
  .sched-form,.sched-upcoming{padding:14px 16px !important;}
  /* Content studio toolbar */
  .studio-tb{padding:8px 12px;gap:6px;}
  .studio-tb h3{font-size:13px;}
  /* Week nav compact */
  .week-lbl{font-size:8px;min-width:80px !important;}
}

@media(max-width:480px){
  /* Phone-specific: everything tighter */
  .logo{font-size:22px !important;}
  .nav-tab{font-size:8px !important;padding:9px 8px !important;letter-spacing:0.04em !important;}
  .stat-num{font-size:16px !important;}
  .stat-label{font-size:6px !important;}
  /* Single column everything */
  .tdp-activity-grid{grid-template-columns:1fr 1fr !important;}
  .jsc-stats{grid-template-columns:1fr 1fr !important;}
  /* Games hub */
  .game-card{padding:14px;}
  .game-title{font-size:17px;}
  .game-emoji{font-size:26px;margin-bottom:6px;}
  /* Spell it */
  .spell-letter-row{padding:8px 10px;gap:8px;}
  .spell-ltr{font-size:24px;width:28px;}
  .spell-move-name{font-size:14px;}
}

/* Landscape phone */
@media(max-width:768px) and (orientation:landscape){
  .mobile-bottom-nav{height:calc(50px + env(safe-area-inset-bottom,0px));}
  .mbn-inner{height:50px;}
  body{padding-bottom:calc(50px + var(--safe-bot));}
}

/* Prevent overscroll bounce showing white */
html,body{overscroll-behavior:none;background:var(--bg);}

/* Better focus styles for accessibility on mobile */
@media(max-width:768px){
  button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
    outline:2px solid var(--accent);outline-offset:2px;
  }
}


/* ============================================================
   FIREBASE AUTH UI
   ============================================================ */
/* fb-auth-bar removed */
.fb-sync-dot{width:7px;height:7px;border-radius:50%;background:var(--dim);flex-shrink:0;transition:background 0.3s;}
.fb-sync-dot.synced{background:#6ec9a0;animation:pulse 2s ease infinite;}
.fb-sync-dot.syncing{background:var(--accent);animation:spin 0.8s linear infinite;}
.fb-sync-dot.error{background:#e07070;}
@keyframes spin{to{transform:rotate(360deg);}}
.fb-auth-user{flex:1;color:var(--muted);}
.fb-auth-btn{padding:4px 10px;border:1px solid var(--border);background:transparent;
  color:var(--dim);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.1em;
  cursor:pointer;transition:all 0.12s;text-transform:uppercase;}
.fb-auth-btn:hover{border-color:var(--accent);color:var(--accent);}
.fb-auth-btn.primary{border-color:var(--accent);color:var(--accent);}

/* Auth modal */
.fb-modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;
  display:flex;align-items:center;justify-content:center;padding:20px;
  animation:fbFadeIn 0.2s ease;
}
@media(max-width:768px){
  .fb-modal-overlay{align-items:flex-start;padding-top:60px;}
}
@keyframes fbFadeIn{from{opacity:0}to{opacity:1}}
.fb-modal{
  background:var(--bg2);border:1px solid var(--border2);
  width:100%;max-width:420px;padding:0;overflow:hidden;
  animation:fUp 0.2s ease;
}
.fb-modal-header{
  padding:24px 28px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.fb-modal-title{font-family:'Cormorant Garamond',serif;font-size:24px;
  color:var(--accent);font-style:italic;}
.fb-modal-close{background:none;border:none;color:var(--dim);font-size:18px;
  cursor:pointer;padding:2px 6px;transition:color 0.12s;}
.fb-modal-close:hover{color:var(--text);}
.fb-modal-body{padding:24px 28px;}
.fb-google-btn{
  width:100%;display:flex;align-items:center;justify-content:center;gap:10px;
  padding:13px 20px;background:white;border:1px solid #ddd;color:#333;
  font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.08em;
  cursor:pointer;transition:all 0.15s;margin-bottom:18px;
}
.fb-google-btn:hover{box-shadow:0 2px 12px rgba(0,0,0,0.15);}
.fb-google-icon{width:18px;height:18px;}
.fb-divider{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
.fb-divider::before,.fb-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.fb-divider-text{font-size:8px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;}
.fb-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  color:var(--text);font-family:'DM Mono',monospace;font-size:11px;
  padding:11px 14px;outline:none;transition:border-color 0.15s;
  margin-bottom:10px;box-sizing:border-box;
}
.fb-input:focus{border-color:var(--accent);}
.fb-input::placeholder{color:var(--dim);}
.fb-submit-btn{
  width:100%;padding:13px;border:1px solid var(--accent);background:transparent;
  color:var(--accent);font-family:'DM Mono',monospace;font-size:10px;
  letter-spacing:0.14em;cursor:pointer;transition:all 0.15s;
  text-transform:uppercase;margin-top:4px;
}
.fb-submit-btn:hover{background:var(--ag);}
.fb-toggle-mode{
  margin-top:14px;text-align:center;font-size:9px;color:var(--dim);
  letter-spacing:0.08em;
}
.fb-toggle-link{color:var(--accent);cursor:pointer;text-decoration:underline;}
.fb-auth-error{
  background:rgba(224,112,112,0.12);border:1px solid rgba(224,112,112,0.3);
  color:#e07070;font-size:9px;padding:8px 12px;margin-bottom:12px;
  letter-spacing:0.08em;display:none;
}
.fb-auth-error.visible{display:block;}
.fb-config-box{
  background:var(--bg3);border:1px solid var(--border);padding:16px;
  margin-top:14px;
}
.fb-config-label{font-size:7px;letter-spacing:0.2em;color:var(--dim);
  text-transform:uppercase;margin-bottom:6px;}
.fb-config-in{
  width:100%;background:var(--bg2);border:1px solid var(--border);
  color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;
  padding:8px 10px;outline:none;resize:none;line-height:1.6;
  transition:border-color 0.15s;box-sizing:border-box;
}
.fb-config-in:focus{border-color:var(--accent);}
.fb-config-save{
  margin-top:8px;padding:7px 16px;border:1px solid var(--accent);
  background:transparent;color:var(--accent);font-family:'DM Mono',monospace;
  font-size:8px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;
}
.fb-config-save:hover{background:var(--ag);}

/* Sync indicator in profile button */
.profile-sync-badge{
  width:8px;height:8px;border-radius:50%;background:var(--dim);
  margin-left:4px;flex-shrink:0;transition:background 0.3s;
}
.profile-sync-badge.synced{background:#6ec9a0;}
.profile-sync-badge.syncing{background:var(--accent);}

@media(max-width:768px){
  .fb-modal{max-width:100%;margin:0 8px;}
  .fb-modal-body{padding:18px 20px;}
  .fb-modal-header{padding:18px 20px 14px;}
}

/* â”€â”€ ROUTINE TAGLINE â”€â”€ */
.routine-tagline-in{background:transparent;border:none;border-bottom:1px solid var(--border);
  color:var(--dim);font-family:'DM Mono',monospace;font-size:9px;font-style:italic;
  outline:none;padding:3px 8px;min-width:220px;transition:border-color 0.12s;letter-spacing:0.06em;}
.routine-tagline-in:focus{border-bottom-color:var(--accent);}
.routine-tagline-in::placeholder{color:var(--dim);opacity:0.7;}
.saved-routine-tagline{font-size:8px;color:var(--dim);font-style:italic;letter-spacing:0.06em;margin-top:2px;}

/* ============================================================
   TEACH PAGE
   ============================================================ */
.teach-layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 148px);}
.teach-sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:18px 14px;display:flex;flex-direction:column;gap:6px;}
.teach-nav-btn{display:flex;align-items:center;gap:8px;padding:9px 12px;background:none;border:1px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;text-align:left;}
.teach-nav-btn:hover{color:var(--text);border-color:var(--border);}
.teach-nav-btn.active{background:var(--ag);border-color:var(--accent);color:var(--accent);}
.teach-nav-icon{font-size:13px;flex-shrink:0;}
.teach-main{overflow-y:auto;}
.teach-section{display:none;padding:28px 32px;}
.teach-section.active{display:block;}

/* â”€â”€ CLASS PLANNER â”€â”€ */
.cp-header{display:flex;align-items:center;gap:14px;margin-bottom:22px;flex-wrap:wrap;}
.cp-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.cp-format-chips{display:flex;gap:6px;flex-wrap:wrap;}
.cp-chip{padding:7px 16px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.cp-chip:hover{border-color:var(--border2);color:var(--text);}
.cp-chip.active{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.cp-meta-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:22px;}
.cp-meta-in{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:8px 12px;outline:none;transition:border-color 0.15s;flex:1;min-width:140px;}
.cp-meta-in:focus{border-color:var(--accent);}
.cp-meta-in::placeholder{color:var(--dim);}

/* Plan sections (collapsible) */
.cp-plan{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
.cp-block{background:var(--bg2);border:1px solid var(--border);overflow:hidden;transition:all 0.2s;}
.cp-block-header{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;user-select:none;border-left:3px solid transparent;transition:border-color 0.15s;}
.cp-block-header:hover{background:var(--bg3);}
.cp-block.warmup .cp-block-header{border-left-color:var(--l1);}
.cp-block.skills .cp-block-header{border-left-color:var(--accent);}
.cp-block.choreo .cp-block-header{border-left-color:var(--l3);}
.cp-block.cooldown .cp-block-header{border-left-color:var(--l2);}
.cp-block.freeplay .cp-block-header{border-left-color:var(--l5);}
.cp-block.custom .cp-block-header{border-left-color:var(--border2);}
.cp-block-toggle{color:var(--dim);font-size:10px;transition:transform 0.2s;flex-shrink:0;}
.cp-block.collapsed .cp-block-toggle{transform:rotate(-90deg);}
.cp-block-icon{font-size:16px;flex-shrink:0;}
.cp-block-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);flex:1;font-style:italic;}
.cp-block-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:0.1em;flex-shrink:0;}
.cp-block-del{background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;padding:2px 6px;flex-shrink:0;transition:color 0.12s;}
.cp-block-del:hover{color:var(--red);}
.cp-block-body{padding:14px 16px;border-top:1px solid var(--border);}
.cp-block.collapsed .cp-block-body{display:none;}

/* Block content */
.cp-block-notes{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:8px 12px;outline:none;resize:none;line-height:1.7;transition:border-color 0.15s;}
.cp-block-notes:focus{border-color:var(--accent);color:var(--text);}
.cp-block-notes::placeholder{color:var(--dim);font-style:italic;}
.cp-moves-area{margin-top:10px;}
.cp-moves-label{font-size:7px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;margin-bottom:6px;}
.cp-move-chips{display:flex;flex-wrap:wrap;gap:5px;min-height:32px;padding:6px;background:var(--bg3);border:1px dashed var(--border);}
.cp-move-chip{padding:4px 10px;background:var(--ag);border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:8px;display:flex;align-items:center;gap:5px;letter-spacing:0.06em;}
.cp-move-chip-del{background:none;border:none;color:var(--accent);cursor:pointer;font-size:10px;padding:0;line-height:1;}
.cp-add-move-row{display:flex;gap:6px;margin-top:8px;}
.cp-add-move-in{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:9px;padding:6px 10px;outline:none;transition:border-color 0.15s;}
.cp-add-move-in:focus{border-color:var(--accent);}
.cp-add-move-btn{padding:6px 14px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.12s;}
.cp-add-move-btn:hover{background:var(--ag);}
.cp-time-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.cp-time-lbl{font-size:8px;color:var(--dim);letter-spacing:0.12em;text-transform:uppercase;width:80px;flex-shrink:0;}
.cp-time-in{width:60px;background:var(--bg3);border:1px solid var(--border);color:var(--accent);font-family:'DM Mono',monospace;font-size:11px;padding:5px 8px;outline:none;text-align:center;transition:border-color 0.15s;}
.cp-time-in:focus{border-color:var(--accent);}
.cp-time-unit{font-size:9px;color:var(--dim);}

/* Add block row */
.cp-add-block-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:22px;}
.cp-add-block-btn{padding:7px 14px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;cursor:pointer;transition:all 0.15s;letter-spacing:0.08em;display:flex;align-items:center;gap:5px;}
.cp-add-block-btn:hover{border-color:var(--accent);color:var(--accent);}

/* Plan actions */
.cp-plan-actions{display:flex;gap:8px;flex-wrap:wrap;}
.cp-save-btn{padding:9px 22px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.cp-save-btn:hover{background:var(--ag);}
.cp-print-btn{padding:9px 22px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.cp-print-btn:hover{border-color:var(--border2);color:var(--text);}
.cp-new-btn{padding:9px 22px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.cp-new-btn:hover{border-color:var(--l5);color:var(--l5);}

/* Saved plans */
.cp-saved-list{margin-top:24px;}
.cp-saved-hdr{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.cp-saved-title{font-size:8px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;}
.cp-saved-line{flex:1;height:1px;background:var(--border);}
.cp-saved-item{background:var(--bg3);border:1px solid var(--border);padding:12px 16px;margin-bottom:7px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.15s;}
.cp-saved-item:hover{border-color:var(--border2);}
.cp-saved-item-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);font-style:italic;flex:1;}
.cp-saved-item-meta{font-size:8px;color:var(--dim);letter-spacing:0.08em;}
.cp-saved-item-del{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 4px;transition:color 0.12s;}
.cp-saved-item-del:hover{color:var(--red);}

/* Time bar */
.cp-time-bar{display:flex;height:8px;border-radius:2px;overflow:hidden;margin-bottom:6px;gap:1px;}
.cp-time-seg{height:100%;min-width:2px;transition:flex 0.3s;}
.cp-time-total{font-size:8px;color:var(--dim);letter-spacing:0.1em;text-align:right;margin-bottom:16px;}

/* â”€â”€ STUDENT ROSTER â”€â”€ */
.roster-header{display:flex;align-items:center;gap:14px;margin-bottom:22px;}
.roster-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.roster-add-btn{padding:9px 20px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.12em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.roster-add-btn:hover{background:var(--ag);}
.roster-add-form{background:var(--bg2);border:1px solid var(--border);padding:18px;margin-bottom:18px;animation:fUp 0.2s ease;display:none;}
.roster-add-form.open{display:block;}
.roster-form-row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
.roster-in{flex:1;min-width:120px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:8px 12px;outline:none;transition:border-color 0.15s;}
.roster-in:focus{border-color:var(--accent);}
.roster-in::placeholder{color:var(--dim);}
.roster-save-btn{padding:8px 18px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.roster-save-btn:hover{background:var(--ag);}
.student-card{background:var(--bg2);border:1px solid var(--border);margin-bottom:10px;overflow:hidden;transition:border-color 0.15s;}
.student-card:hover{border-color:var(--border2);}
.student-card-header{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;}
.student-avatar{width:32px;height:32px;border-radius:50%;background:var(--ag);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.student-name{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--text);font-style:italic;flex:1;}
.student-level{font-size:8px;color:var(--muted);letter-spacing:0.1em;padding:3px 8px;border:1px solid var(--border);}
.student-progress-bar{flex:0 0 80px;height:5px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.student-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s;}
.student-card-toggle{color:var(--dim);font-size:10px;transition:transform 0.2s;}
.student-card.collapsed .student-card-toggle{transform:rotate(-90deg);}
.student-del{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 6px;transition:color 0.12s;}
.student-del:hover{color:var(--red);}
.student-card-body{border-top:1px solid var(--border);padding:14px 16px;display:block;}
.student-card.collapsed .student-card-body{display:none;}
.student-skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px;margin-bottom:12px;}
.skill-chip{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;transition:all 0.12s;}
.skill-chip:hover{border-color:var(--border2);}
.skill-chip.mastered{border-color:var(--l1);background:rgba(110,201,176,0.08);}
.skill-chip.working{border-color:var(--accent);background:rgba(201,169,110,0.08);}
.skill-chip-dot{width:8px;height:8px;border-radius:50%;background:var(--border);flex-shrink:0;transition:background 0.15s;}
.skill-chip.mastered .skill-chip-dot{background:var(--l1);}
.skill-chip.working .skill-chip-dot{background:var(--accent);}
.skill-chip-name{font-size:9px;color:var(--muted);letter-spacing:0.06em;flex:1;}
.skill-chip.mastered .skill-chip-name{color:var(--text);}
.student-notes-in{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:8px 12px;outline:none;resize:none;line-height:1.7;transition:border-color 0.15s;}
.student-notes-in:focus{border-color:var(--accent);color:var(--text);}
.student-notes-in::placeholder{color:var(--dim);}
.student-section-lbl{font-size:7px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;margin-bottom:6px;margin-top:10px;}

/* â”€â”€ TEACHING NOTES â”€â”€ */
.tnotes-header{display:flex;align-items:center;gap:14px;margin-bottom:22px;}
.tnotes-title{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--accent);font-style:italic;flex:1;}
.tnotes-search{flex:1;max-width:280px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:8px 12px;outline:none;transition:border-color 0.15s;}
.tnotes-search:focus{border-color:var(--accent);}
.tnotes-search::placeholder{color:var(--dim);}
.tnote-card{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--accent);padding:14px 16px;margin-bottom:8px;transition:border-color 0.15s;}
.tnote-card:hover{border-color:var(--border2);}
.tnote-move{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--text);font-style:italic;margin-bottom:8px;}
.tnote-fields{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.tnote-field{display:flex;flex-direction:column;gap:4px;}
.tnote-lbl{font-size:7px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;}
.tnote-in{background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:6px 10px;outline:none;resize:none;line-height:1.6;width:100%;transition:border-color 0.15s;}
.tnote-in:focus{border-color:var(--accent);color:var(--text);}
.tnote-in::placeholder{color:var(--dim);}
.tnote-add-row{display:flex;gap:8px;margin-bottom:16px;}
.tnote-add-in{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;padding:9px 14px;outline:none;transition:border-color 0.15s;}
.tnote-add-in:focus{border-color:var(--accent);}
.tnote-add-in::placeholder{color:var(--dim);font-style:italic;}
.tnote-add-btn{padding:9px 18px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;text-transform:uppercase;transition:all 0.15s;}
.tnote-add-btn:hover{background:var(--ag);}
.tnote-del{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 4px;float:right;transition:color 0.12s;}
.tnote-del:hover{color:var(--red);}

/* Print styles */
@media print{
  .nav-tabs,.fb-auth-bar,.mobile-bottom-nav,.profile-btn,.choreo-sidebar{display:none!important;}
  .teach-sidebar{display:none!important;}
  .teach-layout{display:block!important;}
  .teach-section{display:block!important;padding:0!important;}
  .cp-block-body{display:block!important;}
  .cp-plan-actions,.cp-add-block-row,.cp-saved-list{display:none!important;}
  body{background:white!important;color:#111!important;}
  .cp-block{border:1px solid #ddd!important;margin-bottom:8px!important;}
  .cp-block-header{background:#f5f5f5!important;}
  .cp-block-name,.cp-block-time{color:#111!important;}
}

/* Mobile teach */
@media(max-width:768px){
  .teach-layout{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .teach-sidebar{border-right:none;border-bottom:1px solid var(--border);flex-direction:row;flex-wrap:wrap;padding:10px 12px;gap:5px;}
  .teach-nav-btn{flex:1;min-width:80px;font-size:8px;padding:7px 8px;justify-content:center;}
  .teach-nav-icon{display:none;}
  .teach-section{padding:14px 16px;}
  .tnote-fields{grid-template-columns:1fr;}
  .student-skills-grid{grid-template-columns:1fr 1fr;}
  .cp-meta-row{flex-direction:column;}
}


.flex-page{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 148px);}
.flex-sidebar{border-right:1px solid var(--border);background:var(--bg2);padding:20px 18px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.flex-sidebar h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;}
.flex-main{overflow-y:auto;}
.flex-controls{padding:16px 24px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.flex-controls h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;flex:1;}
.flex-body{padding:24px 28px;}
.flex-generate-btn{width:100%;padding:13px;background:linear-gradient(135deg,rgba(201,169,110,0.15),rgba(201,169,110,0.05));border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.18em;cursor:pointer;transition:all 0.2s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;}
.flex-generate-btn:hover{background:rgba(201,169,110,0.2);}
.flex-generate-btn span{font-size:13px;}

/* Stats bar */
.flex-stats{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);}
.flex-stat{flex:1;padding:10px 16px;border-right:1px solid var(--border);}
.flex-stat:last-child{border-right:none;}
.flex-stat-n{font-family:'DM Mono',monospace;font-size:18px;color:var(--accent);}
.flex-stat-l{font-size:7px;color:var(--dim);letter-spacing:0.16em;text-transform:uppercase;margin-top:2px;}

/* Stretch cards â€” same as wu-cards */
.flex-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;margin-bottom:12px;}
.flex-card{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--accent);padding:13px 14px;position:relative;animation:fUp 0.25s ease both;}
.flex-card.fc-hip{border-left-color:var(--l5);}
.flex-card.fc-hamstring{border-left-color:var(--l3);}
.flex-card.fc-shoulder{border-left-color:var(--l1);}
.flex-card.fc-back{border-left-color:var(--l2);}
.flex-card.fc-quad{border-left-color:var(--accent);}
.flex-card.fc-calf{border-left-color:#9b8ea0;}
.flex-card.fc-chest{border-left-color:#d4a5c9;}
.flex-card.fc-wrist{border-left-color:#a0b8d4;}
.flex-card.fc-split{border-left-color:#c9706e;}
.flex-card-del{position:absolute;top:7px;right:7px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:11px;padding:2px 4px;transition:color 0.12s;}
.flex-card-del:hover{color:var(--red);}
.flex-card-name{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--text);margin-bottom:5px;font-style:italic;padding-right:18px;}
.flex-card-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px;}
.flex-card-time{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.flex-card-dur{font-family:'DM Mono',monospace;font-size:9px;color:var(--accent);}
.flex-card-note{font-size:8px;color:var(--dim);line-height:1.65;border-top:1px solid var(--border);padding-top:6px;margin-top:4px;}
.flex-card-intensity{display:flex;gap:3px;margin-top:5px;}
.flex-intensity-dot{width:6px;height:6px;border-radius:50%;background:var(--border);}
.flex-intensity-dot.active{background:var(--accent);}

/* Move muscles panel */
.flex-move-panel{background:var(--bg3);border:1px solid var(--border);padding:16px 18px;margin-bottom:20px;animation:fUp 0.2s ease;}
.flex-move-panel-title{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);font-style:italic;margin-bottom:10px;}
.flex-muscle-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.flex-muscle-tag{padding:4px 10px;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.1em;border:1px solid var(--border);}
.flex-muscle-tag.primary{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.flex-muscle-tag.secondary{border-color:var(--border2);color:var(--muted);}
.flex-muscle-tag.needs{border-color:var(--l5);color:var(--l5);background:rgba(201,169,201,0.06);}
.flex-muscle-legend{display:flex;gap:12px;font-size:7px;color:var(--dim);letter-spacing:0.1em;margin-top:6px;}
.flex-muscle-legend span{display:flex;align-items:center;gap:4px;}
.flex-muscle-legend span::before{content:'';width:6px;height:6px;border-radius:50%;display:inline-block;}
.flex-muscle-legend .leg-primary::before{background:var(--accent);}
.flex-muscle-legend .leg-secondary::before{background:var(--border2);}
.flex-muscle-legend .leg-needs::before{background:var(--l5);}

/* Body diagram placeholder */
.flex-body-map{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:18px;display:flex;gap:20px;align-items:flex-start;}
.flex-body-svg{flex-shrink:0;}
.flex-body-info{flex:1;}
.flex-body-info-title{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);font-style:italic;margin-bottom:8px;}
.flex-body-info-list{font-size:9px;color:var(--muted);line-height:1.9;}

/* Empty state */
.flex-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;gap:12px;color:var(--dim);}
.flex-empty-icon{font-size:40px;opacity:0.4;}
.flex-empty-text{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;}

/* Section headers â€” same as warm-up */
.flex-section-hdr{display:flex;align-items:center;gap:10px;margin:20px 0 10px;}
.flex-section-title{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent2);font-style:italic;white-space:nowrap;}
.flex-section-line{flex:1;height:1px;background:var(--border);}
.flex-section-time{font-size:8px;color:var(--dim);letter-spacing:0.12em;}

/* Total bar */
.flex-total-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:rgba(201,169,110,0.04);border:1px solid rgba(201,169,110,0.12);margin-top:18px;}
.flex-total-bar-txt{font-size:8px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;}
.flex-total-bar-min{font-family:'DM Mono',monospace;font-size:22px;color:var(--accent);}
.flex-start-btn{padding:10px 22px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.flex-start-btn:hover{background:var(--ag);}

@media(max-width:768px){
  .flex-page{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .flex-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:220px;overflow-y:auto;padding:14px;}
  .flex-controls{padding:12px 16px;gap:8px;}
  .flex-cards{grid-template-columns:1fr;}
  .flex-body{padding:14px 16px;}
  .flex-body-map{flex-direction:column;}
}

/* â”€â”€ STUDIO VIEW TABS â”€â”€ */
.studio-view-tabs{display:flex;gap:5px;flex-shrink:0;}
.svt{padding:6px 14px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;white-space:nowrap;}
.svt:hover{border-color:var(--border2);color:var(--text);}
.svt.active{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.studio-cal-nav{display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex:1;}
.studio-filter-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;flex:1;}
.studio-filter-in{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:7px 12px;outline:none;flex:1;min-width:160px;transition:border-color 0.15s;}
.studio-filter-in:focus{border-color:var(--accent);}
.studio-filter-in::placeholder{color:var(--dim);}
.studio-filter-sel{background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;padding:7px 10px;outline:none;cursor:pointer;transition:border-color 0.15s;}
.studio-filter-sel:focus{border-color:var(--accent);}

/* â”€â”€ FILM SCHEDULE â”€â”€ */
.studio-film-schedule{padding:20px 24px;}
.film-sched-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;gap:12px;color:var(--dim);}
.film-sched-empty-icon{font-size:40px;opacity:0.4;}
.film-sched-section-hdr{display:flex;align-items:center;gap:10px;margin:20px 0 10px;}
.film-sched-section-title{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--accent2);font-style:italic;white-space:nowrap;}
.film-sched-line{flex:1;height:1px;background:var(--border);}
.film-sched-count{font-size:8px;color:var(--dim);letter-spacing:0.1em;}
.studio-film-schedule{padding:24px 0 32px;}
.film-sched-group{margin-bottom:32px;}
.film-sched-lane{display:flex;gap:14px;overflow-x:auto;padding:4px 24px 16px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;-webkit-overflow-scrolling:touch;}
.film-sched-lane::-webkit-scrollbar{height:4px;}
.film-sched-lane::-webkit-scrollbar-track{background:transparent;}
.film-sched-lane::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.film-sched-card{flex:0 0 220px;background:var(--bg2);border:1px solid var(--border);border-top:3px solid var(--accent);position:relative;transition:box-shadow 0.15s,border-color 0.15s;cursor:default;display:flex;flex-direction:column;}
.film-sched-card:hover{box-shadow:0 6px 24px rgba(0,0,0,0.45);border-color:var(--border2);}
.film-sched-card.overdue{border-top-color:#e07070;}
.film-sched-card.today{border-top-color:var(--l1);}
.film-sched-card.dragging{opacity:0.25;transform:scale(0.96);}
.film-sched-card.drag-target-left{box-shadow:-3px 0 0 var(--accent),0 6px 24px rgba(0,0,0,0.3);}
.film-sched-card.drag-target-right{box-shadow:3px 0 0 var(--accent),0 6px 24px rgba(0,0,0,0.3);}
.fsc-header{display:flex;align-items:center;gap:6px;padding:8px 10px 7px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.15);}
.fsc-grip{color:var(--dim);font-size:12px;cursor:grab;user-select:none;letter-spacing:-1px;flex-shrink:0;}
.fsc-grip:active{cursor:grabbing;}
.fsc-date{font-family:'DM Mono',monospace;font-size:9px;flex:1;min-width:0;}
.fsc-date.overdue{color:#e07070;}
.fsc-date.today{color:var(--l1);}
.fsc-date.upcoming{color:var(--accent);}
.fsc-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.fsc-body{padding:10px 12px;flex:1;display:flex;flex-direction:column;gap:7px;}
.fsc-title{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);font-style:italic;line-height:1.3;word-break:break-word;}
.fsc-move{font-size:9px;color:var(--accent);letter-spacing:0.06em;}
.fsc-pills{display:flex;flex-wrap:wrap;gap:4px;}
.fsc-pill{font-size:7px;padding:2px 6px;border:1px solid var(--border);color:var(--dim);letter-spacing:0.08em;white-space:nowrap;}
.fsc-audio{display:flex;align-items:center;gap:5px;font-size:8px;color:var(--dim);}
.fsc-notes{font-size:8px;color:var(--muted);line-height:1.5;border-top:1px solid var(--border);padding-top:7px;word-break:break-word;}
.fsc-status-lbl{font-size:8px;letter-spacing:0.1em;text-transform:uppercase;margin-top:auto;padding-top:8px;}

/* â”€â”€ FILTER RESULTS â”€â”€ */
.studio-filter-results{padding:20px 24px;}
.sfr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;gap:8px;color:var(--dim);font-size:9px;letter-spacing:0.1em;}
.sfr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;margin-bottom:24px;}
.sfr-card{background:var(--bg2);border:1px solid var(--border);padding:13px 15px;transition:border-color 0.15s;}
.sfr-card:hover{border-color:var(--border2);}
.sfr-card.repeat{border-left:3px solid var(--l5);}
.sfr-card-title{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--text);font-style:italic;margin-bottom:4px;}
.sfr-card-meta{font-size:8px;color:var(--dim);letter-spacing:0.06em;display:flex;flex-wrap:wrap;gap:6px;}
.sfr-card-badge{padding:2px 7px;border:1px solid var(--border);font-size:7px;letter-spacing:0.1em;}
.sfr-repeat-warn{display:flex;align-items:center;gap:5px;background:rgba(201,169,201,0.08);border:1px solid rgba(160,110,201,0.25);padding:6px 10px;margin-top:8px;font-size:8px;color:var(--l5);letter-spacing:0.06em;}
.sfr-section-hdr{display:flex;align-items:center;gap:10px;margin:24px 0 12px;}
.sfr-section-title{font-size:8px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;white-space:nowrap;}
.sfr-section-line{flex:1;height:1px;background:var(--border);}
.sfr-repeat-group{background:rgba(160,110,201,0.05);border:1px solid rgba(160,110,201,0.2);padding:14px 16px;margin-bottom:10px;}
.sfr-repeat-move{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--l5);font-style:italic;margin-bottom:8px;}
.sfr-repeat-item{display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:9px;color:var(--muted);}
.sfr-repeat-item:last-child{border-bottom:none;}

@media(max-width:768px){
  .studio-view-tabs{order:-1;width:100%;}
  .svt{flex:1;text-align:center;font-size:7px;padding:5px 6px;}
  .studio-filter-bar{flex-direction:column;align-items:stretch;}
  .studio-filter-in{min-width:unset;}
  .film-sched-card{flex:0 0 180px;}
  .film-sched-lane{padding:4px 14px 14px;gap:10px;}
  .sfr-grid{grid-template-columns:1fr;}
}

/* ============================================================
   LANDING PAGE
   ============================================================ */
.landing{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;overflow-y:auto;transition:opacity 0.5s ease,transform 0.5s ease;}
.landing.out{opacity:0;transform:translateY(-20px);pointer-events:none;}
.landing-hero{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px 40px;text-align:center;position:relative;}
.landing-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(201,169,110,0.08) 0%,transparent 70%);pointer-events:none;}
.landing-logo{font-family:'Cormorant Garamond',serif;font-size:clamp(48px,10vw,80px);font-weight:300;letter-spacing:0.1em;color:var(--accent);line-height:1;}
.landing-logo span{font-style:italic;color:var(--accent2);}
.landing-tagline{font-size:10px;letter-spacing:0.3em;text-transform:uppercase;color:var(--dim);margin-top:10px;}
.landing-sub{font-family:'Cormorant Garamond',serif;font-size:clamp(14px,3vw,18px);color:var(--muted);font-style:italic;margin-top:16px;max-width:400px;line-height:1.6;}
.landing-enter{margin-top:32px;padding:14px 40px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:16px;letter-spacing:0.2em;text-transform:uppercase;cursor:pointer;position:relative;overflow:hidden;transition:color 0.2s;}
.landing-enter::before{content:'';position:absolute;inset:0;background:var(--accent);transform:translateY(100%);transition:transform 0.2s ease;}
.landing-enter:hover::before{transform:translateY(0);}
.landing-enter:hover{color:var(--bg);}
.landing-enter span{position:relative;z-index:1;}
.landing-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:0 20px 60px;max-width:900px;margin:0 auto;width:100%;}
.landing-card{background:var(--bg2);border:1px solid var(--border);padding:18px 16px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.landing-card::before{content:'';position:absolute;inset:0;background:var(--accent);opacity:0;transition:opacity 0.2s;}
.landing-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.landing-card:hover::before{opacity:0.04;}
.lc-icon{font-size:26px;line-height:1;}
.lc-title{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--text);font-style:italic;}
.lc-desc{font-size:8px;color:var(--dim);letter-spacing:0.08em;line-height:1.5;}
@media(max-width:480px){
  .landing-grid{grid-template-columns:repeat(2,1fr);gap:10px;padding:0 14px 80px;}
  .landing-hero{padding:48px 20px 28px;}
}

/* ============================================================
   GYM â€” FLEXIBILITY & STRENGTH TAB
   mirrors warm-up layout exactly
   ============================================================ */
.gym-page{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 148px);}
.gym-sidebar{border-right:1px solid var(--border);background:var(--bg2);padding:20px 18px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.gym-sidebar h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;}
.gym-main{overflow-y:auto;}
.gym-controls{padding:16px 24px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.gym-controls h3{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent2);font-style:italic;flex:1;}
.gym-body{padding:24px 28px;}
.gym-generate-btn{width:100%;padding:13px;background:linear-gradient(135deg,rgba(201,169,110,0.15),rgba(201,169,110,0.05));border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.18em;cursor:pointer;transition:all 0.2s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;}
.gym-generate-btn:hover{background:rgba(201,169,110,0.2);}

/* Stats â€” same as warm-up */
.gym-stats{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);}
.gym-stat{flex:1;padding:10px 16px;border-right:1px solid var(--border);}
.gym-stat:last-child{border-right:none;}
.gym-stat-n{font-family:'DM Mono',monospace;font-size:18px;color:var(--accent);}
.gym-stat-l{font-size:7px;color:var(--dim);letter-spacing:0.16em;text-transform:uppercase;margin-top:2px;}

/* Exercise cards â€” same grid/card pattern as warm-up */
.gym-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:12px;}
.gym-card{background:var(--bg3);border:1px solid var(--border);border-left:3px solid transparent;padding:14px;position:relative;transition:all 0.15s;animation:fUp 0.3s ease both;}
.gym-card:hover{border-color:var(--border2);}

/* Border colours by muscle group */
.gmc-shoulder{border-left-color:var(--l1);}
.gmc-back{border-left-color:var(--l2);}
.gmc-core{border-left-color:var(--accent);}
.gmc-hip{border-left-color:var(--l5);}
.gmc-hamstring{border-left-color:var(--l3);}
.gmc-quad{border-left-color:#c9a96e;}
.gmc-grip{border-left-color:#a0d4c0;}
.gmc-wrist{border-left-color:#a0b8d4;}
.gmc-chest{border-left-color:#d4a5c9;}
.gmc-flex{border-left-color:rgba(110,175,201,0.6);}

.gym-card-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;transition:color 0.12s;padding:1px 4px;}
.gym-card-del:hover{color:var(--red);}
.gym-card-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--text);margin-bottom:3px;padding-right:18px;}

/* SKILL CHIP â€” shows the pole skill this exercise unlocks */
.gym-skill-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--ag);border:1px solid var(--accent);color:var(--accent);font-family:'DM Mono',monospace;font-size:7px;letter-spacing:0.1em;margin-bottom:6px;cursor:default;}
.gym-skill-chip-icon{font-size:9px;}
.gym-card-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px;}
.gym-card-time{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.gym-card-dur{font-family:'DM Mono',monospace;font-size:9px;color:var(--accent);}
.gym-card-type{font-size:8px;color:var(--dim);letter-spacing:0.08em;}
.gym-card-note{font-size:9px;color:var(--dim);line-height:1.5;margin-top:6px;border-top:1px solid var(--border);padding-top:6px;font-style:italic;}

/* Skill picker panel */
.gym-skill-panel{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--accent);padding:14px 16px;margin-bottom:14px;}
.gym-skill-panel-title{font-size:7px;letter-spacing:0.2em;color:var(--dim);text-transform:uppercase;margin-bottom:8px;}
.gym-skill-search{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:7px 10px;outline:none;transition:border-color 0.15s;margin-bottom:6px;}
.gym-skill-search:focus{border-color:var(--accent);}
.gym-skill-list{max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;}
.gym-skill-btn{text-align:left;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;padding:6px 10px;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;gap:8px;}
.gym-skill-btn:hover{border-color:var(--border2);color:var(--text);}
.gym-skill-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.gym-skill-badge{font-size:7px;padding:2px 6px;border:1px solid currentColor;opacity:0.7;flex-shrink:0;}
.gym-sel-move{margin-top:8px;padding:10px 12px;background:var(--bg3);border:1px solid var(--accent);display:none;}
.gym-sel-move.visible{display:block;}
.gym-sel-move-name{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-style:italic;margin-bottom:6px;}
.gym-sel-muscles{display:flex;flex-wrap:wrap;gap:4px;}
.gym-sel-muscle{padding:3px 8px;font-family:'DM Mono',monospace;font-size:7px;letter-spacing:0.1em;border:1px solid var(--border);}
.gym-sel-muscle.primary{border-color:var(--accent);color:var(--accent);background:var(--ag);}
.gym-sel-muscle.needs{border-color:var(--l5);color:var(--l5);}

/* Section headers â€” same style as warm-up */
.gym-section-hdr{display:flex;align-items:center;gap:10px;margin:20px 0 10px;}
.gym-section-hdr:first-child{margin-top:0;}
.gym-section-title{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent2);font-style:italic;white-space:nowrap;}
.gym-section-line{flex:1;height:1px;background:var(--border);}
.gym-section-time{font-size:8px;color:var(--dim);letter-spacing:0.12em;}

/* Total bar */
.gym-total-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:rgba(201,169,110,0.04);border:1px solid rgba(201,169,110,0.12);margin-top:18px;}
.gym-total-bar-txt{font-size:8px;color:var(--dim);letter-spacing:0.14em;text-transform:uppercase;}
.gym-total-bar-min{font-family:'DM Mono',monospace;font-size:22px;color:var(--accent);}
.gym-start-btn{padding:10px 22px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;cursor:pointer;transition:all 0.15s;text-transform:uppercase;}
.gym-start-btn:hover{background:var(--ag);}

/* Empty state */
.gym-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;gap:12px;color:var(--dim);}
.gym-empty-icon{font-size:40px;opacity:0.4;}
.gym-empty-text{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;}

@media(max-width:768px){
  .gym-page{grid-template-columns:1fr;display:flex;flex-direction:column;}
  .gym-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:240px;overflow-y:auto;padding:14px;}
  .gym-controls{padding:12px 16px;gap:8px;}
  .gym-cards{grid-template-columns:1fr;}
  .gym-body{padding:14px 16px;}
}

/* ============================================================
   iPAD & SAFARI FIXES
   ============================================================ */

/* iPad portrait: 768-1024px â€” fire the mobile layout */
@media(max-width:1024px){
  /* Two-column grids â†’ single col on iPad */
  .choreo-layout{grid-template-columns:1fr !important;display:flex;flex-direction:column;}
  .wu-page{grid-template-columns:1fr !important;display:flex;flex-direction:column;}
  .gym-page{grid-template-columns:1fr !important;display:flex;flex-direction:column;}
  .teach-layout{grid-template-columns:1fr !important;display:flex;flex-direction:column;}
  .pso-layout{grid-template-columns:1fr !important;display:flex;flex-direction:column;}
  /* Journal two-col */
  .journal-layout{grid-template-columns:1fr !important;}
  /* Studio */
  .studio-page{grid-template-columns:1fr !important;}
}

/* iPad specific (between 768 and 1024) */
@media(min-width:769px) and (max-width:1024px){
  /* Sidebar: collapse to horizontal bar like mobile */
  .wu-sidebar{max-height:200px;overflow-y:auto;border-right:none;border-bottom:1px solid var(--border);}
  .gym-sidebar{max-height:200px;overflow-y:auto;border-right:none;border-bottom:1px solid var(--border);}
  .teach-sidebar{flex-direction:row;flex-wrap:wrap;padding:10px 14px;border-right:none;border-bottom:1px solid var(--border);}
  .teach-nav-btn{flex:1;min-width:100px;}
  /* Choreo sidebar */
  .choreo-sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:220px;}
  /* Nav tabs â€” bigger touch targets on iPad */
  .nav-tab{padding:14px 18px;font-size:11px;}
  /* Cards â€” 2 col on iPad */
  .wu-cards{grid-template-columns:repeat(2,1fr) !important;}
  .gym-cards{grid-template-columns:repeat(2,1fr) !important;}
  .flex-cards{grid-template-columns:repeat(2,1fr) !important;}
  .saved-grid{grid-template-columns:repeat(2,1fr) !important;}
  /* Sub content padding */
  .sub-content{padding:18px 20px;}
  /* Video grid 3 col */
  .vl-grid{grid-template-columns:repeat(3,1fr) !important;}
  /* Games grid */
  .alpha-grid{grid-template-columns:repeat(5,1fr) !important;}
  .challenge-grid{grid-template-columns:repeat(4,1fr) !important;}
  /* Journal */
  .activity-grid{grid-template-columns:repeat(4,1fr) !important;}
  /* Studio calendar */
  .studio-calendar{grid-template-columns:repeat(4,1fr);}
}

/* â”€â”€ Safari-specific fixes â”€â”€ */

/* Safari ignores height:100vh when address bar shows â€” use dvh */
html, body{
  height: 100%;
  height: -webkit-fill-available;
}
.page{min-height:100%;min-height:-webkit-fill-available;}

/* Safari: onclick on non-button elements doesn't fire without cursor:pointer */
[onclick]{cursor:pointer;}
.nav-tab, .focus-chip, .chip, .bank-item, .saved-card, .srp,
.wu-card, .gym-card, .flex-card, .student-card-header,
.cp-block-header, .tracker-bubble, .vl-card,
.cp-saved-item, .tnote-card{cursor:pointer;}

/* Safari: position:fixed + transform bug â€” profile drawer */
.profile-drawer{
  -webkit-transform: translateX(100%);
  transform: translateX(100%);
  will-change: transform;
}
.profile-drawer.open{
  -webkit-transform: translateX(0);
  transform: translateX(0);
}

/* Safari: inputs zoom prevention (font-size must be â‰¥16px) */
input, select, textarea{
  font-size: 16px !important;
}

/* Safari: momentum scrolling on all scroll containers */
.wu-main, .gym-main, .flex-main, .teach-main,
.choreo-main, .choreo-sidebar, .choreo-canvas,
.wu-sidebar, .gym-sidebar, .flex-sidebar, .teach-sidebar,
.wu-body, .gym-body, .flex-body,
.page, .sub-content, .vl-grid,
.journal-left, .journal-right{
  -webkit-overflow-scrolling: touch;
  overflow-y: auto;
}

/* Safari: prevent tap callout and highlight on interactive elements */
button, .nav-tab, .focus-chip, .chip, .bank-item,
.saved-card, .wu-card, .gym-card, .tracker-bubble{
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

/* Safari: drag and drop needs touch-action none on draggable items */
[draggable="true"]{
  -webkit-user-drag: element;
  touch-action: none;
}

/* Safari: select dropdown arrow */
select{-webkit-appearance:none;}

/* Safari: range input */
input[type=range]{-webkit-appearance:none;}

/* Safari: flexbox gap support (older iPads on iOS 14 don't support gap) */
/* Fallback via margin on children when gap fails */
@supports not (gap: 1px){
  .nav-tabs > *{margin-right:2px;}
  .chip + .chip{margin-left:4px;}
  .focus-chip + .focus-chip{margin-top:5px;}
}

/* iPad landscape orientation â€” keep sidebar visible */
@media(min-width:769px) and (max-width:1024px) and (orientation:landscape){
  .wu-page{grid-template-columns:260px 1fr !important;display:grid !important;}
  .gym-page{grid-template-columns:260px 1fr !important;display:grid !important;}
  .wu-sidebar{max-height:none;border-bottom:none;border-right:1px solid var(--border);}
  .gym-sidebar{max-height:none;border-bottom:none;border-right:1px solid var(--border);}
  .choreo-layout{grid-template-columns:220px 1fr !important;display:grid !important;}
  .choreo-sidebar{max-height:none;border-bottom:none;border-right:1px solid var(--border);}
  /* Hide mobile bottom nav in landscape iPad */
  .mobile-bottom-nav{display:none;}
}

/* Fix bottom nav showing on iPad (it's only needed on phones) */
@media(min-width:769px){
  .mobile-bottom-nav{display:none !important;}
  /* Restore bottom padding removed for phone bottom nav */
  body > .page{padding-bottom:0 !important;}
}

/* â”€â”€ DATA BACKUP / RESTORE â”€â”€ */
.backup-section{margin-top:6px;}
.backup-btn-row{display:flex;gap:6px;margin-top:6px;}
.backup-btn{flex:1;padding:9px 10px;border:1px solid var(--border);background:transparent;
  color:var(--muted);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:0.1em;
  cursor:pointer;transition:all 0.15s;text-transform:uppercase;text-align:center;}
.backup-btn:hover{border-color:var(--accent);color:var(--accent);}
.backup-btn.export{border-color:var(--l1);color:var(--l1);}
.backup-btn.export:hover{background:rgba(110,201,160,0.08);}
.backup-btn.import{border-color:var(--accent);color:var(--accent);}
.backup-btn.import:hover{background:var(--ag);}
.backup-status{font-size:8px;color:var(--dim);letter-spacing:0.08em;margin-top:5px;
  line-height:1.6;min-height:14px;}

/* â”€â”€ CLOUD LOADING OVERLAY â”€â”€ */
#cloudLoadingOverlay{
  position:fixed;inset:0;padding-top:env(safe-area-inset-top,0px);background:var(--bg);z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:16px;transition:opacity 0.4s ease;
}
#cloudLoadingOverlay.fade-out{opacity:0;pointer-events:none;}
.cloud-loading-icon{font-size:32px;animation:spin 1.5s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.cloud-loading-text{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);
  letter-spacing:0.2em;text-transform:uppercase;}
.cloud-loading-sub{font-size:8px;color:var(--dim);letter-spacing:0.12em;margin-top:-8px;}

/* â”€â”€ FIREBASE DEBUG PANEL â”€â”€ */
#fbDebug{position:fixed;top:48px;right:0;background:var(--bg2);border:1px solid var(--accent);
  border-top:none;padding:12px 14px;z-index:8000;font-family:'DM Mono',monospace;font-size:9px;
  max-width:300px;line-height:1.8;display:none;box-shadow:0 4px 20px rgba(0,0,0,0.4);}
#fbDebug.visible{display:block;}
.fbd-row{display:flex;justify-content:space-between;gap:10px;border-bottom:1px solid var(--border);padding:3px 0;}
.fbd-row:last-child{border-bottom:none;}
.fbd-label{color:var(--dim);}
.fbd-val{color:var(--text);text-align:right;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.fbd-val.ok{color:#6ec9a0;}
.fbd-val.err{color:#e07070;}
.fbd-val.warn{color:#c9a96e;}


/* ============================================================
   MOBILE LAYOUT FIX â€” safe areas, auth bar, cramped content
   ============================================================ */



/* Shrink auth bar on mobile â€” it was too tall */
@media(max-width:768px){
  .fb-auth-bar{
    padding:4px 10px;
    font-size:8px;
    gap:6px;
    flex-wrap:nowrap;
    overflow:hidden;
  }
  .fb-auth-user{
    font-size:7px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
    flex:1;
  }
  .fb-auth-btn{
    font-size:7px;
    padding:3px 7px;
    flex-shrink:0;
  }
  /* Hide the â†• Sync button text on mobile â€” just show icon */
  #fbSyncStatusBtn{
    font-size:7px;
    padding:3px 6px;
    flex-shrink:0;
  }
  /* Shrink header on mobile */
  header{
    padding:10px 16px 10px;
    flex-wrap:nowrap;
    gap:6px;
    min-height:0;
  }
  .logo{font-size:22px;}
  /* Shrink nav tabs */
  .nav-tab{
    padding:10px 12px;
    font-size:9px;
    letter-spacing:0.08em;
  }
  /* Make pages fill available space properly */
  .page{
    height:calc(100vh - var(--header-h, 120px));
    overflow-y:auto;
  }
}

/* Extra small phones */
@media(max-width:390px){
  header{padding:8px 12px 8px;}
  .logo{font-size:20px;}
  .nav-tab{padding:8px 10px;font-size:8px;}
  .fb-auth-bar{padding:3px 8px;}
  .fb-auth-user{display:none;}/* hide email on tiny screens */
}

/* Fix bottom safe area for iPhone home indicator */
@media(max-width:768px){
  .mobile-bottom-nav{
    padding-bottom:env(safe-area-inset-bottom, 0px);
  }
  body{
    padding-bottom:calc(60px + env(safe-area-inset-bottom, 0px));
  }
}


/* ============================================================
   DYNAMIC ISLAND / NOTCH SAFE AREA
   viewport-fit=cover lets app render edge-to-edge behind the oval
   env(safe-area-inset-top) gives us the exact pixel height to clear it
   ============================================================ */

/* Header pushes down below the Dynamic Island */
header {
  padding-top: calc(env(safe-area-inset-top, 20px) + 48px);
}

/* Mobile â€” tighter but still clears the oval */
@media (max-width: 768px) {
  header {
    padding-top: calc(env(safe-area-inset-top, 20px) + 44px) !important;
    padding-left: 16px;
    padding-right: 16px;
    padding-bottom: 10px;
  }
}

/* Bottom safe area â€” home indicator bar */
.mobile-bottom-nav {
  padding-bottom: env(safe-area-inset-bottom, 0px);
}
body {
  padding-bottom: calc(60px + env(safe-area-inset-bottom, 0px));
}

/* Modals start below the oval */
.fb-modal-overlay,
.profile-drawer-overlay {
  padding-top: env(safe-area-inset-top, 0px);
}
.profile-drawer {
  padding-top: env(safe-area-inset-top, 0px);
}

/* Loading overlay */
#cloudLoadingOverlay {
  padding-top: env(safe-area-inset-top, 0px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WELLNESS REDESIGN â€” smooth, refined, modern dark app
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Typography overhaul â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body,input,button,select,textarea,
.stat-label,.section-label,.badge,.chip,.focus-chip,.bank-chip,
.ct-chip,.recur-chip,.portal-level-chip,.dare-chip,.roulette-cat-chip,
.spell-preset,.feeling-word,.vl-chip,.sec-preset-btn,.wbtn,
.action-btn,.browse-input,.filter-input,.nav-tab,.jnav-btn,.vl-cat-btn,
.wu-section-title,.sfl,.sj-lbl,.vc-field-lbl,.cat-badge,.rm-cat,
.wu-tag,.wg-day-name,.wg-class-time,.wg-class-loc,.tleg,
.tracker-dow-lbl,.pd-stat-l,.jsc-stat-l,.game-desc,.game-tag,
.dare-sub,.alpha-move,.ch-day-move,.roulette-result-meta,
.spell-move-meta,.leg-i,.stub,.export-text,.integ-note,
.sec-name-in,.recur-badge,.cc-meta,.cc-dow,.cc-month,
.empty-text,.portal-tagline,.portal-section-lbl,.portal-skip,
.profile-name-hdr,.pd-section-lbl,.pd-level-display,
.wu-stat-l,.cstat-label,.saved-card-moves,.vl-cat-tag,
.vl-desc,.wu-reps,.wu-duration,.wu-card-note,.alpha-prog-text,
.ch-prog-lbl,.day-type,.day-desc,.dz-empty,.add-sec-btn,
.add-vid-btn,.wg-add-btn,.choreo-sb-hdr h3,.wu-empty-txt {
  font-family:'Outfit',sans-serif !important;
}

/* Boost heading weights */
.gen-btn span,.wu-generate-btn span,.sched-add-btn span,
.portal-enter-btn span,.dare-draw-btn span,.roulette-spin-btn span {
  font-family:'Outfit',sans-serif !important;
  font-weight:600 !important;
  letter-spacing:0.1em !important;
}

/* â”€â”€ Smooth transitions everywhere â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after {
  transition-timing-function:var(--ease) !important;
}

/* â”€â”€ Sticky header with glass â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  position:sticky;top:0;z-index:200;
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  background:rgba(9,8,26,0.92) !important;
  border-bottom:1px solid var(--border) !important;
}

/* â”€â”€ Navigation bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav-tabs {
  background:rgba(9,8,26,0.98) !important;
  border-bottom:1px solid var(--border) !important;
  padding:0 24px !important;
  gap:2px;
}
.nav-tab {
  font-family:'Outfit',sans-serif !important;
  font-size:11px !important;
  font-weight:500 !important;
  letter-spacing:0.05em !important;
  padding:14px 18px !important;
  border-radius:0 !important;
  transition:color 0.18s,border-color 0.18s !important;
}
.nav-tab.active {
  color:var(--accent) !important;
  border-bottom-color:var(--accent) !important;
}
.nav-tab:hover {
  color:var(--accent2) !important;
}

/* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar {
  background:var(--bg2) !important;
}
.stat-num {
  font-family:'Outfit',sans-serif !important;
  font-weight:700 !important;
  font-size:21px !important;
}

/* â”€â”€ Chips â†’ pill shaped â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chip,.focus-chip,.bank-chip,.ct-chip,.recur-chip,
.portal-level-chip,.dare-chip,.roulette-cat-chip,
.spell-preset,.feeling-word,.vl-chip {
  border-radius:var(--r-full) !important;
  padding:6px 16px !important;
  font-size:11px !important;
  font-weight:500 !important;
  letter-spacing:0.03em !important;
  transition:all 0.18s var(--ease) !important;
}
.sec-preset-btn {
  border-radius:var(--r-full) !important;
  font-size:9px !important;
  letter-spacing:0.04em !important;
  font-weight:500 !important;
  transition:all 0.15s var(--ease) !important;
}

/* â”€â”€ Primary buttons â†’ rounded â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gen-btn,.wu-generate-btn,.sched-add-btn,.portal-enter-btn,
.dare-draw-btn,.roulette-spin-btn {
  border-radius:var(--r-md) !important;
  font-size:15px !important;
  font-weight:600 !important;
  letter-spacing:0.07em !important;
  transition:all 0.22s var(--spring) !important;
}
.gen-btn:hover,.wu-generate-btn:hover,.sched-add-btn:hover {
  transform:translateY(-1px) !important;
  box-shadow:0 6px 24px rgba(201,169,110,0.22) !important;
}
.gen-btn:active,.wu-generate-btn:active,.sched-add-btn:active,
.portal-enter-btn:active {
  transform:scale(0.97) translateY(0) !important;
}

/* Wu start all â€” pill */
.wu-start-all-btn {
  border-radius:var(--r-full) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:14px !important;
  font-weight:600 !important;
  padding:11px 30px !important;
  letter-spacing:0.06em !important;
  transition:all 0.22s var(--spring) !important;
}
.wu-start-all-btn:hover {
  transform:translateY(-1px) !important;
  box-shadow:0 6px 20px rgba(201,169,110,0.3) !important;
}

/* Action buttons */
.action-btn,.sj-new-btn,.tdp-save-btn,.sj-save-entry-btn,
.wbtn,.integ-btn,.clear-link,.vl-src-btn,.sj-cancel-btn,
.pd-edit-btn,.pd-signout-btn,.copy-ical-btn,
.alpha-done-btn,.ch-regen-btn {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:10px !important;
  letter-spacing:0.04em !important;
  font-weight:500 !important;
  transition:all 0.15s var(--ease) !important;
}

/* â”€â”€ Cards with smooth elevation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.saved-card,.game-card {
  border-radius:var(--r-lg) !important;
  transition:transform 0.22s var(--ease),box-shadow 0.22s var(--ease),border-color 0.15s !important;
}
.saved-card:hover {
  transform:translateY(-3px) !important;
  box-shadow:var(--shadow-md) !important;
}
.game-card {
  overflow:hidden !important;
}
.game-card:hover {
  transform:translateY(-3px) !important;
  box-shadow:var(--shadow-md) !important;
}

.wu-card {
  border-radius:var(--r-md) !important;
  transition:transform 0.2s var(--ease),box-shadow 0.2s var(--ease),border-color 0.15s !important;
}
.wu-card:hover {
  transform:translateY(-2px) !important;
  box-shadow:var(--shadow-sm) !important;
}
.wu-card:active {
  transform:scale(0.98) !important;
}

.vid-card {
  border-radius:var(--r-md) !important;
  overflow:hidden !important;
  transition:transform 0.2s var(--ease),box-shadow 0.2s var(--ease),border-color 0.15s !important;
}
.vid-card:hover {
  transform:translateY(-2px) !important;
  box-shadow:var(--shadow-sm) !important;
}

.vl-card {
  border-radius:var(--r-lg) !important;
  overflow:hidden !important;
  transition:transform 0.2s var(--ease),box-shadow 0.2s var(--ease),border-color 0.15s !important;
}
.vl-card:hover {
  transform:translateY(-3px) !important;
  box-shadow:var(--shadow-md) !important;
}

.class-card {
  border-radius:var(--r-md) !important;
  transition:transform 0.18s var(--ease),box-shadow 0.18s var(--ease) !important;
}
.class-card:hover {
  transform:translateY(-2px) !important;
  box-shadow:var(--shadow-sm) !important;
}

.sj-entry-card {
  border-radius:var(--r-lg) !important;
  overflow:hidden !important;
  transition:border-color 0.15s,box-shadow 0.2s var(--ease) !important;
}
.sj-entry-card:hover {
  box-shadow:var(--shadow-sm) !important;
}

/* Move row items */
.move-item,.routine-move,.bank-item {
  border-radius:var(--r-sm) !important;
  transition:all 0.15s var(--ease) !important;
}
.move-item:hover {
  transform:translateX(2px) !important;
}

/* Section containers */
.sched-form,.active-game,.journal-streak-card,
.alpha-progress,.ch-progress,.wu-total-bar,
.export-panel,.integ-section,.tracker-day-panel {
  border-radius:var(--r-md) !important;
}
.alpha-detail,.spell-letter-row,.roulette-result {
  border-radius:var(--r-md) !important;
}
.sj-form,.feeling-block {
  border-radius:var(--r-md) !important;
}
.rest-card {
  border-radius:var(--r-md) !important;
}

/* Profile elements */
.pd-stat-card,.jsc-stat {
  border-radius:var(--r-md) !important;
  transition:all 0.15s var(--ease) !important;
}
.pd-stat-card:hover {
  transform:scale(1.02) !important;
  box-shadow:var(--shadow-sm) !important;
}
.portal-box {
  border-radius:var(--r-xl) !important;
  box-shadow:var(--shadow-lg) !important;
  backdrop-filter:blur(24px) !important;
  -webkit-backdrop-filter:blur(24px) !important;
}
.profile-drawer {
  border-radius:var(--r-xl) 0 0 var(--r-xl) !important;
  background:rgba(16,15,34,0.96) !important;
  backdrop-filter:blur(20px) !important;
  -webkit-backdrop-filter:blur(20px) !important;
}
.profile-btn {
  border-radius:var(--r-full) !important;
  transition:all 0.18s var(--ease) !important;
}
.profile-btn:hover {
  border-color:var(--accent) !important;
  background:var(--ag) !important;
}

/* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.browse-input,.filter-input,.vl-search,.sfi,.sj-in,.sj-notes,
.pd-goal-in,.tdp-note-in,.vc-field-val,.vc-field-sel,
.integ-url-in,.spell-in,.vc-notes,.vc-add-in,.add-inspo-in,
.vid-date-in,.vc-date-in,.vid-notes-area,.rm-note,
.portal-input,.vl-my-in {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:11px !important;
  transition:border-color 0.18s,box-shadow 0.18s !important;
}
.browse-input:focus,.filter-input:focus,.vl-search:focus,.sfi:focus,
.sj-in:focus,.sj-notes:focus,.pd-goal-in:focus,.tdp-note-in:focus,
.vc-field-val:focus,.portal-input:focus,.integ-url-in:focus,.spell-in:focus {
  box-shadow:0 0 0 3px rgba(201,169,110,0.13) !important;
}

/* â”€â”€ Page transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page.active {
  animation:wPageIn 0.32s var(--ease) !important;
}
@keyframes wPageIn {
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

/* â”€â”€ Toast â†’ rounded â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  border-radius:var(--r-md) !important;
  padding:12px 22px !important;
  font-family:'Outfit',sans-serif !important;
  font-size:12px !important;
  backdrop-filter:blur(12px) !important;
  box-shadow:var(--shadow-md) !important;
  letter-spacing:0.04em !important;
}

/* â”€â”€ Timer circle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timer-circle {
  box-shadow:0 0 50px rgba(201,169,110,0.18) !important;
  border:2px solid rgba(201,169,110,0.2) !important;
}
.timer-digits {
  font-family:'Outfit',sans-serif !important;
  font-weight:300 !important;
}

/* â”€â”€ Progress bars â†’ pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alpha-prog-bar,.ch-prog-bar {
  border-radius:var(--r-full) !important;
  overflow:hidden !important;
}
.alpha-prog-fill,.ch-prog-fill {
  border-radius:var(--r-full) !important;
}

/* â”€â”€ Calendar & tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tracker-bubble {
  transition:transform 0.2s var(--spring),box-shadow 0.2s var(--ease) !important;
}
.tracker-bubble:hover {
  transform:scale(1.12) !important;
  box-shadow:var(--shadow-sm) !important;
}
.wg-class-pill {
  border-radius:var(--r-sm) !important;
  transition:all 0.15s var(--ease) !important;
}
.wg-class-pill:hover {
  transform:translateY(-1px) !important;
  box-shadow:var(--shadow-sm) !important;
}
.wg-day-hdr {
  background:var(--bg3) !important;
}
.wg-day-num.today {
  color:var(--accent) !important;
}

/* â”€â”€ Sidebar nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vl-cat-btn,.jnav-btn {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:10px !important;
  letter-spacing:0.04em !important;
  transition:all 0.15s var(--ease) !important;
}
.vl-cat-btn:hover,.jnav-btn:hover {
  transform:translateX(2px) !important;
}
.vl-cat-btn.active {
  transform:translateX(2px) !important;
}

/* â”€â”€ Add buttons (dashed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-sec-btn,.add-vid-btn,.wg-add-btn,.dz-empty {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:9px !important;
  letter-spacing:0.06em !important;
  transition:all 0.15s var(--ease) !important;
}
.add-sec-btn:hover,.add-vid-btn:hover,.wg-add-btn:hover {
  transform:scale(1.01) !important;
}

/* â”€â”€ Games â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alpha-cell {
  border-radius:var(--r-sm) !important;
  transition:all 0.2s var(--spring) !important;
}
.alpha-cell:hover {
  transform:scale(1.05) !important;
  box-shadow:var(--shadow-sm) !important;
}
.ch-day {
  border-radius:var(--r-md) !important;
  transition:all 0.18s var(--spring) !important;
}
.ch-day:hover {
  transform:scale(1.04) !important;
  box-shadow:var(--shadow-sm) !important;
}

/* â”€â”€ Roulette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.roulette-wheel {
  box-shadow:0 0 70px rgba(201,169,110,0.12),var(--shadow-lg) !important;
}
.roulette-result,.dare-card {
  border-radius:var(--r-lg) !important;
}

/* â”€â”€ Feeling log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feeling-emoji-btn {
  transition:all 0.2s var(--spring) !important;
}
.feeling-emoji-btn:hover {
  transform:scale(1.2) !important;
}
.feeling-emoji-btn.sel {
  transform:scale(1.25) !important;
}
.tdp-act {
  border-radius:var(--r-sm) !important;
  transition:all 0.18s var(--ease) !important;
}
.tdp-act:hover {
  transform:translateY(-1px) !important;
}

/* â”€â”€ Badges â†’ subtly rounded â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge,.lvl-1,.lvl-2,.lvl-3,.lvl-4,.lvl-5,.lvl-Floor,
.vl-level-badge,.vc-level-badge,.cc-type-badge,.recur-badge,
.game-tag {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  letter-spacing:0.06em !important;
}

/* â”€â”€ Empty states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-text,.wu-empty-txt {
  letter-spacing:0.15em !important;
}

/* â”€â”€ Section labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-label {
  font-family:'Outfit',sans-serif !important;
  font-size:9px !important;
  letter-spacing:0.2em !important;
  font-weight:600 !important;
}

/* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--dim);border-radius:var(--r-full);}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}

/* â”€â”€ Routine section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.routine-section {
  border-radius:var(--r-md) !important;
  overflow:hidden !important;
}
.drop-zone {
  border-radius:0 0 var(--r-md) var(--r-md) !important;
}

/* â”€â”€ Video index cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vc-header {
  background:var(--bg2) !important;
}

/* â”€â”€ Saved routines row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.srp {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:10px !important;
  transition:all 0.15s var(--ease) !important;
}
.srp:hover {
  transform:translateY(-1px) !important;
}

/* â”€â”€ Nav customize mode toggle button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav-tab:hover .nav-tab-grip {
  opacity:1 !important;
}

/* â”€â”€ Day column headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-hdr {
  transition:background 0.2s !important;
}

/* â”€â”€ Combo move names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.move-name,.rm-name,.bi-name {
  font-family:'Cormorant Garamond',serif !important;
}

/* â”€â”€ Photo upload area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sj-photo-area {
  border-radius:var(--r-md) !important;
  transition:all 0.18s var(--ease) !important;
}

/* â”€â”€ Play overlay button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vl-play-btn {
  transition:transform 0.2s var(--spring) !important;
}
.vl-thumb:hover .vl-play-btn {
  transform:scale(1.1) !important;
}

/* â”€â”€ Week navigation buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wbtn {
  border-radius:var(--r-sm) !important;
}
.tracker-nav-btn {
  border-radius:var(--r-sm) !important;
  font-family:'Outfit',sans-serif !important;
  font-size:10px !important;
  transition:all 0.15s !important;
}

/* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cloudLoadingOverlay {
  backdrop-filter:blur(20px) !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore-compat.js"></script>
</head>
<body style="height:100%;overscroll-behavior:none;">

<!-- FIREBASE AUTH BAR -->
<div id="cloudLoadingOverlay">
  <div class="cloud-loading-icon">â—Ž</div>
  <div class="cloud-loading-text">PoleCraft</div>
  <div class="cloud-loading-sub" id="cloudLoadingMsg">Connecting...</div>
</div>
<!-- auth bar removed â€” sync in profile drawer -->


<!-- PORTAL OVERLAY -->
<div class="portal-overlay" id="portalOverlay">
  <div class="portal-box">
    <div class="portal-logo">Pole<span>Craft</span></div>
    <div class="portal-tagline">Choreography Â· Content Â· Creation</div>

    <div class="portal-section-lbl">Your Name</div>
    <input class="portal-input" id="portalName" placeholder="How should we call you?">

    <div class="portal-section-lbl" style="margin-top:14px;">Choose Your Avatar</div>
    <div class="portal-avatar-row">
      <div class="portal-avatar-preview" id="portalAvatarPreview" onclick="document.getElementById('portalAvatarUpload').click()">ðŸŽ­</div>
      <div style="font-size:9px;color:var(--dim);line-height:1.6;">Tap the circle to upload a photo,<br>or pick an emoji below.</div>
      <input type="file" id="portalAvatarUpload" accept="image/*" style="display:none" onchange="portalHandleAvatar(this)">
    </div>
    <div class="portal-avatar-emoji-grid" id="portalEmojiGrid"></div>

    <div class="portal-section-lbl" style="margin-top:18px;">PSO Level</div>
    <div class="portal-level-chips" id="portalLevelChips">
      <button class="portal-level-chip active" data-l="1" onclick="portalSetLevel('1',this)">L1</button>
      <button class="portal-level-chip" data-l="2" onclick="portalSetLevel('2',this)">L2</button>
      <button class="portal-level-chip" data-l="3" onclick="portalSetLevel('3',this)">L3</button>
      <button class="portal-level-chip" data-l="4" onclick="portalSetLevel('4',this)">L4</button>
      <button class="portal-level-chip" data-l="5" onclick="portalSetLevel('5',this)">L5</button>
      <button class="portal-level-chip" data-l="Training" onclick="portalSetLevel('Training',this)">Training</button>
    </div>

    <div class="portal-section-lbl" style="margin-top:18px;">Current Goals (optional)</div>
    <input class="portal-input" id="portalGoal1" placeholder="Goal 1 â€” e.g. Land my jade split">
    <input class="portal-input" style="margin-top:6px;" id="portalGoal2" placeholder="Goal 2 â€” e.g. Compete at PSO in Q3">
    <input class="portal-input" style="margin-top:6px;" id="portalGoal3" placeholder="Goal 3 â€” e.g. Build shoulder mount strength">

    <button class="portal-enter-btn" onclick="portalEnter()"><span>Enter PoleCraft â†’</span></button>
    <div class="portal-skip" onclick="portalSkip()">Skip for now</div>
  </div>
</div>

<!-- PROFILE DRAWER OVERLAY -->
<div class="profile-drawer-overlay" id="profileOverlay" onclick="closeProfile()"></div>

<!-- PROFILE DRAWER -->
<div class="profile-drawer" id="profileDrawer">
  <button class="pd-close" onclick="closeProfile()">âœ•</button>
  <div class="pd-header">
    <div class="pd-title">My Profile</div>
  </div>
  <div class="pd-body" id="pdBody"></div>
</div>

<!-- ===== LANDING PAGE ===== -->
<div class="landing" id="landingPage">
  <div class="landing-hero">
    <div class="landing-logo">Pole<span>Craft</span></div>
    <div class="landing-tagline">Choreography Â· Content Â· Creation</div>
    <div class="landing-sub">Your complete pole dance training studio â€” plan routines, track progress, and grow your craft.</div>
    <button class="landing-enter" onclick="enterApp()"><span>Enter</span></button>
  </div>
  <div style="width:60px;height:1px;background:var(--border);margin:0 auto 32px;"></div>
  <div class="landing-grid">
    <div class="landing-card" onclick="enterApp('generator')">
      <div class="lc-icon">âœ¦</div>
      <div class="lc-title">Combo Generator</div>
      <div class="lc-desc">Generate move combinations filtered by level and category</div>
    </div>
    <div class="landing-card" onclick="enterApp('choreo')">
      <div class="lc-icon">â—ˆ</div>
      <div class="lc-title">Routine Builder</div>
      <div class="lc-desc">Drag and drop sections and moves into full routines</div>
    </div>
    <div class="landing-card" onclick="enterApp('studio')">
      <div class="lc-icon">â–¶</div>
      <div class="lc-title">Content Studio</div>
      <div class="lc-desc">Plan your content calendar and film schedule</div>
    </div>
    <div class="landing-card" onclick="enterApp('warmup')">
      <div class="lc-icon">â—Ž</div>
      <div class="lc-title">Warm-Up</div>
      <div class="lc-desc">Auto-generate warm-up routines for any session</div>
    </div>
    <div class="landing-card" onclick="enterApp('journal')">
      <div class="lc-icon">â—Ž</div>
      <div class="lc-title">Journal</div>
      <div class="lc-desc">Track training days, goals, and progress over time</div>
    </div>
    <div class="landing-card" onclick="enterApp('schedule')">
      <div class="lc-icon">ðŸ“…</div>
      <div class="lc-title">Class Schedule</div>
      <div class="lc-desc">Schedule classes and export to Google Calendar</div>
    </div>
    <div class="landing-card" onclick="enterApp('flex')">
      <div class="lc-icon">â‹</div>
      <div class="lc-title">Flexibility</div>
      <div class="lc-desc">Log stretches and track flexibility progress</div>
    </div>
    <div class="landing-card" onclick="enterApp('pso')">
      <div class="lc-icon">â¬¡</div>
      <div class="lc-title">PSO Training</div>
      <div class="lc-desc">Level cards, competition checklist and scoring</div>
    </div>
    <div class="landing-card" onclick="enterApp('teach')">
      <div class="lc-icon">â—­</div>
      <div class="lc-title">Teach</div>
      <div class="lc-desc">Class planner, student roster and teaching notes</div>
    </div>
    <div class="landing-card" onclick="enterApp('vidlib')">
      <div class="lc-icon">â—‰</div>
      <div class="lc-title">Video Library</div>
      <div class="lc-desc">Browse and organise all your planned video content</div>
    </div>
  </div>
</div>

<header>
  <div>
    <div class="logo">Pole<span>Craft</span></div>
    <div style="font-size:9px;color:var(--dim);letter-spacing:0.16em;margin-top:3px;">CHOREOGRAPHY Â· CONTENT Â· CREATION</div>
  </div>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="tagline">Choreography, Content, Creation</div>
    <button class="profile-btn" id="profileBtn" onclick="openProfile()" style="display:none;">
      <div style="position:relative;display:inline-block;">
        <div class="profile-avatar" id="headerAvatar">ðŸŽ­</div>
        <div class="fb-sync-dot" id="fbSyncDot" style="position:absolute;bottom:0;right:0;width:8px;height:8px;border:2px solid var(--bg2);border-radius:50%;"></div>
      </div>
      <div>
        <div class="profile-name-hdr" id="headerName">â€”</div>
        <div class="profile-level-hdr" id="headerLevel">Set up profile</div>
      </div>
    </button>
  </div>
</header>

<div class="stats-bar">
  <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">Total<br>Moves</div></div>
  <div class="stat"><div class="stat-num" id="statSaved">0</div><div class="stat-label">Saved<br>Combos</div></div>
  <div class="stat"><div class="stat-num" id="statFiltered">0</div><div class="stat-label">Available<br>w/ Filters</div></div>
  <div class="stat"><div class="stat-num" id="statVideos">0</div><div class="stat-label">Videos<br>Planned</div></div>
</div>

<div class="nav-tabs" id="navTabs"></div>

<!-- ===== GENERATOR ===== -->
<div class="page active" id="page-generator">
  <div class="gen-layout">
    <div class="sidebar">
      <div><div class="section-label">PSO Level</div><div class="chips" id="levelChips">
        <button class="chip active" data-level="1">L1 Â· Beginner</button>
        <button class="chip active" data-level="2">L2 Â· Floor Inv.</button>
        <button class="chip active" data-level="3">L3 Â· Aerial Inv.</button>
        <button class="chip active" data-level="4">L4 Â· Advanced</button>
        <button class="chip active" data-level="5">L5 Â· Elite</button>
        <button class="chip active" data-level="Floorwork">Floorwork</button>
      </div></div>
      <div><div class="section-label">Category</div><div class="chips" id="catChips">
        <button class="chip active" data-cat="Spin">Spin</button>
        <button class="chip active" data-cat="Pose">Pose</button>
        <button class="chip active" data-cat="Invert">Invert</button>
        <button class="chip active" data-cat="Mount">Mount</button>
        <button class="chip active" data-cat="Trick">Trick</button>
        <button class="chip active" data-cat="Transition">Transition</button>
        <button class="chip active" data-cat="Drop">Drop</button>
        <button class="chip active" data-cat="Floor">Floor</button>
        <button class="chip active" data-cat="Hold">Hold</button>
        <button class="chip active" data-cat="Climb">Climb</button>
      </div></div>
      <div>
        <div class="section-label">Combo Length</div>
        <div class="range-row"><div style="color:var(--muted);font-size:9px;">Moves</div><div class="range-val" id="rangeVal">4</div></div>
        <input type="range" id="comboLength" min="2" max="8" value="4">
        <div style="display:flex;justify-content:space-between;color:var(--dim);font-size:8px;margin-top:4px;"><span>2</span><span>8</span></div>
      </div>
      <div><div class="section-label">Pre-built Combos</div>
        <div class="chips"><button class="chip" id="prebuiltBtn" onclick="togglePrebuilt(this)">Off</button></div>
      </div>
      <button class="gen-btn" onclick="generateCombo()"><span>âœ¦ Generate Combo</span></button>
      <button class="clear-link" onclick="clearFilters()">Reset all filters</button>
    </div>
    <div class="content-area">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchSub('output',this)">Generated Combo</button>
        <button class="sub-tab" onclick="switchSub('saved',this)">Saved <span id="savedBadge" style="color:var(--accent)"></span></button>
        <button class="sub-tab" onclick="switchSub('browse',this)">Browse All Moves</button>
        <button class="sub-tab" onclick="switchSub('games',this)">ðŸŽ® Games</button>
      </div>
      <div class="sub-content active" id="sub-output">
        <div id="comboOutput"><div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">Set your filters &amp; hit Generate</div></div></div>
      </div>
      <div class="sub-content" id="sub-saved">
        <div id="savedGrid" class="saved-grid"></div>
        <div id="savedEmpty" class="empty-state"><div class="empty-icon">â™¡</div><div class="empty-text">No saved combos yet</div></div>
      </div>
      <div class="sub-content" id="sub-browse">
        <div class="browse-controls">
          <input class="browse-input" id="browseSearch" placeholder="Search moves..." oninput="filterBrowse()">
          <select id="browseLevel" onchange="filterBrowse()">
            <option value="">All Levels</option><option value="1">L1</option><option value="2">L2</option>
            <option value="3">L3</option><option value="4">L4</option><option value="5">L5</option>
            <option value="Floorwork">Floorwork</option>
          </select>
          <select id="browseCat" onchange="filterBrowse()">
            <option value="">All Categories</option>
            <option>Spin</option><option>Pose</option><option>Invert</option><option>Mount</option>
            <option>Trick</option><option>Transition</option><option>Drop</option><option>Floor</option>
            <option>Hold</option><option>Climb</option>
          </select>
        </div>
        <table class="moves-table"><thead><tr><th>Move</th><th>PSO Level</th><th>Category</th></tr></thead>
          <tbody id="browseBody"></tbody></table>
      </div>

      <!-- GAMES PANEL -->
      <div class="sub-content" id="sub-games">
        <div class="games-page" id="gamesPage"></div>
      </div>

    </div>
  </div>
</div>

<!-- ===== ROUTINE BUILDER ===== -->
<div class="page" id="page-choreo">
  <div class="choreo-layout">
    <div class="choreo-sb">
      <div class="choreo-sb-hdr">
        <h3>Move Library</h3>
        <input class="filter-input" id="bankSearch" placeholder="Search moves..." oninput="renderBank()">
        <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px;" id="bankChips">
          <button class="bank-chip active" data-bl="all">All</button>
          <button class="bank-chip" data-bl="1">L1</button><button class="bank-chip" data-bl="2">L2</button>
          <button class="bank-chip" data-bl="3">L3</button><button class="bank-chip" data-bl="4">L4</button>
          <button class="bank-chip" data-bl="5">L5</button><button class="bank-chip" data-bl="Floorwork">Floor</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:3px;" id="bankCatChips">
          <button class="bank-chip active" data-bc="all">All</button>
          <button class="bank-chip" data-bc="Spin">Spin</button><button class="bank-chip" data-bc="Pose">Pose</button>
          <button class="bank-chip" data-bc="Invert">Inv</button><button class="bank-chip" data-bc="Mount">Mount</button>
          <button class="bank-chip" data-bc="Trick">Trick</button><button class="bank-chip" data-bc="Transition">Trans</button>
          <button class="bank-chip" data-bc="Drop">Drop</button><button class="bank-chip" data-bc="Floor">Floor</button>
        </div>
      </div>
      <div class="move-bank" id="moveBank"></div>
    </div>
    <div class="choreo-main">
      <div class="choreo-tb">
        <input class="routine-title-in" id="routineTitle" placeholder="Untitled Routine"><input class="routine-tagline-in" id="routineTagline" placeholder="Tagline â€” e.g. dark + dramatic, lyrical flow...">
        <select id="routineLevel"><option value="">PSO Level</option>
          <option value="1">L1</option><option value="2">L2</option><option value="3">L3</option>
          <option value="4">L4</option><option value="5">L5</option></select>
        <select id="routineCategory"><option value="">Category</option>
          <option>Championship</option><option>Artistic Dramatic</option><option>Artistic Entertainment</option>
          <option>Sensual</option><option>Down to Flow</option><option>Hard Style</option>
          <option>Showstopper</option><option>Showcase</option></select>
        <div style="display:flex;gap:12px;padding:0 4px;">
          <div class="cstat"><div class="cstat-num" id="cstatMoves">0</div><div class="cstat-label">Moves</div></div>
          <div class="cstat"><div class="cstat-num" id="cstatSecs">0</div><div class="cstat-label">Sections</div></div>
        </div>
        <div style="display:flex;gap:7px;flex-wrap:wrap;">
          <button class="action-btn" onclick="saveRoutine()">â™¡ Save</button>
          <button class="action-btn" onclick="exportRoutine()">â†— Export</button>
          <button class="action-btn" onclick="clearRoutine()" style="color:var(--red);border-color:rgba(224,112,112,0.25);">âœ• Clear</button>
        </div>
      </div>
      <div class="sec-presets-bar">
        <span class="sec-presets-label">Add section:</span>
        <div class="sec-presets-group">
          <span class="sec-presets-group-lbl">Training</span>
          <button class="sec-preset-btn sp-i" onclick="addSection('Warm Up','sc-i')">Warm Up</button>
          <button class="sec-preset-btn sp-v" onclick="addSection('Floorwork','sc-v')">Floorwork</button>
          <button class="sec-preset-btn sp-c" onclick="addSection('Pole Work','sc-c')">Pole Work</button>
          <button class="sec-preset-btn sp-b" onclick="addSection('PSO Section','sc-b')">PSO Section</button>
          <button class="sec-preset-btn sp-o" onclick="addSection('Cool Down','sc-o')">Cool Down</button>
        </div>
        <div class="sec-presets-divider"></div>
        <div class="sec-presets-group">
          <span class="sec-presets-group-lbl">Music</span>
          <button class="sec-preset-btn sp-i" onclick="addSection('Intro','sc-i')">Intro</button>
          <button class="sec-preset-btn sp-v" onclick="addSection('Verse','sc-v')">Verse</button>
          <button class="sec-preset-btn sp-c" onclick="addSection('Chorus','sc-c')">Chorus</button>
          <button class="sec-preset-btn sp-b" onclick="addSection('Bridge','sc-b')">Bridge</button>
          <button class="sec-preset-btn sp-o" onclick="addSection('Outro','sc-o')">Outro</button>
          <button class="sec-preset-btn sp-i" onclick="addSection('Pre-Chorus','sc-i')">Pre-Chorus</button>
          <button class="sec-preset-btn sp-v" onclick="addSection('Drop','sc-v')">Drop</button>
          <button class="sec-preset-btn sp-c" onclick="addSection('Hook','sc-c')">Hook</button>
        </div>
        <div class="sec-presets-divider"></div>
        <button class="sec-preset-btn" onclick="addSection('Custom',SC_CLS[routine.sections.length%SC_CLS.length])" style="color:var(--dim);border-color:var(--dim);">+ Custom</button>
      </div>
      <div class="choreo-canvas" id="choreoCanvas"></div>
      <div class="routine-lib">
        <h4>Saved Routines</h4>
        <div class="saved-routines-row" id="savedRoutinesRow">
          <span style="font-size:9px;color:var(--dim);">No saved routines yet</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CONTENT STUDIO ===== -->
<div class="page" id="page-studio">
  <div class="studio-page">
    <div class="studio-tb">
      <h3>Content Studio</h3>

      <!-- View tabs -->
      <div class="studio-view-tabs" id="studioViewTabs">
        <button class="svt active" data-view="calendar" onclick="switchStudioView('calendar',this)">â—« Calendar</button>
        <button class="svt" data-view="film" onclick="switchStudioView('film',this)">ðŸŽ¬ Film Schedule</button>
        <button class="svt" data-view="filter" onclick="switchStudioView('filter',this)">âŠž Browse & Repeats</button>
      </div>

      <!-- Calendar nav (shown in calendar view only) -->
      <div class="studio-cal-nav" id="studioCalNav">
        <div class="week-nav">
          <button class="wbtn" onclick="changeWeek(-1)">â€¹</button>
          <div class="week-lbl" id="weekLbl"></div>
          <button class="wbtn" onclick="changeWeek(1)">â€º</button>
          <button class="wbtn" onclick="goToday()" style="font-size:8px;letter-spacing:0.08em;">Today</button>
        </div>
        <div class="studio-legend">
          <div class="leg-i"><div class="leg-dot" style="background:var(--dim)"></div>Idea</div>
          <div class="leg-i"><div class="leg-dot" style="background:var(--accent)"></div>Filming</div>
          <div class="leg-i"><div class="leg-dot" style="background:#6eafc9"></div>Editing</div>
          <div class="leg-i"><div class="leg-dot" style="background:#c96ea8"></div>Scheduled</div>
          <div class="leg-i"><div class="leg-dot" style="background:var(--l1)"></div>Posted</div>
        </div>
        <button class="action-btn" onclick="addVidCard(weekKey(studioWeekOffset)+'_sun')" style="font-size:9px;">+ Add to Sunday</button>
      </div>

      <!-- Filter bar (shown in filter view) -->
      <div class="studio-filter-bar" id="studioFilterBar" style="display:none;">
        <input class="studio-filter-in" id="sfSearch" placeholder="Search title, move, audio..." oninput="renderStudioFilter()">
        <select class="studio-filter-sel" id="sfStatus" onchange="renderStudioFilter()">
          <option value="">All statuses</option>
          <option value="idea">ðŸ’¡ Idea</option>
          <option value="filming">ðŸŽ¬ Filming</option>
          <option value="editing">âœ‚ï¸ Editing</option>
          <option value="scheduled">ðŸ“… Scheduled</option>
          <option value="posted">âœ… Posted</option>
        </select>
        <select class="studio-filter-sel" id="sfCat" onchange="renderStudioFilter()">
          <option value="">All categories</option>
          <option>Spin</option><option>Invert</option><option>Mount</option><option>Climb</option>
          <option>Pose</option><option>Drop</option><option>Transition</option><option>Floorwork</option>
          <option>Combo</option><option>Warm-Up</option><option>Other</option>
        </select>
        <select class="studio-filter-sel" id="sfLevel" onchange="renderStudioFilter()">
          <option value="">All levels</option>
          <option>L1 â€” Beginner</option><option>L2 â€” Beginner+</option><option>L3 â€” Intermediate</option>
          <option>L4 â€” Advanced</option><option>L5 â€” Elite</option>
        </select>
        <button class="studio-filter-sel" style="border-color:var(--l5);color:var(--l5);cursor:pointer;" onclick="renderStudioRepeats()">âš  Find Repeats</button>
      </div>
    </div>

    <!-- CALENDAR VIEW -->
    <div id="studioViewCalendar">
      <div class="studio-week" id="studioWeek"></div>
    </div>

    <!-- FILM SCHEDULE VIEW -->
    <div id="studioViewFilm" style="display:none;">
      <div class="studio-film-schedule" id="studioFilmSchedule"></div>
    </div>

    <!-- FILTER / BROWSE VIEW -->
    <div id="studioViewFilter" style="display:none;">
      <div class="studio-filter-results" id="studioFilterResults"></div>
    </div>
  </div>
</div>

<!-- ===== WARM-UP RANDOMIZER ===== -->
<div class="page" id="page-warmup">
  <div class="wu-page">
    <div class="wu-sidebar">
      <h3>â—Ž Warm-Up Builder</h3>

      <div>
        <div class="section-label">Session Type</div>
        <div style="display:flex;flex-direction:column;gap:5px;" id="wuSessionChips">
          <button class="focus-chip active" data-s="full">Full Body Warm-Up</button>
          <button class="focus-chip" data-s="pre-climb">Pre-Climb Focus</button>
          <button class="focus-chip" data-s="pre-invert">Pre-Invert Focus</button>
          <button class="focus-chip" data-s="pre-spin">Pre-Spin Focus</button>
          <button class="focus-chip" data-s="pre-flex">Pre-Flexibility</button>
          <button class="focus-chip" data-s="pre-floorwork">Pre-Floorwork</button>
          <button class="focus-chip" data-s="custom">Custom Focus</button>
        </div>
      </div>

      <div id="wuCustomFocus" style="display:none;">
        <div class="section-label">Focus Areas</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;" id="wuFocusChips">
          <button class="focus-chip active" data-f="grip">Grip</button>
          <button class="focus-chip active" data-f="shoulder">Shoulders</button>
          <button class="focus-chip active" data-f="core">Core</button>
          <button class="focus-chip active" data-f="back">Back / Lats</button>
          <button class="focus-chip active" data-f="legs">Legs / Glutes</button>
          <button class="focus-chip active" data-f="hip">Hips / Hip Flexors</button>
          <button class="focus-chip active" data-f="flex">Flexibility</button>
          <button class="focus-chip active" data-f="cardio">Cardio / Pulse</button>
        </div>
      </div>

      <div>
        <div class="section-label">Warm-Up Duration</div>
        <div class="range-row"><div style="color:var(--muted);font-size:9px;">Minutes</div><div class="range-val" id="wuDurVal">10</div></div>
        <input type="range" id="wuDuration" min="5" max="30" value="10" step="5"
          oninput="document.getElementById('wuDurVal').textContent=this.value">
        <div style="display:flex;justify-content:space-between;color:var(--dim);font-size:8px;margin-top:4px;"><span>5 min</span><span>30 min</span></div>
      </div>

      <div>
        <div class="section-label">Intensity Level</div>
        <div style="display:flex;gap:5px;flex-direction:column;" id="wuIntensityChips">
          <button class="focus-chip" data-i="gentle">ðŸŒŠ Gentle â€” mobility focus</button>
          <button class="focus-chip active" data-i="moderate">âš¡ Moderate â€” standard</button>
          <button class="focus-chip" data-i="activating">ðŸ”¥ Activating â€” high energy</button>
        </div>
      </div>

      <div>
        <div class="section-label">Link to Saved Routine</div>
        <select id="wuRoutineLink" style="width:100%;">
          <option value="">â€” None (general warm-up) â€”</option>
        </select>
        <div style="font-size:8px;color:var(--dim);margin-top:5px;line-height:1.6;">When linked, warm-up will prioritize the muscles used in your routine's moves.</div>
      </div>

      <button class="wu-generate-btn" onclick="generateWarmup()"><span>â—Ž Generate Warm-Up</span></button>

      <div style="display:flex;align-items:center;gap:8px;padding:9px 0 0;">
        <button class="focus-chip active" id="cdToggleBtn" onclick="toggleCooldown(this)" style="width:100%;text-align:left;">
          ðŸ§Š Include Cool Down
        </button>
      </div>
      <div style="font-size:8px;color:var(--dim);line-height:1.6;margin-top:4px;">Cool down stretches will generate alongside your warm-up.</div>

      <button class="clear-link" onclick="clearWarmup()">Clear</button>
    </div>

    <div class="wu-main">
      <div class="wu-controls">
        <h3 id="wuHeadline">Your Warm-Up</h3>
        <div class="wu-stats">
          <div class="wu-stat"><div class="wu-stat-n" id="wuStatExercises">â€”</div><div class="wu-stat-l">Exercises</div></div>
          <div class="wu-stat"><div class="wu-stat-n" id="wuStatTime">â€”</div><div class="wu-stat-l">WU Min</div></div>
          <div class="wu-stat"><div class="wu-stat-n" id="wuStatCDTime" style="color:var(--l2);">â€”</div><div class="wu-stat-l">CD Min</div></div>
          <div class="wu-stat"><div class="wu-stat-n" id="wuStatSets">â€”</div><div class="wu-stat-l">Sets</div></div>
        </div>
        <button class="action-btn" onclick="generateWarmup()" id="wuRegenBtn" style="display:none;">â†º Regenerate</button>
        <button class="action-btn" onclick="copyWarmup()" id="wuCopyBtn" style="display:none;">â†— Copy</button>
      </div>
      <div class="wu-body" id="wuBody">
        <div class="wu-empty">
          <div class="wu-empty-icon">â—Ž</div>
          <div class="wu-empty-txt">Choose your session type &amp; hit Generate</div>
          <div style="font-size:9px;color:var(--dim);max-width:260px;text-align:center;line-height:1.7;">Link a saved routine to get a warm-up tuned to the exact muscles your choreo demands.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timer overlay -->
<div class="timer-overlay hidden" id="timerOverlay" onclick="timerClickAway(event)">
  <div class="timer-exercise" id="timerExercise"></div>
  <div class="timer-set" id="timerSet"></div>
  <div class="timer-circle">
    <svg viewBox="0 0 180 180"><circle id="timerArc" cx="90" cy="90" r="84" stroke-dasharray="528" stroke-dashoffset="0"/></svg>
    <div>
      <div class="timer-digits" id="timerDigits">00</div>
      <div class="timer-label" id="timerLabel">seconds</div>
    </div>
  </div>
  <div class="timer-actions">
    <button class="action-btn" onclick="pauseTimer()" id="timerPauseBtn">â¸ Pause</button>
    <button class="action-btn" onclick="stopTimer()">âœ• Stop</button>
  </div>
  <div class="timer-note" id="timerNote"></div>
  <div style="font-size:8px;color:var(--dim);margin-top:14px;">Click anywhere to pause Â· Click again to resume</div>
</div>

<!-- ===== VIDEO LIBRARY ===== -->
<div class="page" id="page-vidlib">
  <div class="vl-page">
    <div class="vl-sidebar">
      <h3>â—‰ Video Library</h3>
      <div class="vl-cat-group-lbl">Browse by Category</div>
      <button class="vl-cat-btn active" data-vlcat="all" onclick="vlSetCat('all',this)">All Moves <span class="vl-count" id="vlCountAll"></span></button>
      <div class="vl-cat-group-lbl">Warm-Up</div>
      <button class="vl-cat-btn" data-vlcat="warmup-mobility" onclick="vlSetCat('warmup-mobility',this)">Mobility &amp; Activation</button>
      <button class="vl-cat-btn" data-vlcat="warmup-stretch" onclick="vlSetCat('warmup-stretch',this)">Stretching</button>
      <button class="vl-cat-btn" data-vlcat="warmup-cooldown" onclick="vlSetCat('warmup-cooldown',this)">Cool Down</button>
      <div class="vl-cat-group-lbl">Pole Moves</div>
      <button class="vl-cat-btn" data-vlcat="spin" onclick="vlSetCat('spin',this)">Spins</button>
      <button class="vl-cat-btn" data-vlcat="climb" onclick="vlSetCat('climb',this)">Climbs</button>
      <button class="vl-cat-btn" data-vlcat="invert" onclick="vlSetCat('invert',this)">Inversions</button>
      <button class="vl-cat-btn" data-vlcat="mount" onclick="vlSetCat('mount',this)">Mounts</button>
      <button class="vl-cat-btn" data-vlcat="pose" onclick="vlSetCat('pose',this)">Poses &amp; Holds</button>
      <button class="vl-cat-btn" data-vlcat="drop" onclick="vlSetCat('drop',this)">Drops</button>
      <button class="vl-cat-btn" data-vlcat="transition" onclick="vlSetCat('transition',this)">Transitions</button>
      <button class="vl-cat-btn" data-vlcat="floorwork" onclick="vlSetCat('floorwork',this)">Floorwork</button>
      <div class="vl-cat-group-lbl">Combos</div>
      <button class="vl-cat-btn" data-vlcat="combo-beginner" onclick="vlSetCat('combo-beginner',this)">Beginner Combos</button>
      <button class="vl-cat-btn" data-vlcat="combo-intermediate" onclick="vlSetCat('combo-intermediate',this)">Intermediate Combos</button>
      <button class="vl-cat-btn" data-vlcat="combo-advanced" onclick="vlSetCat('combo-advanced',this)">Advanced Combos</button>
      <div class="vl-cat-group-lbl">By Level</div>
      <button class="vl-cat-btn" data-vlcat="level-L1" onclick="vlSetCat('level-L1',this)">L1 Beginner</button>
      <button class="vl-cat-btn" data-vlcat="level-L2" onclick="vlSetCat('level-L2',this)">L2 Beginner+</button>
      <button class="vl-cat-btn" data-vlcat="level-L3" onclick="vlSetCat('level-L3',this)">L3 Intermediate</button>
      <button class="vl-cat-btn" data-vlcat="level-L4" onclick="vlSetCat('level-L4',this)">L4 Advanced</button>
      <button class="vl-cat-btn" data-vlcat="level-L5" onclick="vlSetCat('level-L5',this)">L5 Elite</button>
    </div>
    <div class="vl-main">
      <div class="vl-toolbar">
        <input class="vl-search" id="vlSearch" placeholder="Search moves, combos, warm-up..." oninput="renderVidLib()">
        <div class="vl-filter-chips" id="vlChips">
          <button class="vl-chip active" data-vlf="all" onclick="vlSetFilter('all',this)">All</button>
          <button class="vl-chip" data-vlf="beginner" onclick="vlSetFilter('beginner',this)">Beginner</button>
          <button class="vl-chip" data-vlf="intermediate" onclick="vlSetFilter('intermediate',this)">Intermediate</button>
          <button class="vl-chip" data-vlf="advanced" onclick="vlSetFilter('advanced',this)">Advanced</button>
        </div>
        <div style="margin-left:auto;font-size:9px;color:var(--dim);" id="vlResultCount"></div>
      </div>
      <div class="vl-grid" id="vlGrid"></div>
    </div>
  </div>
</div>

<!-- ===== CLASS SCHEDULE ===== -->
<div class="page" id="page-schedule">
  <div class="sched-page">
    <div class="sched-sidebar">
      <div>
        <h3>ðŸ“… Add Class</h3>
        <div style="font-size:9px;color:var(--dim);margin-top:2px;line-height:1.5;">Schedule a class, session, or performance. Export to Google Calendar, Mindbody, or iCal.</div>
      </div>

      <div>
        <div class="sfl">Class Name</div>
        <input class="sfi" id="scName" placeholder="e.g. Pole Level 2, Private with Jade...">
      </div>

      <div>
        <div class="sfl">Class Type</div>
        <div class="class-type-chips" id="ctChips">
          <button class="ct-chip active" data-ct="pole">Pole</button>
          <button class="ct-chip" data-ct="stretch">Stretch</button>
          <button class="ct-chip" data-ct="conditioning">Conditioning</button>
          <button class="ct-chip" data-ct="floorwork">Floorwork</button>
          <button class="ct-chip" data-ct="private">Private</button>
          <button class="ct-chip" data-ct="performance">Performance</button>
          <button class="ct-chip" data-ct="other">Other</button>
        </div>
      </div>

      <div class="sched-row">
        <div>
          <div class="sfl">Date</div>
          <input class="sfi" id="scDate" type="date">
        </div>
        <div>
          <div class="sfl">Time</div>
          <input class="sfi" id="scTime" type="time">
        </div>
      </div>

      <div class="sched-row">
        <div>
          <div class="sfl">Duration</div>
          <select class="sfi" id="scDuration">
            <option value="30">30 min</option>
            <option value="45">45 min</option>
            <option value="60" selected>1 hour</option>
            <option value="75">1h 15m</option>
            <option value="90">1h 30m</option>
            <option value="120">2 hours</option>
          </select>
        </div>
        <div>
          <div class="sfl">Level</div>
          <select class="sfi" id="scLevel">
            <option value="">Any</option>
            <option>L1</option><option>L2</option><option>L3</option>
            <option>L4</option><option>L5</option><option>All Levels</option>
          </select>
        </div>
      </div>

      <div>
        <div class="sfl">Location / Studio</div>
        <input class="sfi" id="scLocation" placeholder="Studio name or address...">
      </div>

      <div>
        <div class="sfl">Instructor</div>
        <input class="sfi" id="scInstructor" placeholder="Instructor name...">
      </div>

      <div>
        <div class="sfl">Notes</div>
        <textarea class="sfi" id="scNotes" rows="2" placeholder="What to bring, focus for the class..."></textarea>
      </div>

      <div>
        <div class="sfl" style="margin-bottom:6px;">Repeats</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;" id="recurChips">
          <button class="recur-chip active" data-r="none">Once</button>
          <button class="recur-chip" data-r="weekly">Weekly</button>
          <button class="recur-chip" data-r="biweekly">Bi-weekly</button>
          <button class="recur-chip" data-r="monthly">Monthly</button>
        </div>
      </div>

      <button class="sched-add-btn" onclick="addSchedClass()"><span>+ Add to Schedule</span></button>
    </div>

    <div class="sched-main">
      <!-- Week grid -->
      <div class="upcoming-hdr">
        <div class="upcoming-title">Week View</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="wbtn" onclick="schedChangeWeek(-1)">â€¹</button>
          <div class="week-lbl" id="schedWeekLbl" style="min-width:160px;text-align:center;"></div>
          <button class="wbtn" onclick="schedChangeWeek(1)">â€º</button>
          <button class="wbtn" onclick="schedGoToday()" style="font-size:8px;">Today</button>
        </div>
      </div>
      <div class="week-grid" id="schedWeekGrid"></div>

      <!-- Upcoming list -->
      <div class="upcoming-section">
        <div class="upcoming-hdr">
          <div class="upcoming-title">Upcoming Classes</div>
          <div style="display:flex;gap:7px;">
            <button class="action-btn" onclick="clearPastClasses()" style="font-size:8px;">Clear Past</button>
          </div>
        </div>
        <div id="upcomingList"></div>
      </div>

      <!-- Integration -->
      <div class="integ-section">
        <div class="integ-title">ðŸ“¤ Export &amp; Integrations</div>

        <div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--dim);margin-bottom:8px;">Google Calendar</div>
        <div class="integ-row">
          <button class="integ-btn gcal" onclick="exportAllToGCal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            Add All to Google Calendar
          </button>
          <button class="integ-btn gcal" onclick="exportNextToGCal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            Next Class Only
          </button>
        </div>
        <div class="integ-note">Opens Google Calendar in a new tab with event pre-filled. Sign in to save it.</div>

        <div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--dim);margin-bottom:8px;margin-top:16px;">Mindbody / Wellness App</div>
        <div class="integ-row">
          <button class="integ-btn mb" onclick="openMindbody()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
            Open Mindbody App
          </button>
          <button class="integ-btn mb" onclick="openMindbodySearch()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            Find Classes Near Me
          </button>
        </div>
        <div class="integ-input-row">
          <input class="integ-url-in" id="mbStudioUrl" placeholder="Paste your studio's Mindbody booking link...">
          <button class="copy-ical-btn" onclick="openMbLink()">Open â†’</button>
        </div>
        <div class="integ-note">Paste your studio's Mindbody link above to save it and open it directly. Your schedule here will not sync automatically â€” use the iCal export for that.</div>

        <div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--dim);margin-bottom:8px;margin-top:16px;">iCal / Apple Calendar / Outlook</div>
        <div class="integ-row">
          <button class="integ-btn ical" onclick="downloadIcal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            Download .ics File
          </button>
          <button class="integ-btn ical" onclick="copyIcalText()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 00-2 2v14h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/></svg>
            Copy iCal Text
          </button>
        </div>
        <div class="integ-note">Download .ics and drag it into Apple Calendar, Google Calendar, or Outlook to import all your classes at once.</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PSO TRAINING ===== -->
<div class="page" id="page-pso">
  <div style="padding:28px 36px;">
    <div style="background:linear-gradient(135deg,rgba(123,159,212,0.06),rgba(160,110,201,0.04));border:1px solid rgba(123,159,212,0.15);padding:24px 28px;margin-bottom:28px;display:flex;gap:20px;align-items:flex-start;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:46px;color:var(--pso);opacity:0.7;line-height:1;font-style:italic;flex-shrink:0;">PSO</div>
      <div><h2 style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;color:var(--pso);margin-bottom:7px;">PSO Training Space</h2>
      <p style="font-size:11px;color:var(--muted);line-height:1.7;">Official PSO competition levels, scoring rubrics, deduction rules, and key guidelines â€” aligned with the PSO Live Events Rules Document.</p></div>
    </div>
    <div style="font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);font-style:italic;">Competition Levels</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-bottom:28px;" id="psoCards"></div>
    <div style="font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);font-style:italic;">Scoring Systems</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="action-btn" id="techBtn" onclick="showScoring('tech',this)" style="border-color:var(--accent);color:var(--accent);">Technical Â· Championship</button>
      <button class="action-btn" id="artBtn" onclick="showScoring('art',this)">Artistic Â· Dramatic / Sensual</button>
    </div>
    <div id="scoreTech" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:22px;">
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Quality of Execution</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts â˜… Tiebreaker</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Confidence, precision, good form. Straight knees, pointed toes, smooth inversions, controlled drops.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Difficulty â€” Moves</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Strength + flexibility, fewer contact points, longer holds, height on pole, release moves.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Difficulty â€” Transitions</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Lifting into moves, switching sides, low contact, directional changes, no bailouts.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Difficulty â€” Combinations</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Many linked movements, time on pole without floor, range of contacts, full traversal.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Balance of Program</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Full stage use, both poles, full height, difficulty balanced throughout routine.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Variety of Movements</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Large vocabulary, range of shapes, speeds, level-appropriate skill areas demonstrated.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Clarity of Concept &amp; Musicality</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Clear theme, choreography matches music accents, costume and props support concept.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Flow and Fluidity</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Seamless transitions, integrated set-ups, continuity throughout.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Stage Presence</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Audience connection, commanding attention, high energy, holding character.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Uniqueness of Performance</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Surprising or unexpected linking of movements, creative or unusual concept.</p></div>
    </div>
    <div id="scoreArt" style="display:none;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:22px;">
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Clarity of Concept</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">25 pts â˜… Tiebreaker</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Clear emotion/storyline, pole tricks develop concept, facial expressions, appropriate song choice.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Stage Presence</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">15 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Connection with audience, commanding attention, high energy, holding character throughout.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Quality of Execution</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Confidence, precision, form â€” knees, toes, inversions, controlled drops.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Musicality</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Highlights accents and beats, matches or intentionally contrasts cadence and crescendos.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Flow and Fluidity</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Seamless transitions, integrated set-ups, good continuity and follow-through.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Category Appropriateness</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">10 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Choreography and concept are well suited to the chosen category.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Level Appropriateness</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">5 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Mastery of movement areas correlating to the competition level.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--accent2);margin-bottom:3px;">Stage Etiquette</div><div style="font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--accent);font-weight:600;margin-bottom:6px;">5 pts</div><p style="font-size:10px;color:var(--muted);line-height:1.6;">Audience acknowledgment, intentional entrance/exit, appropriate hair/makeup.</p></div>
    </div>
    <div style="font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);font-style:italic;">Key Rules at a Glance</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:28px;">
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Music Time Limits</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">L1: <span style="color:var(--accent)">2:30</span> Â· L2: <span style="color:var(--accent)">3:00</span> Â· L3: <span style="color:var(--accent)">3:30</span> Â· L4/L5: <span style="color:var(--accent)">4:00</span> max. Submit m4a/mp3/wav. Bring labeled USB backup.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Level Locking</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">Once you compete, stay or move up for <span style="color:var(--accent)">12 months</span>. Place 1â€“3 in 8+ competitor division â†’ move up within <span style="color:var(--accent)">2 months</span>.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Both Poles Required</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">L2â€“L5 must use <span style="color:var(--accent)">both spinning AND static poles</span>. Stage right = spin, stage left = static (standard setup).</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Grip Aids</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">Body only â€” never to the pole. OK: Dry Hands, iTac, Tite Grip, Griptonite. <span style="color:var(--accent)">NOT OK: chalk, Firm Grip, Liquid Chalk.</span></p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Props</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">Max <span style="color:var(--accent)">25 lbs</span> and <span style="color:var(--accent)">7'Ã—5'Ã—3'</span>. No fire, food, glass, glitter, fog, water, live animals, real weapons.</p></div>
      <div style="background:var(--bg3);border:1px solid var(--border);padding:13px;"><div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:7px;">Scoring Method</div><p style="font-size:10px;color:var(--muted);line-height:1.7;">3 judges rank competitors via ordinals. <span style="color:var(--accent)">Lowest ordinal total wins</span> (like golf). 1st=1pt, 2nd=2pts, etc.</p></div>
    </div>
    <div id="psoChecklistWrap" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px;"></div>
  </div>
</div>

<script>
// ============================================================
// MOVES DATABASE
// ============================================================
const MOVES=[
  {psoLevel:"1",name:"Fireman Spin",cat:"Spin"},{psoLevel:"1",name:"Chair Spin",cat:"Spin"},
  {psoLevel:"1",name:"Back Hook Spin",cat:"Spin"},{psoLevel:"1",name:"Front Hook Spin",cat:"Spin"},
  {psoLevel:"1",name:"Sunwheel Spin",cat:"Spin"},{psoLevel:"1",name:"Carousel Spin",cat:"Spin"},
  {psoLevel:"1",name:"Attitude Spin",cat:"Spin"},{psoLevel:"1",name:"Peter Pan Spin",cat:"Spin"},
  {psoLevel:"1",name:"Juliet Spin",cat:"Spin"},{psoLevel:"1",name:"Corkscrew Spin",cat:"Spin"},
  {psoLevel:"1",name:"Step Around Spin",cat:"Spin"},{psoLevel:"1",name:"Ballerina Spin",cat:"Spin"},
  {psoLevel:"1",name:"Martini Spin",cat:"Spin"},{psoLevel:"1",name:"Tornado",cat:"Spin"},
  {psoLevel:"1",name:"Pole Sit",cat:"Pose"},{psoLevel:"1",name:"Side Seat",cat:"Pose"},
  {psoLevel:"1",name:"Martini Seat",cat:"Pose"},{psoLevel:"1",name:"Pole Hug",cat:"Pose"},
  {psoLevel:"1",name:"Mermaid Pose",cat:"Pose"},{psoLevel:"1",name:"Ballerina Pose",cat:"Pose"},
  {psoLevel:"1",name:"Flamingo Pose",cat:"Pose"},{psoLevel:"1",name:"Seahorse",cat:"Pose"},
  {psoLevel:"1",name:"Pegasus",cat:"Pose"},{psoLevel:"1",name:"Pike Hip Hold",cat:"Pose"},
  {psoLevel:"1",name:"Basic Climb",cat:"Climb"},{psoLevel:"1",name:"Side Climb",cat:"Climb"},
  {psoLevel:"1",name:"Front Climb",cat:"Climb"},{psoLevel:"1",name:"Fan Kick",cat:"Transition"},
  {psoLevel:"1",name:"Body Wave",cat:"Transition"},{psoLevel:"1",name:"Dive Down",cat:"Transition"},
  {psoLevel:"1",name:"Back Slide",cat:"Transition"},{psoLevel:"1",name:"Pole Cartwheel",cat:"Transition"},
  {psoLevel:"1",name:"Crucifix Hold",cat:"Hold"},{psoLevel:"1",name:"Bui Bui Bend",cat:"Trick"},
  {psoLevel:"1",name:"Elf",cat:"Trick"},{psoLevel:"1",name:"Knee Bridge",cat:"Trick"},
  {psoLevel:"1",name:"Muscle Up",cat:"Trick"},{psoLevel:"1",name:"Ballet Hook",cat:"Trick"},
  {psoLevel:"2",name:"Basic Invert",cat:"Invert"},{psoLevel:"2",name:"Chopper Invert",cat:"Invert"},
  {psoLevel:"2",name:"Invert to Crucifix",cat:"Invert"},{psoLevel:"2",name:"One Arm Invert",cat:"Invert"},
  {psoLevel:"2",name:"Butterfly",cat:"Pose"},{psoLevel:"2",name:"Superman",cat:"Pose"},
  {psoLevel:"2",name:"Jasmine",cat:"Pose"},{psoLevel:"2",name:"Genie",cat:"Pose"},
  {psoLevel:"2",name:"Layback",cat:"Pose"},{psoLevel:"2",name:"Cupid",cat:"Pose"},
  {psoLevel:"2",name:"Figurehead",cat:"Pose"},{psoLevel:"2",name:"Wrist Seat",cat:"Pose"},
  {psoLevel:"2",name:"Scissor Sit",cat:"Pose"},{psoLevel:"2",name:"Stargazer",cat:"Pose"},
  {psoLevel:"2",name:"Z Pose",cat:"Pose"},{psoLevel:"2",name:"Splits",cat:"Pose"},
  {psoLevel:"2",name:"Full Moon",cat:"Pose"},{psoLevel:"2",name:"Closed Rainbow",cat:"Pose"},
  {psoLevel:"2",name:"Fang",cat:"Pose"},{psoLevel:"2",name:"Fish",cat:"Pose"},
  {psoLevel:"2",name:"Remi Layback",cat:"Pose"},{psoLevel:"2",name:"Reiko",cat:"Pose"},
  {psoLevel:"2",name:"Cross Knee Release",cat:"Trick"},{psoLevel:"2",name:"Cross Ankle Release",cat:"Trick"},
  {psoLevel:"2",name:"Handstand",cat:"Trick"},{psoLevel:"2",name:"Knee Swing",cat:"Trick"},
  {psoLevel:"2",name:"Marley",cat:"Transition"},{psoLevel:"2",name:"Hook & Roll",cat:"Transition"},
  {psoLevel:"2",name:"Twisted Jasmine",cat:"Transition"},{psoLevel:"2",name:"Climb Over",cat:"Transition"},
  {psoLevel:"2",name:"Switch Leap",cat:"Transition"},{psoLevel:"2",name:"Air Walk",cat:"Transition"},
  {psoLevel:"2",name:"Jasmine Spin",cat:"Spin"},{psoLevel:"2",name:"Tarzan Spin",cat:"Spin"},
  {psoLevel:"2",name:"Forward Spin",cat:"Spin"},{psoLevel:"2",name:"Thigh Hold",cat:"Hold"},
  {psoLevel:"2",name:"Drops (HollyÂ·SupermanÂ·Martini)",cat:"Drop"},
  {psoLevel:"3",name:"Aerial Invert",cat:"Invert"},
  {psoLevel:"3",name:"Shoulder Mount",cat:"Mount"},{psoLevel:"3",name:"Reverse Shoulder Mount",cat:"Mount"},
  {psoLevel:"3",name:"Shoulder Mount Hang",cat:"Mount"},{psoLevel:"3",name:"Shoulder Mount Walk-Down",cat:"Mount"},
  {psoLevel:"3",name:"Outside Leg Hang (Gemini)",cat:"Pose"},{psoLevel:"3",name:"Inside Leg Hang (Scorpio)",cat:"Pose"},
  {psoLevel:"3",name:"Extended Butterfly",cat:"Pose"},{psoLevel:"3",name:"Flatline",cat:"Pose"},
  {psoLevel:"3",name:"Flatline Scorpio",cat:"Pose"},{psoLevel:"3",name:"Brass Monkey",cat:"Pose"},
  {psoLevel:"3",name:"Jade Split",cat:"Pose"},{psoLevel:"3",name:"Inverted 1-Leg Crucifix",cat:"Pose"},
  {psoLevel:"3",name:"Reverse Superman",cat:"Pose"},{psoLevel:"3",name:"Castaway",cat:"Pose"},
  {psoLevel:"3",name:"Hood Ornament",cat:"Pose"},{psoLevel:"3",name:"Dangerous Bird",cat:"Pose"},
  {psoLevel:"3",name:"Jallegra",cat:"Pose"},{psoLevel:"3",name:"Meathook Split",cat:"Pose"},
  {psoLevel:"3",name:"Flip",cat:"Trick"},{psoLevel:"3",name:"Butterfly to Superman",cat:"Trick"},
  {psoLevel:"3",name:"Apprentice to Butterfly",cat:"Transition"},
  {psoLevel:"3",name:"Jaws / Death Drop",cat:"Drop"},
  {psoLevel:"4",name:"Ayesha",cat:"Invert"},{psoLevel:"4",name:"Twisted Grip Ayesha",cat:"Invert"},
  {psoLevel:"4",name:"Handspring",cat:"Mount"},{psoLevel:"4",name:"Twisted Grip Handspring",cat:"Mount"},
  {psoLevel:"4",name:"Aerial Shoulder Mount",cat:"Mount"},{psoLevel:"4",name:"Caterpillar",cat:"Mount"},
  {psoLevel:"4",name:"Rainbow Marchenko",cat:"Mount"},{psoLevel:"4",name:"Reiko Mount",cat:"Mount"},
  {psoLevel:"4",name:"Iron X",cat:"Pose"},{psoLevel:"4",name:"Allegra",cat:"Pose"},
  {psoLevel:"4",name:"Allegra Split",cat:"Pose"},{psoLevel:"4",name:"Chopsticks",cat:"Pose"},
  {psoLevel:"4",name:"Cocoon",cat:"Pose"},{psoLevel:"4",name:"Bird of Paradise",cat:"Pose"},
  {psoLevel:"4",name:"Russian Layback",cat:"Pose"},{psoLevel:"4",name:"Flatline Scorpio Split",cat:"Pose"},
  {psoLevel:"4",name:"Planche",cat:"Pose"},{psoLevel:"4",name:"Reverse Ayesha",cat:"Pose"},
  {psoLevel:"4",name:"Yogini / Shooting Star",cat:"Pose"},{psoLevel:"4",name:"Ankle Hang",cat:"Pose"},
  {psoLevel:"4",name:"Flight Attendant",cat:"Pose"},{psoLevel:"4",name:"Sunrise",cat:"Pose"},
  {psoLevel:"4",name:"No-Hand Ayesha",cat:"Trick"},{psoLevel:"4",name:"Fonji",cat:"Trick"},
  {psoLevel:"4",name:"Meathook",cat:"Trick"},{psoLevel:"4",name:"Leg Switch",cat:"Trick"},
  {psoLevel:"4",name:"Electric Switch",cat:"Trick"},{psoLevel:"4",name:"Brass Hook",cat:"Trick"},
  {psoLevel:"4",name:"Phoenix",cat:"Spin"},{psoLevel:"4",name:"Rock Star Spin",cat:"Spin"},
  {psoLevel:"4",name:"Suicide Spin",cat:"Spin"},{psoLevel:"4",name:"Stag Spin",cat:"Spin"},
  {psoLevel:"4",name:"Holly Drop",cat:"Drop"},{psoLevel:"4",name:"Death Drop",cat:"Drop"},
  {psoLevel:"4",name:"Sad Girl Drop",cat:"Drop"},{psoLevel:"4",name:"Superman Drop",cat:"Drop"},
  {psoLevel:"4",name:"Butterfly to Flatline",cat:"Transition"},{psoLevel:"4",name:"Le Poisson",cat:"Transition"},
  {psoLevel:"5",name:"Agata",cat:"Pose"},{psoLevel:"5",name:"Allegra Oversplit",cat:"Pose"},
  {psoLevel:"5",name:"Anastasia",cat:"Pose"},{psoLevel:"5",name:"Iron X Double Forearm",cat:"Pose"},
  {psoLevel:"5",name:"Baby Valentine",cat:"Pose"},{psoLevel:"5",name:"Broken Doll",cat:"Pose"},
  {psoLevel:"5",name:"Cupid No Hands",cat:"Pose"},{psoLevel:"5",name:"Fairy Sit",cat:"Pose"},
  {psoLevel:"5",name:"Meridian",cat:"Pose"},{psoLevel:"5",name:"Titanic",cat:"Pose"},
  {psoLevel:"5",name:"Dove",cat:"Pose"},{psoLevel:"5",name:"Cradle",cat:"Pose"},
  {psoLevel:"5",name:"Archer",cat:"Pose"},{psoLevel:"5",name:"Genevieve",cat:"Pose"},
  {psoLevel:"5",name:"Ayesha Elbow Grip",cat:"Invert"},{psoLevel:"5",name:"Ayesha Forearm Grip",cat:"Invert"},
  {psoLevel:"5",name:"Ayesha Double Forearm",cat:"Invert"},
  {psoLevel:"5",name:"One Handed Spin",cat:"Spin"},{psoLevel:"5",name:"Pirouette",cat:"Spin"},
  {psoLevel:"5",name:"Sit Spin",cat:"Spin"},{psoLevel:"5",name:"Straddle Spin",cat:"Spin"},
  {psoLevel:"5",name:"Cast-off",cat:"Drop"},{psoLevel:"5",name:"Dragon Tail",cat:"Drop"},
  {psoLevel:"5",name:"Tailpipe",cat:"Drop"},{psoLevel:"5",name:"Hip Dips",cat:"Trick"},
  {psoLevel:"5",name:"Knee Hold",cat:"Hold"},
  {psoLevel:"Floorwork",name:"Body Roll",cat:"Floor"},{psoLevel:"Floorwork",name:"Shoulder Roll",cat:"Floor"},
  {psoLevel:"Floorwork",name:"Leg Waves",cat:"Floor"},{psoLevel:"Floorwork",name:"Straddle Roll",cat:"Floor"},
  {psoLevel:"Floorwork",name:"Back Arch Slide",cat:"Floor"},{psoLevel:"Floorwork",name:"Chair Pose Floor",cat:"Floor"},
  {psoLevel:"Floorwork",name:"Heel Clack",cat:"Floor"},{psoLevel:"Floorwork",name:"Cat Crawl",cat:"Floor"},
  {psoLevel:"Floorwork",name:"Hair Flip",cat:"Transition"},{psoLevel:"Floorwork",name:"Mermaid to Split",cat:"Transition"},
];

const PREBUILT=[
  {name:"Fireman â†’ Chair â†’ Pole Sit â†’ Cross Knee Release",moves:[
    {psoLevel:"1",name:"Fireman Spin",cat:"Spin"},{psoLevel:"1",name:"Chair Spin",cat:"Spin"},
    {psoLevel:"1",name:"Pole Sit",cat:"Pose"},{psoLevel:"2",name:"Cross Knee Release",cat:"Trick"}]},
  {name:"Climb â†’ Gemini â†’ Flatline â†’ Jade",moves:[
    {psoLevel:"1",name:"Basic Climb",cat:"Climb"},{psoLevel:"3",name:"Outside Leg Hang (Gemini)",cat:"Pose"},
    {psoLevel:"3",name:"Flatline",cat:"Pose"},{psoLevel:"3",name:"Jade Split",cat:"Pose"}]},
  {name:"Butterfly â†’ Extended Butterfly â†’ Ayesha",moves:[
    {psoLevel:"2",name:"Butterfly",cat:"Pose"},{psoLevel:"3",name:"Extended Butterfly",cat:"Pose"},
    {psoLevel:"4",name:"Ayesha",cat:"Invert"}]},
  {name:"Phoenix â†’ Iron X â†’ Superman Drop",moves:[
    {psoLevel:"4",name:"Phoenix",cat:"Spin"},{psoLevel:"4",name:"Iron X",cat:"Pose"},
    {psoLevel:"4",name:"Superman Drop",cat:"Drop"}]},
];

// ============================================================
// GENERATOR STATE
// ============================================================
let activeLevels=new Set(["1","2","3","4","5","Floorwork"]);
let activeCats=new Set(["Spin","Pose","Invert","Mount","Trick","Transition","Drop","Floor","Hold","Climb"]);
let usePrebuilt=false;
let savedCombos=JSON.parse(localStorage.getItem('pc_combos')||'[]');
let currentCombo=null;

function lc(l){return l==="Floorwork"?"lvl-Floor":"lvl-"+l;}
function ll(l){return{"1":"L1","2":"L2","3":"L3","4":"L4","5":"L5","Floorwork":"Floor"}[l]||l;}
// ============================================================
// USER PORTAL
// ============================================================
const PORTAL_EMOJIS = ['ðŸŽ­','ðŸ’ƒ','ðŸ•º','ðŸŒ¸','âœ¨','ðŸ¦‹','ðŸ”¥','ðŸ’«','ðŸŒ™','â­','ðŸŽª','ðŸŽ¨','ðŸ‘‘','ðŸ¦š','ðŸŒº','ðŸ†','ðŸŽ¯','ðŸ’Ž','ðŸŒ™','ðŸ¦„','ðŸŽ ','ðŸŒŠ','ðŸŽ¶','ðŸŒ¹','ðŸ¦…'];
const PORTAL_KEY = 'pc_user_profile';

let pcUser = null;
let portalSelectedLevel = '1';
let portalSelectedEmoji = 'ðŸŽ­';
let portalAvatarDataUrl = null;

function initPortal() {
  // Render emoji grid
  const grid = document.getElementById('portalEmojiGrid');
  if(grid) grid.innerHTML = PORTAL_EMOJIS.map(e =>
    `<span class="portal-avatar-emoji${e===portalSelectedEmoji?' sel':''}" onclick="portalPickEmoji('${e}',this)">${e}</span>`
  ).join('');

  // Check if user exists
  const saved = localStorage.getItem(PORTAL_KEY);
  if(saved) {
    try {
      pcUser = JSON.parse(saved);
      hidePortal();
      updateHeaderProfile();
    } catch(e) { showPortal(); }
  } else {
    showPortal();
  }
}

function showPortal() {
  const el = document.getElementById('portalOverlay');
  if(el) el.style.display = 'flex';
}

function hidePortal() {
  const el = document.getElementById('portalOverlay');
  if(el) el.style.display = 'none';
}

function portalSetLevel(l, btn) {
  portalSelectedLevel = l;
  document.querySelectorAll('.portal-level-chip').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function portalPickEmoji(e, el) {
  portalSelectedEmoji = e;
  portalAvatarDataUrl = null;
  document.querySelectorAll('.portal-avatar-emoji').forEach(x => x.classList.remove('sel'));
  if(el) el.classList.add('sel');
  const prev = document.getElementById('portalAvatarPreview');
  if(prev) prev.innerHTML = e;
}

function portalHandleAvatar(input) {
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    portalAvatarDataUrl = e.target.result;
    const prev = document.getElementById('portalAvatarPreview');
    if(prev) prev.innerHTML = `<img src="${portalAvatarDataUrl}" alt="avatar">`;
    // Deselect emojis
    document.querySelectorAll('.portal-avatar-emoji').forEach(x => x.classList.remove('sel'));
  };
  reader.readAsDataURL(file);
}

function portalSkip() {
  pcUser = {
    name: 'Dancer',
    level: '1',
    avatar: null,
    emoji: 'ðŸŽ­',
    goals: [],
    milestones: [],
    joinDate: new Date().toISOString(),
    badges: []
  };
  saveUser();
  hidePortal();
  updateHeaderProfile();
}

function saveUser() {
  if(pcUser) localStorage.setItem(PORTAL_KEY, JSON.stringify(pcUser));
}

function updateHeaderProfile() {
  const btn = document.getElementById('profileBtn');
  if(!pcUser || !btn) return;
  btn.style.display = 'flex';

  const avatar = document.getElementById('headerAvatar');
  if(avatar) avatar.innerHTML = pcUser.avatar
    ? `<img src="${pcUser.avatar}" alt="avatar">`
    : (pcUser.emoji || 'ðŸŽ­');

  const nameEl = document.getElementById('headerName');
  if(nameEl) nameEl.textContent = pcUser.name;

  const lvlEl = document.getElementById('headerLevel');
  if(lvlEl) lvlEl.textContent = pcUser.level ? 'PSO L' + pcUser.level : 'Pole Dancer';
}

// â”€â”€ PROFILE DRAWER â”€â”€
function openProfile() {
  if(!pcUser) return;
  renderProfileDrawer();
  document.getElementById('profileDrawer').classList.add('open');
  document.getElementById('profileOverlay').classList.add('open');
}

function closeProfile() {
  document.getElementById('profileDrawer').classList.remove('open');
  document.getElementById('profileOverlay').classList.remove('open');
}

function addGoal() {
  const input = document.getElementById('pdGoalIn');
  const text = input?.value.trim(); if(!text) return;
  if(!pcUser.goals) pcUser.goals = [];
  pcUser.goals.push({text, done:false, id:'g'+Date.now()});
  input.value = '';
  saveUser(); renderProfileDrawer();
}

function toggleGoal(id) {
  const g = pcUser.goals?.find(x => x.id===id); if(!g) return;
  g.done = !g.done;
  if(g.done) {
    pcUser.milestones = pcUser.milestones || [];
    pcUser.milestones.push({text: g.text, date: new Date().toLocaleDateString()});
  }
  saveUser(); renderProfileDrawer();
}

function deleteProfileGoal(id) {
  if(!pcUser.goals) return;
  pcUser.goals = pcUser.goals.filter(g => g.id !== id);
  saveUser(); renderProfileDrawer();
}

function portalSignOut() {
  if(!confirm('Reset your profile? Your saved combos and routines will stay.')) return;
  pcUser = null;
  localStorage.removeItem(PORTAL_KEY);
  closeProfile();
  document.getElementById('profileBtn').style.display = 'none';
  showPortal();
}

function checkBadges() {
  if(!pcUser) return;
  const badges = pcUser.badges || [];
  const add = (id) => { if(!badges.includes(id)) badges.push(id); };
  const saved = JSON.parse(localStorage.getItem('pc_saved') || '[]');
  const routines = JSON.parse(localStorage.getItem('pc_routines') || '[]');
  const sched = JSON.parse(localStorage.getItem('pc_schedule') || '[]');
  const studio = JSON.parse(localStorage.getItem('pc_studio') || '{}');
  const videos = Object.values(studio).reduce((a,d) => a+(Array.isArray(d)?d.length:0), 0);
  if(saved.length >= 1) add('first_combo');
  if(saved.length >= 10) add('10_combos');
  if(routines.length >= 1) add('first_routine');
  if(videos >= 1) add('video_planner');
  if(sched.length >= 1) add('scheduler');
  pcUser.badges = badges;
  saveUser();
}


// ============================================================
// GAMES
// ============================================================

// A-Z move suggestions for AlphaPole â€” primary + alternatives
const ALPHA_MOVES = {
  A: {primary:'Ayesha', alts:['Aerial Invert','Attitude Spin','Apprentice','Ankle Hang']},
  B: {primary:'Brass Monkey', alts:['Back Hook Spin','Butterfly','Body Roll','Ballerina Spin']},
  C: {primary:'Crucifix', alts:['Carousel Spin','Chair Spin','Cross Knee Release','Caterpillar Climb','Cupid']},
  D: {primary:'Dove', alts:['Dead Drop','Dip Spin','Diamond','Dragon']},
  E: {primary:'Extended Butterfly', alts:['Eagle','Eros','Extended Crucifix']},
  F: {primary:'Figurehead', alts:['Fireman Spin','Flatline Scorpio','Fish Flop','Flag','Forearm Mount']},
  G: {primary:'Gemini', alts:['Genie','Goddess','Gargoyle']},
  H: {primary:'Handspring', alts:['Holly Drop','Hip Hold','Helicopter Spin','Hang Glider']},
  I: {primary:'Iron X', alts:['Inside Leg Hang','Iguana','Inverted Crucifix']},
  J: {primary:'Jade Split', alts:['Jasmine','Janeiro','Juliet Spin']},
  K: {primary:'Knee Hold', alts:['Kick Through','Kitty']},
  L: {primary:'Layback', alts:['Leg Hang','Lotus','Liana']},
  M: {primary:'Marchetti', alts:['Martini Drop','Mermaid Spin','Monkey Spin','Mount Shoulder']},
  N: {primary:'No-Hand Ayesha', alts:['Neymar','Needle Scale']},
  O: {primary:'Outside Leg Hang', alts:['Overhead Grip','Open Invert','Oval Spin']},
  P: {primary:'Pole Sit', alts:['Pencil Spin','Pigeon Pose','Pike','Poison']},
  Q: {primary:'Queen', alts:['Quad Grip','Q Shape']},
  R: {primary:'Remi Sit', alts:['Reverse Grab Spin','Reverse Invert','Russian Split','Rollover']},
  S: {primary:'Scorpio', alts:['Shoulder Mount','Superman','Spiral Spin','Straddle','Sneaky V']},
  T: {primary:'Twisted Gemini', alts:['Thigh Hold','Titanic','Tabletop','Teddy']},
  U: {primary:'Unicorn', alts:['Upright Invert','Under the Moon']},
  V: {primary:'Violator', alts:['V-Invert','Vortex Spin']},
  W: {primary:'Wrist Seat', alts:['Windmill Spin','Witch','Waterfall']},
  X: {primary:'X-Grip Invert', alts:['X Pose','Cross Ankle Release']},
  Y: {primary:'Yogini', alts:['Y-Shape Hold','Yogi Sit']},
  Z: {primary:'Zero Gravity', alts:['Zigzag Climb','Zenith']},
};

// Spell-It word presets by theme
const SPELL_PRESETS = [
  {label:'POLE',word:'POLE'},{label:'SPIN',word:'SPIN'},{label:'FLEX',word:'FLEX'},
  {label:'IRON',word:'IRON'},{label:'JADE',word:'JADE'},{label:'FIRE',word:'FIRE'},
  {label:'AYESHA',word:'AYESHA'},{label:'GRACE',word:'GRACE'},{label:'BRAVE',word:'BRAVE'},
  {label:'GRIND',word:'GRIND'},{label:'CRAFT',word:'CRAFT'},{label:'RISE',word:'RISE'},
];

// 30-Day challenge prompts
const CHALLENGE_30 = [
  'Your best spin','A move you learned this month','Combo under 4 moves','Hold for 10 seconds',
  'Invert from the floor','A move with pointed toes','Your current nemesis move','Flow practice â€” no stops',
  'Climb to the top','A move to music that matches your mood','Teach someone a move',
  'A drop you love','Body wave into a spin','Shoulder mount attempt','Floorwork only',
  'A move you nailed 6 months ago','Spin + invert combo','A pose held for 8 counts',
  'Something you filmed & hated â€” try again','Cross training (yoga, strength, stretch)',
  'A move outside your comfort zone','Freestyle to a song you love','Something from the Video Library',
  'A combo from the generator','Record a tutorial for yourself','Slow motion filming session',
  'Add a new move to your Routine Builder','A move that scared you once','Rest & recover mindfully',
  'Share your favourite move of the 30 days',
];

// Dare deck
const DARE_DECKS = {
  moves: [
    {e:'ðŸŽ¯',t:'Land your nemesis move 3 times in a row.',s:'Move Dare'},
    {e:'â±ï¸',t:'Hold any invert for 10 full seconds.',s:'Hold Challenge'},
    {e:'ðŸ”„',t:'Do a combo you have never done before â€” improvise.',s:'Improv Dare'},
    {e:'ðŸª©',t:'Spin for 30 seconds without stopping.',s:'Spin Marathon'},
    {e:'ðŸ¦¶',t:'Do an entire combo with pointed toes throughout.',s:'Technique Dare'},
    {e:'ðŸ‘†',t:'Film a tutorial for the move you are worst at.',s:'Teacher Dare'},
    {e:'ðŸŒ€',t:'5 different spins. No repeats.',s:'Spin Variety'},
    {e:'ðŸ§—',t:'Climb to the top and hold for a 5-count.',s:'Climb Dare'},
    {e:'ðŸ’«',t:'Do your favourite combo on your bad side only.',s:'Weak Side Dare'},
    {e:'ðŸŽ­',t:'Perform a 60-second improv to a random song.',s:'Freestyle Dare'},
    {e:'ðŸ“',t:'Every move must include a split or straddle.',s:'Flex Dare'},
    {e:'ðŸ‹ï¸',t:'Shoulder mount 5 times in a row.',s:'Strength Dare'},
    {e:'ðŸŒŠ',t:'Floorwork only for 2 full minutes.',s:'Floorwork Dare'},
    {e:'ðŸŽµ',t:'Pick a song you have never danced to. Go.',s:'Blind Music Dare'},
    {e:'â¬†ï¸',t:'Nail a move one level above your current PSO.',s:'Level Up Dare'},
  ],
  creative: [
    {e:'ðŸŽ¨',t:'Create a combo using only moves beginning with the same letter.',s:'Alphabet Dare'},
    {e:'ðŸ“–',t:'Spell your name using pole moves.',s:'Name Spell Dare'},
    {e:'ðŸŽ¬',t:'Film the same move from 3 different angles.',s:'Director Dare'},
    {e:'ðŸªž',t:'Mirror a video from someone you follow â€” exactly.',s:'Copy Cat Dare'},
    {e:'ðŸŽ­',t:'Do a combo that tells a story without words.',s:'Storyteller Dare'},
    {e:'ðŸŒˆ',t:'One move from each category: Spin, Invert, Drop, Floorwork.',s:'Rainbow Combo'},
    {e:'ðŸ”‡',t:'Dance a full minute in silence. No music.',s:'Silent Dare'},
    {e:'ðŸŒ™',t:'Film your session in different lighting or a new time of day.',s:'Aesthetic Dare'},
  ],
  social: [
    {e:'ðŸ“²',t:'Post a move you have been too scared to share.',s:'Courage Post'},
    {e:'ðŸ’¬',t:'Drop a tutorial in your stories for a beginner move.',s:'Teach It Dare'},
    {e:'ðŸ¤',t:'Tag another pole dancer and challenge them.',s:'Pass It On'},
    {e:'ðŸ†',t:'Post your best attempt at a PSO-scored routine.',s:'Competition Dare'},
    {e:'ðŸ“¸',t:'Post a BTS â€” set up, playlist, outfit & all.',s:'Behind the Scenes'},
    {e:'ðŸ”',t:'Repost something that inspired you this week.',s:'Gratitude Dare'},
  ],
};

// State
let alphaDone = JSON.parse(localStorage.getItem('pc_alpha_done') || '[]');
let alphaCustomMoves = JSON.parse(localStorage.getItem('pc_alpha_moves') || '{}');
let challenge30Data = JSON.parse(localStorage.getItem('pc_30day') || '{}');
let activeLetter = null;
let currentGame = null;
let rouletteActive = [];
let dareHistory = [];
let dareActiveDeck = 'moves';
let spellWordAlts = {};

// â”€â”€ GAME HUB â”€â”€
function renderGamesHub(){
  const el = document.getElementById('gamesPage');
  if(!el) return;
  const alphaDone30 = alphaDone.length;
  const ch30done = Object.values(challenge30Data).filter(Boolean).length;
  el.innerHTML = `
    <div style="margin-bottom:20px;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:26px;color:var(--accent2);font-style:italic;margin-bottom:4px;">ðŸŽ® Pole Games</div>
      <div style="font-size:9px;color:var(--dim);letter-spacing:0.16em;text-transform:uppercase;">Training challenges Â· Content prompts Â· Creative games</div>
    </div>
    <div class="games-hub">
      <div class="game-card gc-alpha" onclick="startGame('alpha')">
        <span class="game-emoji">ðŸ”¤</span>
        <div class="game-title">AlphaPole</div>
        <div class="game-desc">The classic Instagram challenge. One pole move for every letter of the alphabet â€” A to Z, 26 days. Pick a letter to see move suggestions and track your progress.</div>
        <div class="game-tag">${alphaDone30}/26 complete</div>
      </div>
      <div class="game-card gc-spell" onclick="startGame('spell')">
        <span class="game-emoji">âœï¸</span>
        <div class="game-title">Spell It</div>
        <div class="game-desc">Type any word and PoleCraft builds a combo where each move starts with that letter. Spell AYESHA, JADE, FIRE, your name â€” anything. Great for content themes.</div>
        <div class="game-tag">Word â†’ Combo</div>
      </div>
      <div class="game-card gc-30day" onclick="startGame('thirty')">
        <span class="game-emoji">ðŸ“…</span>
        <div class="game-title">30-Day Challenge</div>
        <div class="game-desc">A full month of daily pole prompts â€” from nemesis moves to freestyle sessions. Track your streak, check off days, and build a content series around it.</div>
        <div class="game-tag">${ch30done}/30 done</div>
      </div>
      <div class="game-card gc-roulette" onclick="startGame('roulette')">
        <span class="game-emoji">ðŸŽ°</span>
        <div class="game-title">Spin Roulette</div>
        <div class="game-desc">Spin the wheel and land on a random move from the database. Filter by category or level. Perfect for breaking out of training ruts and discovering moves you avoid.</div>
        <div class="game-tag">Random Move Generator</div>
      </div>
      <div class="game-card gc-dare" onclick="startGame('dare')">
        <span class="game-emoji">ðŸƒ</span>
        <div class="game-title">Dare Deck</div>
        <div class="game-desc">Draw a challenge card. Three decks: Move Dares, Creative Dares, and Social Dares. Each card pushes you somewhere new â€” great for when you do not know what to train.</div>
        <div class="game-tag">Draw a Card</div>
      </div>
    </div>`;
}

function startGame(game){
  currentGame = game;
  const el = document.getElementById('gamesPage');
  if(!el) return;
  if(game === 'alpha') renderAlphaPole();
  else if(game === 'spell') renderSpellIt();
  else if(game === 'thirty') renderThirtyDay();
  else if(game === 'roulette') renderRoulette();
  else if(game === 'dare') renderDare();
}

function backToHub(){
  currentGame = null;
  renderGamesHub();
}

function gameBackBtn(){
  return `<button class="ag-back" onclick="backToHub()">â† All Games</button>`;
}

// â”€â”€ ALPHAPOLE â”€â”€
function renderAlphaPole(){
  const el = document.getElementById('gamesPage');
  const done = alphaDone.length;
  const pct = Math.round((done/26)*100);
  let detailHtml = '';
  if(activeLetter){
    const d = ALPHA_MOVES[activeLetter];
    const customMove = alphaCustomMoves[activeLetter] || '';
    const isDone = alphaDone.includes(activeLetter);
    detailHtml = `
    <div class="alpha-detail">
      <div class="alpha-detail-letter">${activeLetter}</div>
      <div class="alpha-detail-move">${d.primary}</div>
      <div class="alpha-detail-alts">Alternatives: ${d.alts.join(' Â· ')}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <input style="flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:5px 10px;outline:none;" 
          placeholder="Override: type the move YOU did..." value="${customMove}"
          oninput="alphaCustomMoves['${activeLetter}']=this.value;localStorage.setItem('pc_alpha_moves',JSON.stringify(alphaCustomMoves));">
      </div>
      <button class="alpha-done-btn${isDone?' marked':''}" onclick="toggleAlphaDone('${activeLetter}')">
        ${isDone ? 'âœ“ Marked Done â€” undo?' : 'Mark as Done âœ“'}
      </button>
    </div>`;
  }

  el.innerHTML = `
    ${gameBackBtn()}
    <div class="ag-title">AlphaPole</div>
    <div class="ag-subtitle">26 letters Â· 26 moves Â· the classic IG challenge</div>
    <div class="alpha-progress">
      <div style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent);">${done}<span style="font-size:13px;color:var(--dim);">/26</span></div>
      <div class="alpha-prog-bar"><div class="alpha-prog-fill" style="width:${pct}%"></div></div>
      <div class="alpha-prog-text">${pct}% complete</div>
      <button class="ch-regen-btn" onclick="if(confirm('Reset all AlphaPole progress?')){alphaDone=[];alphaCustomMoves={};localStorage.removeItem('pc_alpha_done');localStorage.removeItem('pc_alpha_moves');activeLetter=null;renderAlphaPole();}">Reset</button>
    </div>
    ${detailHtml}
    <div class="alpha-grid">
      ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(l => {
        const isDone = alphaDone.includes(l);
        const custom = alphaCustomMoves[l];
        const moveName = custom || ALPHA_MOVES[l].primary;
        const shortName = moveName.length > 10 ? moveName.slice(0,9)+'â€¦' : moveName;
        return `<div class="alpha-cell${isDone?' done':''}${activeLetter===l?' active-letter':''}" onclick="activeLetter='${l}';renderAlphaPole();">
          ${isDone?'<div class="alpha-check">âœ“</div>':''}
          <div class="alpha-letter">${l}</div>
          <div class="alpha-move">${shortName}</div>
        </div>`;
      }).join('')}
    </div>`;
}

function toggleAlphaDone(letter){
  if(alphaDone.includes(letter)) alphaDone = alphaDone.filter(l=>l!==letter);
  else alphaDone.push(letter);
  localStorage.setItem('pc_alpha_done', JSON.stringify(alphaDone));
  renderAlphaPole();
}

// â”€â”€ SPELL IT â”€â”€
function renderSpellIt(word){
  const el = document.getElementById('gamesPage');
  const currentWord = word || '';
  let resultHtml = '';
  if(currentWord){
    const letters = currentWord.toUpperCase().replace(/[^A-Z]/g,'').split('');
    if(!spellWordAlts[currentWord]) spellWordAlts[currentWord] = {};
    resultHtml = `<div class="spell-result">${letters.map((l,i)=>{
      const d = ALPHA_MOVES[l];
      if(!d) return `<div class="spell-letter-row"><div class="spell-ltr">${l}</div><div class="spell-move-name" style="color:var(--dim);">No move found for ${l}</div></div>`;
      const altIdx = spellWordAlts[currentWord][i] || 0;
      const moveName = altIdx === 0 ? d.primary : d.alts[altIdx-1] || d.primary;
      return `<div class="spell-letter-row" style="animation-delay:${i*60}ms">
        <div class="spell-ltr">${l}</div>
        <div style="flex:1;">
          <div class="spell-move-name">${moveName}</div>
          <div class="spell-move-meta">${d.alts.length} alternatives available</div>
        </div>
        <button class="spell-alt-btn" onclick="cycleSpellAlt('${currentWord}',${i},${d.alts.length});renderSpellIt('${currentWord}');">â†º Alt</button>
      </div>`;
    }).join('')}</div>`;
  }
  el.innerHTML = `
    ${gameBackBtn()}
    <div class="ag-title">Spell It</div>
    <div class="ag-subtitle">Type a word Â· each letter becomes a pole move Â· instant combo</div>
    <div class="spell-area">
      <div class="spell-input-row">
        <input class="spell-in" id="spellWordIn" placeholder="Type a word..." maxlength="12" value="${currentWord}"
          onkeydown="if(event.key==='Enter')doSpell()">
        <button class="spell-go-btn" onclick="doSpell()"><span>Spell It â†’</span></button>
      </div>
      <div style="font-size:8px;color:var(--dim);margin-bottom:12px;letter-spacing:0.1em;text-transform:uppercase;">Try a preset:</div>
      <div class="spell-presets">
        ${SPELL_PRESETS.map(p=>`<button class="spell-preset" onclick="renderSpellIt('${p.word}')">${p.label}</button>`).join('')}
      </div>
      ${resultHtml}
    </div>`;
  if(currentWord) document.getElementById('spellWordIn').value = currentWord;
}

function doSpell(){
  const w = (document.getElementById('spellWordIn')?.value||'').trim();
  if(!w){showToast('Type a word first!');return;}
  spellWordAlts = {};
  renderSpellIt(w.toUpperCase());
}

function cycleSpellAlt(word, idx, altCount){
  if(!spellWordAlts[word]) spellWordAlts[word] = {};
  const cur = spellWordAlts[word][idx] || 0;
  spellWordAlts[word][idx] = (cur + 1) % (altCount + 1);
}

// â”€â”€ 30-DAY CHALLENGE â”€â”€
function renderThirtyDay(){
  const el = document.getElementById('gamesPage');
  const done = Object.values(challenge30Data).filter(Boolean).length;
  const today = new Date().getDate();
  const pct = Math.round((done/30)*100);
  el.innerHTML = `
    ${gameBackBtn()}
    <div class="ag-title">30-Day Challenge</div>
    <div class="ag-subtitle">One prompt every day Â· build a content series Â· track your streak</div>
    <div class="ch-progress">
      <div>
        <div class="ch-prog-nums">${done}<span style="font-size:14px;color:var(--dim);">/30</span></div>
        <div class="ch-prog-lbl">Days Done</div>
      </div>
      <div class="ch-prog-bar"><div class="ch-prog-fill" style="width:${pct}%"></div></div>
      <button class="ch-regen-btn" onclick="if(confirm('Reset all 30-day progress?')){challenge30Data={};localStorage.removeItem('pc_30day');renderThirtyDay();}">Reset</button>
    </div>
    <div class="challenge-grid">
      ${CHALLENGE_30.map((prompt,i)=>{
        const day = i+1;
        const isDone = challenge30Data[day];
        const isToday = day === today;
        return `<div class="ch-day${isDone?' done':''}${isToday?' today':''}" onclick="toggle30Day(${day})">
          <div class="ch-day-num">Day ${day}</div>
          <div class="ch-day-move">${prompt}</div>
          ${isDone?'<div class="ch-day-check">âœ“</div>':''}
        </div>`;
      }).join('')}
    </div>`;
}

function toggle30Day(day){
  challenge30Data[day] = !challenge30Data[day];
  localStorage.setItem('pc_30day', JSON.stringify(challenge30Data));
  renderThirtyDay();
}

// â”€â”€ SPIN ROULETTE â”€â”€
let rouletteFilterCats = new Set(['Spin','Invert','Mount','Drop','Pose','Trick','Hold','Climb','Transition','Floor']);

function renderRoulette(result){
  const el = document.getElementById('gamesPage');
  const cats = ['Spin','Invert','Mount','Drop','Pose','Trick','Hold','Climb','Transition','Floor'];
  const resultHtml = result ? `
    <div class="roulette-result">
      <div style="font-size:9px;color:var(--dim);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:8px;">You landed on...</div>
      <div class="roulette-result-move">${result.name}</div>
      <div class="roulette-result-meta">PSO L${result.psoLevel} Â· ${result.cat}</div>
      ${result.desc?`<div class="roulette-result-desc">${result.desc}</div>`:''}
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button class="spell-alt-btn" style="padding:6px 16px;" onclick="spinRoulette()">â†º Spin Again</button>
        <button class="spell-alt-btn" style="padding:6px 16px;" onclick="addMoveToCombo('${result.name}')">+ Add to Combo</button>
      </div>
    </div>` : `
    <div style="text-align:center;padding:30px 0;color:var(--dim);font-size:10px;letter-spacing:0.14em;text-transform:uppercase;">Press Spin to land on a random move</div>`;

  el.innerHTML = `
    ${gameBackBtn()}
    <div class="ag-title">Spin Roulette</div>
    <div class="ag-subtitle">Random move from the database Â· filter by category</div>
    <div class="roulette-categories">
      ${cats.map(cat=>`<button class="roulette-cat-chip${rouletteFilterCats.has(cat)?' active':''}" onclick="toggleRouletteCat('${cat}')">${cat}</button>`).join('')}
    </div>
    <div class="roulette-area">
      <button class="roulette-spin-btn" onclick="spinRoulette()"><span>ðŸŽ° Spin</span></button>
      ${resultHtml}
    </div>`;
}

function toggleRouletteCat(cat){
  if(rouletteFilterCats.has(cat)) rouletteFilterCats.delete(cat);
  else rouletteFilterCats.add(cat);
  renderRoulette();
}

function spinRoulette(){
  const pool = MOVES.filter(m => rouletteFilterCats.has(m.cat));
  if(!pool.length){showToast('No moves match your filters!');return;}
  const picked = pool[Math.floor(Math.random()*pool.length)];
  renderRoulette(picked);
}

function addMoveToCombo(name){
  const move = MOVES.find(m=>m.name===name);
  if(!move) return;
  if(!currentCombo) currentCombo={moves:[]};
  if(!currentCombo.moves) currentCombo.moves=[];
  currentCombo.moves.push(move);
  renderCombo(currentCombo);
  showToast(name+' added to combo!');
}

// â”€â”€ DARE DECK â”€â”€
function renderDare(drawn){
  const el = document.getElementById('gamesPage');
  const decks = [{id:'moves',label:'Move Dares'},{id:'creative',label:'Creative'},{id:'social',label:'Social'}];
  const cardHtml = drawn ? `
    <div class="dare-card" style="animation:fUp 0.3s ease;">
      <div class="dare-emoji">${drawn.e}</div>
      <div class="dare-text">${drawn.t}</div>
      <div class="dare-sub">${drawn.s}</div>
    </div>` : `
    <div class="dare-card" style="border-top-color:var(--border);">
      <div class="dare-emoji">ðŸƒ</div>
      <div class="dare-text" style="color:var(--dim);">Draw a card to get your dare</div>
    </div>`;

  const histHtml = dareHistory.length ? `
    <div class="dare-history">
      <div style="font-size:7px;letter-spacing:0.2em;text-transform:uppercase;color:var(--dim);margin-bottom:6px;">Previous Cards</div>
      ${dareHistory.slice(-4).reverse().map((d,i)=>`
        <div class="dare-hist-item">
          <div class="dare-hist-num">${d.e}</div>
          <div style="flex:1;">${d.t}</div>
          <div style="font-size:7px;color:var(--dim);">${d.s}</div>
        </div>`).join('')}
    </div>` : '';

  el.innerHTML = `
    ${gameBackBtn()}
    <div class="ag-title">Dare Deck</div>
    <div class="ag-subtitle">Draw a challenge card Â· three decks Â· never train the same way twice</div>
    <div class="dare-type-chips">
      ${decks.map(d=>`<button class="dare-chip${dareActiveDeck===d.id?' active':''}" onclick="dareActiveDeck='${d.id}';renderDare();">${d.label}</button>`).join('')}
    </div>
    <div class="dare-area">
      ${cardHtml}
      <button class="dare-draw-btn" onclick="drawDare()"><span>ðŸƒ Draw Card</span></button>
      ${histHtml}
    </div>`;
}

function drawDare(){
  const deck = DARE_DECKS[dareActiveDeck] || DARE_DECKS.moves;
  const card = deck[Math.floor(Math.random()*deck.length)];
  dareHistory.push(card);
  renderDare(card);
}

// Init games when tab opens
function initGames(){
  renderGamesHub();
}

// ============================================================
// JOURNAL & TRACKER
// ============================================================
const FEELING_EMOJIS = ['ðŸ˜´','ðŸ˜ž','ðŸ˜','ðŸ™‚','ðŸ˜Š','ðŸ’ª','ðŸ”¥'];
const FEELING_WORDS_BEFORE = ['stiff','tired','anxious','unfocused','heavy','nervous','ready','energised','focused','strong','excited','calm'];
const FEELING_WORDS_AFTER  = ['proud','exhausted','flowing','strong','accomplished','frustrated','calm','euphoric','sore','alive','creative','grounded'];
const ACTIVITIES = [
  {id:'trained', icon:'ðŸŽ¯', label:'Trained', cls:'active-trained'},
  {id:'filmed',  icon:'ðŸŽ¬', label:'Filmed',  cls:'active-filmed'},
  {id:'stretched',icon:'ðŸ§˜',label:'Stretch / Recovery', cls:'active-stretched'},
  {id:'rest',    icon:'ðŸ’¤', label:'Rest Day', cls:'active-rest'},
];
const GOAL_TIERS = ['This Week','This Month','Big Dreams'];
const GOAL_STATUS = ['notstarted','inprogress','landed'];
const GOAL_STATUS_ICONS = {'notstarted':'â—‹','inprogress':'â—‘','landed':'ðŸ”¥'};

// Storage keys
const K_TRACKER  = 'pc_tracker';
const K_JOURNAL  = 'pc_journal';
const K_GOALS    = 'pc_goals';

let trackerData   = JSON.parse(localStorage.getItem(K_TRACKER)  || '{}');
let journalData   = JSON.parse(localStorage.getItem(K_JOURNAL)  || '[]');
let goalsData     = JSON.parse(localStorage.getItem(K_GOALS)    || '[]');
let trackerMonth  = new Date().getMonth();
let trackerYear   = new Date().getFullYear();
let selectedDay   = null;
let showingJournalForm = false;
let journalFormState   = {};
let showGoalForm       = false;
let showArchive        = false;
let newGoalTier        = 'This Month';


// â”€â”€ SIDEBAR STREAK CARD â”€â”€
function renderJournalStreakCard(){
  const el = document.getElementById('journalStreakCard');
  if(!el) return;
  // Calculate current streak
  let streak = 0;
  const today = new Date();
  for(let i=0; i<90; i++){
    const d = new Date(today);
    d.setDate(d.getDate()-i);
    const key = d.toISOString().slice(0,10);
    const entry = trackerData[key];
    if(entry && entry.activities && entry.activities.length) streak++;
    else if(i>0) break;
  }
  // Monthly totals
  const monthKeys = Object.keys(trackerData).filter(k=>k.startsWith(`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`));
  const monthTrained = monthKeys.filter(k=>trackerData[k]?.activities?.includes('trained')).length;
  const monthFilmed  = monthKeys.filter(k=>trackerData[k]?.activities?.includes('filmed')).length;
  const goalsLanded  = goalsData.filter(g=>g.status==='landed').length;

  el.innerHTML = `
    <div class="jsc-title">Your Journey</div>
    <div class="jsc-streak">${streak}</div>
    <div class="jsc-streak-lbl">Day Streak ðŸ”¥</div>
    <div class="jsc-stats">
      <div class="jsc-stat"><div class="jsc-stat-n">${monthTrained}</div><div class="jsc-stat-l">Trained</div></div>
      <div class="jsc-stat"><div class="jsc-stat-n">${monthFilmed}</div><div class="jsc-stat-l">Filmed</div></div>
      <div class="jsc-stat"><div class="jsc-stat-n">${journalData.length}</div><div class="jsc-stat-l">Entries</div></div>
      <div class="jsc-stat"><div class="jsc-stat-n">${goalsLanded}</div><div class="jsc-stat-l">Landed ðŸ”¥</div></div>
    </div>`;
}

// â”€â”€ SECTION SWITCHING â”€â”€
function showJournalSection(sec, btn){
  document.querySelectorAll('.journal-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.jnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('jsec-'+sec).classList.add('active');
  if(btn) btn.classList.add('active');
  if(sec==='tracker')  renderTracker();
  if(sec==='sessions') renderSessionJournal();
  if(sec==='goals')    renderGoals();
}

function initJournal(){
  renderJournalStreakCard();
  renderTracker();
}

// ============================================================
// CONSISTENCY TRACKER
// ============================================================
function renderTracker(){
  const el = document.getElementById('jsec-tracker');
  if(!el) return;
  const monthName = new Date(trackerYear, trackerMonth, 1).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const firstDay  = new Date(trackerYear, trackerMonth, 1).getDay();
  const daysIn    = new Date(trackerYear, trackerMonth+1, 0).getDate();
  const today     = new Date();
  const todayStr  = today.toISOString().slice(0,10);

  // Build day-panel HTML if a day is selected
  let dayPanelHtml = '';
  if(selectedDay){
    const dkey = selectedDay;
    const entry = trackerData[dkey] || {activities:[],note:''};
    const dLabel = new Date(dkey+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    dayPanelHtml = `
      <div class="tracker-day-panel">
        <div class="tdp-date">${dLabel}</div>
        <div class="tdp-activity-grid">
          ${ACTIVITIES.map(a=>`
            <div class="tdp-act${(entry.activities||[]).includes(a.id)?' '+a.cls:''}" onclick="toggleTrackerActivity('${dkey}','${a.id}')">
              <span class="tdp-act-icon">${a.icon}</span>
              <span class="tdp-act-lbl">${a.label}</span>
            </div>`).join('')}
        </div>
        <textarea class="tdp-note-in" rows="2" placeholder="Quick note â€” how did it feel? What did you work on?" 
          oninput="updateTrackerNote('${dkey}',this.value)">${entry.note||''}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="tdp-save-btn" onclick="selectedDay=null;renderTracker();renderJournalStreakCard();">Done âœ“</button>
          <button class="tdp-save-btn" style="border-color:var(--l3);color:var(--l3);" onclick="openJournalFormForDay('${dkey}')">+ Journal Entry</button>
        </div>
      </div>`;
  }

  // Build calendar
  let calHtml = '';
  // Empty cells before first day
  for(let i=0;i<firstDay;i++) calHtml += `<div class="tracker-bubble tb-empty"></div>`;
  for(let d=1;d<=daysIn;d++){
    const dkey = `${trackerYear}-${String(trackerMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const entry = trackerData[dkey];
    const acts  = entry?.activities || [];
    const isToday = dkey===todayStr;
    const isFuture= new Date(dkey+'T12:00:00') > today && !isToday;
    const isSelected = dkey===selectedDay;
    let cls = 'tracker-bubble';
    if(isFuture) cls+=' tb-future';
    else if(acts.length>1) cls+=' tb-multi';
    else if(acts.includes('trained')) cls+=' tb-trained';
    else if(acts.includes('filmed'))  cls+=' tb-filmed';
    else if(acts.includes('stretched')) cls+=' tb-stretched';
    else if(acts.includes('rest'))    cls+=' tb-rest';
    if(isToday)    cls+=' tb-today';
    if(isSelected) cls+=' tb-today';
    const icons = acts.map(a=>ACTIVITIES.find(x=>x.id===a)?.icon||'').join('');
    calHtml += `<div class="${cls}" onclick="selectedDay='${dkey}';renderTracker();" title="${dkey}">
      <div class="tracker-date-num">${d}</div>
      <div class="tracker-bubble-icons">${icons}</div>
    </div>`;
  }

  // Monthly stats
  const allKeys = Object.keys(trackerData).filter(k=>k.startsWith(`${trackerYear}-${String(trackerMonth+1).padStart(2,'0')}`));
  const trainDays = allKeys.filter(k=>(trackerData[k]?.activities||[]).includes('trained')).length;
  const filmDays  = allKeys.filter(k=>(trackerData[k]?.activities||[]).includes('filmed')).length;
  const stretchDays=allKeys.filter(k=>(trackerData[k]?.activities||[]).includes('stretched')).length;
  const activeDays= allKeys.filter(k=>(trackerData[k]?.activities||[]).length>0).length;

  el.innerHTML = `
    <div class="tracker-header">
      <div class="tracker-title">Consistency Tracker</div>
      <div class="tracker-month-nav">
        <button class="tracker-nav-btn" onclick="trackerMonth--;if(trackerMonth<0){trackerMonth=11;trackerYear--;}renderTracker();">â€¹</button>
        <div class="tracker-month-lbl">${monthName}</div>
        <button class="tracker-nav-btn" onclick="trackerMonth++;if(trackerMonth>11){trackerMonth=0;trackerYear++;}renderTracker();">â€º</button>
      </div>
    </div>

    <div class="tracker-legend">
      <div class="tleg"><div class="tleg-dot" style="background:rgba(201,169,110,0.5);border:1px solid var(--accent);border-radius:50%;"></div>Trained (${trainDays})</div>
      <div class="tleg"><div class="tleg-dot" style="background:rgba(160,110,201,0.5);border:1px solid var(--l5);border-radius:50%;"></div>Filmed (${filmDays})</div>
      <div class="tleg"><div class="tleg-dot" style="background:rgba(110,201,176,0.5);border:1px solid var(--l1);border-radius:50%;"></div>Stretched (${stretchDays})</div>
      <div class="tleg"><div class="tleg-dot" style="background:rgba(123,159,212,0.5);border:1px solid var(--l2);border-radius:50%;"></div>Rest</div>
      <div style="margin-left:auto;font-size:8px;color:var(--dim);letter-spacing:0.1em;">${activeDays} active days this month</div>
    </div>

    ${dayPanelHtml}

    <div class="tracker-dow">
      ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="tracker-dow-lbl">${d}</div>`).join('')}
    </div>
    <div class="tracker-grid">${calHtml}</div>`;
}

function toggleTrackerActivity(dkey, actId){
  if(!trackerData[dkey]) trackerData[dkey]={activities:[],note:''};
  const acts = trackerData[dkey].activities;
  const idx = acts.indexOf(actId);
  if(idx>-1) acts.splice(idx,1); else acts.push(actId);
  saveTracker();
  renderTracker();
  renderJournalStreakCard();
}

function updateTrackerNote(dkey, val){
  if(!trackerData[dkey]) trackerData[dkey]={activities:[],note:''};
  trackerData[dkey].note = val;
  saveTracker();
}

// ============================================================
// SESSION JOURNAL
// ============================================================
function renderSessionJournal(){
  const el = document.getElementById('jsec-sessions');
  if(!el) return;
  const formHtml = showingJournalForm ? buildJournalForm() : '';
  const entriesHtml = journalData.length
    ? journalData.slice().reverse().map((e,i)=>buildEntryCard(e, journalData.length-1-i)).join('')
    : `<div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">No journal entries yet â€” start your first session</div></div>`;

  el.innerHTML = `
    <div class="sj-header">
      <div class="sj-title">Session Journal</div>
      ${!showingJournalForm ? `<button class="sj-new-btn" onclick="showingJournalForm=true;journalFormState={before:{emoji:'',energy:5,words:[]},after:{emoji:'',energy:5,words:[]}};renderSessionJournal();">+ New Entry</button>` : ''}
    </div>
    ${formHtml}
    <div class="sj-entries">${entriesHtml}</div>`;
}

function buildJournalForm(){
  const bf = journalFormState.before || {emoji:'',energy:5,words:[]};
  const af = journalFormState.after  || {emoji:'',energy:5,words:[]};
  const today = new Date().toISOString().slice(0,10);
  return `
  <div class="sj-form">
    <div class="sj-form-title">New Session Entry</div>
    <div class="sj-form-grid">
      <div class="sj-field">
        <div class="sj-lbl">Date</div>
        <input class="sj-in" type="date" id="sjDate" value="${today}">
      </div>
      <div class="sj-field">
        <div class="sj-lbl">Session Title / Move Focus</div>
        <input class="sj-in" id="sjTitle" placeholder="e.g. Jade split attempts, shoulder mount day...">
      </div>
      <div class="sj-field full">
        <div class="sj-lbl">Photo (optional)</div>
        <div class="sj-photo-area" onclick="document.getElementById('sjPhotoUp').click()">
          <input type="file" id="sjPhotoUp" accept="image/*" style="display:none" onchange="handleJournalPhoto(this)">
          ${journalFormState.photo ? `<img src="${journalFormState.photo}" alt="session photo">` : ''}
          <span class="sj-photo-icon">${journalFormState.photo ? 'ðŸ“¸' : 'ðŸ“·'}</span>
          <span class="sj-photo-label">${journalFormState.photo ? 'Tap to change' : 'Upload a photo from this session'}</span>
        </div>
      </div>
    </div>

    ${buildFeelingBlock('before', bf)}

    <div class="sj-field" style="margin-bottom:16px;">
      <div class="sj-lbl" style="margin-bottom:6px;">Session Notes</div>
      <textarea class="sj-notes" id="sjNotes" rows="4" placeholder="What did you work on? What clicked? What frustrated you? How did movement feel today?"></textarea>
    </div>

    ${buildFeelingBlock('after', af)}

    <div class="sj-submit-row">
      <button class="sj-cancel-btn" onclick="showingJournalForm=false;renderSessionJournal();">Cancel</button>
      <button class="sj-save-entry-btn" onclick="saveJournalEntry()">Save Entry â†’</button>
    </div>
  </div>`;
}

function buildFeelingBlock(when, state){
  const label = when === 'before' ? 'Before â€” How are you feeling?' : 'After â€” How do you feel now?';
  const words = when === 'before' ? FEELING_WORDS_BEFORE : FEELING_WORDS_AFTER;
  return `
  <div class="feeling-block" style="margin-bottom:14px;">
    <div class="feeling-title">${label}</div>
    <div class="feeling-emoji-row">
      ${FEELING_EMOJIS.map(e=>`<button class="feeling-emoji-btn${state.emoji===e?' sel':''}" onclick="journalFormState.${when}.emoji='${e}';reRenderFeelingBlocks();">${e}</button>`).join('')}
    </div>
    <div class="feeling-energy">
      <div class="feeling-energy-lbl"><span>Low Energy</span><span>Energy: ${state.energy||5}/10</span><span>High Energy</span></div>
      <input type="range" class="feeling-energy-slider" min="1" max="10" value="${state.energy||5}"
        oninput="journalFormState.${when}.energy=parseInt(this.value);this.previousElementSibling.children[1].textContent='Energy: '+this.value+'/10'">
    </div>
    <div class="sj-lbl" style="margin-bottom:6px;">Words that describe this moment:</div>
    <div class="feeling-words">
      ${words.map(w=>`<button class="feeling-word${(state.words||[]).includes(w)?' sel':''}" onclick="toggleFeelingWord('${when}','${w}')">${w}</button>`).join('')}
    </div>
  </div>`;
}

function reRenderFeelingBlocks(){
  const form = document.querySelector('.sj-form');
  if(!form) return;
  const bf = journalFormState.before || {};
  const af = journalFormState.after  || {};
  form.querySelectorAll('.feeling-block').forEach((block,i)=>{
    const when = i===0?'before':'after';
    const state = i===0?bf:af;
    const words = when==='before'?FEELING_WORDS_BEFORE:FEELING_WORDS_AFTER;
    block.querySelectorAll('.feeling-emoji-btn').forEach(btn=>{
      btn.classList.toggle('sel', btn.textContent===state.emoji);
    });
    block.querySelectorAll('.feeling-word').forEach(btn=>{
      btn.classList.toggle('sel', (state.words||[]).includes(btn.textContent));
    });
  });
}

function toggleFeelingWord(when, word){
  const arr = journalFormState[when].words = journalFormState[when].words||[];
  const idx = arr.indexOf(word);
  if(idx>-1) arr.splice(idx,1); else arr.push(word);
  reRenderFeelingBlocks();
}

function handleJournalPhoto(input){
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => { journalFormState.photo = e.target.result; renderSessionJournal(); };
  reader.readAsDataURL(file);
}

function saveJournalEntry(){
  const entry = {
    id: Date.now(),
    date: document.getElementById('sjDate')?.value || new Date().toISOString().slice(0,10),
    title: document.getElementById('sjTitle')?.value || '',
    photo: journalFormState.photo || null,
    notes: document.getElementById('sjNotes')?.value || '',
    before: {...(journalFormState.before||{})},
    after:  {...(journalFormState.after||{})},
  };
  journalData.push(entry);
  saveJournal();
  showingJournalForm = false;
  journalFormState = {};
  // Also auto-log trained on that date
  const dkey = entry.date;
  if(!trackerData[dkey]) trackerData[dkey]={activities:[],note:''};
  if(!trackerData[dkey].activities.includes('trained')) trackerData[dkey].activities.push('trained');
  saveTracker();
  renderSessionJournal();
  renderJournalStreakCard();
  showToast('Session entry saved!');
}

function openJournalFormForDay(dkey){
  showingJournalForm = true;
  journalFormState = {before:{emoji:'',energy:5,words:[]},after:{emoji:'',energy:5,words:[]}, prefillDate: dkey};
  showJournalSection('sessions', document.querySelectorAll('.jnav-btn')[1]);
  setTimeout(()=>{const el=document.getElementById('sjDate');if(el)el.value=dkey;},50);
}

function deleteJournalEntry(idx){
  if(!confirm('Delete this entry?')) return;
  journalData.splice(idx,1);
  saveJournal();
  renderSessionJournal();
  renderJournalStreakCard();
}

function buildEntryCard(entry, idx){
  const dateLabel = new Date(entry.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'long',day:'numeric',year:'numeric'});
  const bMood = entry.before?.emoji||'';
  const aMood = entry.after?.emoji||'';
  const bWords = (entry.before?.words||[]).join(', ');
  const aWords = (entry.after?.words||[]).join(', ');
  const bEnergy = entry.before?.energy||'â€”';
  const aEnergy = entry.after?.energy||'â€”';
  return `
  <div class="sj-entry-card">
    <div class="sj-entry-top">
      <div style="flex:1;">
        <div class="sj-entry-date">${dateLabel}</div>
        ${entry.title?`<div style="font-size:13px;color:var(--muted);margin-bottom:6px;">${entry.title}</div>`:''}
        <div class="sj-entry-mood-row">
          ${bMood?`<span class="sj-entry-mood" title="Before">${bMood}</span>`:''}
          ${bMood&&aMood?`<span style="font-size:10px;color:var(--dim);">â†’</span>`:''}
          ${aMood?`<span class="sj-entry-mood" title="After">${aMood}</span>`:''}
          ${bEnergy&&aEnergy?`<span style="font-size:8px;color:var(--dim);margin-left:6px;">Energy ${bEnergy}â†’${aEnergy}</span>`:''}
        </div>
        ${bWords||aWords?`<div class="sj-entry-words">
          ${(entry.before?.words||[]).map(w=>`<span class="sj-entry-word" style="border-color:rgba(123,159,212,0.3);color:var(--l2);">${w}</span>`).join('')}
          ${(entry.after?.words||[]).map(w=>`<span class="sj-entry-word" style="border-color:rgba(110,201,176,0.3);color:var(--l1);">${w}</span>`).join('')}
        </div>`:''}
      </div>
      ${entry.photo?`<img class="sj-entry-photo" src="${entry.photo}" alt="session">` : ''}
      <button class="sj-entry-del" onclick="deleteJournalEntry(${idx})">âœ•</button>
    </div>
    ${entry.notes?`<div class="sj-entry-notes">${entry.notes}</div>`:''}
  </div>`;
}

// ============================================================
// POLE GOALS
// ============================================================
function renderGoals(){
  const el = document.getElementById('jsec-goals');
  if(!el) return;
  const active   = goalsData.filter(g=>g.status!=='landed');
  const archived = goalsData.filter(g=>g.status==='landed');

  const formHtml = showGoalForm ? `
    <div class="goal-add-form open">
      <div class="goal-add-row">
        <input class="goal-add-in" id="goalIn" placeholder="e.g. Land my jade split, get shoulder mount clean..." onkeydown="if(event.key==='Enter')addGoalItem()">
        <select class="goal-tier-sel" id="goalTierSel" onchange="newGoalTier=this.value">
          ${GOAL_TIERS.map(t=>`<option value="${t}"${t===newGoalTier?' selected':''}>${t}</option>`).join('')}
        </select>
      </div>
      <input class="goal-add-note-in" id="goalNoteIn" placeholder="Optional: why this goal matters, what training it needs..." style="margin-bottom:8px;">
      <div style="display:flex;gap:8px;">
        <button class="goal-add-save" onclick="addGoalItem()">Add Goal</button>
        <button class="sj-cancel-btn" style="padding:8px 14px;" onclick="showGoalForm=false;renderGoals();">Cancel</button>
      </div>
    </div>` : '';

  const tiersHtml = GOAL_TIERS.map(tier=>{
    const tierGoals = active.filter(g=>g.tier===tier);
    return `
    <div class="goals-tier">
      <div class="goals-tier-hdr">
        <div class="goals-tier-title">${tier}</div>
        <div class="goals-tier-line"></div>
        <div class="goals-tier-count">${tierGoals.length}</div>
      </div>
      ${tierGoals.length ? tierGoals.map(g=>buildGoalItem(g)).join('') : `<div style="font-size:9px;color:var(--dim);padding:8px 0;font-style:italic;">No goals yet for this tier â€” add one above</div>`}
    </div>`;
  }).join('');

  const archiveHtml = archived.length ? `
    <div style="margin-top:8px;">
      <div class="goals-archive-toggle" onclick="showArchive=!showArchive;renderGoals();">
        ${showArchive?'â–¼':'â–º'} Landed Goals Archive (${archived.length}) ðŸ”¥
      </div>
      ${showArchive ? archived.map(g=>buildGoalItem(g)).join('') : ''}
    </div>` : '';

  el.innerHTML = `
    <div class="goals-header">
      <div class="goals-title">Pole Goals</div>
      <button class="goals-add-btn" onclick="showGoalForm=!showGoalForm;renderGoals();">${showGoalForm?'Cancel':'+ Add Goal'}</button>
    </div>
    ${formHtml}
    ${tiersHtml}
    ${archiveHtml}`;
}

function buildGoalItem(goal){
  const statusCls = goal.status==='landed'?'gs-landed':goal.status==='inprogress'?'gs-inprogress':'';
  const icon = GOAL_STATUS_ICONS[goal.status]||'â—‹';
  return `
  <div class="goal-item ${statusCls}" id="goal_${goal.id}">
    <button class="goal-status-btn ${statusCls}" onclick="cycleGoalStatus('${goal.id}')" title="Tap to update progress">${icon}</button>
    <div class="goal-body">
      <div class="goal-text">${goal.text}</div>
      ${goal.note?`<div class="goal-note">${goal.note}</div>`:''}
      ${goal.landedDate?`<div class="goal-landed-date">Landed ${goal.landedDate} ðŸ”¥</div>`:''}
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">
      <button class="goal-del" onclick="deleteGoal('${goal.id}')">âœ•</button>
      <div style="font-size:7px;color:var(--dim);letter-spacing:0.08em;">${goal.tier||''}</div>
    </div>
  </div>`;
}

function addGoalItem(){
  const text = document.getElementById('goalIn')?.value.trim();
  if(!text){showToast('Type a goal first');return;}
  const note = document.getElementById('goalNoteIn')?.value.trim()||'';
  const tier = document.getElementById('goalTierSel')?.value || newGoalTier;
  goalsData.push({id:'g'+Date.now(), text, note, tier, status:'notstarted', created: new Date().toLocaleDateString()});
  saveGoals();
  showGoalForm = false;
  renderGoals();
  renderJournalStreakCard();
}

function cycleGoalStatus(id){
  const goal = goalsData.find(g=>g.id===id); if(!goal) return;
  const idx = GOAL_STATUS.indexOf(goal.status);
  goal.status = GOAL_STATUS[(idx+1)%GOAL_STATUS.length];
  if(goal.status==='landed') goal.landedDate = new Date().toLocaleDateString();
  else delete goal.landedDate;
  saveGoals();
  renderGoals();
  renderJournalStreakCard();
  if(goal.status==='landed') showToast('Goal landed! ðŸ”¥');
}

function deleteGoal(id){
  if(!confirm('Remove this goal?')) return;
  goalsData = goalsData.filter(g=>g.id!==id);
  saveGoals();
  renderGoals();
  renderJournalStreakCard();
}

// ============================================================
// DRAGGABLE NAV + MULTI-PROFILE
// ============================================================

const NAV_PAGES_DEFAULT = [
  {id:'journal',  icon:'â—Ž', label:'Journal'},
  {id:'warmup',   icon:'â—Ž', label:'Warm-Up'},
  {id:'generator',icon:'âœ¦', label:'Combo Generator'},
  {id:'choreo',   icon:'â—ˆ', label:'Routine Builder'},
  {id:'studio',   icon:'â–¶', label:'Content Studio'},
  {id:'vidlib',   icon:'â—‰', label:'Video Library'},
  {id:'schedule', icon:'ðŸ“…', label:'Class Schedule'},
  {id:'pso',      icon:'â¬¡', label:'PSO Training'},
  {id:'teach',    icon:'â—­', label:'Teach'},
  {id:'flex',     icon:'â‹', label:'Flexibility'},
];

const NAV_ORDER_KEY    = 'pc_nav_order';
const ALL_PROFILES_KEY = 'pc_all_profiles';
const ACTIVE_PROFILE_KEY = 'pc_active_profile';

let navCustomizeMode = false;
let navDragSrc = null;
let navPages = [];
let allProfiles = [];
let activeProfileId = null;

// â”€â”€ NAV INIT â”€â”€

function resetNavOrder(){
  localStorage.removeItem('pc_nav_order');
  localStorage.removeItem('pc_nav_version');
  navPages = [...NAV_PAGES_DEFAULT];
  navCustomizeMode = false;
  const hint = document.getElementById('navCustomizeHint');
  if(hint) hint.remove();
  renderNav();
  renderMobileNav();
  showToast('Tabs reset â€” all tabs restored!');
}
function initNav(){
  // NAV_VERSION â€” bump this whenever new tabs are added to force a merge
  const NAV_VERSION = 3; // v3 added teach + flex
  const savedRaw = localStorage.getItem(NAV_ORDER_KEY);
  const savedVersion = parseInt(localStorage.getItem('pc_nav_version')||'0');
  const saved = JSON.parse(savedRaw || 'null');

  if(saved && Array.isArray(saved)){
    // Always merge: keep saved order, append any pages missing from it
    const savedIds = saved.map(p=>p.id);
    const missing = NAV_PAGES_DEFAULT.filter(p=>!savedIds.includes(p.id));
    // Also remove any stale ids that no longer exist in defaults
    const validIds = new Set(NAV_PAGES_DEFAULT.map(p=>p.id));
    const filtered = saved.filter(p=>validIds.has(p.id));
    navPages = [...filtered, ...missing];
    // Re-save the merged result and update version
    localStorage.setItem(NAV_ORDER_KEY, JSON.stringify(navPages));
    localStorage.setItem('pc_nav_version', NAV_VERSION);
  } else {
    navPages = [...NAV_PAGES_DEFAULT];
    localStorage.setItem('pc_nav_version', NAV_VERSION);
  }
  renderNav();
}

function renderNav(){
  const container = document.getElementById('navTabs');
  if(!container) return;
  container.style.display = 'flex';
  container.style.alignItems = 'stretch';

  const activeId = container.querySelector('.nav-tab.active')?.dataset?.page || 'generator';

  container.innerHTML = navPages.map(p => `
    <button class="nav-tab${p.id===activeId?' active':''}"
      data-page="${p.id}"
      draggable="${navCustomizeMode}"
      onclick="navTabClick(event,'${p.id}',this)"
      ondragstart="navDragStart(event,'${p.id}')"
      ondragover="navDragOver(event,'${p.id}')"
      ondragleave="navDragLeave(event)"
      ondrop="navDrop(event,'${p.id}')"
      ondragend="navDragEnd(event)"
      title="${navCustomizeMode?'Drag to reorder':p.label}">
      ${navCustomizeMode?`<span class="nav-tab-grip">â ¿</span>`:''}${p.icon} ${p.label}
    </button>`).join('') +
    `<button class="nav-customize-btn${navCustomizeMode?' active':''}" onclick="toggleNavCustomize()" title="${navCustomizeMode?'Done':'Customize tab order'}">
      ${navCustomizeMode?'âœ“ Done':'â ¿ Reorder'}
    </button>`;

  // Re-activate current page button
  container.querySelectorAll('.nav-tab').forEach(btn=>{
    if(btn.dataset.page === activeId) btn.classList.add('active');
  });
}

function navTabClick(e, pageId, btn){
  if(navCustomizeMode){ e.preventDefault(); return; }
  showPage(pageId, btn);
}

function toggleNavCustomize(){
  navCustomizeMode = !navCustomizeMode;
  // Show hint bar
  let hint = document.getElementById('navCustomizeHint');
  if(navCustomizeMode){
    if(!hint){
      hint = document.createElement('div');
      hint.id = 'navCustomizeHint';
      hint.className = 'nav-customize-hint';
      hint.innerHTML = 'â ¿ Drag tabs to reorder Â· click âœ“ Done when finished <button onclick="resetNavOrder()" style="margin-left:12px;padding:2px 8px;border:1px solid var(--border);background:transparent;color:var(--dim);font-family:\'DM Mono\',monospace;font-size:7px;cursor:pointer;letter-spacing:0.1em;" title="Restore all tabs">â†º Reset tabs</button>';
      document.getElementById('navTabs').insertAdjacentElement('afterend', hint);
    }
  } else {
    if(hint) hint.remove();
    saveNavOrder();
    showToast('Tab order saved!');
  }
  renderNav();
}

function navDragStart(e, pageId){
  if(!navCustomizeMode) return;
  navDragSrc = pageId;
  e.target.classList.add('nav-dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function navDragOver(e, pageId){
  if(!navCustomizeMode || navDragSrc===pageId) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('nav-drag-over');
}

function navDragLeave(e){
  e.currentTarget.classList.remove('nav-drag-over');
}

function navDrop(e, targetId){
  if(!navCustomizeMode || navDragSrc===targetId) return;
  e.preventDefault();
  e.currentTarget.classList.remove('nav-drag-over');
  const srcIdx = navPages.findIndex(p=>p.id===navDragSrc);
  const tgtIdx = navPages.findIndex(p=>p.id===targetId);
  if(srcIdx<0||tgtIdx<0) return;
  const [moved] = navPages.splice(srcIdx,1);
  navPages.splice(tgtIdx,0,moved);
  renderNav();
}

function navDragEnd(e){
  e.target.classList.remove('nav-dragging');
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('nav-drag-over'));
}

// â”€â”€ MULTI-PROFILE â”€â”€
function initProfiles(){
  allProfiles = JSON.parse(localStorage.getItem(ALL_PROFILES_KEY) || 'null');
  activeProfileId = localStorage.getItem(ACTIVE_PROFILE_KEY);

  // Migrate existing single profile into multi-profile system
  if(!allProfiles){
    const legacy = localStorage.getItem('pc_user_profile');
    if(legacy){
      try {
        const p = JSON.parse(legacy);
        p.id = 'profile_' + Date.now();
        allProfiles = [p];
        activeProfileId = p.id;
      } catch(e){ allProfiles = []; }
    } else {
      allProfiles = [];
    }
    saveProfiles();
  }

  // Set active
  if(activeProfileId && allProfiles.find(p=>p.id===activeProfileId)){
    pcUser = allProfiles.find(p=>p.id===activeProfileId);
  } else if(allProfiles.length > 0){
    pcUser = allProfiles[0];
    activeProfileId = pcUser.id;
  }

  if(pcUser){
    hidePortal();
    updateHeaderProfile();
    renderProfileSwitcher();
  } else {
    showPortal();
  }
}

function switchToProfile(id){
  const p = allProfiles.find(x=>x.id===id);
  if(!p) return;
  pcUser = p;
  activeProfileId = id;
  saveProfiles();
  updateHeaderProfile();
  renderProfileSwitcher();
  closeProfile();
  showToast('Switched to ' + p.name);
}

function addNewProfile(){
  // Reset pcUser to null, show portal as "new profile" flow
  pcUser = null;
  closeProfile();
  showPortal();
  // Override portalEnter to add to list instead of replacing
  window._addingNewProfile = true;
}

function deleteProfile(id){
  if(allProfiles.length <= 1){ showToast('Cannot delete your only profile'); return; }
  const p = allProfiles.find(x=>x.id===id);
  if(!confirm('Delete profile "' + (p?.name||'this profile') + '"? All data stays on this device.')) return;
  allProfiles = allProfiles.filter(x=>x.id!==id);
  if(activeProfileId===id){
    pcUser = allProfiles[0];
    activeProfileId = pcUser.id;
  }
  saveProfiles();
  updateHeaderProfile();
  renderProfileSwitcher();
}

function renderProfileSwitcher(){
  // Injected into profile drawer body
  const body = document.getElementById('pdBody');
  if(!body) return;
  // Re-render full drawer which includes switcher
  renderProfileDrawer();
}

// Patch portalEnter to support multi-profile
const _origPortalEnter = window.portalEnter;
function portalEnter(){
  const name = (document.getElementById('portalName')?.value || '').trim();
  if(!name){ document.getElementById('portalName').focus(); showToast('Enter your name to continue'); return; }

  const goals = [
    document.getElementById('portalGoal1')?.value.trim(),
    document.getElementById('portalGoal2')?.value.trim(),
    document.getElementById('portalGoal3')?.value.trim(),
  ].filter(Boolean).map(g=>({text:g,done:false,id:'g'+Date.now()+Math.random().toString(36).slice(2)}));

  const newProfile = {
    id: 'profile_' + Date.now(),
    name,
    level: portalSelectedLevel,
    avatar: portalAvatarDataUrl || null,
    emoji: portalAvatarDataUrl ? null : portalSelectedEmoji,
    goals,
    milestones: [],
    joinDate: new Date().toISOString(),
    badges: [],
  };

  if(window._addingNewProfile){
    allProfiles.push(newProfile);
    window._addingNewProfile = false;
  } else {
    // First time setup â€” replace or init
    if(allProfiles.length === 0){
      allProfiles.push(newProfile);
    } else {
      // Update existing active profile
      const idx = allProfiles.findIndex(p=>p.id===activeProfileId);
      if(idx>-1) allProfiles[idx] = {...allProfiles[idx], ...newProfile, id:allProfiles[idx].id};
      else allProfiles.push(newProfile);
    }
  }

  pcUser = newProfile;
  activeProfileId = newProfile.id;
  saveProfiles();
  // Also save to legacy key for compatibility
  localStorage.setItem('pc_user_profile', JSON.stringify(pcUser));
  hidePortal();
  updateHeaderProfile();
  checkBadges();
  showToast('Welcome to PoleCraft, ' + name + '!');
}

// Patch renderProfileDrawer to include profile switcher at top
const _origRenderProfileDrawer = window.renderProfileDrawer;
function renderProfileDrawer(){
  if(!pcUser) return;
  const body = document.getElementById('pdBody');
  if(!body) return;

  const levelColors = {'1':'var(--l1)','2':'var(--l2)','3':'var(--l3)','4':'var(--l4)','5':'var(--l5)','Training':'var(--accent)'};
  const lc = levelColors[pcUser.level] || 'var(--accent)';
  const savedCombos = JSON.parse(localStorage.getItem('pc_combos') || '[]').length;
  const savedRoutines = JSON.parse(localStorage.getItem('pc_routines') || '[]').length;
  const schedCount = JSON.parse(localStorage.getItem('pc_schedule') || '[]').filter(c => c.date >= new Date().toISOString().slice(0,10)).length;
  const studioData = JSON.parse(localStorage.getItem('pc_studio') || '{}');
  const videoCount = Object.values(studioData).reduce((a,d) => a + (Array.isArray(d) ? d.length : 0), 0);
  const joined = pcUser.joinDate ? new Date(pcUser.joinDate).toLocaleDateString('en-US',{month:'long',year:'numeric'}) : '';

  const goalsHtml = (pcUser.goals||[]).map(g => `
    <div class="pd-goal-row">
      <div class="pd-goal-check${g.done?' done':''}" onclick="toggleGoal('${g.id}')">${g.done?'âœ“':''}</div>
      <div class="pd-goal-text${g.done?' done':''}">${g.text}</div>
      <button class="pd-goal-del" onclick="deleteProfileGoal('${g.id}')">âœ•</button>
    </div>`).join('');

  const BADGE_DEFS = [
    {id:'first_combo',label:'First Combo',emoji:'ðŸŽ‰'},
    {id:'10_combos',label:'10 Combos',emoji:'ðŸ”Ÿ'},
    {id:'first_routine',label:'Choreographer',emoji:'ðŸ’ƒ'},
    {id:'video_planner',label:'Content Creator',emoji:'ðŸŽ¬'},
    {id:'scheduler',label:'Class Regular',emoji:'ðŸ“…'},
    {id:'level_up',label:'Level Up',emoji:'â¬†ï¸'},
  ];
  const badgesHtml = BADGE_DEFS.map(b=>{
    const earned=(pcUser.badges||[]).includes(b.id);
    return `<div class="pd-badge${earned?' earned':''}" title="${b.emoji}">${b.emoji} ${b.label}</div>`;
  }).join('');

  // Profile switcher section
  const switcherHtml = allProfiles.length > 0 ? `
    <div class="profile-switcher">
      <div class="ps-title">Profiles</div>
      <div class="ps-list">
        ${allProfiles.map(p=>`
          <div class="ps-item${p.id===activeProfileId?' ps-active':''}" onclick="switchToProfile('${p.id}')">
            <div class="ps-avatar">${p.avatar?`<img src="${p.avatar}" alt="">`:(p.emoji||'ðŸŽ­')}</div>
            <div>
              <div class="ps-name">${p.name}</div>
              <div class="ps-level">PSO L${p.level||'1'}</div>
            </div>
            ${allProfiles.length>1&&p.id!==activeProfileId?`<button class="ps-del-btn" onclick="event.stopPropagation();deleteProfile('${p.id}')">âœ•</button>`:''}
          </div>`).join('')}
        <button class="ps-add-btn" onclick="addNewProfile()">+ Add Profile</button>
      </div>
    </div>` : '';

  body.innerHTML = switcherHtml + `
    <div style="text-align:center;padding-top:4px;">
      <div class="pd-avatar-big" id="pdAvatarBig" onclick="document.getElementById('pdAvatarUpload').click()">
        ${pcUser.avatar?`<img src="${pcUser.avatar}" alt="avatar">`:(pcUser.emoji||'ðŸŽ­')}
      </div>
      <input type="file" id="pdAvatarUpload" accept="image/*" style="display:none" onchange="pdHandleAvatar(this)">
      <div class="pd-name-display">${pcUser.name}</div>
      <div class="pd-level-display" style="color:${lc};">PSO Level ${pcUser.level}</div>
      <div style="font-size:8px;color:var(--dim);margin-top:3px;">Member since ${joined}</div>
    </div>

    <div style="background:var(--bg3);border:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div class="fb-sync-dot" id="fbSyncDot2"></div>
      <div style="font-size:9px;color:var(--muted);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="fbAuthUser">Not signed in</div>
      <button class="fb-auth-btn" id="fbAuthBarBtn" onclick="showFbModal()" style="font-size:8px;padding:4px 10px;flex-shrink:0;">Sign In</button>
    </div>
    <div style="display:flex;gap:6px;" id="fbSyncActions">
      <button onclick="fbPushAllLocalData()" style="flex:1;padding:8px;border:1px solid var(--l1);background:transparent;color:var(--l1);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:0.08em;">â†‘ Push to Cloud</button>
      <button onclick="fbLoadAllData()" style="flex:1;padding:8px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:0.08em;">â†“ Pull from Cloud</button>
    </div>

    <div class="pd-section">
      <div class="pd-section-lbl">My Stats</div>
      <div class="pd-stat-grid">
        <div class="pd-stat-card"><div class="pd-stat-n">${savedCombos}</div><div class="pd-stat-l">Saved Combos</div></div>
        <div class="pd-stat-card"><div class="pd-stat-n">${savedRoutines}</div><div class="pd-stat-l">Routines</div></div>
        <div class="pd-stat-card"><div class="pd-stat-n">${videoCount}</div><div class="pd-stat-l">Videos Planned</div></div>
        <div class="pd-stat-card"><div class="pd-stat-n">${schedCount}</div><div class="pd-stat-l">Classes Upcoming</div></div>
      </div>
    </div>

    <div class="pd-section">
      <div class="pd-section-lbl">My Goals</div>
      <div id="pdGoalsList">${goalsHtml||'<div style="font-size:9px;color:var(--dim);padding:4px 0;">No goals yet</div>'}</div>
      <div class="pd-add-goal-row">
        <input class="pd-goal-in" id="pdGoalIn" placeholder="Add a new goal..." onkeydown="if(event.key===\'Enter\')addGoal()">
        <button class="pd-goal-add-btn" onclick="addGoal()">+</button>
      </div>
    </div>

    <div class="pd-section">
      <div class="pd-section-lbl">Badges</div>
      <div class="pd-badges">${badgesHtml}</div>
    </div>

    <div class="pd-section">
      <div class="pd-section-lbl">Profile Settings</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div>
          <div style="font-size:8px;color:var(--dim);letter-spacing:0.12em;margin-bottom:4px;">DISPLAY NAME</div>
          <input class="pd-goal-in" style="width:100%;font-size:10px;" id="pdNameEdit" value="${pcUser.name}" onblur="pdSaveName(this.value)">
        </div>
        <div>
          <div style="font-size:8px;color:var(--dim);letter-spacing:0.12em;margin-bottom:4px;">PSO LEVEL</div>
          <div style="display:flex;gap:5px;flex-wrap:wrap;">
            ${['1','2','3','4','5','Training'].map(l=>`<button class="portal-level-chip${pcUser.level===l?' active':''}" data-l="${l}" onclick="pdSetLevel('${l}',this)">${l==='Training'?'Training':'L'+l}</button>`).join('')}
          </div>
        </div>
        <div>
          <div style="font-size:8px;color:var(--dim);letter-spacing:0.12em;margin-bottom:4px;">AVATAR EMOJI</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;">${['ðŸŽ­','ðŸ’ƒ','ðŸ•º','ðŸŒ¸','âœ¨','ðŸ¦‹','ðŸ”¥','ðŸ’«','ðŸŒ™','â­','ðŸŽª','ðŸŽ¨','ðŸ‘‘','ðŸ¦š','ðŸŒº','ðŸ†','ðŸŽ¯','ðŸ’Ž','ðŸ¦„','ðŸŽ ','ðŸŒŠ','ðŸŽ¶','ðŸŒ¹','ðŸ¦…'].map(e=>`<span class="portal-avatar-emoji${pcUser.emoji===e&&!pcUser.avatar?' sel':''}" onclick="pdPickEmoji('${e}',this)">${e}</span>`).join('')}</div>
        </div>
      </div>
    </div>

    <div class="pd-section backup-section">
      <div class="pd-section-lbl">Data Backup</div>
      <div style="font-size:8px;color:var(--dim);line-height:1.6;margin-bottom:6px;">
        Export all your data to a file. Import it back anytime â€” even after a code update.
      </div>
      <div class="backup-btn-row">
        <button class="backup-btn export" onclick="exportAllData()">â¬‡ Export Backup</button>
        <button class="backup-btn import" onclick="document.getElementById('importFileIn').click()">â¬† Import Backup</button>
      </div>
      <input type="file" id="importFileIn" accept=".json" style="display:none;" onchange="importAllData(this)">
      <div class="backup-status" id="backupStatus"></div>
    </div>

    <div class="pd-section" style="padding-bottom:4px;">
      <button class="pd-signout-btn" onclick="portalSignOut()">Sign Out / Reset Profile</button>
    </div>`;
}

// Save profile changes back to allProfiles array
function _syncProfileToList(){
  if(!pcUser||!activeProfileId) return;
  const idx = allProfiles.findIndex(p=>p.id===activeProfileId);
  if(idx>-1) allProfiles[idx] = pcUser;
  saveProfiles();
}

// Patch pdSaveName, pdSetLevel, pdPickEmoji to also sync
const _origPdSaveName = window.pdSaveName;
function pdSaveName(v){
  if(!v.trim()) return;
  pcUser.name = v.trim();
  _syncProfileToList();
  updateHeaderProfile();
}

const _origPdSetLevel = window.pdSetLevel;
function pdSetLevel(l,btn){
  pcUser.level = l;
  _syncProfileToList();
  updateHeaderProfile();
  renderProfileDrawer();
}

const _origPdPickEmoji = window.pdPickEmoji;
function pdPickEmoji(e, el){
  pcUser.emoji = e;
  pcUser.avatar = null;
  _syncProfileToList();
  updateHeaderProfile();
  renderProfileDrawer();
}

const _origPdHandleAvatar = window.pdHandleAvatar;
function pdHandleAvatar(input){
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    pcUser.avatar = e.target.result;
    pcUser.emoji = null;
    _syncProfileToList();
    saveProfiles();
    updateHeaderProfile();
    renderProfileDrawer();
  };
  reader.readAsDataURL(file);
}

// ============================================================
// MOBILE BOTTOM NAV
// ============================================================
function renderMobileNav(){
  const inner = document.getElementById('mbnInner');
  if(!inner) return;
  const activeId = document.querySelector('.nav-tab.active')?.dataset?.page || 'generator';
  // Show first 5 pages in bottom nav (most used), rest accessible via top nav
  const mobilePages = navPages.slice(0,4);
  inner.innerHTML = mobilePages.map(p=>`
    <button class="mbn-btn${p.id===activeId?' active':''}" data-page="${p.id}" onclick="mbnClick('${p.id}',this)">
      <span class="mbn-icon">${p.icon}</span>
      <span>${p.label.split(' ')[0]}</span>
    </button>`).join('') +
    `<button class="mbn-btn" onclick="mbnMore(this)">
      <span class="mbn-icon">â‹¯</span>
      <span>More</span>
    </button>`;
}

function mbnClick(pageId, btn){
  // Find the matching top nav button and trigger showPage
  const topBtn = document.querySelector('.nav-tab[data-page="'+pageId+'"]');
  if(topBtn) showPage(pageId, topBtn);
  else showPage(pageId, {classList:{add:()=>{},remove:()=>{}}});
  // Update bottom nav active state
  document.querySelectorAll('.mbn-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function mbnMore(btn){
  // Show a quick picker for the remaining tabs
  const shown = navPages.slice(0,6).map(p=>p.id);
  const rest = navPages.filter(p=>!shown.includes(p.id));
  if(!rest.length){ showToast('All tabs shown below'); return; }
  // Simple dropdown-style overlay
  let picker = document.getElementById('mbnMorePicker');
  if(picker){ picker.remove(); return; }
  picker = document.createElement('div');
  picker.id = 'mbnMorePicker';
  picker.style.cssText = 'position:fixed;bottom:calc(60px + env(safe-area-inset-bottom,0px));left:0;right:0;background:var(--bg2);border-top:1px solid var(--border2);padding:12px;display:flex;flex-wrap:wrap;gap:8px;z-index:600;animation:fUp 0.15s ease;';
  picker.innerHTML = rest.map(p=>`
    <button onclick="mbnPickerClick('${p.id}')" style="flex:1;min-width:100px;padding:10px;background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.08em;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;">
      <span style="font-size:20px;">${p.icon}</span>
      <span>${p.label.split(' ')[0]}</span>
    </button>`).join('') +
    `<button onclick="document.getElementById('mbnMorePicker').remove()" style="position:absolute;top:8px;right:12px;background:none;border:none;color:var(--dim);font-size:16px;cursor:pointer;">âœ•</button>`;
  document.body.appendChild(picker);
}

function mbnPickerClick(pageId){
  const picker = document.getElementById('mbnMorePicker');
  if(picker) picker.remove();
  const topBtn = document.querySelector('.nav-tab[data-page="'+pageId+'"]');
  if(topBtn) showPage(pageId, topBtn);
  renderMobileNav();
}

// Sync bottom nav when showPage is called
const _origShowPage = window.showPage;
function showPage(n, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const pageEl = document.getElementById('page-'+n);
  if(pageEl) pageEl.classList.add('active');
  if(btn && btn.classList) btn.classList.add('active');
  if(n==='studio'){ renderStudio(); if(studioView==='film') renderFilmSchedule(); else if(studioView==='filter') renderStudioFilter(); }
  if(n==='journal') initJournal();
  if(n==='teach') initTeach();
  if(n==='flex') initFlex();
  // Sync mobile nav
  document.querySelectorAll('.mbn-btn[data-page]').forEach(b=>{
    b.classList.toggle('active', b.dataset.page===n);
  });
  // Scroll top nav tab into view
  const activeTab = document.querySelector('.nav-tab[data-page="'+n+'"]');
  if(activeTab) activeTab.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}

// ============================================================
// FIREBASE CLOUD SYNC
// ============================================================
const FB_CONFIG_KEY = 'pc_fb_config';
let fbApp = null;
let fbAuth = null;
let fbDb = null;
let fbUser = null;
let fbIsSignUp = false;
let fbSyncing = false;
let fbSyncTimer = null;

// â”€â”€ CONFIG â”€â”€
// â”€â”€ Hardcoded fallback config â€” no setup needed â”€â”€
const FB_HARDCODED_CONFIG = {
  "apiKey": "AIzaSyBtk80sQhVvW5FlwJHMHObgPa4OpY7CP4s",
  "authDomain": "polecraft-191b7.firebaseapp.com",
  "projectId": "polecraft-191b7",
  "storageBucket": "polecraft-191b7.firebasestorage.app",
  "messagingSenderId": "702567112294",
  "appId": "1:702567112294:web:9f13ff37bb2de436fad7a7",
  "measurementId": "G-335N41MHPF"
};

function getFbConfig(){
  // Try localStorage first (user may have pasted a different config)
  try{
    const saved = JSON.parse(localStorage.getItem(FB_CONFIG_KEY)||'null');
    if(saved && saved.apiKey) return saved;
  } catch(e){}
  // Always fall back to hardcoded config â€” no setup needed
  return FB_HARDCODED_CONFIG;
}

function fbSaveConfig(){
  let raw = document.getElementById('fbConfigIn')?.value.trim();
  if(!raw){ showToast('Paste your Firebase config first'); return; }

  // Auto-clean: handle JS object format (Firebase gives JS, not JSON)
  // Remove: const firebaseConfig = {...}; and const app = ...
  raw = raw.replace(/const\s+\w+\s*=\s*/g, '');  // remove "const x = "
  raw = raw.replace(/;\s*$/gm, '');                // remove trailing semicolons
  raw = raw.replace(/\/\/.*/g, '');                // remove // comments
  // Find the {...} object
  const match = raw.match(/\{[\s\S]*\}/);
  if(match) raw = match[0];
  // Add quotes around unquoted keys (JS object â†’ JSON)
  raw = raw.replace(/(\s*)(\w+)(\s*:)/g, '$1"$2"$3');
  // Remove trailing commas before }
  raw = raw.replace(/,(\s*[}\]])/g, '$1');

  try{
    const cfg = JSON.parse(raw);
    if(!cfg.apiKey||!cfg.projectId){
      showToast('Config missing apiKey or projectId');
      return;
    }
    localStorage.setItem(FB_CONFIG_KEY, JSON.stringify(cfg));
    showToast('Config saved â€” reloading...');
    setTimeout(()=>location.reload(), 800);
  } catch(e){
    // Show exactly what went wrong
    showToast('Could not parse config â€” try the JSON format');
    const status = document.getElementById('fbConfigStatus');
    if(status) status.textContent = 'Error: ' + e.message;
    console.error('Config parse error:', e, 'Raw:', raw);
  }
}

// â”€â”€ INIT FIREBASE â”€â”€
function initFirebase(){
  // Wait for Firebase SDK to load (it loads async from CDN)
  if(typeof firebase === 'undefined'){
    setTimeout(initFirebase, 200);
    return;
  }
  _doInitFirebase();
}

function _doInitFirebase(){
  const cfg = getFbConfig(); // always returns hardcoded config as fallback
  try{
    // Init or reuse app
    if(firebase.apps && firebase.apps.length){ fbApp = firebase.apps[0]; }
    else { fbApp = firebase.initializeApp(cfg); }
    fbAuth = firebase.auth();
    fbDb   = firebase.firestore();

    // Force auth to persist across sessions (fixes Safari/iOS clearing sign-in)
    fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>{
      console.warn('Persistence not supported:', e);
    });

    // Also store uid in localStorage as backup so we know they were signed in
    // Auth state listener
    fbAuth.onAuthStateChanged(user=>{
      fbUser = user;
      updateFbAuthBar();
      if(user){
        // Remember this user was signed in (backup for Safari)
        localStorage.setItem('pc_last_uid', user.uid);
        localStorage.setItem('pc_last_email', user.email || user.displayName || '');
        hideFbModal();
        fbLoadAllData(); // loads from cloud, then dismisses overlay
        fbStartLiveSync(); // subscribe to real-time updates
      } else {
        // Not signed in â€” try auto-reconnect with stored credentials
        const storedEmail = localStorage.getItem('pc_auth_email');
        const storedPass  = localStorage.getItem('pc_auth_pass');
        if(storedEmail && storedPass){
          setLoadingMsg('Reconnecting...');
          fbAuth.signInWithEmailAndPassword(storedEmail, storedPass)
            .then(()=>{ /* onAuthStateChanged will fire again with user */ })
            .catch(e=>{
              console.warn('Auto-reconnect failed:', e);
              localStorage.removeItem('pc_auth_email');
              localStorage.removeItem('pc_auth_pass');
              dismissLoadingOverlay('Sign in to sync your data');
            });
        } else {
          // Not signed in, no stored credentials â€” dismiss immediately
          dismissLoadingOverlay('');
        }
        if(fbLiveSyncUnsub){ fbLiveSyncUnsub(); fbLiveSyncUnsub=null; }
      }
    });
    // Safety net â€” if auth takes more than 5s, dismiss anyway
    setTimeout(()=>dismissLoadingOverlay(''), 1500);
    
    // Pull fresh data when app comes back into focus (switching tabs/apps)
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible' && fbUser && fbDb){
        const now = Date.now();
        if(now - (fbLastPull||0) > 30000){ // only if >30s since last pull
          fbLastPull = now;
          fbSilentPull();
        }
      }
    });

    // Show auth bar
    document.getElementById('fbAuthBar').classList.remove('hidden');
  } catch(e){
    console.error('Firebase init failed:', e);
    // Show the error so user knows what happened
    const bar = document.getElementById('fbAuthBar');
    if(bar){
      bar.classList.remove('hidden');
      document.getElementById('fbAuthUser').textContent = 'Config error: ' + e.message;
      const btn = document.getElementById('fbAuthBarBtn');
      btn.textContent = 'Fix Config';
      btn.onclick = ()=>{ showFbModal(); setTimeout(()=>{ document.getElementById('fbConfigBox').style.display='block'; },100); };
    }
    showToast('Firebase error: ' + e.message);
  }
}

// â”€â”€ AUTH BAR â”€â”€
function updateFbAuthBar(){
  // Update all sync dots (header avatar + profile drawer)
  const dots = document.querySelectorAll('.fb-sync-dot');
  const user  = document.getElementById('fbAuthUser');
  const btn   = document.getElementById('fbAuthBarBtn');
  const actions = document.getElementById('fbSyncActions');
  const mbnDot   = document.getElementById('mbnSyncDot');
  const mbnLabel = document.getElementById('mbnSyncLabel');
  const mbnBtn   = document.getElementById('mbnSyncBtn');

  if(fbUser){
    dots.forEach(d=>{ d.className='fb-sync-dot synced'; });
    if(user) user.textContent = fbUser.displayName || fbUser.email || 'Signed in';
    if(btn){ btn.textContent='Sign Out'; btn.style.borderColor='var(--border)'; btn.style.color='var(--dim)'; btn.onclick=fbSignOut; }
    if(actions) actions.style.display='flex';
    const badge = document.getElementById('profileSyncBadge');
    if(badge) badge.className='profile-sync-badge synced';
    if(mbnDot) mbnDot.className='mbn-sync-dot synced';
    if(mbnLabel) mbnLabel.textContent = (fbUser.displayName||fbUser.email||'').split(' ')[0].substring(0,8) || 'Synced';
    if(mbnBtn){ mbnBtn.onclick=fbSignOut; mbnBtn.style.color='var(--l1)'; }
  } else {
    dots.forEach(d=>{ d.className='fb-sync-dot'; });
    const lastEmail = localStorage.getItem('pc_last_email');
    if(user) user.textContent = lastEmail ? 'Tap to sign back in as '+lastEmail : 'Not signed in';
    if(btn){ btn.textContent='Sign In to Sync'; btn.style.borderColor='var(--accent)'; btn.style.color='var(--accent)'; btn.onclick=showFbModal; }
    if(actions) actions.style.display='flex';
    if(mbnDot) mbnDot.className='mbn-sync-dot';
    if(mbnLabel) mbnLabel.textContent='Sign In';
    if(mbnBtn){ mbnBtn.onclick=showFbModal; mbnBtn.style.color='var(--accent)'; }
  }
}

function setSyncing(on){
  fbSyncing = on;
  const cls = 'fb-sync-dot ' + (on ? 'syncing' : (fbUser ? 'synced' : ''));
  document.querySelectorAll('.fb-sync-dot').forEach(d=>d.className=cls);
}

// â”€â”€ AUTH MODAL â”€â”€
function showFbModal(){
  const overlay = document.getElementById('fbModalOverlay');
  if(overlay){ overlay.style.display='flex'; }
  document.getElementById('fbAuthError').classList.remove('visible');
}
function hideFbModal(){
  const overlay = document.getElementById('fbModalOverlay');
  if(overlay) overlay.style.display='none';
}
function fbModalBgClick(e){
  if(e.target===document.getElementById('fbModalOverlay')) hideFbModal();
}
function fbToggleMode(){
  fbIsSignUp = !fbIsSignUp;
  document.getElementById('fbModalTitle').textContent = fbIsSignUp ? 'Create Account' : 'Sign In to PoleCraft';
  document.getElementById('fbSubmitBtn').textContent = fbIsSignUp ? 'Create Account' : 'Sign In';
  document.getElementById('fbToggleText').textContent = fbIsSignUp ? 'Already have an account?' : 'Don\'t have an account?';
  document.getElementById('fbToggleLink').textContent = fbIsSignUp ? 'Sign in' : 'Create account';
  document.getElementById('fbAuthError').classList.remove('visible');
}
function fbShowError(msg){
  const el = document.getElementById('fbAuthError');
  if(el){ el.textContent = msg; el.classList.add('visible'); }
}

// â”€â”€ GOOGLE SIGN IN â”€â”€
function fbSignInGoogle(){
  if(!fbAuth){ showToast('Firebase not configured'); return; }
  const provider = new firebase.auth.GoogleAuthProvider();
  // Use redirect on iOS Safari â€” popup is blocked and doesn't persist
  if(/iPhone|iPad|iPod/.test(navigator.userAgent)){
    fbAuth.signInWithRedirect(provider);
  } else {
    fbAuth.signInWithPopup(provider)
      .then(r=>{ showToast('Welcome ' + (r.user.displayName||'') + '!'); })
      .catch(e=>{ fbShowError(e.message); });
  }
}

// â”€â”€ EMAIL AUTH â”€â”€
function fbSubmitAuth(){
  if(!fbAuth){ showToast('Firebase not configured'); return; }
  const email = document.getElementById('fbEmailIn')?.value.trim();
  const pass  = document.getElementById('fbPassIn')?.value;
  if(!email||!pass){ fbShowError('Enter email and password'); return; }
  document.getElementById('fbSubmitBtn').textContent = fbIsSignUp ? 'Creating...' : 'Signing in...';
  const promise = fbIsSignUp
    ? fbAuth.createUserWithEmailAndPassword(email, pass)
    : fbAuth.signInWithEmailAndPassword(email, pass);
  promise
    .then(r=>{
      showToast('Welcome!');
      // Store credentials for auto-reconnect on iOS Safari
      if(!fbIsSignUp){
        localStorage.setItem('pc_auth_email', email);
        localStorage.setItem('pc_auth_pass', pass);
      }
    })
    .catch(e=>{
      document.getElementById('fbSubmitBtn').textContent = fbIsSignUp ? 'Create Account' : 'Sign In';
      const msgs = {
        'auth/user-not-found':'No account with that email. Create one?',
        'auth/wrong-password':'Wrong password.',
        'auth/email-already-in-use':'Account already exists. Sign in instead.',
        'auth/weak-password':'Password must be at least 6 characters.',
        'auth/invalid-email':'Invalid email address.',
        'auth/too-many-requests':'Too many attempts. Try again later.',
        'auth/invalid-credential':'Wrong email or password.',
      };
      fbShowError(msgs[e.code]||e.message);
    });
}

// â”€â”€ SIGN OUT â”€â”€
function fbSignOut(){
  if(!fbAuth) return;
  if(!confirm('Sign out? Your data is saved in the cloud and will be here when you sign back in.')) return;
  fbAuth.signOut().then(()=>{
    fbUser = null;
    localStorage.removeItem('pc_auth_email');
    localStorage.removeItem('pc_auth_pass');
    updateFbAuthBar();
    showToast('Signed out');
  });
}

// ============================================================
// FIRESTORE SYNC â€” ALL DATA
// ============================================================
const FS_DEBOUNCE = 1500; // ms to wait after last change before writing

function fbGetUserDoc(){
  if(!fbDb||!fbUser) return null;
  return fbDb.collection('users').doc(fbUser.uid);
}

// Debounced write â€” batches rapid changes
function fbScheduleSync(dataType, data){
  if(!fbUser||!fbDb) return;
  clearTimeout(fbSyncTimer);
  fbSyncTimer = setTimeout(()=>fbSyncNow(dataType, data), FS_DEBOUNCE);
}

async function fbSyncNow(dataType, data){
  if(!fbUser||!fbDb) return;
  setSyncing(true);
  try{
    let saveData = data;
    if(dataType==='journal' && Array.isArray(data)){
      saveData = data.map(e=>({...e, photo: e.photo&&e.photo.length>30000?e.photo.substring(0,30000):e.photo}));
    }
    if(dataType==='profile' && data){
      saveData={...data};
      if(saveData.avatar&&saveData.avatar.length>30000) saveData.avatar=saveData.avatar.substring(0,30000);
    }
    await fbGetUserDoc().set({[dataType]:saveData, updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    setSyncing(false);
    fbd('write', new Date().toLocaleTimeString()+' ('+dataType+')', 'ok');
  } catch(e){
    console.error('Sync failed ['+dataType+']:', e);
    fbd('error', e.message);
    setSyncing(false);
  }
}

// â”€â”€ LOAD ALL DATA FROM CLOUD â”€â”€
async function fbLoadAllData(){
  if(!fbUser||!fbDb){
    dismissLoadingOverlay('No connection â€” using local data');
    return;
  }
  setSyncing(true);
  setLoadingMsg('Loading your data...');
  try{
    const snap = await fbGetUserDoc().get();
    if(!snap.exists){
      setSyncing(false);
      fbPushAllLocalData();
      dismissLoadingOverlay('New account â€” saving your data...');
      return;
    }
    fbApplyCloudData(snap.data(), false);
    
    // Full re-render after initial load
    renderNav(); renderMobileNav();
    renderSaved(); renderSavedRoutines();
    renderGoals(); updateStats(); updateHeaderProfile();
    const activePage = document.querySelector('.page.active');
    if(activePage){
      const id = activePage.id.replace('page-','');
      if(id==='journal')  initJournal();
      if(id==='choreo')   { renderCanvas(); renderSavedRoutines(); }
      if(id==='studio')   renderStudio();
      if(id==='teach')    initTeach();
    }

    setSyncing(false);
    dismissLoadingOverlay('Synced âœ“');
    showToast('Data loaded âœ“');

  } catch(e){
    console.error('Cloud load failed:', e);
    setSyncing(false);
    dismissLoadingOverlay('Sync error â€” showing local data');
    showToast('Could not reach cloud â€” showing saved local data');
  }
}

function setLoadingMsg(msg){
  const el = document.getElementById('cloudLoadingMsg');
  if(el) el.textContent = msg;
}

function dismissLoadingOverlay(msg){
  const el = document.getElementById('cloudLoadingOverlay');
  if(!el) return;
  el.style.opacity='0';
  el.style.pointerEvents='none';
  setTimeout(()=>{ el.style.display='none'; }, 350);
}

// Push all local data up to cloud for new accounts
async function fbPushAllLocalData(){
  if(!fbUser||!fbDb) return;
  setSyncing(true);
  showToast('Uploading to cloud...');
  try{
    // Write each data type to its own subcollection doc
    const items = {
      combos:      JSON.parse(localStorage.getItem('pc_combos')||'[]'),
      routines:    JSON.parse(localStorage.getItem('pc_routines')||'[]'),
      tracker:     JSON.parse(localStorage.getItem('pc_tracker')||'{}'),
      journal:     JSON.parse(localStorage.getItem('pc_journal')||'[]'),
      goals:       JSON.parse(localStorage.getItem('pc_goals')||'[]'),
      schedule:    JSON.parse(localStorage.getItem('pc_schedule')||'[]'),
      studio:      JSON.parse(localStorage.getItem('pc_studio')||'{}'),
      navOrder:    navPages,
      teachPlans:  teachPlans,
      teachRoster: teachRoster,
      teachNotes:  teachNotes,
      profile:     pcUser || null,
    };
    await fbGetUserDoc().set({...items, updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    setSyncing(false);
    showToast('All data synced to cloud âœ“');
    fbd('write', new Date().toLocaleTimeString()+' (full push)', 'ok');
  } catch(e){
    setSyncing(false);
    fbd('error', e.message);
    showToast('Push failed: '+e.message);
    console.error('Push failed:', e);
  }
}

// â”€â”€ PATCH SAVE FUNCTIONS TO ALSO SYNC â”€â”€
// These wrap the existing localStorage saves to also trigger cloud sync

const _origSaveTracker = window.saveTracker;
function saveTracker(){
  localStorage.setItem('pc_tracker', JSON.stringify(trackerData));
  fbScheduleSync('tracker', trackerData);
}

const _origSaveJournal = window.saveJournal;
function saveJournal(){
  localStorage.setItem('pc_journal', JSON.stringify(journalData));
  fbScheduleSync('journal', journalData);
}

const _origSaveGoals = window.saveGoals;
function saveGoals(){
  localStorage.setItem('pc_goals', JSON.stringify(goalsData));
  fbScheduleSync('goals', goalsData);
}

const _origSaveProfiles = window.saveProfiles;
function saveProfiles(){
  localStorage.setItem('pc_all_profiles', JSON.stringify(allProfiles));
  if(activeProfileId) localStorage.setItem('pc_active_profile', activeProfileId);
  if(pcUser) fbScheduleSync('profile', pcUser);
}

// Patch combo save
function fbSyncCombos(){
  fbScheduleSync('combos', savedCombos);
}

// Patch routine save  
function fbSyncRoutines(){
  fbScheduleSync('routines', JSON.parse(localStorage.getItem('pc_routines')||'[]'));
}

// Patch schedule save
function fbSyncSchedule(){
  fbScheduleSync('schedule', schedClasses || JSON.parse(localStorage.getItem('pc_schedule')||'[]'));
}

// Patch studio save
function fbSyncStudio(){
  fbScheduleSync('studio', studioData || JSON.parse(localStorage.getItem('pc_studio')||'{}'));
}

// Patch nav order save
const _origSaveNavOrder = window.saveNavOrder;
function saveNavOrder(){
  localStorage.setItem('pc_nav_order', JSON.stringify(navPages));
  fbScheduleSync('navOrder', navPages);
}

// Manual full sync button
function fbManualSync(){
  if(!fbUser){ showFbModal(); return; }
  fbPushAllLocalData();
}

// Add sync badge to profile button
function fbAddSyncBadge(){
  const btn = document.getElementById('profileBtn');
  if(btn && !document.getElementById('profileSyncBadge')){
    const badge = document.createElement('div');
    badge.id = 'profileSyncBadge';
    badge.className = 'profile-sync-badge' + (fbUser ? ' synced' : '');
    btn.appendChild(badge);
  }
}

// ============================================================
// TEACH PAGE
// ============================================================
const K_TEACH_PLANS   = 'pc_teach_plans';
const K_TEACH_ROSTER  = 'pc_teach_roster';
const K_TEACH_NOTES   = 'pc_teach_notes';

let teachPlans   = JSON.parse(localStorage.getItem(K_TEACH_PLANS)  || '[]');
let teachRoster  = JSON.parse(localStorage.getItem(K_TEACH_ROSTER) || '[]');
let teachNotes   = JSON.parse(localStorage.getItem(K_TEACH_NOTES)  || '[]');

// Current plan being edited
let cpFormat     = '60';  // '60','90','workshop'
let cpBlocks     = [];
let cpName       = '';
let cpLevel      = '';
let cpEditId     = null;
let rosterShowForm = false;
let tnoteSearch  = '';

function saveTeachPlans(){ localStorage.setItem(K_TEACH_PLANS,  JSON.stringify(teachPlans));  fbScheduleSync('teachPlans',  teachPlans); }
function saveTeachRoster(){ localStorage.setItem(K_TEACH_ROSTER, JSON.stringify(teachRoster)); fbScheduleSync('teachRoster', teachRoster); }
function saveTeachNotes(){ localStorage.setItem(K_TEACH_NOTES,  JSON.stringify(teachNotes));  fbScheduleSync('teachNotes',  teachNotes); }

// Format presets (minutes per block)
const CP_FORMATS = {
  '60':      { label:'1 Hour Class (60 min)', total:60, blocks:[
    {type:'warmup',   icon:'ðŸ”¥', name:'Warm-Up',        mins:10, notes:'', moves:[], collapsed:false},
    {type:'skills',   icon:'âœ¦',  name:'Skills & Drills', mins:25, notes:'', moves:[], collapsed:false},
    {type:'choreo',   icon:'ðŸ’ƒ', name:'Choreography',    mins:15, notes:'', moves:[], collapsed:false},
    {type:'cooldown', icon:'ðŸ§Š', name:'Cool Down',        mins:10, notes:'', moves:[], collapsed:false},
  ]},
  '90':      { label:'90 Min Class', total:90, blocks:[
    {type:'warmup',   icon:'ðŸ”¥', name:'Warm-Up',          mins:15, notes:'', moves:[], collapsed:false},
    {type:'skills',   icon:'âœ¦',  name:'Skills & Drills',  mins:30, notes:'', moves:[], collapsed:false},
    {type:'choreo',   icon:'ðŸ’ƒ', name:'Choreography',     mins:25, notes:'', moves:[], collapsed:false},
    {type:'freeplay', icon:'ðŸŽª', name:'Freestyle / Play', mins:10, notes:'', moves:[], collapsed:false},
    {type:'cooldown', icon:'ðŸ§Š', name:'Cool Down',          mins:10, notes:'', moves:[], collapsed:false},
  ]},
  'workshop':{ label:'Workshop (2â€“3 hrs)', total:150, blocks:[
    {type:'warmup',   icon:'ðŸ”¥', name:'Warm-Up & Intro',    mins:20, notes:'', moves:[], collapsed:false},
    {type:'skills',   icon:'âœ¦',  name:'Foundation Skills',  mins:30, notes:'', moves:[], collapsed:false},
    {type:'skills',   icon:'âœ¦',  name:'Advanced Skills',    mins:40, notes:'', moves:[], collapsed:false},
    {type:'choreo',   icon:'ðŸ’ƒ', name:'Choreography Focus', mins:30, notes:'', moves:[], collapsed:false},
    {type:'freeplay', icon:'ðŸŽª', name:'Open Practice',      mins:20, notes:'', moves:[], collapsed:false},
    {type:'cooldown', icon:'ðŸ§Š', name:'Cool Down & Q&A',     mins:10, notes:'', moves:[], collapsed:false},
  ]},
};

const CP_BLOCK_TYPES = [
  {type:'warmup',   icon:'ðŸ”¥', label:'Warm-Up'},
  {type:'skills',   icon:'âœ¦',  label:'Skills'},
  {type:'choreo',   icon:'ðŸ’ƒ', label:'Choreography'},
  {type:'cooldown', icon:'ðŸ§Š', label:'Cool Down'},
  {type:'freeplay', icon:'ðŸŽª', label:'Free Play'},
  {type:'custom',   icon:'â—ˆ',  label:'Custom'},
];

function initTeach(){
  if(!cpBlocks.length) cpBlocks = CP_FORMATS['60'].blocks.map(b=>({...b, id:'b'+Date.now()+Math.random().toString(36).slice(2), moves:[...b.moves]}));
  // Populate moves datalist from MOVES database
  const dl = document.getElementById('cpMovesList');
  if(dl && typeof MOVES !== 'undefined'){
    dl.innerHTML = MOVES.map(m=>`<option value="${m.name}">${m.name} (${m.cat}, L${m.psoLevel})</option>`).join('');
  }
  showTeachSection('planner', document.querySelector('.teach-nav-btn'));
}

function showTeachSection(sec, btn){
  document.querySelectorAll('.teach-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.teach-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tsec-'+sec).classList.add('active');
  if(btn) btn.classList.add('active');
  if(sec==='planner')  renderClassPlanner();
  if(sec==='roster')   renderRoster();
  if(sec==='tnotes')   renderTeachNotes();
}

// ============================================================
// CLASS PLANNER
// ============================================================
function cpSetFormat(fmt){
  if(!confirm('Switch format? This will reset the current plan blocks.')) return;
  cpFormat = fmt;
  const preset = CP_FORMATS[fmt];
  cpBlocks = preset.blocks.map(b=>({...b, id:'b'+Date.now()+Math.random().toString(36).slice(2), moves:[...b.moves]}));
  renderClassPlanner();
}


function cpBuildMoveSelect(blockId){
  const sel = document.getElementById('cpcat_'+blockId);
  if(!sel || typeof MOVES === 'undefined') return;
  const cats = ['Spin','Invert','Mount','Climb','Pose','Drop','Trick','Hold','Transition','Floor'];
  sel.innerHTML = '<option value="">Browse all moves...</option>' +
    cats.map(cat=>{
      const moves = MOVES.filter(m=>m.cat===cat);
      if(!moves.length) return '';
      return `<optgroup label="${cat}">${moves.map(m=>`<option value="${m.name}">${m.name} â€” L${m.psoLevel}</option>`).join('')}</optgroup>`;
    }).join('');
}

function cpPickFromSelect(blockId, sel){
  if(!sel.value) return;
  const inp = document.getElementById('cpmovein_'+blockId);
  if(inp) inp.value = sel.value;
  cpAddMove(blockId);
  sel.value = '';
}
function renderClassPlanner(){
  const el = document.getElementById('tsec-planner');
  if(!el) return;

  const totalMins = cpBlocks.reduce((s,b)=>s+Number(b.mins||0),0);

  // Time bar segments with colors
  const barColors = {warmup:'var(--l1)',skills:'var(--accent)',choreo:'var(--l3)',cooldown:'var(--l2)',freeplay:'var(--l5)',custom:'var(--border2)'};
  const barSegs = cpBlocks.map(b=>`<div class="cp-time-seg" style="flex:${b.mins||1};background:${barColors[b.type]||'var(--border2)'};" title="${b.name}: ${b.mins}min"></div>`).join('');

  const blocksHtml = cpBlocks.map((b,i)=>renderCpBlock(b,i)).join('');
  const savedHtml = teachPlans.length ? teachPlans.map((p,i)=>`
    <div class="cp-saved-item" onclick="cpLoadPlan(${i})">
      <div>
        <div class="cp-saved-item-name">${p.name||'Untitled Plan'}</div>
        <div class="cp-saved-item-meta">${p.format==='workshop'?'Workshop':p.format==='90'?'90 min':'1 hr'} Â· ${p.blocks.length} sections Â· ${p.blocks.reduce((s,b)=>s+(Number(b.mins)||0),0)} min</div>
      </div>
      <button class="cp-saved-item-del" onclick="event.stopPropagation();cpDeletePlan(${i})">âœ•</button>
    </div>`).join('') : '<div style="font-size:9px;color:var(--dim);padding:4px 0;">No saved plans yet</div>';

  el.innerHTML = `
    <div class="cp-header">
      <div class="cp-title">Class Planner</div>
      <div class="cp-format-chips">
        ${Object.entries(CP_FORMATS).map(([k,v])=>`<button class="cp-chip${cpFormat===k?' active':''}" onclick="cpSetFormat('${k}')">${v.label.split('(')[0].trim()}</button>`).join('')}
      </div>
    </div>
    <div class="cp-meta-row">
      <input class="cp-meta-in" id="cpNameIn" placeholder="Plan name â€” e.g. Thursday Beginners, Level 3 Workshop..." value="${cpName}" oninput="cpName=this.value">
      <input class="cp-meta-in" id="cpLevelIn" placeholder="Level / focus" value="${cpLevel}" oninput="cpLevel=this.value" style="flex:0 0 180px;">
    </div>
    <div class="cp-time-bar">${barSegs}</div>
    <div class="cp-time-total">${totalMins} min total</div>
    <div class="cp-plan" id="cpPlanBlocks">${blocksHtml}</div>
    <div class="cp-add-block-row">
      ${CP_BLOCK_TYPES.map(t=>`<button class="cp-add-block-btn" onclick="cpAddBlock('${t.type}','${t.icon}','${t.label}')">${t.icon} + ${t.label}</button>`).join('')}
    </div>
    <div class="cp-plan-actions">
      <button class="cp-save-btn" onclick="cpSavePlan()">Save Plan</button>
      <button class="cp-print-btn" onclick="window.print()">Print / Export</button>
      <button class="cp-new-btn" onclick="cpNewPlan()">New Plan</button>
    </div>
    <div class="cp-saved-list">
      <div class="cp-saved-hdr"><div class="cp-saved-title">Saved Plans</div><div class="cp-saved-line"></div></div>
      ${savedHtml}
    </div>`;
  // Wire up move selects after render
  setTimeout(()=>{ cpBlocks.forEach(b=>cpBuildMoveSelect(b.id)); }, 0);
}

function renderCpBlock(b, i){
  const movesHtml = (b.moves||[]).map((m,mi)=>`<div class="cp-move-chip">${m}<button class="cp-move-chip-del" onclick="cpRemoveMove('${b.id}',${mi})">âœ•</button></div>`).join('');
  return `
  <div class="cp-block ${b.type}${b.collapsed?' collapsed':''}" id="cpb_${b.id}">
    <div class="cp-block-header" onclick="cpToggleBlock('${b.id}')">
      <span class="cp-block-toggle">â–¼</span>
      <span class="cp-block-icon">${b.icon}</span>
      <span class="cp-block-name">${b.name}</span>
      <span class="cp-block-time">${b.mins} min</span>
      <button class="cp-block-del" onclick="event.stopPropagation();cpDeleteBlock('${b.id}')">âœ•</button>
    </div>
    <div class="cp-block-body">
      <div class="cp-time-row">
        <div class="cp-time-lbl">Duration</div>
        <input class="cp-time-in" type="number" min="1" max="120" value="${b.mins}"
          oninput="cpUpdateMins('${b.id}',this.value)">
        <span class="cp-time-unit">min</span>
        <input style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;padding:3px 8px;outline:none;margin-left:12px;" 
          value="${b.name}" placeholder="Section name" 
          oninput="cpUpdateName('${b.id}',this.value)" onclick="event.stopPropagation()">
      </div>
      <textarea class="cp-block-notes" rows="2" placeholder="Teaching notes, key points, cues for this section..." oninput="cpUpdateNotes('${b.id}',this.value)" onclick="event.stopPropagation()">${b.notes||''}</textarea>
      <div class="cp-moves-area">
        <div class="cp-moves-label">Moves / Skills</div>
        <div class="cp-move-chips" id="cpmoves_${b.id}">${movesHtml||'<span style="font-size:8px;color:var(--dim);padding:4px;">Drop moves here or add below</span>'}</div>
        <div class="cp-add-move-row">
          <input class="cp-add-move-in" id="cpmovein_${b.id}" placeholder="Type to search all 200+ moves..."
            list="cpMovesList"
            onkeydown="if(event.key==='Enter')cpAddMove('${b.id}')">
          <select class="cp-add-move-btn" id="cpcat_${b.id}" style="border-color:var(--border);color:var(--dim);font-size:8px;padding:6px 8px;cursor:pointer;"
            onchange="cpPickFromSelect('${b.id}',this)">
          </select>
          <button class="cp-add-move-btn" onclick="cpAddMove('${b.id}')">+ Add</button>
        </div>
      </div>
    </div>
  </div>`;
}

function cpToggleBlock(id){
  const b = cpBlocks.find(x=>x.id===id); if(!b) return;
  b.collapsed = !b.collapsed;
  const el = document.getElementById('cpb_'+id);
  if(el) el.classList.toggle('collapsed', b.collapsed);
  // Just update toggle arrow
  const arr = el?.querySelector('.cp-block-toggle');
  if(arr) arr.style.transform = b.collapsed ? 'rotate(-90deg)' : '';
  const body = el?.querySelector('.cp-block-body');
  if(body) body.style.display = b.collapsed ? 'none' : '';
}

function cpUpdateMins(id, val){
  const b = cpBlocks.find(x=>x.id===id); if(!b) return;
  b.mins = parseInt(val)||0;
  // Update time bar and total without full re-render
  const totalMins = cpBlocks.reduce((s,x)=>s+Number(x.mins||0),0);
  const barColors = {warmup:'var(--l1)',skills:'var(--accent)',choreo:'var(--l3)',cooldown:'var(--l2)',freeplay:'var(--l5)',custom:'var(--border2)'};
  const bar = document.querySelector('.cp-time-bar');
  if(bar) bar.innerHTML = cpBlocks.map(x=>`<div class="cp-time-seg" style="flex:${x.mins||1};background:${barColors[x.type]||'var(--border2)'};" title="${x.name}: ${x.mins}min"></div>`).join('');
  const tot = document.querySelector('.cp-time-total');
  if(tot) tot.textContent = totalMins + ' min total';
  const timeEl = document.querySelector(`#cpb_${id} .cp-block-time`);
  if(timeEl) timeEl.textContent = (parseInt(val)||0) + ' min';
}

function cpUpdateName(id, val){
  const b = cpBlocks.find(x=>x.id===id); if(!b) return;
  b.name = val;
  const nameEl = document.querySelector(`#cpb_${id} .cp-block-name`);
  if(nameEl) nameEl.textContent = val;
}

function cpUpdateNotes(id, val){
  const b = cpBlocks.find(x=>x.id===id); if(!b) return;
  b.notes = val;
}

function cpAddBlock(type, icon, label){
  cpBlocks.push({id:'b'+Date.now(), type, icon, name:label, mins:15, notes:'', moves:[], collapsed:false});
  renderClassPlanner();
}

function cpDeleteBlock(id){
  cpBlocks = cpBlocks.filter(b=>b.id!==id);
  renderClassPlanner();
}

function cpAddMove(blockId){
  const inp = document.getElementById('cpmovein_'+blockId);
  const val = inp?.value.trim(); if(!val) return;
  const b = cpBlocks.find(x=>x.id===blockId); if(!b) return;
  if(!b.moves) b.moves = [];
  b.moves.push(val);
  inp.value = '';
  // Re-render just the moves area
  const mArea = document.getElementById('cpmoves_'+blockId);
  if(mArea) mArea.innerHTML = b.moves.map((m,mi)=>`<div class="cp-move-chip">${m}<button class="cp-move-chip-del" onclick="cpRemoveMove('${blockId}',${mi})">âœ•</button></div>`).join('') || '<span style="font-size:8px;color:var(--dim);padding:4px;">Drop moves here or add below</span>';
}

function cpRemoveMove(blockId, idx){
  const b = cpBlocks.find(x=>x.id===blockId); if(!b) return;
  b.moves.splice(idx,1);
  const mArea = document.getElementById('cpmoves_'+blockId);
  if(mArea) mArea.innerHTML = b.moves.map((m,mi)=>`<div class="cp-move-chip">${m}<button class="cp-move-chip-del" onclick="cpRemoveMove('${blockId}',${mi})">âœ•</button></div>`).join('') || '<span style="font-size:8px;color:var(--dim);padding:4px;">Drop moves here or add below</span>';
}

function cpSavePlan(){
  const name = cpName || document.getElementById('cpNameIn')?.value || 'Untitled Plan';
  const plan = {
    id: cpEditId || 'plan'+Date.now(),
    name: name.trim() || 'Untitled Plan',
    level: cpLevel,
    format: cpFormat,
    blocks: cpBlocks.map(b=>({...b, moves:[...b.moves]})),
    savedAt: new Date().toLocaleDateString(),
  };
  if(cpEditId){
    const idx = teachPlans.findIndex(p=>p.id===cpEditId);
    if(idx>-1) teachPlans[idx]=plan; else teachPlans.push(plan);
  } else {
    teachPlans.push(plan);
    cpEditId = plan.id;
  }
  saveTeachPlans();
  showToast('Plan saved!');
  renderClassPlanner();
}

function cpLoadPlan(idx){
  const p = teachPlans[idx]; if(!p) return;
  cpFormat = p.format || '60';
  cpBlocks = p.blocks.map(b=>({...b, id:b.id||'b'+Date.now()+Math.random().toString(36).slice(2), moves:[...(b.moves||[])]}));
  cpName   = p.name;
  cpLevel  = p.level||'';
  cpEditId = p.id;
  renderClassPlanner();
  document.getElementById('cpNameIn').value = cpName;
  document.getElementById('cpLevelIn').value = cpLevel;
}

function cpDeletePlan(idx){
  if(!confirm('Delete this plan?')) return;
  teachPlans.splice(idx,1);
  saveTeachPlans();
  renderClassPlanner();
}

function cpNewPlan(){
  if(!confirm('Start a new plan? Unsaved changes will be lost.')) return;
  cpEditId = null; cpName = ''; cpLevel = '';
  cpBlocks = CP_FORMATS[cpFormat].blocks.map(b=>({...b, id:'b'+Date.now()+Math.random().toString(36).slice(2), moves:[...b.moves]}));
  renderClassPlanner();
}

// ============================================================
// STUDENT ROSTER
// ============================================================
// Skill list pulled from move database categories
const TEACH_SKILL_CATS = ['Spins','Inverts','Mounts','Climbs','Poses','Drops','Transitions','Floorwork','Holds','Combos'];
const DEFAULT_SKILLS = ['Fireman Spin','Chair Spin','Back Hook Spin','Basic Invert','Gemini','Scorpio','Brass Monkey','Jade Split','Shoulder Mount','Basic Climb','Crucifix','Butterfly','Ayesha','Iron X'];

function renderRoster(){
  const el = document.getElementById('tsec-roster');
  if(!el) return;
  const formHtml = rosterShowForm ? `
    <div class="roster-add-form open">
      <div class="roster-form-row">
        <input class="roster-in" id="rosterNameIn" placeholder="Student name">
        <select class="roster-in" id="rosterLevelIn" style="flex:0 0 160px;">
          <option value="">PSO Level</option>
          <option>L1 Beginner</option><option>L2 Floor Inverter</option>
          <option>L3 Aerial Inverter</option><option>L4 Advanced</option>
          <option>L5 Elite</option><option>Training</option>
        </select>
        <input class="roster-in" id="rosterEmailIn" placeholder="Contact (optional)">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="roster-save-btn" onclick="addStudent()">Add Student</button>
        <button class="cp-print-btn" onclick="rosterShowForm=false;renderRoster();">Cancel</button>
      </div>
    </div>` : '';

  const studentsHtml = teachRoster.length
    ? teachRoster.map((s,i)=>renderStudentCard(s,i)).join('')
    : `<div class="empty-state"><div class="empty-icon">â—Ž</div><div class="empty-text">No students yet â€” add your first student above</div></div>`;

  el.innerHTML = `
    <div class="roster-header">
      <div class="roster-title">Student Roster</div>
      <button class="roster-add-btn" onclick="rosterShowForm=!rosterShowForm;renderRoster();">${rosterShowForm?'Cancel':'+ Add Student'}</button>
    </div>
    ${formHtml}
    <div id="rosterList">${studentsHtml}</div>`;
}

function renderStudentCard(s, idx){
  const skills = s.skills || {};
  const masteredCount = Object.values(skills).filter(v=>v==='mastered').length;
  const totalSkills = DEFAULT_SKILLS.length;
  const pct = Math.round(masteredCount/totalSkills*100);
  const collapsed = s.collapsed !== false; // default collapsed

  const skillsHtml = DEFAULT_SKILLS.map(sk=>{
    const st = skills[sk]||'';
    return `<div class="skill-chip${st==='mastered'?' mastered':st==='working'?' working':''}" onclick="cycleStudentSkill(${idx},'${sk.replace(/'/g,"\\'")}')">
      <div class="skill-chip-dot"></div>
      <span class="skill-chip-name">${sk}</span>
      ${st==='mastered'?'<span style="font-size:9px;">âœ“</span>':st==='working'?'<span style="font-size:9px;">â—‘</span>':''}
    </div>`;
  }).join('');

  return `
  <div class="student-card${collapsed?' collapsed':''}" id="student_${idx}">
    <div class="student-card-header" onclick="toggleStudentCard(${idx})">
      <div class="student-avatar">${s.emoji||'ðŸŽ­'}</div>
      <div class="student-name">${s.name}</div>
      ${s.level?`<div class="student-level">${s.level}</div>`:''}
      <div class="student-progress-bar"><div class="student-progress-fill" style="width:${pct}%"></div></div>
      <span style="font-size:8px;color:var(--dim);margin:0 4px;">${pct}%</span>
      <span class="student-card-toggle">â–¼</span>
      <button class="student-del" onclick="event.stopPropagation();deleteStudent(${idx})">âœ•</button>
    </div>
    <div class="student-card-body">
      <div class="student-section-lbl">Skills Progress â€” tap to cycle: â—‹ Not started â†’ â—‘ Working â†’ âœ“ Mastered</div>
      <div class="student-skills-grid">${skillsHtml}</div>
      <div class="student-section-lbl">Notes</div>
      <textarea class="student-notes-in" rows="2" placeholder="Class notes, goals, things to work on..." 
        oninput="updateStudentNotes(${idx},this.value)">${s.notes||''}</textarea>
    </div>
  </div>`;
}

function toggleStudentCard(idx){
  const s = teachRoster[idx]; if(!s) return;
  s.collapsed = !s.collapsed;
  const el = document.getElementById('student_'+idx);
  if(!el) return;
  el.classList.toggle('collapsed', s.collapsed);
  const body = el.querySelector('.student-card-body');
  if(body) body.style.display = s.collapsed ? 'none' : '';
  const arr = el.querySelector('.student-card-toggle');
  if(arr) arr.style.transform = s.collapsed ? 'rotate(-90deg)' : '';
}

function addStudent(){
  const name = document.getElementById('rosterNameIn')?.value.trim();
  if(!name){ showToast('Enter a student name'); return; }
  const emojis = ['ðŸŒ¸','âœ¨','ðŸ’ƒ','ðŸŒ™','ðŸ¦‹','ðŸ”¥','ðŸ’«','â­','ðŸŒº','ðŸŽ­'];
  teachRoster.push({
    id:'s'+Date.now(), name,
    level: document.getElementById('rosterLevelIn')?.value||'',
    email: document.getElementById('rosterEmailIn')?.value.trim()||'',
    emoji: emojis[Math.floor(Math.random()*emojis.length)],
    skills:{}, notes:'', collapsed:false,
    joined: new Date().toLocaleDateString(),
  });
  saveTeachRoster();
  rosterShowForm = false;
  renderRoster();
}

function deleteStudent(idx){
  const s = teachRoster[idx];
  if(!confirm('Remove '+s.name+' from roster?')) return;
  teachRoster.splice(idx,1);
  saveTeachRoster();
  renderRoster();
}

function cycleStudentSkill(idx, skill){
  const s = teachRoster[idx]; if(!s) return;
  if(!s.skills) s.skills = {};
  const cur = s.skills[skill]||'';
  const next = cur===''?'working':cur==='working'?'mastered':'';
  if(next==='') delete s.skills[skill]; else s.skills[skill] = next;
  saveTeachRoster();
  // Re-render just this card
  const el = document.getElementById('student_'+idx);
  if(!el) return;
  // Update just skills grid + progress
  const skills = s.skills;
  const masteredCount = Object.values(skills).filter(v=>v==='mastered').length;
  const pct = Math.round(masteredCount/DEFAULT_SKILLS.length*100);
  el.querySelector('.student-progress-fill').style.width = pct+'%';
  el.querySelector('[style*="8px;color"]') && (el.querySelectorAll('[style*="8px;color"]')[0].textContent = pct+'%');
  el.querySelector('.student-skills-grid').innerHTML = DEFAULT_SKILLS.map(sk=>{
    const st = skills[sk]||'';
    return `<div class="skill-chip${st==='mastered'?' mastered':st==='working'?' working':''}" onclick="cycleStudentSkill(${idx},'${sk.replace(/'/g,"\\'")}')">
      <div class="skill-chip-dot"></div>
      <span class="skill-chip-name">${sk}</span>
      ${st==='mastered'?'<span style="font-size:9px;">âœ“</span>':st==='working'?'<span style="font-size:9px;">â—‘</span>':''}
    </div>`;
  }).join('');
}

function updateStudentNotes(idx, val){
  if(!teachRoster[idx]) return;
  teachRoster[idx].notes = val;
  saveTeachRoster();
}

// ============================================================
// TEACHING NOTES
// ============================================================
function renderTeachNotes(){
  const el = document.getElementById('tsec-tnotes');
  if(!el) return;
  const filtered = tnoteSearch
    ? teachNotes.filter(n=>n.move.toLowerCase().includes(tnoteSearch.toLowerCase()))
    : teachNotes;

  const notesHtml = filtered.length ? filtered.map((n,i)=>`
    <div class="tnote-card">
      <button class="tnote-del" onclick="deleteTeachNote(${i})">âœ•</button>
      <div class="tnote-move">${n.move}</div>
      <div class="tnote-fields">
        <div class="tnote-field">
          <div class="tnote-lbl">Teaching Cues</div>
          <textarea class="tnote-in" rows="2" placeholder="Key verbal cues, body awareness points..." 
            oninput="updateTeachNote(${i},'cues',this.value)">${n.cues||''}</textarea>
        </div>
        <div class="tnote-field">
          <div class="tnote-lbl">Common Mistakes</div>
          <textarea class="tnote-in" rows="2" placeholder="What students usually get wrong..." 
            oninput="updateTeachNote(${i},'mistakes',this.value)">${n.mistakes||''}</textarea>
        </div>
        <div class="tnote-field">
          <div class="tnote-lbl">Progressions / Drills</div>
          <textarea class="tnote-in" rows="2" placeholder="How to break it down, lead-up moves..." 
            oninput="updateTeachNote(${i},'progressions',this.value)">${n.progressions||''}</textarea>
        </div>
        <div class="tnote-field">
          <div class="tnote-lbl">Safety Notes</div>
          <textarea class="tnote-in" rows="2" placeholder="Spotting, grip checks, body placement warnings..." 
            oninput="updateTeachNote(${i},'safety',this.value)">${n.safety||''}</textarea>
        </div>
      </div>
    </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">${tnoteSearch?'No notes match "'+tnoteSearch+'"':'Add your first teaching note below'}</div></div>`;

  el.innerHTML = `
    <div class="tnotes-header">
      <div class="tnotes-title">Teaching Notes</div>
      <input class="tnotes-search" placeholder="Search moves..." value="${tnoteSearch}"
        oninput="tnoteSearch=this.value;renderTeachNotes()">
    </div>
    <div class="tnote-add-row">
      <input class="tnote-add-in" id="tnoteAddIn" placeholder="Move name â€” e.g. Jade Split, Shoulder Mount..." 
        onkeydown="if(event.key==='Enter')addTeachNote()">
      <button class="tnote-add-btn" onclick="addTeachNote()">+ Add Note</button>
    </div>
    <div id="tnoteList">${notesHtml}</div>`;
}

function addTeachNote(){
  const name = document.getElementById('tnoteAddIn')?.value.trim();
  if(!name){ showToast('Enter a move name'); return; }
  if(teachNotes.find(n=>n.move.toLowerCase()===name.toLowerCase())){
    showToast('Note for this move already exists'); return;
  }
  teachNotes.unshift({id:'tn'+Date.now(), move:name, cues:'', mistakes:'', progressions:'', safety:''});
  saveTeachNotes();
  renderTeachNotes();
}

function updateTeachNote(idx, field, val){
  if(!teachNotes[idx]) return;
  teachNotes[idx][field] = val;
  saveTeachNotes();
}

function deleteTeachNote(idx){
  if(!confirm('Delete this note?')) return;
  teachNotes.splice(idx,1);
  saveTeachNotes();
  renderTeachNotes();
}

// â”€â”€ PATCH ROUTINES TO SAVE TAGLINE â”€â”€
const _origSaveRoutine = window.saveRoutine;
// ============================================================
// FLEXIBILITY TAB
// ============================================================

// â”€â”€ MOVE â†’ MUSCLES MAP â”€â”€
// For each pole move category, what muscles are primary / secondary / needed for flexibility

// â”€â”€ FLEXIBILITY EXERCISES DATABASE â”€â”€

// â”€â”€ FOCUS PRESETS â”€â”€

// â”€â”€ STATE â”€â”€

// â”€â”€ GENERATE SESSION â”€â”€
// â”€â”€ RENDER â”€â”€
// ============================================================
// STUDIO: VIEW SWITCHING, FILM SCHEDULE, FILTER & REPEATS
// ============================================================
let studioView = 'calendar';

function switchStudioView(view, btn){
  studioView = view;
  document.querySelectorAll('.svt').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('studioViewCalendar').style.display = view==='calendar' ? '' : 'none';
  document.getElementById('studioViewFilm').style.display    = view==='film'     ? '' : 'none';
  document.getElementById('studioViewFilter').style.display  = view==='filter'   ? '' : 'none';
  document.getElementById('studioCalNav').style.display  = view==='calendar' ? '' : 'none';
  document.getElementById('studioFilterBar').style.display = view==='filter' ? 'flex' : 'none';
  if(view==='film')   renderFilmSchedule();
  if(view==='filter') renderStudioFilter();
}

// â”€â”€ GET ALL CARDS across all weeks â”€â”€
function getAllStudioCards(){
  const cards = [];
  Object.entries(studioData).forEach(([dataKey, arr])=>{
    if(!Array.isArray(arr)) return;
    arr.forEach((card, ci)=>{
      cards.push({...card, dataKey, ci});
    });
  });
  return cards;
}

// â”€â”€ FILM SCHEDULE VIEW â”€â”€
let filmSchedDragSrc = null;

function renderFilmSchedule(){
  const el = document.getElementById('studioFilmSchedule');
  if(!el) return;

  const today = new Date(); today.setHours(0,0,0,0);
  const allCards = getAllStudioCards();

  const filmCards = allCards
    .filter(c=>c.schedDate)
    .map(c=>({ ...c, _date: new Date(c.schedDate+'T00:00:00') }))
    .sort((a,b)=>a._date-b._date);

  if(!filmCards.length){
    el.innerHTML = `<div class="film-sched-empty">
      <div class="film-sched-empty-icon">ðŸŽ¬</div>
      <div style="font-size:10px;letter-spacing:0.12em;text-transform:uppercase;">No film dates set yet</div>
      <div style="font-size:9px;color:var(--dim);margin-top:4px;">Add a ðŸŽ¬ Film Date to any content card</div>
    </div>`;
    return;
  }

  const groups = {overdue:[], today:[], thisweek:[], upcoming:[]};
  const endOfWeek = new Date(today); endOfWeek.setDate(endOfWeek.getDate()+7);
  filmCards.forEach(c=>{
    const d = c._date;
    if(d < today) groups.overdue.push(c);
    else if(d.toDateString()===today.toDateString()) groups.today.push(c);
    else if(d <= endOfWeek) groups.thisweek.push(c);
    else groups.upcoming.push(c);
  });

  const statusLabels = {idea:'ðŸ’¡ Idea',filming:'ðŸŽ¬ Filming',editing:'âœ‚ï¸ Editing',scheduled:'ðŸ“… Scheduled',posted:'âœ… Posted'};
  const statusColors = {idea:'var(--dim)',filming:'var(--accent)',editing:'#6eafc9',scheduled:'#c96ea8',posted:'var(--l1)'};

  function renderCard(c, cls){
    const d = c._date;
    const dateStr = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const st = c.status||'idea';
    const stColor = statusColors[st];
    const stLabel = statusLabels[st]||'';
    const pills = [c.moveCategory, c.moveLevel].filter(Boolean);
    return `<div class="film-sched-card ${cls}"
      draggable="true"
      ondragstart="filmSchedDragStart(event,'${c.dataKey}',${c.ci})"
      ondragend="filmSchedDragEnd(event)"
      ondragover="filmSchedDragOver(event)"
      ondragleave="filmSchedDragLeave(event)"
      ondrop="filmSchedDrop(event,'${c.dataKey}',${c.ci})">
      <div class="fsc-header">
        <span class="fsc-grip">â ¿</span>
        <div class="fsc-date ${cls}">${dateStr}</div>
        <div class="fsc-status-dot" style="background:${stColor};" title="${stLabel}"></div>
      </div>
      <div class="fsc-body">
        <div class="fsc-title">${c.title||'Untitled Card'}</div>
        ${c.moveName?`<div class="fsc-move">â†³ ${c.moveName}</div>`:''}
        ${pills.length?`<div class="fsc-pills">${pills.map(p=>`<span class="fsc-pill">${p}</span>`).join('')}</div>`:''}
        ${c.audio?`<div class="fsc-audio"><span>ðŸŽµ</span><span>${c.audio}</span></div>`:''}
        ${c.location?`<div class="fsc-audio"><span>ðŸ“</span><span>${c.location}</span></div>`:''}
        ${c.outfit?`<div class="fsc-audio"><span>ðŸ‘—</span><span>${c.outfit}</span></div>`:''}
        ${c.notes?`<div class="fsc-notes">${c.notes}</div>`:''}
        <div class="fsc-status-lbl" style="color:${stColor};">${stLabel}</div>
      </div>
    </div>`;
  }

  function renderGroup(title, cards, cls){
    if(!cards.length) return '';
    return `<div class="film-sched-group">
      <div class="film-sched-section-hdr">
        <div class="film-sched-section-title">${title}</div>
        <div class="film-sched-line"></div>
        <div class="film-sched-count">${cards.length} video${cards.length>1?'s':''}</div>
      </div>
      <div class="film-sched-lane">${cards.map(c=>renderCard(c,cls)).join('')}</div>
    </div>`;
  }

  el.innerHTML =
    renderGroup('âš  Overdue', groups.overdue, 'overdue') +
    renderGroup('Today', groups.today, 'today') +
    renderGroup('This Week', groups.thisweek, 'upcoming') +
    renderGroup('Upcoming', groups.upcoming, 'upcoming') ||
    '<div class="film-sched-empty"><div style="font-size:10px;letter-spacing:0.12em;text-transform:uppercase;">All caught up âœ“</div></div>';
}

function filmSchedDragStart(e, dataKey, ci){
  filmSchedDragSrc = {dataKey, ci};
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', JSON.stringify({dataKey, ci}));
  setTimeout(()=>e.target.classList.add('dragging'), 0);
}
function filmSchedDragEnd(e){
  filmSchedDragSrc = null;
  document.querySelectorAll('.film-sched-card').forEach(c=>{
    c.classList.remove('dragging','drag-target-left','drag-target-right');
  });
}
function filmSchedDragOver(e){
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  if(!filmSchedDragSrc) return;
  const card = e.currentTarget;
  const rect = card.getBoundingClientRect();
  card.classList.remove('drag-target-left','drag-target-right');
  if(e.clientX < rect.left + rect.width / 2) card.classList.add('drag-target-left');
  else card.classList.add('drag-target-right');
}
function filmSchedDragLeave(e){
  e.currentTarget.classList.remove('drag-target-left','drag-target-right');
}
function filmSchedDrop(e, targetKey, targetCi){
  e.preventDefault();
  if(!filmSchedDragSrc) return;
  const {dataKey:srcKey, ci:srcCi} = filmSchedDragSrc;
  if(srcKey===targetKey && srcCi===targetCi) return;
  const card = e.currentTarget;
  const insertBefore = card.classList.contains('drag-target-left');
  card.classList.remove('drag-target-left','drag-target-right');
  const srcArr = studioData[srcKey];
  if(!srcArr) return;
  const [movedCard] = srcArr.splice(srcCi, 1);
  const tgtArr = studioData[targetKey];
  if(!tgtArr){ srcArr.splice(srcCi, 0, movedCard); return; }
  let tgtIdx = targetCi;
  if(srcKey===targetKey && srcCi < targetCi) tgtIdx--;
  tgtArr.splice(Math.max(0, insertBefore ? tgtIdx : tgtIdx + 1), 0, movedCard);
  saveStudioData();
  renderFilmSchedule();
  showToast('Film schedule reordered');
}

// â”€â”€ FILTER / BROWSE VIEW â”€â”€
function renderStudioFilter(){
  const el = document.getElementById('studioFilterResults'); if(!el) return;
  const q     = (document.getElementById('sfSearch')?.value||'').toLowerCase();
  const stat  = document.getElementById('sfStatus')?.value||'';
  const cat   = document.getElementById('sfCat')?.value||'';
  const level = document.getElementById('sfLevel')?.value||'';

  let cards = getAllStudioCards();

  if(q)     cards = cards.filter(c=>(c.title||'').toLowerCase().includes(q)||(c.moveName||'').toLowerCase().includes(q)||(c.audio||'').toLowerCase().includes(q)||(c.notes||'').toLowerCase().includes(q));
  if(stat)  cards = cards.filter(c=>(c.status||'idea')===stat);
  if(cat)   cards = cards.filter(c=>c.moveCategory===cat);
  if(level) cards = cards.filter(c=>c.moveLevel===level);

  if(!cards.length){
    el.innerHTML = `<div class="sfr-empty"><div style="font-size:24px;opacity:0.4;">âŠž</div><div>No cards match your filters</div></div>`;
    return;
  }

  const statusLabels = {idea:'ðŸ’¡ Idea',filming:'ðŸŽ¬ Filming',editing:'âœ‚ï¸ Editing',scheduled:'ðŸ“… Scheduled',posted:'âœ… Posted'};
  const statusColors = {idea:'var(--dim)',filming:'var(--accent)',editing:'#6eafc9',scheduled:'#c96ea8',posted:'var(--l1)'};

  // Check for repeats while rendering
  const moveCounts = {};
  cards.forEach(c=>{ if(c.moveName){ moveCounts[c.moveName] = (moveCounts[c.moveName]||0)+1; }});

  const cardsHtml = cards.map(c=>{
    const isRepeat = c.moveName && moveCounts[c.moveName]>1;
    const stColor = statusColors[c.status||'idea'];
    return `<div class="sfr-card${isRepeat?' repeat':''}">
      <div class="sfr-card-title">${c.title||'Untitled Card'}</div>
      <div class="sfr-card-meta">
        ${c.moveName?`<span class="sfr-card-badge" style="border-color:var(--border2);">${c.moveName}</span>`:''}
        ${c.moveCategory?`<span class="sfr-card-badge">${c.moveCategory}</span>`:''}
        ${c.moveLevel?`<span class="sfr-card-badge">${c.moveLevel}</span>`:''}
        <span class="sfr-card-badge" style="color:${stColor};border-color:${stColor};">${statusLabels[c.status||'idea']}</span>
        ${c.schedDate?`<span class="sfr-card-badge">ðŸŽ¬ ${c.schedDate}</span>`:''}
      </div>
      ${isRepeat?`<div class="sfr-repeat-warn">âš  "${c.moveName}" appears in ${moveCounts[c.moveName]} cards â€” possible repeat content</div>`:''}
    </div>`;
  }).join('');

  el.innerHTML = `<div class="sfr-grid">${cardsHtml}</div>`;
}

// â”€â”€ REPEAT CONTENT DETECTOR â”€â”€
function renderStudioRepeats(){
  const el = document.getElementById('studioFilterResults'); if(!el) return;
  const allCards = getAllStudioCards();

  // Group by move name (case-insensitive)
  const byMove = {};
  allCards.forEach(c=>{
    if(!c.moveName) return;
    const key = c.moveName.toLowerCase().trim();
    if(!byMove[key]) byMove[key] = {name:c.moveName, cards:[]};
    byMove[key].cards.push(c);
  });

  // Group by title similarity
  const byTitle = {};
  allCards.forEach(c=>{
    if(!c.title) return;
    const key = c.title.toLowerCase().trim();
    if(!byTitle[key]) byTitle[key] = {name:c.title, cards:[]};
    byTitle[key].cards.push(c);
  });

  const moveRepeats  = Object.values(byMove).filter(g=>g.cards.length>1);
  const titleRepeats = Object.values(byTitle).filter(g=>g.cards.length>1);
  const statusLabels = {idea:'ðŸ’¡',filming:'ðŸŽ¬',editing:'âœ‚ï¸',scheduled:'ðŸ“…',posted:'âœ…'};

  if(!moveRepeats.length && !titleRepeats.length){
    el.innerHTML = `<div class="sfr-empty"><div style="font-size:28px;opacity:0.4;">âœ“</div><div>No repeat content found â€” your library looks unique!</div></div>`;
    return;
  }

  function renderRepeatGroup(groups, label){
    if(!groups.length) return '';
    return `<div class="sfr-section-hdr">
      <div class="sfr-section-title">${label}</div>
      <div class="sfr-section-line"></div>
      <div class="sfr-section-title">${groups.length} duplicate${groups.length>1?'s':''}</div>
    </div>` +
    groups.map(g=>`
      <div class="sfr-repeat-group">
        <div class="sfr-repeat-move">âš  "${g.name}" â€” ${g.cards.length} cards</div>
        ${g.cards.map(c=>`
          <div class="sfr-repeat-item">
            <span style="font-size:12px;">${statusLabels[c.status||'idea']||'ðŸ’¡'}</span>
            <span style="flex:1;">${c.title||'Untitled'}</span>
            <span style="color:var(--dim);font-size:8px;">${c.schedDate||c.dataKey?.split('_').slice(0,-1).join(' ')}</span>
          </div>`).join('')}
      </div>`).join('');
  }

  el.innerHTML =
    `<div style="font-size:9px;color:var(--muted);margin-bottom:16px;padding:10px 14px;background:rgba(160,110,201,0.06);border:1px solid rgba(160,110,201,0.2);">
      Found <strong style="color:var(--l5);">${moveRepeats.length + titleRepeats.length}</strong> potential repeat${moveRepeats.length+titleRepeats.length>1?'s':''} across your content library
    </div>` +
    renderRepeatGroup(moveRepeats,  'âš  Repeated Move Names') +
    renderRepeatGroup(titleRepeats, 'âš  Repeated Titles');
}

// â”€â”€ FIX: Card drag between day columns â”€â”€
function vidCardDrop(e, targetDataKey){
  e.preventDefault(); e.stopPropagation();
  const el = document.getElementById('dayBody_'+targetDataKey);
  el?.classList.remove('dz-over');
  if(!studioDragSrc) return;
  const {dataKey:srcKey, ci:srcIdx} = studioDragSrc;
  if(srcKey===targetDataKey) return; // same column â€” do nothing (reorder not needed)
  const card = studioData[srcKey]?.[srcIdx];
  if(!card) return;
  // Move card
  studioData[srcKey].splice(srcIdx, 1);
  if(!studioData[targetDataKey]) studioData[targetDataKey]=[];
  studioData[targetDataKey].push({...card});
  studioDragSrc = null;
  saveStudio(); renderStudio();
}

// ============================================================
// GYM â€” FLEXIBILITY & STRENGTH
// ============================================================

// â”€â”€ Every exercise maps to the POLE SKILL NAMES it unlocks â”€â”€
// skills[] = the actual move names shown on the card
const GYM_EXERCISES = [

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” SHOULDER STRENGTH & HEALTH â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Scapular Pull-Ups',muscle:'shoulder',type:'strength',dur:null,reps:8,sets:3,intensity:2,
   note:'Dead hang, retract shoulder blades without bending elbows. Builds the foundation for every invert.',
   skills:['Shoulder Mount','Basic Invert','Ayesha','Iron X']},
  {name:'Band Pull-Aparts',muscle:'shoulder',type:'strength',dur:null,reps:15,sets:3,intensity:1,
   note:'Arms straight, band at chest height, pull apart squeezing shoulder blades. Essential shoulder health.',
   skills:['Shoulder Mount','Flag','Crucifix','Iron X']},
  {name:'Face Pulls',muscle:'shoulder',type:'strength',dur:null,reps:15,sets:3,intensity:1,
   note:'Bands or cable at face height, pull to ears. Rear delt + external rotator. Protects the shoulder joint.',
   skills:['Ayesha','Iron X','Shoulder Mount','Flag']},
  {name:'Overhead Press',muscle:'shoulder',type:'strength',dur:null,reps:8,sets:3,intensity:2,
   note:'Strict form â€” bar or dumbbells from shoulders to overhead. Builds pressing strength for static holds.',
   skills:['Flag','Iron X','Handstand','Crucifix']},
  {name:'Pike Push-Ups',muscle:'shoulder',type:'strength',dur:null,reps:10,sets:3,intensity:2,
   note:'Hips high, head moving toward floor between hands. Pressing strength for handstands and static poses.',
   skills:['Handstand','Shoulder Mount','Flag','Ayesha']},
  {name:'Cuban Press',muscle:'shoulder',type:'strength',dur:null,reps:10,sets:3,intensity:1,
   note:'External rotation + overhead press in one. Bulletproofs the rotator cuff.',
   skills:['Twisted Grip Deadlift','Shoulder Mount','Ayesha']},
  {name:'Doorframe Chest Stretch',muscle:'chest',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Arm at 90Â° on doorframe/pole, rotate body away. Both directions â€” high, mid and low.',
   skills:['Ayesha','Iron X','Flag','Crucifix']},
  {name:'Cow Face Arms (Gomukhasana)',muscle:'shoulder',type:'flex',dur:30,reps:null,sets:2,intensity:2,
   note:'One arm up, one arm down, clasp behind back. Full shoulder rotation range.',
   skills:['Ayesha','Twisted Grip Deadlift','Iron X','Shoulder Mount']},
  {name:'Sleeper Stretch',muscle:'shoulder',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Lie on side, elbow at 90Â°, press wrist down with other hand. Posterior capsule health.',
   skills:['Shoulder Mount','Ayesha','Flag']},
  {name:'Thread the Needle',muscle:'shoulder',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'On all fours, thread arm under body. Thoracic + shoulder rotation.',
   skills:['Back Hook Spin','Butterfly','Shoulder Roll']},
  {name:'Wall Angels',muscle:'shoulder',type:'rehab',dur:null,reps:10,sets:3,intensity:1,
   note:'Back flat against wall, arms slide overhead keeping contact. Shoulder mobility + scapular control.',
   skills:['Shoulder Mount','Basic Invert','Flag','Ayesha']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” BACK & LATS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Dead Hang',muscle:'back',type:'strength',dur:30,reps:null,sets:3,intensity:1,
   note:'Hang from bar, fully relaxed. Decompresses spine + grip endurance. Do this every session.',
   skills:['Basic Climb','Basic Invert','Shoulder Mount','All Climbs']},
  {name:'Chin-Ups',muscle:'back',type:'strength',dur:null,reps:5,sets:4,intensity:3,
   note:'Supinated grip (palms facing you). Activates lats AND biceps. Most important upper body pull for pole.',
   skills:['Basic Invert','Shoulder Mount','Brass Monkey','Ayesha','Iron X']},
  {name:'Pull-Ups',muscle:'back',type:'strength',dur:null,reps:5,sets:4,intensity:3,
   note:'Pronated grip. Full range of motion â€” dead hang to chin over bar. Pure lat strength.',
   skills:['Basic Climb','Shoulder Mount','Flag','Crucifix','Iron X']},
  {name:'Negative Pull-Ups',muscle:'back',type:'strength',dur:5,reps:null,sets:5,intensity:2,
   note:'Jump to top position, lower yourself in 5 seconds. Best way to build pull-up strength.',
   skills:['Basic Climb','Shoulder Mount','Ayesha']},
  {name:'Lat Pulldown',muscle:'back',type:'strength',dur:null,reps:10,sets:3,intensity:2,
   note:'Wide grip, pull to chest. Isolates lats.',
   skills:['Basic Invert','Shoulder Mount','Basic Climb','Iron X']},
  {name:'Seated Cable Row',muscle:'back',type:'strength',dur:null,reps:12,sets:3,intensity:2,
   note:'Pull elbows behind body, squeeze mid-back. Rhomboids and mid-trap for posture and holds.',
   skills:['Crucifix','Flag','Butterfly','Flatline Scorpio']},
  {name:'Superman Hold',muscle:'back',type:'strength',dur:20,reps:null,sets:3,intensity:1,
   note:'Prone on floor, lift arms and legs. Lower back and glute activation.',
   skills:['Jade Split','Gemini','Scorpio','Superman']},
  {name:'Lat Stretch (pole-assisted)',muscle:'back',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Hold pole at shoulder height, step back, sit hips down. Full lat stretch.',
   skills:['Basic Invert','Shoulder Mount','Basic Climb']},
  {name:'Child\'s Pose',muscle:'back',type:'flex',dur:40,reps:null,sets:2,intensity:1,
   note:'Knees wide, arms extended, hips to heels. Lats + thoracic decompression.',
   skills:['Basic Invert','Shoulder Mount','Brass Monkey']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” CORE & STABILITY â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Hollow Body Hold',muscle:'core',type:'strength',dur:20,reps:null,sets:4,intensity:2,
   note:'Lower back pressed to floor, arms overhead. This is the foundation of every invert and trick.',
   skills:['Basic Invert','Brass Monkey','Iron X','Ayesha','Trick']},
  {name:'Hanging Knee Raises',muscle:'core',type:'strength',dur:null,reps:10,sets:3,intensity:2,
   note:'Dead hang, pull knees to chest slowly. Core compression strength for inverting.',
   skills:['Basic Invert','Shoulder Mount','Brass Monkey','Gemini']},
  {name:'Hanging L-Sit',muscle:'core',type:'strength',dur:10,reps:null,sets:4,intensity:3,
   note:'Dead hang, legs straight parallel to floor. The hardest core exercise for pole athletes.',
   skills:['Flag','Iron X','Ayesha','Crucifix']},
  {name:'Dead Bug',muscle:'core',type:'strength',dur:null,reps:8,sets:3,intensity:1,
   note:'Opposite arm/leg extend slowly to floor. Deep core activation â€” does not compress the spine.',
   skills:['Basic Invert','Shoulder Mount','Gemini','Scorpio']},
  {name:'Plank Hold',muscle:'core',type:'strength',dur:30,reps:null,sets:3,intensity:1,
   note:'Full body tension. Shoulders over wrists. Squeeze glutes. Foundation of pole stability.',
   skills:['Ayesha','Iron X','Flag','Handstand']},
  {name:'Side Plank',muscle:'core',type:'strength',dur:20,reps:null,sets:3,intensity:2,
   note:'Lateral stability for side shapes and aerial holds.',
   skills:['Flag','Iron X','Flatline Scorpio','Jade Split']},
  {name:'V-Sit Hold',muscle:'core',type:'strength',dur:10,reps:null,sets:4,intensity:3,
   note:'Seated, both legs extended at 45Â°. Advanced core compression.',
   skills:['Flag','Iron X','Ayesha','Jade Split']},
  {name:'Dragon Flag',muscle:'core',type:'strength',dur:null,reps:5,sets:3,intensity:3,
   note:'Hold bench, lower body in rigid plank from shoulders. Elite core.',
   skills:['Iron X','Flag','Ayesha','Superman']},
  {name:'Russian Twist',muscle:'core',type:'strength',dur:null,reps:20,sets:3,intensity:2,
   note:'Seated, feet off floor, rotate torso. Obliques for every spin and transition.',
   skills:['All Spins','Back Hook Spin','Flatline Scorpio','Transitions']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” HIP FLEXORS, GLUTES & LEGS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Hip Flexor Lunge Stretch',muscle:'hip',type:'flex',dur:60,reps:null,sets:2,intensity:1,
   note:'Tall kneeling, push hips forward. Anterior hip flexor + psoas. Essential for all splits work.',
   skills:['Jade Split','Allegra','Front Split','Chair Spin']},
  {name:'Pigeon Pose',muscle:'hip',type:'flex',dur:60,reps:null,sets:2,intensity:2,
   note:'Front shin parallel to mat, fold forward. Deep hip external rotator. Best pre-invert hip opener.',
   skills:['Gemini','Scorpio','Chair Spin','Brass Monkey']},
  {name:'90/90 Hip Stretch',muscle:'hip',type:'flex',dur:60,reps:null,sets:2,intensity:2,
   note:'Front and back leg at 90Â°. Works both internal and external hip rotation at the same time.',
   skills:['Gemini','Scorpio','Chair Spin','Flatline Scorpio']},
  {name:'Frog Pose',muscle:'hip',type:'flex',dur:60,reps:null,sets:2,intensity:3,
   note:'Knees wide, feet behind knees, sink hips. Advanced inner hip opener for middle splits.',
   skills:['Middle Split','Gemini','Jade Split','Straddle']},
  {name:'Hip Circles',muscle:'hip',type:'flex',dur:40,reps:null,sets:2,intensity:1,
   note:'Wide stance, full hip circles each direction. Lubricates hip joint before loading.',
   skills:['Chair Spin','Hip Roll','Back Hook Spin','Mounts']},
  {name:'Glute Bridge',muscle:'hip',type:'strength',dur:null,reps:15,sets:3,intensity:1,
   note:'Push hips up, squeeze glutes at top. Activates posterior chain before climbs.',
   skills:['Basic Climb','Shoulder Mount','Gemini','Jade Split']},
  {name:'Single-Leg Glute Bridge',muscle:'hip',type:'strength',dur:null,reps:10,sets:3,intensity:2,
   note:'One leg extended, push through heel. Hip stability + glute strength for pole sits.',
   skills:['Pole Sit','Gemini','Scorpio','Knee Hold']},
  {name:'Cossack Squat',muscle:'hip',type:'strength',dur:null,reps:8,sets:3,intensity:2,
   note:'Wide stance, shift weight side to side dropping into squat. Hip mobility + leg strength.',
   skills:['Middle Split','Floorwork','Chair Spin','Drop']},
  {name:'Bulgarian Split Squat',muscle:'quad',type:'strength',dur:null,reps:8,sets:3,intensity:2,
   note:'Rear foot elevated, deep single-leg squat. Quad strength + hip flexor stretch.',
   skills:['Basic Climb','Jade Split','Drop','Mount']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” SPLITS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Low Lunge (Dragon Pose)',muscle:'hip',type:'flex',dur:60,reps:null,sets:3,intensity:2,
   note:'Front knee over ankle, back knee down. Sink hips slowly. Breathe into the hip crease.',
   skills:['Jade Split','Front Split','Allegra','Chair Spin']},
  {name:'Half Split',muscle:'hamstring',type:'flex',dur:45,reps:null,sets:2,intensity:2,
   note:'Front leg extended, hips square, fold over extended leg. Hamstring origin stretch.',
   skills:['Front Split','Jade Split','Needle','Gemini']},
  {name:'Full Front Split',muscle:'hamstring',type:'flex',dur:60,reps:null,sets:3,intensity:3,
   note:'Use blocks under hips if needed. Square hips â€” don\'t let them rotate open.',
   skills:['Jade Split','Allegra','Front Split','Needle']},
  {name:'Middle Split Walk-Out',muscle:'hip',type:'flex',dur:60,reps:null,sets:2,intensity:3,
   note:'Feet wide, walk hands forward. Inner thigh + adductors. Don\'t force â€” gravity only.',
   skills:['Middle Split','Gemini','Straddle']},
  {name:'Pancake Stretch',muscle:'hamstring',type:'flex',dur:60,reps:null,sets:2,intensity:2,
   note:'Seated wide legs, fold forward flat. Hinge from hips not back. Classic splits conditioning.',
   skills:['Middle Split','Jade Split','Needle']},
  {name:'PNF Hamstring (contract-relax)',muscle:'hamstring',type:'pnf',dur:40,reps:null,sets:3,intensity:3,
   note:'Flex hamstring against resistance for 5s, release and go deeper. Fastest flexibility gains.',
   skills:['Front Split','Jade Split','Needle','Gemini']},
  {name:'PNF Hip Flexor (contract-relax)',muscle:'hip',type:'pnf',dur:40,reps:null,sets:3,intensity:3,
   note:'In lunge, gently press front knee forward for 5s, then sink deeper. 3 rounds.',
   skills:['Jade Split','Allegra','Chair Spin','Front Split']},
  {name:'Straddle Hold (seated)',muscle:'hip',type:'flex',dur:45,reps:null,sets:2,intensity:2,
   note:'Seated straddle, upright spine. Warm adductors before loading.',
   skills:['Middle Split','Gemini','Straddle Invert']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” BACK BENDS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Cobra Stretch',muscle:'back',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Prone, push up through hands. Gentle spine extension. Start here before deeper backbends.',
   skills:['Superman','Back Hook Spin','Layback Mount','Body Roll']},
  {name:'Sphinx Pose',muscle:'back',type:'flex',dur:40,reps:null,sets:2,intensity:1,
   note:'Forearms on floor, passive backbend. Good entry point for back bend conditioning.',
   skills:['Superman','Layback Mount','Body Roll']},
  {name:'Bridge Pose',muscle:'back',type:'flex',dur:40,reps:null,sets:3,intensity:2,
   note:'Feet flat, push hips up, breathe into the chest. Progresses toward full wheel.',
   skills:['Layback Mount','Superman','Back Hook Spin']},
  {name:'Camel Pose',muscle:'back',type:'flex',dur:30,reps:null,sets:2,intensity:2,
   note:'Kneeling, reach for heels, push hips forward. Intense anterior chain opener.',
   skills:['Layback Mount','Back Hook Spin','Superman','Body Roll']},
  {name:'Full Wheel (Urdhva Dhanurasana)',muscle:'back',type:'flex',dur:30,reps:null,sets:3,intensity:3,
   note:'Full backbend â€” press chest through arms. Build gradually from bridge. Advanced.',
   skills:['Full Wheel','Layback Mount','Superman','Body Roll']},
  {name:'Bow Pose',muscle:'back',type:'flex',dur:30,reps:null,sets:2,intensity:2,
   note:'Prone, grab ankles, kick feet into hands. Whole front body opens.',
   skills:['Superman','Layback Mount','Back Hook Spin']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” GRIP & FOREARMS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Grip Squeeze (towel / gripper)',muscle:'grip',type:'strength',dur:null,reps:20,sets:3,intensity:1,
   note:'Squeeze and release. Builds grip endurance. Do every session.',
   skills:['All Climbs','All Holds','All Spins','All Inverts']},
  {name:'Farmer\'s Carry',muscle:'grip',type:'strength',dur:30,reps:null,sets:3,intensity:2,
   note:'Heavy weights, walk. Loaded grip endurance â€” directly transfers to pole hold time.',
   skills:['All Holds','All Climbs','Ayesha','Iron X']},
  {name:'Wrist Flexor Stretch',muscle:'wrist',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Arm extended, palm up, press fingers down with other hand.',
   skills:['Twisted Grip Deadlift','Ayesha','Twisted Grip Moves']},
  {name:'Wrist Extensor Stretch',muscle:'wrist',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Arm extended, palm down, press fingers toward you.',
   skills:['Twisted Grip Deadlift','Iron X','Flag','Twisted Grip Moves']},
  {name:'Reverse Wrist Curls',muscle:'wrist',type:'strength',dur:null,reps:15,sets:3,intensity:1,
   note:'Forearm on knee, palm down, curl wrist up. Extensor strength balances grip work.',
   skills:['All Grip Holds','Twisted Grip Deadlift','Iron X']},

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â” HAMSTRINGS â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  {name:'Seated Forward Fold',muscle:'hamstring',type:'flex',dur:45,reps:null,sets:2,intensity:1,
   note:'Legs together, reach for feet. Use a strap. Decompress spine as you breathe out.',
   skills:['Gemini','Scorpio','Needle','Front Split']},
  {name:'Standing Forward Fold',muscle:'hamstring',type:'flex',dur:40,reps:null,sets:2,intensity:1,
   note:'Soft bend in knees. Let head hang heavy. Great before invert work.',
   skills:['Basic Invert','Scorpio','Needle']},
  {name:'Dynamic Leg Swings',muscle:'hamstring',type:'flex',dur:30,reps:null,sets:2,intensity:1,
   note:'Hold pole for balance. Swing leg through full range front/back. 15 reps each.',
   skills:['Front Split','Jade Split','Needle','Gemini']},
  {name:'Romanian Deadlift',muscle:'hamstring',type:'strength',dur:null,reps:8,sets:3,intensity:2,
   note:'Hip hinge, feel the hamstrings load. Builds posterior chain for climbs and mounts.',
   skills:['Basic Climb','Shoulder Mount','Jade Split','Gemini']},
  {name:'Nordic Curl',muscle:'hamstring',type:'strength',dur:null,reps:5,sets:3,intensity:3,
   note:'Anchor feet, lower body using hamstrings. The best hamstring strengthener.',
   skills:['Front Split','Jade Split','Basic Climb','Mounts']},
];

// â”€â”€ MUSCLE â†’ POLE GOAL PRESETS â”€â”€
const GYM_PRESETS = {
  full:     {label:'Full Body', muscles:['shoulder','back','core','hip','hamstring','grip']},
  strength: {label:'Pole Strength', muscles:['shoulder','back','core','grip'], types:['strength']},
  flex:     {label:'Flexibility', muscles:['shoulder','back','hip','hamstring'], types:['flex','pnf']},
  splits:   {label:'Splits Training', muscles:['hip','hamstring','quad'], types:['flex','pnf']},
  backbend: {label:'Back Bends', muscles:['back','shoulder','chest'], types:['flex']},
  shoulder: {label:'Shoulder Health', muscles:['shoulder','chest','back'], types:['strength','flex','rehab']},
  core:     {label:'Core & Stability', muscles:['core','back'], types:['strength']},
  skill:    {label:'Skill-Specific', muscles:[], types:[]},
};

// â”€â”€ MOVE â†’ MUSCLES needed (for skill-specific targeting) â”€â”€
const GYM_MOVE_MUSCLES = {
  'Shoulder Mount':      ['shoulder','back','core'],
  'Ayesha':              ['shoulder','back','core','grip'],
  'Iron X':              ['shoulder','back','core','grip'],
  'Flag':                ['shoulder','back','core'],
  'Crucifix':            ['shoulder','back','core'],
  'Basic Invert':        ['core','shoulder','back'],
  'Jade Split':          ['hip','hamstring','back'],
  'Allegra':             ['hip','back','shoulder'],
  'Gemini':              ['hip','hamstring','back'],
  'Scorpio':             ['hip','back','shoulder'],
  'Brass Monkey':        ['hip','back','shoulder'],
  'Needle':              ['hamstring','hip','back'],
  'Front Split':         ['hamstring','hip','quad'],
  'Middle Split':        ['hip','hamstring'],
  'Twisted Grip Deadlift':['shoulder','back','wrist'],
  'Basic Climb':         ['shoulder','back','grip','quad'],
  'Superman':            ['back','shoulder','core'],
  'Layback Mount':       ['back','shoulder','hip'],
  'Back Hook Spin':      ['shoulder','hip','back'],
  'Chair Spin':          ['shoulder','hip'],
  'Butterfly':           ['shoulder','back','core'],
  'Flatline Scorpio':    ['back','hip','shoulder'],
  'Hip Roll':            ['hip','back','core'],
  'Body Roll':           ['back','core','hip'],
};

// â”€â”€ STATE â”€â”€
let gymSession  = 'full';
let gymStyle    = 'mixed';
let gymPlan     = null;
let gymSelSkill = null;

function initFlex(){
  // Sidebar chips
  document.getElementById('gymSessionChips').addEventListener('click',e=>{
    const b=e.target.closest('.focus-chip');if(!b)return;
    document.querySelectorAll('#gymSessionChips .focus-chip').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    gymSession=b.dataset.gs;
    document.getElementById('gymSkillPickerWrap').style.display=gymSession==='skill'?'block':'none';
    if(gymSession==='skill') gymFilterSkills('');
  });
  document.getElementById('gymStyleChips').addEventListener('click',e=>{
    const b=e.target.closest('.focus-chip');if(!b)return;
    document.querySelectorAll('#gymStyleChips .focus-chip').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    gymStyle=b.dataset.gst;
  });
  // Populate routine link
  const sel=document.getElementById('gymRoutineLink');
  const routines=JSON.parse(localStorage.getItem('pc_routines')||'[]');
  sel.innerHTML='<option value="">â€” None (general session) â€”</option>'+
    routines.map((r,i)=>`<option value="${i}">${r.title||'Untitled Routine'}</option>`).join('');
}

function gymFilterSkills(q){
  const el=document.getElementById('gymSkillList');if(!el)return;
  const allMoves=typeof MOVES!=='undefined'?MOVES:[];
  const filtered=q?allMoves.filter(m=>m.name.toLowerCase().includes(q.toLowerCase())):allMoves;
  el.innerHTML=filtered.slice(0,40).map(m=>`
    <button class="gym-skill-btn${gymSelSkill===m.name?' selected':''}" onclick="gymSelectSkill('${m.name.replace(/'/g,"\\'")}')">
      <span style="flex:1;">${m.name}</span>
      <span class="gym-skill-badge">${m.cat}</span>
      <span class="gym-skill-badge">L${m.psoLevel}</span>
    </button>`).join('');
}

function gymSelectSkill(name){
  gymSelSkill=name;
  gymFilterSkills(document.getElementById('gymSkillSearch')?.value||'');
  const muscles=GYM_MOVE_MUSCLES[name]||[];
  const panel=document.getElementById('gymSelMovePanel');
  if(!panel)return;
  panel.classList.add('visible');
  document.getElementById('gymSelMoveName').textContent=name;
  document.getElementById('gymSelMuscles').innerHTML=muscles.map(m=>
    `<span class="gym-sel-muscle primary">${m}</span>`).join('');
}

// â”€â”€ GENERATE â”€â”€
function generateGym(){
  const targetMin=parseInt(document.getElementById('gymDuration').value);
  const targetSec=targetMin*60;
  const preset=GYM_PRESETS[gymSession]||GYM_PRESETS.full;

  // Build muscle targets
  let muscles=[...preset.muscles];

  // Skill-specific
  if(gymSession==='skill'&&gymSelSkill){
    muscles=[...new Set([...(GYM_MOVE_MUSCLES[gymSelSkill]||[]),...muscles])];
  }

  // Blend in routine muscles
  const routineLink=document.getElementById('gymRoutineLink')?.value;
  if(routineLink!==''){
    const routines=JSON.parse(localStorage.getItem('pc_routines')||'[]');
    const rt=routines[parseInt(routineLink)];
    if(rt){
      rt.sections.forEach(sec=>sec.moves.forEach(mv=>{
        (GYM_MOVE_MUSCLES[mv.name]||[]).forEach(m=>{if(!muscles.includes(m))muscles.push(m);});
      }));
    }
  }

  // Filter by style
  let pool=GYM_EXERCISES.filter(ex=>{
    if(gymStyle==='strength') return ex.type==='strength';
    if(gymStyle==='flex')     return ex.type==='flex'||ex.type==='pnf';
    if(gymStyle==='rehab')    return ex.type==='rehab'||ex.type==='flex';
    return true; // mixed
  });

  // If preset has type filter
  if(preset.types&&preset.types.length){
    pool=pool.filter(ex=>preset.types.includes(ex.type));
  }

  // Score by muscle relevance
  pool=pool.map(ex=>{
    const score=muscles.includes(ex.muscle)?2:
      ex.skills.some(s=>gymSession==='skill'&&gymSelSkill&&s===gymSelSkill)?3:1;
    return{...ex,score};
  }).filter(ex=>muscles.length===0||muscles.includes(ex.muscle)||
    ex.skills.some(s=>gymSession==='skill'&&gymSelSkill&&s===gymSelSkill))
  .sort((a,b)=>(b.score-a.score)+(Math.random()-0.5)*0.5);

  // Build phases
  const phases=[];
  const used=new Set();

  // Phase 1: Warm-in (~15%)
  const warmPool=GYM_EXERCISES.filter(e=>e.type==='flex'&&e.intensity===1&&!used.has(e.name));
  const p1=gymBuildPhase('Warm-In & Mobility ðŸ”¥',warmPool,targetSec*0.15,used,1);
  if(p1.exercises.length)phases.push(p1);

  // Phase 2: Strength work (~50%)
  const strPool=pool.filter(e=>e.type==='strength'&&!used.has(e.name));
  if(strPool.length&&gymStyle!=='flex'){
    const p2=gymBuildPhase(gymSession==='splits'?'Splits Conditioning ðŸ©°':
      gymSession==='backbend'?'Back Bend Conditioning ðŸŒ™':
      gymSession==='skill'&&gymSelSkill?`Strength for ${gymSelSkill} ðŸ’ª`:
      'Strength & Conditioning ðŸ’ª',strPool,targetSec*0.50,used,1);
    if(p2.exercises.length)phases.push(p2);
  }

  // Phase 3: Flexibility / active work (~35%)
  const flxPool=pool.filter(e=>(e.type==='flex'||e.type==='pnf')&&!used.has(e.name));
  if(flxPool.length){
    const p3=gymBuildPhase(gymSession==='splits'?'Split Progressions ðŸ§˜':
      gymSession==='backbend'?'Back Bend Stretching ðŸŒ™':
      gymSession==='skill'&&gymSelSkill?`Flexibility for ${gymSelSkill} â‹`:
      'Flexibility Work â‹',flxPool,targetSec*0.35,used,1);
    if(p3.exercises.length)phases.push(p3);
  }

  const totalSec=phases.reduce((a,p)=>a+p.totalSec,0);
  const totalEx=phases.reduce((a,p)=>a+p.exercises.length,0);
  const totalSets=phases.reduce((a,p)=>a+p.exercises.reduce((b,e)=>b+e.sets,0),0);
  // Count unique skills targeted
  const skillSet=new Set(phases.flatMap(p=>p.exercises.flatMap(e=>e.skills)));

  gymPlan={phases,totalSec,totalEx,totalSets,skillCount:skillSet.size,muscles,
    focusLabel:preset.label,skillName:gymSession==='skill'?gymSelSkill:null};
  renderGym();
}

function gymBuildPhase(name,pool,targetSec,used,minEx){
  const phase={name,exercises:[],totalSec:0};
  let elapsed=0;
  for(const ex of pool){
    if(used.has(ex.name))continue;
    const exSec=(ex.dur||ex.reps*4)*ex.sets+(ex.sets>1?(ex.sets-1)*30:0);
    if(elapsed>0&&elapsed+exSec>targetSec*1.4)break;
    phase.exercises.push({...ex});
    phase.totalSec+=exSec;
    elapsed+=exSec;
    used.add(ex.name);
    if(elapsed>=targetSec)break;
  }
  return phase;
}

// â”€â”€ RENDER â”€â”€
function renderGym(){
  const plan=gymPlan;if(!plan)return;
  const body=document.getElementById('gymBody');
  const totalMin=Math.round(plan.totalSec/60);

  document.getElementById('gymStatEx').textContent=plan.totalEx;
  document.getElementById('gymStatTime').textContent=totalMin;
  document.getElementById('gymStatSets').textContent=plan.totalSets;
  document.getElementById('gymStatSkills').textContent=plan.skillCount;
  document.getElementById('gymRegenBtn').style.display='';
  document.getElementById('gymCopyBtn').style.display='';
  document.getElementById('gymHeadline').textContent=plan.focusLabel+' Session';

  // Skill panel if skill-specific
  let html='';
  if(plan.skillName&&GYM_MOVE_MUSCLES[plan.skillName]){
    const mm=GYM_MOVE_MUSCLES[plan.skillName];
    html+=`<div style="background:var(--bg2);border:1px solid var(--accent);border-left:3px solid var(--accent);padding:14px 18px;margin-bottom:20px;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent);font-style:italic;margin-bottom:8px;">Training for: ${plan.skillName}</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;">${mm.map(m=>`<span class="wu-tag muscle">${m}</span>`).join('')}</div>
    </div>`;
  }

  // Muscle tags
  html+=`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:18px;">${plan.muscles.map(m=>`<span class="wu-tag muscle">${m}</span>`).join('')}</div>`;

  // Phases
  plan.phases.forEach(phase=>{
    const phaseMin=Math.round(phase.totalSec/60)||1;
    html+=`<div class="gym-section-hdr">
      <div class="gym-section-title">${phase.name}</div>
      <div class="gym-section-line"></div>
      <div class="gym-section-time">~${phaseMin} min</div>
    </div>`;
    html+=`<div class="gym-cards">`;
    phase.exercises.forEach((ex,i)=>{
      const mc='gmc-'+ex.muscle;
      const typeLabel=ex.type==='pnf'?'PNF':ex.type==='strength'?'Strength':ex.type==='rehab'?'Rehab':'Stretch';
      const typeColor=ex.type==='strength'?'var(--accent)':ex.type==='pnf'?'var(--l5)':'var(--l2)';
      const durStr=ex.dur?`${ex.dur}s`:`${ex.reps} reps`;
      const timerData=ex.dur?`data-dur="${ex.dur}" data-sets="${ex.sets}" data-name="${ex.name.replace(/"/g,'&quot;')}" data-note="${(ex.note||'').replace(/"/g,'&quot;')}"` :'';
      // SKILL NAMES on the card â€” these are the pole moves this trains
      const skillChips=ex.skills.slice(0,4).map(s=>`<span class="gym-skill-chip"><span class="gym-skill-chip-icon">â—ˆ</span>${s}</span>`).join('');
      html+=`
        <div class="gym-card ${mc}" style="animation-delay:${i*40}ms">
          <button class="gym-card-del" onclick="removeGymEx('${phase.name}','${ex.name.replace(/'/g,"\\'")}')">âœ•</button>
          <div class="gym-card-name">${ex.name}</div>
          <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px;">${skillChips}</div>
          <div class="gym-card-tags"><span class="wu-tag muscle">${ex.muscle}</span></div>
          <div class="gym-card-time">
            <span class="gym-card-dur">${durStr} Â· ${ex.sets} set${ex.sets>1?'s':''}</span>
            <span style="font-size:8px;color:${typeColor};margin-left:4px;">${typeLabel}</span>
            ${ex.dur?`<button class="wu-timer-btn" ${timerData} onclick="startExTimer(this)" style="margin-left:auto;">â± Timer</button>`:''}
          </div>
          ${ex.note?`<div class="gym-card-note">${ex.note}</div>`:''}
        </div>`;
    });
    html+=`</div>`;
    html+=`<div class="rest-card"><span class="rest-icon">ðŸ’§</span><span class="rest-txt">Rest / Water</span><span class="rest-dur" style="margin-left:auto;">60â€“90s</span></div>`;
  });

  html+=`<div class="gym-total-bar">
    <div>
      <div class="gym-total-bar-txt">Total session time</div>
      <div class="gym-total-bar-min">${totalMin} min</div>
    </div>
    <button class="gym-start-btn" onclick="gymStartGuided()">â–¶ Start Guided Session</button>
  </div>`;

  body.innerHTML=html;
}

function removeGymEx(phaseName,exName){
  if(!gymPlan)return;
  const phase=gymPlan.phases.find(p=>p.name===phaseName);if(!phase)return;
  phase.exercises=phase.exercises.filter(e=>e.name!==exName);
  phase.totalSec=phase.exercises.reduce((a,e)=>a+(e.dur||e.reps*4)*e.sets+(e.sets>1?(e.sets-1)*30:0),0);
  gymPlan.totalEx=gymPlan.phases.reduce((a,p)=>a+p.exercises.length,0);
  gymPlan.totalSec=gymPlan.phases.reduce((a,p)=>a+p.totalSec,0);
  gymPlan.totalSets=gymPlan.phases.reduce((a,p)=>a+p.exercises.reduce((b,e)=>b+e.sets,0),0);
  renderGym();
}

function gymStartGuided(){
  const firstBtn=document.querySelector('#gymBody .wu-timer-btn');
  if(firstBtn)startExTimer(firstBtn);
  else showToast('No timed exercises â€” use rep count for strength exercises');
}

function gymCopyPlan(){
  if(!gymPlan)return;
  let lines=[gymPlan.focusLabel.toUpperCase()+' â€” GYM SESSION',''];
  gymPlan.phases.forEach(phase=>{
    lines.push(`â”€â”€ ${phase.name.toUpperCase()} â”€â”€`);
    phase.exercises.forEach(e=>{
      const durStr=e.dur?`${e.dur}s hold`:`${e.reps} reps`;
      lines.push(`  ${e.name} â€” ${durStr} Ã— ${e.sets} sets`);
      lines.push(`    Skills: ${e.skills.join(', ')}`);
    });
    lines.push('');
  });
  lines.push(`Total: ${Math.round(gymPlan.totalSec/60)} min Â· ${gymPlan.totalEx} exercises Â· ${gymPlan.skillCount} skills targeted`);
  navigator.clipboard.writeText(lines.join('\n')).then(()=>showToast('Plan copied!'));
}

// ============================================================
// iPAD & SAFARI FIXES
// ============================================================

// Detect iPad/Safari
const isIPad = /iPad/.test(navigator.userAgent) || 
               (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
              (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);

// iPad/Safari: drag and drop doesn't work natively â€” add touch drag polyfill
function addTouchDragSupport(){
  if(!isIOS && !isIPad) return;
  let dragEl = null, dragClone = null, startX=0, startY=0;

  document.addEventListener('touchstart', e=>{
    const el = e.target.closest('[draggable="true"]');
    if(!el) return;
    dragEl = el;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    // Visual feedback
    setTimeout(()=>{ if(dragEl) dragEl.style.opacity='0.5'; }, 150);
  }, {passive:true});

  document.addEventListener('touchmove', e=>{
    if(!dragEl) return;
    e.preventDefault(); // prevent scroll while dragging
    const touch = e.touches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    if(target) target.dispatchEvent(new Event('dragover',{bubbles:true}));
  }, {passive:false});

  document.addEventListener('touchend', e=>{
    if(!dragEl) return;
    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    dragEl.style.opacity='';
    if(target){
      // Find nearest drop zone
      const dz = target.closest('.drop-zone') || target.closest('.routine-section');
      if(dz) dz.dispatchEvent(new Event('drop',{bubbles:true}));
    }
    dragEl = null;
  }, {passive:true});
}

// Safari: fix 300ms click delay on older iOS
function fixSafariClickDelay(){
  if(!isIOS) return;
  // Add touch-action manipulation to prevent delay
  const style = document.createElement('style');
  style.textContent = 'button, [onclick], .nav-tab, .focus-chip, .chip, .bank-item, .saved-card, .wu-card, .gym-card, .tracker-bubble { touch-action: manipulation; }';
  document.head.appendChild(style);
}

// Safari: vh units don't account for address bar â€” use dvh where supported
function fixSafariVH(){
  if(!isIOS) return;
  const setVH = () => {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  };
  setVH();
  window.addEventListener('resize', setVH, {passive:true});
  window.addEventListener('orientationchange', ()=>setTimeout(setVH, 300), {passive:true});
}

// Safari: inputs with font-size < 16px cause zoom â€” already fixed in CSS
// but double-check at runtime
function fixSafariInputZoom(){
  if(!isIOS) return;
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    const fs = parseFloat(getComputedStyle(el).fontSize);
    if(fs < 16) el.style.fontSize = '16px';
  });
}

// iPad: detect orientation changes and re-render layout
function handleOrientationChange(){
  if(!isIPad) return;
  window.addEventListener('orientationchange', ()=>{
    setTimeout(()=>{
      // Re-trigger any active page render
      const activePage = document.querySelector('.nav-tab.active');
      if(activePage){
        const pageId = activePage.dataset.page;
        if(pageId==='warmup' && typeof generateWarmup==='function' && wuCurrentPlan) renderWarmup();
        if(pageId==='flex' && typeof renderGym==='function' && gymPlan) renderGym();
      }
    }, 400);
  }, {passive:true});
}

// Run all fixes
function initIPadFixes(){
  fixSafariClickDelay();
  fixSafariVH();
  addTouchDragSupport();
  handleOrientationChange();
  // Small delay for DOM to be ready
  setTimeout(fixSafariInputZoom, 500);
}

// ============================================================
// DATA BACKUP & RESTORE
// ============================================================
const BACKUP_KEYS = [
  {key:'pc_combos',        label:'Combos'},
  {key:'pc_routines',      label:'Routines'},
  {key:'pc_tracker',       label:'Tracker'},
  {key:'pc_journal',       label:'Journal'},
  {key:'pc_goals',         label:'Goals'},
  {key:'pc_schedule',      label:'Schedule'},
  {key:'pc_studio',        label:'Content Studio'},
  {key:'pc_all_profiles',  label:'Profiles'},
  {key:'pc_active_profile',label:'Active Profile'},
  {key:'pc_nav_order',     label:'Nav Order'},
  {key:'pc_teach_plans',   label:'Teach Plans'},
  {key:'pc_teach_roster',  label:'Teach Roster'},
  {key:'pc_teach_notes',   label:'Teaching Notes'},
  {key:'pc_alpha_moves',   label:'AlphaPole Moves'},
  {key:'pc_alpha_done',    label:'AlphaPole Progress'},
  {key:'pc_30day',         label:'30-Day Challenge'},
  {key:'pc_checks',        label:'PSO Checklist'},
  {key:'pc_mb_url',        label:'Mindbody URL'},
  {key:'pc_fb_config',     label:'Firebase Config'},
];

function exportAllData(){
  const backup = {
    _version: 1,
    _exported: new Date().toISOString(),
    _app: 'PoleCraft',
    data: {}
  };
  let count = 0;
  BACKUP_KEYS.forEach(({key, label}) => {
    const val = localStorage.getItem(key);
    if(val){ backup.data[key] = val; count++; }
  });

  const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href     = url;
  a.download = `polecraft-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);

  const status = document.getElementById('backupStatus');
  if(status) status.textContent = `âœ“ Exported ${count} data items â€” ${date}`;
  showToast('Backup downloaded!');
}

function importAllData(input){
  const file = input.files[0];
  if(!file) return;
  const status = document.getElementById('backupStatus');

  const reader = new FileReader();
  reader.onload = e => {
    try{
      const backup = JSON.parse(e.target.result);

      // Validate it's a PoleCraft backup
      if(backup._app !== 'PoleCraft' || !backup.data){
        if(status) status.textContent = 'âœ• Not a valid PoleCraft backup file';
        showToast('Invalid backup file'); return;
      }

      const keys = Object.keys(backup.data);
      let restored = 0;

      // Restore each key
      keys.forEach(key => {
        const val = backup.data[key];
        if(val && key.startsWith('pc_')){
          localStorage.setItem(key, val);
          restored++;
        }
      });

      // Reload app state from restored localStorage
      try{
        savedCombos  = JSON.parse(localStorage.getItem('pc_combos')  || '[]');
        journalData  = JSON.parse(localStorage.getItem('pc_journal') || '[]');
        trackerData  = JSON.parse(localStorage.getItem('pc_tracker') || '{}');
        goalsData    = JSON.parse(localStorage.getItem('pc_goals')   || '[]');
        teachPlans   = JSON.parse(localStorage.getItem('pc_teach_plans')  || '[]');
        teachRoster  = JSON.parse(localStorage.getItem('pc_teach_roster') || '[]');
        teachNotes   = JSON.parse(localStorage.getItem('pc_teach_notes')  || '[]');
      } catch(err){ console.warn('State reload error:', err); }

      // Re-init profiles + nav
      initNav();
      initProfiles();
      renderSaved();
      updateStats();

      const exportedDate = backup._exported
        ? new Date(backup._exported).toLocaleDateString()
        : 'unknown date';

      if(status) status.textContent = `âœ“ Restored ${restored} items from ${exportedDate}`;
      showToast(`Backup restored â€” ${restored} items!`);

    } catch(err){
      if(status) status.textContent = 'âœ• Could not read file â€” is it a valid JSON backup?';
      showToast('Import failed: ' + err.message);
    }
    // Reset file input so same file can be re-imported
    input.value = '';
  };
  reader.readAsText(file);
}

// â”€â”€ FIREBASE DEBUG â”€â”€
function toggleFbDebug(){
  const panel = document.getElementById('fbDebug');
  const btn   = document.getElementById('fbSyncStatusBtn');
  if(!panel) return;
  const showing = panel.classList.toggle('visible');
  if(btn) btn.style.color = showing ? 'var(--accent)' : '';
  if(showing) refreshFbDebug();
}

function fbd(id, val, cls){
  const el = document.getElementById('fbd-'+id); if(!el) return;
  el.textContent = val;
  el.className = 'fbd-val' + (cls?' '+cls:'');
}

function refreshFbDebug(){
  fbd('sdk',   typeof firebase!=='undefined'?'âœ“ loaded':'âœ• missing', typeof firebase!=='undefined'?'ok':'err');
  fbd('app',   fbApp?'âœ“ initialized':'âœ• not init', fbApp?'ok':'err');
  fbd('auth',  fbAuth?'âœ“ ready':'âœ• null', fbAuth?'ok':'err');
  fbd('db',    fbDb?'âœ“ ready':'âœ• null', fbDb?'ok':'err');
  fbd('user',  fbUser?(fbUser.email||fbUser.uid||'signed in'):'not signed in', fbUser?'ok':'warn');
  fbd('doc',   'â€”');
  // Test a live read
  if(fbUser && fbDb){
    fbd('read', 'testing...', 'warn');
    fbGetUserDoc().get()
      .then(doc=>{
        fbd('read', new Date().toLocaleTimeString(), 'ok');
        fbd('doc',  doc.exists?'âœ“ exists ('+Object.keys(doc.data()||{}).join(', ')+')':'âœ• empty - new account', doc.exists?'ok':'warn');
        fbd('error','â€”');
      })
      .catch(e=>{
        fbd('read', 'FAILED', 'err');
        fbd('error', e.message);
        fbd('doc', 'âœ• read failed', 'err');
      });
  }
}

// Patch fbSyncNow to update debug
const _origFbSyncNow = fbSyncNow;
async function fbSyncNow(dataType, data){
  await _origFbSyncNow(dataType, data);
  fbd('write', new Date().toLocaleTimeString()+' ('+dataType+')', 'ok');
}

let fbLiveSyncUnsub = null;
let fbLastPull = 0;

// Real-time listener â€” Firestore pushes changes to this device automatically
function fbStartLiveSync(){
  if(!fbUser||!fbDb) return;
  if(fbLiveSyncUnsub) fbLiveSyncUnsub();

  // Listen to the whole data subcollection â€” fires when any doc changes
  fbLiveSyncUnsub = fbGetUserDoc().onSnapshot(snap=>{
    if(snap.metadata.hasPendingWrites) return;
    if(snap.exists){ fbApplyCloudData(snap.data(), true); fbd('read', new Date().toLocaleTimeString(), 'ok'); }
  }, err=>{ console.warn('Live sync error:', err); fbd('error', err.message); });
}

// Pull without showing loading overlay â€” for background refreshes
async function fbSilentPull(){
  if(!fbUser||!fbDb) return;
  try{
    const snap = await fbGetUserDoc().get();
    if(snap.exists) fbApplyCloudData(snap.data(), true);
  } catch(e){ console.warn('Silent pull failed:', e); }
}

// Apply cloud data to app state â€” shared by load and live sync
function fbApplyCloudData(d, rerender){
  if(!d) return;
  
  if(d.combos !== undefined){
    savedCombos = d.combos;
    localStorage.setItem('pc_combos', JSON.stringify(savedCombos));
    if(rerender){ renderSaved(); updateStats(); }
  }
  if(d.routines !== undefined){
    savedRoutines = d.routines;
    localStorage.setItem('pc_routines', JSON.stringify(savedRoutines));
    if(rerender) renderSavedRoutines();
  }
  if(d.tracker !== undefined){
    trackerData = d.tracker;
    localStorage.setItem('pc_tracker', JSON.stringify(trackerData));
    if(rerender){
      const activePage = document.querySelector('.page.active');
      if(activePage?.id==='page-journal') renderTracker();
    }
  }
  if(d.journal !== undefined){
    journalData = d.journal;
    localStorage.setItem('pc_journal', JSON.stringify(journalData));
  }
  if(d.goals !== undefined){
    goalsData = d.goals;
    localStorage.setItem('pc_goals', JSON.stringify(goalsData));
    if(rerender){
      const activePage = document.querySelector('.page.active');
      if(activePage?.id==='page-journal') renderGoals();
    }
  }
  if(d.schedule !== undefined){
    schedClasses = d.schedule;
    localStorage.setItem('pc_schedule', JSON.stringify(schedClasses));
  }
  if(d.studio !== undefined){
    studioData = d.studio;
    localStorage.setItem('pc_studio', JSON.stringify(studioData));
    if(rerender){
      const activePage = document.querySelector('.page.active');
      if(activePage?.id==='page-studio') renderStudio();
    }
  }
  if(d.teachPlans  !== undefined){ teachPlans  = d.teachPlans;  localStorage.setItem('pc_teach_plans',  JSON.stringify(teachPlans));  }
  if(d.teachRoster !== undefined){ teachRoster = d.teachRoster; localStorage.setItem('pc_teach_roster', JSON.stringify(teachRoster)); }
  if(d.teachNotes  !== undefined){ teachNotes  = d.teachNotes;  localStorage.setItem('pc_teach_notes',  JSON.stringify(teachNotes));  }
  if(d.navOrder !== undefined){
    const savedIds = d.navOrder.map(p=>p.id);
    const missing  = NAV_PAGES_DEFAULT.filter(p=>!savedIds.includes(p.id));
    navPages = [...d.navOrder, ...missing];
    localStorage.setItem('pc_nav_order', JSON.stringify(navPages));
    if(rerender){ renderNav(); renderMobileNav(); }
  }
  if(d.profile !== undefined){
    pcUser = d.profile;
    activeProfileId = d.profile.id || fbUser?.uid;
    allProfiles = allProfiles.length
      ? allProfiles.map(p=>p.id===activeProfileId ? d.profile : p)
      : [d.profile];
    saveProfiles();
    if(rerender) updateHeaderProfile();
  }
}

// Measure actual header height after render and set CSS var
function updateHeaderHeight(){
  const header = document.querySelector('header');
  const authBar = document.getElementById('fbAuthBar');
  const navBar  = document.getElementById('navTabs');
  let h = 0;
  if(header)  h += header.offsetHeight;
  if(authBar && !authBar.classList.contains('hidden')) h += authBar.offsetHeight;
  if(navBar)  h += navBar.offsetHeight;
  document.documentElement.style.setProperty('--header-h', h+'px');
}


function init(){
  initIPadFixes();
  initNav();
  initProfiles();
  initFirebase();
  setTimeout(updateHeaderHeight, 300);
  window.addEventListener("resize", updateHeaderHeight, {passive:true});
  setTimeout(fbAddSyncBadge, 500);
  setTimeout(renderMobileNav, 50);
  updateStats(); renderBrowse(); renderSaved(); renderPSO();
  renderCanvas(); renderBank(); renderSavedRoutines();
  renderPSOChecklist(); initStudio(); initWuRoutineLink(); initSchedule(); renderVidLib(); renderMobileNav();
  document.getElementById('comboLength').addEventListener('input',function(){
    document.getElementById('rangeVal').textContent=this.value;
  });
  document.getElementById('routineTitle').value='';
  document.getElementById('routineTitle').addEventListener('input',()=>{});
  maybeShowLanding();
}

function switchSub(n,btn){
  document.querySelectorAll('.sub-content').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('sub-'+n).classList.add('active');
  btn.classList.add('active');
  if(n==='games') renderGamesHub();
}

function showScoring(t,btn){
  document.getElementById('scoreTech').style.display=t==='tech'?'grid':'none';
  const sa=document.getElementById('scoreArt');sa.style.display=t==='art'?'grid':'none';
  document.getElementById('techBtn').style.cssText=t==='tech'?'border-color:var(--accent);color:var(--accent);':'';
  document.getElementById('artBtn').style.cssText=t==='art'?'border-color:var(--accent);color:var(--accent);':'';
}

document.getElementById('levelChips').addEventListener('click',e=>{
  const c=e.target.closest('.chip');if(!c)return;
  const v=c.dataset.level;
  activeLevels.has(v)?activeLevels.delete(v):activeLevels.add(v);
  c.classList.toggle('active',activeLevels.has(v));
  updateStats();
});
document.getElementById('catChips').addEventListener('click',e=>{
  const c=e.target.closest('.chip');if(!c)return;
  const v=c.dataset.cat;
  activeCats.has(v)?activeCats.delete(v):activeCats.add(v);
  c.classList.toggle('active',activeCats.has(v));
  updateStats();
});

function togglePrebuilt(btn){
  usePrebuilt=!usePrebuilt;
  btn.textContent=usePrebuilt?'On':'Off';
  btn.classList.toggle('active',usePrebuilt);
}

function clearFilters(){
  activeLevels=new Set(["1","2","3","4","5","Floorwork"]);
  activeCats=new Set(["Spin","Pose","Invert","Mount","Trick","Transition","Drop","Floor","Hold","Climb"]);
  document.querySelectorAll('#levelChips .chip').forEach(c=>c.classList.add('active'));
  document.querySelectorAll('#catChips .chip').forEach(c=>c.classList.add('active'));
  updateStats();
}

function getFiltered(){return MOVES.filter(m=>activeLevels.has(m.psoLevel)&&activeCats.has(m.cat));}

function updateStats(){
  document.getElementById('statTotal').textContent=MOVES.length;
  document.getElementById('statSaved').textContent=savedCombos.length;
  document.getElementById('statFiltered').textContent=getFiltered().length;
  document.getElementById('savedBadge').textContent=savedCombos.length?`(${savedCombos.length})`:'';
  const vids=Object.values(studioData).reduce((a,d)=>a+d.length,0);
  document.getElementById('statVideos').textContent=vids;
}

function generateCombo(){
  const f=getFiltered(),len=parseInt(document.getElementById('comboLength').value);
  if(usePrebuilt&&Math.random()<0.25){
    const pb=PREBUILT[Math.floor(Math.random()*PREBUILT.length)];
    currentCombo={moves:pb.moves,name:pb.name};
  }else{
    if(f.length<len){showToast('Not enough moves match filters!');return;}
    const pool=[...f],sel=[];
    for(let i=0;i<len&&pool.length>0;i++) sel.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);
    currentCombo={moves:sel};
  }
  renderCombo(currentCombo);
  switchSub('output',document.querySelector('.sub-tab'));
}

function renderCombo(combo){
  const lvls=[...new Set(combo.moves.map(m=>m.psoLevel))].map(ll).join(', ');
  let h=`<div class="combo-fade"><div class="combo-header"><div class="combo-title">${combo.name||'Generated Sequence'}</div><div class="combo-meta">${combo.moves.length} moves Â· ${lvls}</div></div><div class="moves-list">`;
  combo.moves.forEach((m,i)=>{
    h+=`<div class="move-item" style="animation-delay:${i*50}ms">
      <div class="move-num">${i+1}</div><div class="move-name">${m.name}</div>
      <span class="badge ${lc(m.psoLevel)}">${ll(m.psoLevel)}</span>
      <span class="cat-badge">${m.cat}</span></div>`;
    if(i<combo.moves.length-1) h+=`<div class="arrow-row">â†“</div>`;
  });
  h+=`</div><div class="combo-actions">
    <button class="action-btn" onclick="saveCombo()">â™¡ Save</button>
    <button class="action-btn" onclick="copyCombo()">â†— Copy</button>
    <button class="action-btn" onclick="generateCombo()">â†º Regenerate</button>
    <button class="action-btn" onclick="sendComboToStudio()">â–¶ Add to Studio</button>
  </div></div>`;
  document.getElementById('comboOutput').innerHTML=h;
}

function saveCombo(){
  if(!currentCombo)return;
  // Try to get tagline from a prompt or existing field
  const tagline = currentCombo.tagline || '';
  savedCombos.unshift({id:Date.now(),moves:currentCombo.moves,name:currentCombo.name,tagline,created:new Date().toLocaleDateString()});
  localStorage.setItem('pc_combos',JSON.stringify(savedCombos));
  fbSyncCombos();
  updateStats();renderSaved();showToast('Combo saved!');
}
function copyCombo(){
  if(!currentCombo)return;
  navigator.clipboard.writeText(currentCombo.moves.map((m,i)=>`${i+1}. ${m.name} (L${m.psoLevel}, ${m.cat})`).join('\n')).then(()=>showToast('Copied!'));
}
function sendComboToStudio(){
  if(!currentCombo)return;
  studioQueuedCombo=currentCombo;
  showToast('Ready! Go to Content Studio and drag to a day card');
  showPage('studio',document.querySelectorAll('.nav-tab')[2]);
}

function renderSaved(){
  const g=document.getElementById('savedGrid'),e=document.getElementById('savedEmpty');
  if(!savedCombos.length){g.innerHTML='';e.style.display='flex';return;}
  e.style.display='none';
  g.innerHTML=savedCombos.map((c,i)=>`
    <div class="saved-card" onclick="loadSaved(${i})">
      <button class="saved-card-del" onclick="event.stopPropagation();deleteSaved(${i})">âœ•</button>
      <div class="saved-card-name">${c.name||'Combo '+(savedCombos.length-i)}</div>
      ${c.tagline?`<div class="saved-routine-tagline">${c.tagline}</div>`:''}
      <div class="saved-card-moves">${c.moves.map(m=>m.name).join(' â†’ ')}</div>
      <div style="font-size:8px;color:var(--dim);margin-top:6px;">${c.created}</div>
    </div>`).join('');
}
function loadSaved(i){currentCombo=savedCombos[i];renderCombo(currentCombo);switchSub('output',document.querySelector('.sub-tab'));}
function deleteSaved(i){savedCombos.splice(i,1);localStorage.setItem('pc_combos',JSON.stringify(savedCombos));fbSyncCombos();updateStats();renderSaved();}
function filterBrowse(){
  const q=document.getElementById('browseSearch').value.toLowerCase();
  const lv=document.getElementById('browseLevel').value;
  const ct=document.getElementById('browseCat').value;
  renderBrowse(MOVES.filter(m=>{
    if(q&&!m.name.toLowerCase().includes(q))return false;
    if(lv&&m.psoLevel!==lv)return false;
    if(ct&&m.cat!==ct)return false;
    return true;
  }));
}
function renderBrowse(list){
  const body=document.getElementById('browseBody'),data=list||MOVES;
  if(!data.length){body.innerHTML=`<tr><td colspan="3" style="padding:24px;text-align:center;color:var(--dim);font-size:9px;">No moves found</td></tr>`;return;}
  body.innerHTML=data.map(m=>`<tr>
    <td class="nc">${m.name}</td>
    <td><span class="badge ${lc(m.psoLevel)}">${ll(m.psoLevel)}</span></td>
    <td style="color:var(--muted);font-size:9px;">${m.cat}</td>
  </tr>`).join('');
}

// ============================================================
// ROUTINE BUILDER
// ============================================================
let routine={sections:[]};
let savedRoutines=JSON.parse(localStorage.getItem('pc_routines')||'[]');
let bankLvl='all',bankCat='all';
let dragSrc=null,dragOverInfo=null;

document.getElementById('bankChips').addEventListener('click',e=>{
  const c=e.target.closest('.bank-chip');if(!c)return;
  document.querySelectorAll('#bankChips .bank-chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');bankLvl=c.dataset.bl;renderBank();
});
document.getElementById('bankCatChips').addEventListener('click',e=>{
  const c=e.target.closest('.bank-chip');if(!c)return;
  document.querySelectorAll('#bankCatChips .bank-chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');bankCat=c.dataset.bc;renderBank();
});

function renderBank(){
  const q=document.getElementById('bankSearch').value.toLowerCase();
  const f=MOVES.filter(m=>{
    if(bankLvl!=='all'&&m.psoLevel!==bankLvl)return false;
    if(bankCat!=='all'&&m.cat!==bankCat)return false;
    if(q&&!m.name.toLowerCase().includes(q))return false;
    return true;
  });
  const bk=document.getElementById('moveBank');
  if(!f.length){bk.innerHTML='<div style="padding:14px;text-align:center;color:var(--dim);font-size:9px;">No moves found</div>';return;}
  bk.innerHTML=f.map(m=>`
    <div class="bank-item" draggable="true"
      data-name="${m.name.replace(/"/g,'&quot;')}" data-level="${m.psoLevel}" data-cat="${m.cat}"
      ondragstart="bankDragStart(event,this)" ondragend="bankDragEnd(event)">
      <span class="bi-grip">â ¿</span>
      <span class="bi-name">${m.name}</span>
      <span class="badge ${lc(m.psoLevel)}" style="font-size:8px;">${ll(m.psoLevel)}</span>
    </div>`).join('');
}

function bankDragStart(e,el){
  dragSrc={fromBank:true,move:{name:el.dataset.name,psoLevel:el.dataset.level,cat:el.dataset.cat,note:''}};
  el.classList.add('dragging');e.dataTransfer.effectAllowed='copy';
}
function bankDragEnd(){document.querySelectorAll('.bank-item').forEach(el=>el.classList.remove('dragging'));}

const SC_CLS=['sc-i','sc-v','sc-c','sc-b','sc-o'];
const SC_NAMES=['Warm Up','Floorwork','Pole Work','PSO Section','Cool Down'];

let secDragSrc=null; // which section is being dragged

function addSection(name,cls){
  const i=routine.sections.length;
  routine.sections.push({
    id:'s'+Date.now()+Math.random().toString(36).slice(2),
    name:name||SC_NAMES[Math.min(i,SC_NAMES.length-1)],
    cls:cls||SC_CLS[Math.min(i,SC_CLS.length-1)],
    moves:[]
  });renderCanvas();
}
function removeSection(id){routine.sections=routine.sections.filter(s=>s.id!==id);renderCanvas();}
function renameSection(id,v){const s=routine.sections.find(s=>s.id===id);if(s)s.name=v;}

// Section drag-and-drop
function secDragStart(e,id){
  secDragSrc=id;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain','section:'+id);
  setTimeout(()=>document.getElementById('section_'+id)?.classList.add('sec-dragging'),0);
}
function secDragEnd(e){
  secDragSrc=null;
  document.querySelectorAll('.routine-section').forEach(el=>{
    el.classList.remove('sec-dragging','sec-drag-above','sec-drag-below');
  });
}
function secDragOver(e,id){
  e.preventDefault();e.stopPropagation();
  if(!secDragSrc||secDragSrc===id)return;
  document.querySelectorAll('.routine-section').forEach(el=>el.classList.remove('sec-drag-above','sec-drag-below'));
  const el=document.getElementById('section_'+id);if(!el)return;
  const rect=el.getBoundingClientRect();
  const above=e.clientY<rect.top+rect.height/2;
  el.classList.add(above?'sec-drag-above':'sec-drag-below');
  e.dataTransfer.dropEffect='move';
}
function secDragLeave(e,id){
  if(!e.currentTarget.contains(e.relatedTarget))
    document.getElementById('section_'+id)?.classList.remove('sec-drag-above','sec-drag-below');
}
function secDrop(e,id){
  e.preventDefault();e.stopPropagation();
  document.querySelectorAll('.routine-section').forEach(el=>el.classList.remove('sec-drag-above','sec-drag-below','sec-dragging'));
  if(!secDragSrc||secDragSrc===id)return;
  const fromIdx=routine.sections.findIndex(s=>s.id===secDragSrc);
  const toEl=document.getElementById('section_'+id);
  const rect=toEl?.getBoundingClientRect();
  const above=rect?e.clientY<rect.top+rect.height/2:true;
  let toIdx=routine.sections.findIndex(s=>s.id===id);
  if(fromIdx<0||toIdx<0)return;
  const [moved]=routine.sections.splice(fromIdx,1);
  toIdx=routine.sections.findIndex(s=>s.id===id);
  routine.sections.splice(above?toIdx:toIdx+1,0,moved);
  secDragSrc=null;
  renderCanvas();
}

function renderCanvas(){
  updateChoreoStats();
  const canvas=document.getElementById('choreoCanvas');
  let h='';
  let off=0;
  routine.sections.forEach((sec,si)=>{
    h+=`<div class="routine-section ${sec.cls}" id="section_${sec.id}"
      ondragover="secDragOver(event,'${sec.id}')"
      ondragleave="secDragLeave(event,'${sec.id}')"
      ondrop="secDrop(event,'${sec.id}')">
      <div class="sec-hdr">
        <span class="sec-grip" draggable="true"
          ondragstart="secDragStart(event,'${sec.id}')"
          ondragend="secDragEnd(event)"
          title="Drag to reorder section">â ¿</span>
        <div class="sec-color-dot"></div>
        <input class="sec-name-in" value="${sec.name}" oninput="renameSection('${sec.id}',this.value)" placeholder="Section">
        <div class="sec-actions">
          <button class="sec-btn danger" onclick="removeSection('${sec.id}')">âœ•</button>
        </div>
      </div>
      <div class="drop-zone" id="dz_${sec.id}"
        ondragover="dzOver(event,'${sec.id}')"
        ondragleave="dzLeave(event,'${sec.id}')"
        ondrop="dzDrop(event,'${sec.id}')">`;
    if(!sec.moves.length){h+=`<div class="dz-empty">Drop moves here</div>`;}
    else sec.moves.forEach((mv,mi)=>{
      h+=`<div class="routine-move" id="rmv_${mv.id}"
        draggable="true"
        ondragstart="mvDragStart(event,'${sec.id}',${mi})"
        ondragend="mvDragEnd(event)"
        ondragover="mvDragOver(event,'${sec.id}',${mi})"
        ondragleave="mvDragLeave(event)"
        ondrop="mvDrop(event,'${sec.id}',${mi})">
        <span class="rm-grip">â ¿</span>
        <span class="rm-num">${off+mi+1}</span>
        <span class="rm-name">${mv.name}</span>
        <span class="badge ${lc(mv.psoLevel)}" style="font-size:8px;">${ll(mv.psoLevel)}</span>
        <span class="rm-cat">${mv.cat}</span>
        <input class="rm-note" placeholder="note..." value="${mv.note||''}"
          oninput="updateMvNote('${sec.id}','${mv.id}',this.value)"
          ondragstart="event.stopPropagation()">
        <button class="rm-del" onclick="removeMove('${sec.id}','${mv.id}')">âœ•</button>
      </div>`;
    });
    off+=sec.moves.length;
    h+=`</div></div>`;
  });
  h+=`<button class="add-sec-btn" onclick="addSection()">+ Add Section</button>`;
  canvas.innerHTML=h;
}

function updateChoreoStats(){
  const tot=routine.sections.reduce((a,s)=>a+s.moves.length,0);
  document.getElementById('cstatMoves').textContent=tot;
  document.getElementById('cstatSecs').textContent=routine.sections.length;
}

function addMoveToSec(secId,move){
  const s=routine.sections.find(s=>s.id===secId);if(!s)return;
  s.moves.push({...move,id:'m'+Date.now()+Math.random().toString(36).slice(2)});
  renderCanvas();
}
function removeMove(secId,mvId){
  const s=routine.sections.find(s=>s.id===secId);
  if(s){s.moves=s.moves.filter(m=>m.id!==mvId);renderCanvas();}
}
function updateMvNote(secId,mvId,note){
  const s=routine.sections.find(s=>s.id===secId);
  if(s){const m=s.moves.find(m=>m.id===mvId);if(m)m.note=note;}
}

function dzOver(e,sid){e.preventDefault();e.dataTransfer.dropEffect=dragSrc?.fromBank?'copy':'move';document.getElementById('dz_'+sid)?.classList.add('drag-over');}
function dzLeave(e,sid){if(!e.currentTarget.contains(e.relatedTarget))document.getElementById('dz_'+sid)?.classList.remove('drag-over');}
function dzDrop(e,sid){
  e.preventDefault();document.getElementById('dz_'+sid)?.classList.remove('drag-over');
  if(!dragSrc)return;
  if(dragSrc.fromBank){addMoveToSec(sid,{...dragSrc.move});}
  else if(dragSrc.sectionId){
    const ss=routine.sections.find(s=>s.id===dragSrc.sectionId);
    const ds=routine.sections.find(s=>s.id===sid);
    if(!ss||!ds)return;
    const[mv]=ss.moves.splice(dragSrc.moveIdx,1);
    ds.moves.push(mv);renderCanvas();
  }
  dragSrc=null;dragOverInfo=null;
}

function mvDragStart(e,sid,mi){
  dragSrc={sectionId:sid,moveIdx:mi};e.dataTransfer.effectAllowed='move';
  const sec=routine.sections.find(s=>s.id===sid);
  if(sec?.moves[mi]){setTimeout(()=>document.getElementById('rmv_'+sec.moves[mi].id)?.classList.add('dragging'),0);}
}
function mvDragEnd(){
  document.querySelectorAll('.routine-move').forEach(el=>el.classList.remove('dragging','dta','dtb'));
  dragSrc=null;dragOverInfo=null;
}
function mvDragOver(e,sid,mi){
  e.preventDefault();e.stopPropagation();
  document.querySelectorAll('.routine-move').forEach(el=>el.classList.remove('dta','dtb'));
  const sec=routine.sections.find(s=>s.id===sid);if(!sec)return;
  const mv=sec.moves[mi];if(!mv)return;
  const el=document.getElementById('rmv_'+mv.id);if(!el)return;
  const rect=el.getBoundingClientRect();
  const above=e.clientY<rect.top+rect.height/2;
  el.classList.add(above?'dta':'dtb');
  dragOverInfo={sectionId:sid,moveIdx:mi,above};
}
function mvDragLeave(e){if(!e.currentTarget.contains(e.relatedTarget))e.currentTarget.classList.remove('dta','dtb');}
function mvDrop(e,sid,mi){
  e.preventDefault();e.stopPropagation();
  document.querySelectorAll('.routine-move').forEach(el=>el.classList.remove('dta','dtb'));
  if(!dragSrc)return;
  const ds=routine.sections.find(s=>s.id===sid);if(!ds)return;
  const above=dragOverInfo?.above??true;
  if(dragSrc.fromBank){
    const ins=above?mi:mi+1;
    ds.moves.splice(ins,0,{...dragSrc.move,id:'m'+Date.now()+Math.random().toString(36).slice(2)});
    renderCanvas();dragSrc=null;dragOverInfo=null;return;
  }
  const ss=routine.sections.find(s=>s.id===dragSrc.sectionId);if(!ss)return;
  const srcMv=ss.moves[dragSrc.moveIdx];
  if(ss.id===ds.id){
    ss.moves.splice(dragSrc.moveIdx,1);
    let ins=above?mi:mi+1;
    if(dragSrc.moveIdx<mi)ins--;
    ss.moves.splice(Math.max(0,ins),0,srcMv);
  }else{
    ss.moves.splice(dragSrc.moveIdx,1);
    ds.moves.splice(above?mi:mi+1,0,srcMv);
  }
  renderCanvas();dragSrc=null;dragOverInfo=null;
}

function saveRoutine(){
  const title=document.getElementById('routineTitle').value||'Untitled Routine';
  savedRoutines.unshift({id:Date.now(),title,level:document.getElementById('routineLevel').value,
    category:document.getElementById('routineCategory').value,
    sections:JSON.parse(JSON.stringify(routine.sections)),created:new Date().toLocaleDateString()});
  localStorage.setItem('pc_routines',JSON.stringify(savedRoutines));
  fbSyncRoutines();
  renderSavedRoutines();initWuRoutineLink();showToast('Routine saved!');
}
function loadRoutine(id){
  const r=savedRoutines.find(r=>r.id===id);if(!r)return;
  document.getElementById('routineTitle').value=r.title||'';
  document.getElementById('routineLevel').value=r.level||'';
  document.getElementById('routineCategory').value=r.category||'';
  routine.sections=JSON.parse(JSON.stringify(r.sections));
  renderCanvas();
}
function deleteRoutine(id){
  savedRoutines=savedRoutines.filter(r=>r.id!==id);
  localStorage.setItem('pc_routines',JSON.stringify(savedRoutines));
  renderSavedRoutines();
}
function clearRoutine(){
  if(!confirm('Clear all sections?'))return;
  routine.sections=[];document.getElementById('routineTitle').value='';renderCanvas();
}
function renderSavedRoutines(){
  const row=document.getElementById('savedRoutinesRow');
  if(!savedRoutines.length){row.innerHTML='<span style="font-size:9px;color:var(--dim);">No saved routines yet</span>';return;}
  row.innerHTML=savedRoutines.map(r=>`
    <div class="srp" onclick="loadRoutine(${r.id})" style="flex-direction:column;align-items:flex-start;gap:2px;">
      <div style="display:flex;width:100%;align-items:center;gap:6px;">
        <span style="flex:1;">${r.title||'Untitled'}${r.level?' Â· L'+r.level:''}${r.category?' Â· '+r.category:''}</span>
        <span style="color:var(--dim);font-size:9px;" onclick="event.stopPropagation();deleteRoutine(${r.id})">âœ•</span>
      </div>
      ${r.tagline?`<span style="font-size:8px;color:var(--dim);font-style:italic;letter-spacing:0.06em;">${r.tagline}</span>`:''}
    </div>`).join('');
}
function exportRoutine(){
  const title=document.getElementById('routineTitle').value||'Untitled';
  let lines=[title.toUpperCase(),''];
  let n=1;
  routine.sections.forEach(sec=>{
    lines.push(`â”€â”€ ${sec.name.toUpperCase()} â”€â”€`);
    sec.moves.forEach(mv=>lines.push(`  ${n++}. ${mv.name} (L${mv.psoLevel}, ${mv.cat})${mv.note?' ['+mv.note+']':''}`));
    lines.push('');
  });
  lines.push(`Total: ${routine.sections.reduce((a,s)=>a+s.moves.length,0)} moves`);
  const panel=document.createElement('div');panel.className='export-panel';
  panel.innerHTML=`<h4>${title}</h4><pre class="export-text">${lines.join('\n')}</pre>
    <div style="display:flex;gap:7px;margin-top:12px;">
      <button class="action-btn" onclick="navigator.clipboard.writeText(this.closest('.export-panel').querySelector('pre').textContent).then(()=>showToast('Copied!'))">â†— Copy</button>
      <button class="action-btn" onclick="this.closest('.export-panel').remove()">âœ• Close</button>
    </div>`;
  document.getElementById('choreoCanvas').appendChild(panel);
  panel.scrollIntoView({behavior:'smooth'});
}

// ============================================================
// CONTENT STUDIO
// ============================================================
// 5 content types, one per weekday (Sunâ€“Thuâ€“Fri on specific days)
const studioWeekDays = [
  {key:'sun', cls:'dc-sun', title:'Sunday',    type:'Rest / Stretch',    emoji:'ðŸŒ…', desc:'Recovery, mobility & stretch content. Great for saves & shares.'},
  {key:'mon', cls:'dc-mon', title:'Monday',    type:'Flowy Combo',       emoji:'ðŸŒŠ', desc:'Flowy combo of the week. Smooth transitions, lyrical movement.'},
  {key:'tue', cls:'dc-tue', title:'Tuesday',   type:'Tutorial',          emoji:'ðŸŽ“', desc:'Step-by-step breakdown of a move, transition, or concept.'},
  {key:'wed', cls:'dc-wed', title:'Wednesday', type:'Filming Day',       emoji:'ðŸŽ¬', desc:'Dedicated filming session. Plan your shots, lighting & looks.'},
  {key:'thu', cls:'dc-thu', title:'Thursday',  type:'Then What?',        emoji:'ðŸ”€', desc:'Combos & transitions â€” the unexpected link, the escape move.'},
  {key:'fri', cls:'dc-fri', title:'Friday',    type:'Freaky Friday',     emoji:'âœ¨', desc:'Variations, inversions & creative reinterpretations.'},
  {key:'sat', cls:'dc-sat', title:'Saturday',  type:'Filming Day',       emoji:'ðŸ“¹', desc:'Second filming window. Behind the scenes, b-roll, extras.'},
];

let studioWeekOffset=0;
let studioData=JSON.parse(localStorage.getItem('pc_studio')||'{}');
let studioQueuedCombo=null;
let studioDragSrc=null;

function getWeekStart(offset){
  const now=new Date();
  const day=now.getDay();
  const diff=now.getDate()-day;
  const start=new Date(now.setDate(diff+(offset*7)));
  start.setHours(0,0,0,0);
  return start;
}

function weekKey(offset){
  const ws=getWeekStart(offset);
  return ws.toISOString().slice(0,10);
}

function changeWeek(d){studioWeekOffset+=d;renderStudio();}
function goToday(){studioWeekOffset=0;renderStudio();}

function initStudio(){renderStudio();}

function renderStudio(){
  const ws=getWeekStart(studioWeekOffset);
  const we=new Date(ws);we.setDate(we.getDate()+6);
  const fmt=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  document.getElementById('weekLbl').textContent=`${fmt(ws)} â€“ ${fmt(we)}, ${ws.getFullYear()}`;
  const wk=weekKey(studioWeekOffset);

  // Build dates for each day of this week (Sun=0, Mon=1, Tue=2, Thu=4, Fri=5)
  const dayOffsets={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};

  const col=document.getElementById('studioWeek');
  col.innerHTML='';

  studioWeekDays.forEach(day=>{
    const dayDate=new Date(ws);
    dayDate.setDate(dayDate.getDate()+dayOffsets[day.key]);
    const dateStr=dayDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const dataKey=`${wk}_${day.key}`;
    if(!studioData[dataKey])studioData[dataKey]=[];
    const cards=studioData[dataKey];

    const dc=document.createElement('div');
    dc.className=`day-col ${day.cls}`;
    dc.innerHTML=`
      <div class="day-hdr" onclick="handleDayHdrClick(event,this)">
        <div class="day-hdr-top">
          <div class="day-title">${day.emoji} ${day.title}</div>
          <span class="day-card-count">${cards.length||''}</span>
          <button class="day-toggle" onclick="toggleDayCol(event,this)" title="Collapse">â€¹</button>
        </div>
        <div class="day-type">${day.type}</div>
        <div style="font-size:8px;color:var(--muted);margin-bottom:2px;">${dateStr}</div>
        <div class="day-desc">${day.desc}</div>
      </div>
      <div class="day-body" id="dayBody_${dataKey}"
        ondragover="studioDzOver(event,'${dataKey}')" ondrop="vidCardDrop(event,'${dataKey}')"
        ondragleave="studioDzLeave(event,'${dataKey}')"
        ondrop="studioComboDropOnDay(event,'${dataKey}')">
        ${cards.map((card,ci)=>renderVidCard(card,dataKey,ci)).join('')}
        <button class="add-vid-btn" onclick="addVidCard('${dataKey}')">+ Add Card</button>
      </div>`;
    col.appendChild(dc);
  });
  updateStats();
}

function renderVidCard(card,dataKey,ci){
  const statuses=['idea','filming','editing','scheduled','posted'];
  const statusLabels=['ðŸ’¡ Idea','ðŸŽ¬ Filming','âœ‚ï¸ Editing','ðŸ“… Scheduled','âœ… Posted'];
  const statusColors={idea:'var(--dim)',filming:'var(--accent)',editing:'#6eafc9',scheduled:'#c96ea8',posted:'var(--l1)'};
  const st = card.status||'idea';
  const dotColor = statusColors[st];

  const CATS = ['Spin','Invert','Mount','Climb','Pose','Drop','Transition','Floorwork','Combo','Warm-Up','Other'];
  const LEVELS = ['L1 â€” Beginner','L2 â€” Beginner+','L3 â€” Intermediate','L4 â€” Advanced','L5 â€” Elite'];
  const levelColors = {'L1':'var(--l1)','L2':'var(--l2)','L3':'var(--l3)','L4':'var(--l4)','L5':'var(--l5)'};
  const lv = card.moveLevel || '';
  const lk = lv.slice(0,2);
  const lcolor = levelColors[lk] || 'var(--muted)';

  const comboSlotsHtml=(card.combos&&card.combos.length)
    ?card.combos.map((combo,idx)=>`
      <div class="vc-combo-slot">
        <span class="vc-cs-name">${combo.name||'Saved Combo'}</span>
        <span style="font-size:8px;color:var(--dim);">${combo.moves?combo.moves.length+' moves':''}</span>
        <button class="vc-cs-del" onclick="removeComboFromCard('${dataKey}',${ci},${idx})">âœ•</button>
      </div>`).join('')
    :'';

  const inspoHtml=(card.inspo&&card.inspo.length)
    ?card.inspo.map((url,idx)=>{
      const display=url.replace(/^https?:\/\/(www\.)?/,'').slice(0,38);
      return `<div class="vc-inspo-link">
        <span style="font-size:10px;flex-shrink:0;">ðŸ”—</span>
        <a class="vc-inspo-txt" href="${url}" target="_blank" rel="noopener">${display}</a>
        <button class="vc-inspo-del" onclick="removeInspoLink('${dataKey}',${ci},${idx})">âœ•</button>
      </div>`;
    }).join('')
    :'';

  const catOpts = CATS.map(cat=>`<option value="${cat}"${card.moveCategory===cat?' selected':''}>${cat}</option>`).join('');
  const lvlOpts = `<option value="">â€” Level â€”</option>`+LEVELS.map(l=>`<option value="${l}"${card.moveLevel===l?' selected':''}>${l}</option>`).join('');
  const psoOpts = ['â€”','Beginner','Intermediate','Advanced','Elite'].map(p=>`<option value="${p}"${(card.psoSkill||'â€”')===p?' selected':''}>${p}</option>`).join('');

  return `
  <div class="vid-card" draggable="true"
    ondragstart="vidCardDragStart(event,'${dataKey}',${ci})"
    ondragend="vidCardDragEnd(event)">

    <!-- HEADER -->
    <div class="vc-header">
      <span class="vc-drag-grip">â ¿</span>
      <div class="vc-status-dot" style="background:${dotColor};" title="${st}" onclick="cycleVcStatus('${dataKey}',${ci})"></div>
      <input class="vc-title-in" placeholder="Video title..." value="${(card.title||'').replace(/"/g,'&quot;')}"
        oninput="updateVidField('${dataKey}',${ci},'title',this.value)">
      <button class="vc-del" onclick="deleteVidCard('${dataKey}',${ci})">âœ•</button>
    </div>

    <!-- STATUS -->
    <div class="vc-status-row">
      <select class="vc-status-sel" onchange="updateVidField('${dataKey}',${ci},'status',this.value)">
        ${statuses.map(s=>`<option value="${s}"${st===s?' selected':''}>${statusLabels[statuses.indexOf(s)]}</option>`).join('')}
      </select>
    </div>

    <!-- INDEX CARD â€” move metadata -->
    <div class="vc-index">
      <div class="vc-field full">
        <div class="vc-field-lbl">Move Name</div>
        <input class="vc-field-val" placeholder="e.g. Jade Split, Ayesha..." value="${(card.moveName||'').replace(/"/g,'&quot;')}"
          oninput="updateVidField('${dataKey}',${ci},'moveName',this.value)">
      </div>
      <div class="vc-field">
        <div class="vc-field-lbl">Category</div>
        <select class="vc-field-sel" onchange="updateVidField('${dataKey}',${ci},'moveCategory',this.value)">
          <option value="">â€” Type â€”</option>${catOpts}
        </select>
      </div>
      <div class="vc-field">
        <div class="vc-field-lbl">PSO Level</div>
        <select class="vc-field-sel" style="color:${lcolor};" onchange="updateVidField('${dataKey}',${ci},'moveLevel',this.value)">
          ${lvlOpts}
        </select>
      </div>
      <div class="vc-field">
        <div class="vc-field-lbl">Skill</div>
        <select class="vc-field-sel" onchange="updateVidField('${dataKey}',${ci},'psoSkill',this.value)">
          ${psoOpts}
        </select>
      </div>
      <div class="vc-field">
        <div class="vc-field-lbl">Film Date ðŸŽ¬</div>
        <input class="vc-field-val" type="date" value="${card.schedDate||''}"
          oninput="updateVidField('${dataKey}',${ci},'schedDate',this.value)">
      </div>
      <div class="vc-field full">
        <div class="vc-field-lbl">Post Date ðŸ“¤</div>
        <input class="vc-field-val" type="date" value="${card.postDate||''}"
          oninput="updateVidField('${dataKey}',${ci},'postDate',this.value)">
      </div>
    </div>

    <!-- PRODUCTION DETAILS -->
    <div class="vc-section">
      <div class="vc-section-lbl">Production</div>
      <div class="vc-row">
        <span class="vc-row-icon">ðŸŽµ</span>
        <input class="vc-in" placeholder="Audio / song..." value="${(card.audio||'').replace(/"/g,'&quot;')}"
          oninput="updateVidField('${dataKey}',${ci},'audio',this.value)">
      </div>
      <div class="vc-row">
        <span class="vc-row-icon">ðŸ“</span>
        <input class="vc-in" placeholder="Location / setup..." value="${(card.location||'').replace(/"/g,'&quot;')}"
          oninput="updateVidField('${dataKey}',${ci},'location',this.value)">
      </div>
      <div class="vc-row">
        <span class="vc-row-icon">ðŸ‘—</span>
        <input class="vc-in" placeholder="Outfit / look..." value="${(card.outfit||'').replace(/"/g,'&quot;')}"
          oninput="updateVidField('${dataKey}',${ci},'outfit',this.value)">
      </div>
    </div>

    <!-- COMBOS -->
    <div class="vc-section">
      <div class="vc-section-lbl">Combos / Moves</div>
      <div id="vcs_${dataKey}_${ci}">${comboSlotsHtml}</div>
      <div class="vc-combo-dz" id="cdz_${dataKey}_${ci}"
        ondragover="comboDzOver(event,'${dataKey}',${ci})"
        ondragleave="comboDzLeave(event,'${dataKey}',${ci})"
        ondrop="comboDrop(event,'${dataKey}',${ci})">
        Drop combo Â· <span style="color:var(--accent);cursor:pointer;" onclick="attachQueuedCombo('${dataKey}',${ci})">attach queued</span>
      </div>
    </div>

    <!-- INSPO LINKS -->
    <div class="vc-section">
      <div class="vc-section-lbl">Inspo Links</div>
      <div id="ir_${dataKey}_${ci}">${inspoHtml}</div>
      <div class="vc-add-inspo">
        <input class="vc-add-in" id="inspoIn_${dataKey}_${ci}" placeholder="Paste URL..."
          onkeydown="if(event.key==='Enter')addInspoLink('${dataKey}',${ci})">
        <button class="vc-add-btn" onclick="addInspoLink('${dataKey}',${ci})">Add</button>
      </div>
    </div>

    <!-- NOTES -->
    <div class="vc-section">
      <div class="vc-section-lbl">Notes</div>
      <textarea class="vc-notes" rows="2"
        placeholder="Shot notes, caption ideas, lessons learned..."
        oninput="updateVidField('${dataKey}',${ci},'notes',this.value)">${card.notes||''}</textarea>
    </div>

  </div>`;
}

function saveStudio(){localStorage.setItem('pc_studio',JSON.stringify(studioData));fbSyncStudio();updateStats();}

function addVidCard(dataKey){
  studioData[dataKey].push({id:Date.now(),title:'',status:'idea',audio:'',location:'',schedDate:'',postDate:'',combos:[],inspo:[],notes:''});
  saveStudio();renderStudio();
}
function deleteVidCard(dataKey,ci){
  studioData[dataKey].splice(ci,1);saveStudio();renderStudio();
}
function updateVidField(dataKey,ci,field,val){
  if(!studioData[dataKey]||!studioData[dataKey][ci])return;
  studioData[dataKey][ci][field]=val;
  saveStudio();
}
function cycleVcStatus(dataKey,ci){
  const statuses=['idea','filming','editing','scheduled','posted'];
  const card=studioData[dataKey]?.[ci]; if(!card) return;
  const idx=statuses.indexOf(card.status||'idea');
  card.status=statuses[(idx+1)%statuses.length];
  saveStudio(); renderStudio();
}

function toggleDayCol(e,btn){
  e.stopPropagation();
  const col=btn.closest('.day-col');
  col.classList.toggle('collapsed');
  btn.textContent=col.classList.contains('collapsed')?'â€º':'â€¹';
}

function handleDayHdrClick(e,hdr){
  // Only expand if collapsed and clicking outside the toggle button
  const col=hdr.closest('.day-col');
  if(col.classList.contains('collapsed') && !e.target.classList.contains('day-toggle')){
    col.classList.remove('collapsed');
    hdr.querySelector('.day-toggle').textContent='â€¹';
  }
}

function cycleStatus(dataKey,ci){
  const statuses=['idea','filming','editing','scheduled','posted'];
  const card=studioData[dataKey][ci];if(!card)return;
  const idx=statuses.indexOf(card.status||'idea');
  card.status=statuses[(idx+1)%statuses.length];
  saveStudio();renderStudio();
}

// Combo dropping onto day (from generator "Send to Studio")
function studioDzOver(e,dataKey){
  e.preventDefault();
  if(studioDragSrc||studioQueuedCombo)e.dataTransfer.dropEffect='copy';
}
function studioDzLeave(e,dataKey){}
function studioComboDropOnDay(e,dataKey){
  e.preventDefault();
  if(!studioQueuedCombo && !studioDragSrc) return;
  if(studioDragSrc){ vidCardDrop(e,dataKey); return; }
  if(!studioQueuedCombo)return;
  studioData[dataKey].push({id:Date.now(),title:studioQueuedCombo.name||'New Video',status:'idea',audio:'',location:'',schedDate:'',postDate:'',combos:[{...studioQueuedCombo}],inspo:[],notes:''});
  studioQueuedCombo=null;
  saveStudio();renderStudio();
}

// Combo drop zone on individual card
function comboDzOver(e,dataKey,ci){e.preventDefault();document.getElementById('cdz_'+dataKey+'_'+ci)?.classList.add('drag-over');}
function comboDzLeave(e,dataKey,ci){document.getElementById('cdz_'+dataKey+'_'+ci)?.classList.remove('drag-over');}
function comboDrop(e,dataKey,ci){
  e.preventDefault();e.stopPropagation();
  document.getElementById('cdz_'+dataKey+'_'+ci)?.classList.remove('drag-over');
  if(studioQueuedCombo){
    attachQueuedCombo(dataKey,ci);
  } else if(studioDragSrc){
    // drag from saved combos list (future enhancement)
  }
}
function attachQueuedCombo(dataKey,ci){
  if(!studioQueuedCombo){showToast('No queued combo â€” generate one and click "Add to Studio"');return;}
  if(!studioData[dataKey]||!studioData[dataKey][ci])return;
  if(!studioData[dataKey][ci].combos)studioData[dataKey][ci].combos=[];
  studioData[dataKey][ci].combos.push({...studioQueuedCombo});
  studioQueuedCombo=null;
  saveStudio();renderStudio();
}
function removeComboFromCard(dataKey,ci,idx){
  studioData[dataKey][ci].combos.splice(idx,1);saveStudio();renderStudio();
}

// Inspo links
function addInspoLink(dataKey,ci){
  const inp=document.getElementById(`inspoIn_${dataKey}_${ci}`);
  if(!inp)return;const url=inp.value.trim();if(!url)return;
  if(!studioData[dataKey][ci].inspo)studioData[dataKey][ci].inspo=[];
  studioData[dataKey][ci].inspo.push(url);
  inp.value='';saveStudio();renderStudio();
}
function removeInspoLink(dataKey,ci,idx){
  studioData[dataKey][ci].inspo.splice(idx,1);saveStudio();renderStudio();
}

// Drag video cards between days
function vidCardDragStart(e,dataKey,ci){
  studioDragSrc={dataKey,ci};e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',JSON.stringify({dataKey,ci}));
}
function vidCardDragEnd(){studioDragSrc=null;}

// ============================================================
// PSO LEVEL CARDS
// ============================================================
const PSO_L=[
  {n:"1",cls:"lc-1",t:"The Beginner",d:'"Cannot invert, or learning but not consistent. Not teaching pole or performing for pay."',
   a:["All spins, poses, climbs","Floor-only moves (cartwheels, handstands)","Spinning or static pole (not required to use both)"],
   na:["No inverting â€” hips must stay below shoulders","No kips or press to arm-only balances","Cannot be teaching or performing for pay (past 6 months)"]},
  {n:"2",cls:"lc-2",t:"The Floor Inverter",d:'"Can invert from the ground cleanly, but not aerial inverts consistently."',
   a:["Floor inverts with 3+ contact points","Descending inverts","Marley, No-Hand Genie, Holly drop","Cross ankle release, Kips (1 hand)","MUST use both poles"],
   na:["Aerial inverts","All shoulder mounts","Butterfly flip","Forearm grip inverted with no extra contact","Bird of paradise, Rainbow Marchenko"]},
  {n:"3",cls:"lc-3",t:"The Aerial Inverter",d:'"Can aerial invert confidently, but not handsprings consistently."',
   a:["Aerial inverts + descending inverts","Shoulder mounts + walk-downs","Dangerous Bird in any grip","MUST use both poles"],
   na:["Handsprings (2-contact)","Butterfly flip","Forearm grip inverted with no extra contact","Bird of paradise, Eagle, Rainbow Marchenko"]},
  {n:"4",cls:"lc-4",t:"The Advanced Poler",d:'"Can perform 2-contact moves â€” handspring, ayesha, cocoon. Single entrance/exit to hardest moves."',
   a:["2-contact moves (handspring, ayesha, iron x, cocoon)","Phoenixes (momentum-driven)","MUST use both poles"],
   na:["Release moves with torso rotation (fonji)","1-contact inverts airborne (elbow ayesha flip)","Regrips/flips back to pole (Montanaro)","Deadlifts into 2-contact moves"]},
  {n:"5",cls:"lc-5",t:"The Elite Poler",d:'"Many 2-contact moves, many entrances/exits, comfortably strings together 3â€“5 hardest moves."',
   a:["All move types permitted","Release moves, complex flips/regrips","MUST use both poles"],
   na:["No technical restrictions (safety rules always apply)"]},
];
const LCN_COLORS={lc1:'var(--l1)',lc2:'var(--l2)',lc3:'var(--l3)',lc4:'var(--l4)',lc5:'var(--l5)'};

function renderPSO(){
  const wrap=document.getElementById('psoCards');
  wrap.innerHTML=PSO_L.map(l=>{
    const examples=MOVES.filter(m=>m.psoLevel===l.n).slice(0,7).map(m=>`<span style="font-size:8px;padding:2px 6px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--dim);">${m.name}</span>`).join('');
    const ncls=`lc${l.n}`;
    const col=LCN_COLORS[ncls]||'var(--accent)';
    return `<div style="background:var(--bg3);border:1px solid var(--border);padding:18px;border-left:3px solid ${col};">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:${col};line-height:1;">${l.n}</div>
        <div><div style="font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);">PSO Level</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--text);font-style:italic;">${l.t}</div></div>
      </div>
      <div style="font-size:10px;color:var(--muted);line-height:1.6;font-style:italic;border-left:2px solid var(--border);padding-left:8px;margin-bottom:10px;">${l.d}</div>
      <div style="font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:5px;">âœ“ Allowed</div>
      <ul style="list-style:none;padding:0;margin-bottom:8px;">${l.a.map(x=>`<li style="font-size:10px;color:var(--muted);padding:1px 0;"><span style="color:var(--l1);">âœ“ </span>${x}</li>`).join('')}</ul>
      <div style="font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:5px;">âœ• Not Allowed</div>
      <ul style="list-style:none;padding:0;margin-bottom:10px;">${l.na.map(x=>`<li style="font-size:10px;color:var(--muted);padding:1px 0;"><span style="color:var(--red);">âœ• </span>${x}</li>`).join('')}</ul>
      <div style="font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--dim);margin-bottom:5px;">Example Moves</div>
      <div style="display:flex;flex-wrap:wrap;gap:3px;">${examples}</div>
    </div>`;
  }).join('');
}

// PSO Checklist
const PSO_CHECKS={
  "Routine Prep":["Music trimmed to level time limit","Both poles used in routine (L2+)","All moves within level restrictions","No butterfly flip (L2â€“L4)","Concept/theme clear throughout","Entry and exit are intentional"],
  "Music & Submission":["Track submitted as m4a/mp3/wav to Portal","Labeled USB backup ready","N-word removed or bleeped","Music within max time limit"],
  "Day Of":["Arrived 1+ hour before division start","Checked in with Stage Monitors 30+ min before","Liability release signed","Warmed up properly","USB on person backstage"],
  "Costume & Props":["Costume meets coverage requirements","Genitals and anus covered at all times","Prop under 25 lbs and within 7'Ã—5'Ã—3'","Grip aid applied to body only (not pole)","Prop setup + removal both â‰¤30 seconds"],
};
let checkState=JSON.parse(localStorage.getItem('pc_checks')||'{}');

function renderPSOChecklist(){
  document.getElementById('psoChecklistWrap').innerHTML=Object.entries(PSO_CHECKS).map(([title,items])=>`
    <div style="background:var(--bg3);border:1px solid var(--border);padding:16px;">
      <div style="font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--accent2);margin-bottom:10px;">${title}</div>
      ${items.map((item,i)=>{
        const key=title+'_'+i,done=checkState[key];
        return `<div class="ci${done?' done':''}" onclick="toggleCheck('${key}',this)" style="display:flex;align-items:flex-start;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.025);cursor:pointer;">
          <div style="width:12px;height:12px;border:1px solid var(--border2);flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;${done?'background:var(--l1);border-color:var(--l1);':''}">
            ${done?'<span style="font-size:8px;color:var(--bg);">âœ“</span>':''}
          </div>
          <div style="font-size:10px;color:var(--muted);line-height:1.5;${done?'text-decoration:line-through;color:var(--dim);':''};">${item}</div>
        </div>`;
      }).join('')}
    </div>`).join('');
}

function toggleCheck(key,el){
  el.classList.toggle('done');
  checkState[key]=el.classList.contains('done');
  localStorage.setItem('pc_checks',JSON.stringify(checkState));
  renderPSOChecklist();
}

// ============================================================
// WARM-UP RANDOMIZER
// ============================================================

// Full exercise database â€” muscle groups, types, durations, pole links
const WU_EXERCISES = [
  // â”€â”€ CARDIO / PULSE â”€â”€
  {name:"March in Place",muscle:["cardio"],type:"cardio",dur:60,reps:null,sets:1,note:"Pump arms, lift knees. Gets the blood moving.",poleLinks:[]},
  {name:"Hip Circles",muscle:["cardio","hip"],type:"mobility",dur:30,reps:null,sets:2,note:"Slow full circles each direction. Warm up hip joints for mounts.",poleLinks:["Mount","Spin"]},
  {name:"Jumping Jacks",muscle:["cardio","legs","shoulder"],type:"cardio",dur:45,reps:null,sets:1,note:"Light pace â€” just to elevate heart rate.",poleLinks:[]},
  {name:"High Knees (slow)",muscle:["cardio","legs","hip"],type:"cardio",dur:30,reps:null,sets:2,note:"Controlled lift â€” wake up hip flexors.",poleLinks:["Climb","Mount"]},
  {name:"Side Steps + Arm Swings",muscle:["cardio","shoulder","hip"],type:"cardio",dur:45,reps:null,sets:1,note:"Move laterally â€” open up the shoulders as you go.",poleLinks:["Spin","Transition"]},
  {name:"Torso Twists",muscle:["cardio","core"],type:"mobility",dur:40,reps:null,sets:1,note:"Feet hip-width, arms relaxed, rotate spine each direction. Spinal mobility for all pole work.",poleLinks:["Spin","Transition","Floorwork"]},
  {name:"Butt Kicks",muscle:["cardio","legs"],type:"cardio",dur:30,reps:null,sets:1,note:"Light heel-to-butt pulses. Warm up hamstrings.",poleLinks:["Climb"]},

  // â”€â”€ SHOULDER / UPPER BODY â”€â”€
  {name:"Arm Circles (small â†’ large)",muscle:["shoulder"],type:"mobility",dur:40,reps:null,sets:2,note:"Start small, build to full rotation. Forward then reverse. Critical for all pole work.",poleLinks:["Spin","Invert","Mount","Climb"]},
  {name:"Shoulder Rolls",muscle:["shoulder"],type:"mobility",dur:20,reps:null,sets:2,note:"Roll forward 10 times, backward 10 times. Release tension before gripping.",poleLinks:["Spin","Hold","Climb"]},
  {name:"Cross-Body Shoulder Stretch",muscle:["shoulder"],type:"stretch",dur:20,reps:null,sets:2,note:"Hold 20s each side. Keeps the rear deltoid healthy.",poleLinks:["Spin","Hold"]},
  {name:"Overhead Reach + Side Bend",muscle:["shoulder","core"],type:"stretch",dur:25,reps:null,sets:2,note:"Full stretch from fingertips to hip. 25s each side.",poleLinks:["Invert","Pose","Climb"]},
  {name:"Wall Angels",muscle:["shoulder","back"],type:"mobility",dur:30,reps:10,sets:2,note:"Back flat against wall, arms slide overhead. Critical for shoulder health.",poleLinks:["Invert","Mount","Pose"]},
  {name:"Band Pull-Apart (or towel)",muscle:["shoulder","back"],type:"activation",dur:null,reps:15,sets:2,note:"Keep arms straight. Activates rear delts and scapular stabilizers.",poleLinks:["Invert","Mount","Climb"]},
  {name:"Scapular Push-Ups",muscle:["shoulder","back"],type:"activation",dur:null,reps:10,sets:2,note:"Push shoulder blades apart without bending elbows. Essential for safe inversions.",poleLinks:["Invert","Mount"]},
  {name:"Tricep Stretch",muscle:["shoulder"],type:"stretch",dur:20,reps:null,sets:2,note:"Arm overhead, hand behind head. 20s each side.",poleLinks:["Spin","Hold","Climb"]},
  {name:"Doorframe / Pole Chest Stretch",muscle:["shoulder"],type:"stretch",dur:25,reps:null,sets:2,note:"Use the pole. Stretch front of shoulder and chest.",poleLinks:["Spin","Pose"]},
  {name:"Wrist Circles + Flexion",muscle:["grip","shoulder"],type:"mobility",dur:30,reps:null,sets:2,note:"Full wrist circles, then flexion/extension. Do this before EVERY session.",poleLinks:["Spin","Hold","Climb","Invert","Mount"]},

  // â”€â”€ GRIP / FOREARM â”€â”€
  {name:"Grip Squeeze (towel or gripper)",muscle:["grip"],type:"activation",dur:null,reps:20,sets:3,note:"Squeeze and release. Builds grip endurance for long pole sets.",poleLinks:["Climb","Hold","Spin","Invert"]},
  {name:"Finger Extensions",muscle:["grip"],type:"mobility",dur:20,reps:null,sets:2,note:"Spread fingers wide, hold 3s. Balances grip strength on extensor side.",poleLinks:["Hold","Climb","Spin"]},
  {name:"Forearm Stretch (palm down)",muscle:["grip"],type:"stretch",dur:20,reps:null,sets:2,note:"Arm extended, palm down, gently press back with other hand. 20s each side.",poleLinks:["Hold","Climb","Spin","Invert","Mount"]},
  {name:"Forearm Stretch (palm up)",muscle:["grip"],type:"stretch",dur:20,reps:null,sets:2,note:"Arm extended, palm up â€” gets the flexors. 20s each side.",poleLinks:["Hold","Climb","Spin","Invert"]},
  {name:"Towel Catch Drill",muscle:["grip","shoulder"],type:"activation",dur:30,reps:null,sets:2,note:"Hold towel at chest height, release grip, catch with opposite hand. Classic pole grip warm-up.",poleLinks:["Climb","Hold","Spin"]},
  {name:"Hanging Hold (pole or bar)",muscle:["grip","shoulder","back"],type:"activation",dur:20,reps:null,sets:3,note:"Dead hang for 20s. Best grip + shoulder opener there is.",poleLinks:["Climb","Hold","Invert","Mount"]},

  // â”€â”€ CORE â”€â”€
  {name:"Dead Bug (slow)",muscle:["core"],type:"activation",dur:null,reps:8,sets:2,note:"Opposite arm/leg lower slowly. Activates deep core â€” essential for inversions.",poleLinks:["Invert","Mount","Pose"]},
  {name:"Bird-Dog",muscle:["core","back","legs"],type:"activation",dur:null,reps:8,sets:2,note:"On all fours â€” extend opposite arm and leg. Core stability for controlled movement.",poleLinks:["Invert","Transition","Pose"]},
  {name:"Cat-Cow Stretch",muscle:["core","back","hip"],type:"mobility",dur:30,reps:null,sets:2,note:"Slow controlled spinal flexion/extension. Great spinal warm-up.",poleLinks:["Transition","Floorwork","Spin"]},
  {name:"Hollow Body Hold",muscle:["core"],type:"activation",dur:20,reps:null,sets:2,note:"Lower back pressed to floor, arms overhead, legs extended. Core compression for inversions.",poleLinks:["Invert","Trick","Mount"]},
  {name:"Plank Hold",muscle:["core","shoulder"],type:"activation",dur:30,reps:null,sets:2,note:"Full body tension. Shoulders over wrists. Resist sagging hips.",poleLinks:["Invert","Climb","Mount","Trick"]},
  {name:"Standing Side Crunch",muscle:["core"],type:"activation",dur:null,reps:12,sets:2,note:"Hands behind head, lift knee to elbow. Obliques â€” needed for side shapes.",poleLinks:["Pose","Spin","Transition"]},

  // â”€â”€ BACK / LATS â”€â”€
  {name:"Child's Pose",muscle:["back","shoulder","hip"],type:"stretch",dur:30,reps:null,sets:2,note:"Gentle lat stretch. Drop hips back, walk arms forward.",poleLinks:["Invert","Climb","Mount"]},
  {name:"Lat Stretch (pole-assisted)",muscle:["back"],type:"stretch",dur:25,reps:null,sets:2,note:"Hold pole, bend at hip, let torso drop. Full lat stretch.",poleLinks:["Invert","Climb","Mount"]},
  {name:"Superman Hold",muscle:["back","legs"],type:"activation",dur:20,reps:null,sets:2,note:"Prone on floor, lift arms and legs. Lower back activation.",poleLinks:["Pose","Trick","Invert"]},
  {name:"Seated Pole Pull",muscle:["back","grip"],type:"activation",dur:null,reps:8,sets:3,note:"Sit at base of pole, pull down on pole without using legs. Lat/bicep activation.",poleLinks:["Invert","Climb","Mount"]},
  {name:"Row Motion (band or pole resistance)",muscle:["back","shoulder"],type:"activation",dur:null,reps:10,sets:2,note:"Pull elbows back, squeeze shoulder blades. Activates rhomboids and mid-back.",poleLinks:["Climb","Invert","Mount"]},

  // â”€â”€ LEGS / GLUTES â”€â”€
  {name:"Bodyweight Squats",muscle:["legs"],type:"activation",dur:null,reps:15,sets:2,note:"Full depth if available. Quads + hamstrings â€” essential for climbs and mounts.",poleLinks:["Climb","Mount","Drop"]},
  {name:"Reverse Lunges",muscle:["legs","hip"],type:"activation",dur:null,reps:10,sets:2,note:"Step back into lunge. Hip flexor opener + quad/glute strength.",poleLinks:["Climb","Mount","Transition"]},
  {name:"Glute Bridge",muscle:["legs","hip"],type:"activation",dur:null,reps:15,sets:2,note:"Lie on back, push hips up, squeeze at top. Activates glutes before climbing.",poleLinks:["Climb","Invert","Pose"]},
  {name:"Calf Raises",muscle:["legs"],type:"activation",dur:null,reps:15,sets:2,note:"Full raise, slow lower. Ankle stability + calf strength for pointed toes.",poleLinks:["Spin","Pose","Climb"]},
  {name:"Leg Swings (front/back)",muscle:["legs","hip"],type:"mobility",dur:30,reps:null,sets:2,note:"Hold pole for balance. 30s each leg. Hip flexor and hamstring mobility.",poleLinks:["Mount","Transition","Floorwork","Spin"]},
  {name:"Leg Swings (side to side)",muscle:["legs","hip"],type:"mobility",dur:30,reps:null,sets:2,note:"Hold pole, lateral swings. Opens adductors. 30s each leg.",poleLinks:["Spin","Pose","Transition","Floorwork"]},
  {name:"Hamstring Stretch (standing)",muscle:["legs","flex"],type:"stretch",dur:25,reps:null,sets:2,note:"Forward fold, soft knees. 25s hold. Reduces injury risk on climbing.",poleLinks:["Climb","Drop","Invert"]},
  {name:"Quad Stretch (standing)",muscle:["legs"],type:"stretch",dur:20,reps:null,sets:2,note:"Hold ankle behind you. 20s each side. Knee and hip flexor health.",poleLinks:["Climb","Mount","Floorwork"]},
  {name:"Sumo Squat Hold",muscle:["legs","hip"],type:"activation",dur:20,reps:null,sets:2,note:"Wide stance, toes out, hold bottom for 20s. Opens inner thighs and activates glutes.",poleLinks:["Mount","Floorwork","Spin"]},

  // â”€â”€ HIP FLEXORS â”€â”€
  {name:"Low Lunge Hip Flexor Stretch",muscle:["hip"],type:"stretch",dur:30,reps:null,sets:2,note:"Back knee on floor, push hips forward. 30s each side. Critical for inverts.",poleLinks:["Invert","Mount","Floorwork","Transition"]},
  {name:"Pigeon Pose",muscle:["hip","flex"],type:"stretch",dur:40,reps:null,sets:2,note:"40s each side. Deep hip opener. Great before spins and floorwork.",poleLinks:["Spin","Floorwork","Pose","Transition"]},
  {name:"Hip Flexor Activation (high knee march)",muscle:["hip","cardio"],type:"activation",dur:30,reps:null,sets:2,note:"Slow deliberate high knee pull â€” wake up the hip flexors.",poleLinks:["Mount","Invert","Climb"]},
  {name:"Figure-4 Stretch",muscle:["hip","legs"],type:"stretch",dur:30,reps:null,sets:2,note:"Cross ankle over opposite knee, flex foot, hold or deepen. 30s each side.",poleLinks:["Pose","Spin","Floorwork"]},
  {name:"Seated Butterfly Stretch",muscle:["hip","flex"],type:"stretch",dur:30,reps:null,sets:2,note:"Feet together, gentle press on knees. Inner thigh and hip opener.",poleLinks:["Floorwork","Pose","Mount"]},

  // â”€â”€ FLEXIBILITY â”€â”€
  {name:"Standing Forward Fold",muscle:["flex","legs","back"],type:"stretch",dur:30,reps:null,sets:2,note:"Soft knees, hang heavy. Full posterior chain stretch.",poleLinks:["Floorwork","Transition","Invert"]},
  {name:"Seated Straddle Stretch",muscle:["flex","legs","hip"],type:"stretch",dur:40,reps:null,sets:2,note:"Legs wide, slowly walk hands forward. Don't force â€” breathe.",poleLinks:["Floorwork","Pose","Spin"]},
  {name:"Spine Twist (supine)",muscle:["flex","core","hip","back"],type:"stretch",dur:25,reps:null,sets:2,note:"Lie on back, knee drops across body. 25s each side. Full spinal release.",poleLinks:["Floorwork","Spin","Transition"]},
  {name:"Chest Opener (lying on foam roller or floor)",muscle:["flex","shoulder"],type:"stretch",dur:30,reps:null,sets:1,note:"Arms wide, let chest open fully. Counteracts grip tension.",poleLinks:["Pose","Spin","Floorwork"]},
  {name:"Ankle Circles + Pointed/Flexed",muscle:["flex","legs"],type:"mobility",dur:20,reps:null,sets:2,note:"10 circles each direction, then 10 point/flex. Ankle health + pointed toes in performance.",poleLinks:["Spin","Pose","Floorwork","Drop"]},
  {name:"Neck Rolls (slow)",muscle:["flex","shoulder"],type:"mobility",dur:20,reps:null,sets:1,note:"Very slow, controlled. Drop ear to shoulder, front half-circle only â€” no full back rolls.",poleLinks:["Floorwork","Spin"]},
  {name:"Wrist + Finger Yoga",muscle:["grip","flex"],type:"mobility",dur:30,reps:null,sets:2,note:"Prayer position stretches, prayer in reverse, individual finger bends. Wrist health.",poleLinks:["Hold","Climb","Spin","Invert","Mount"]},
  {name:"Back Arch Preparation",muscle:["flex","back","shoulder"],type:"stretch",dur:20,reps:null,sets:2,note:"On all fours, slowly lower belly, open chest. Gentle backbend prep.",poleLinks:["Pose","Floorwork","Spin","Trick"]},
  {name:"Shoulder Dislocations (band or towel)",muscle:["flex","shoulder"],type:"mobility",dur:null,reps:10,sets:2,note:"Wide grip, slowly pass overhead and behind. Full shoulder mobility. Go slow.",poleLinks:["Invert","Mount","Trick","Pose"]},
];

// â”€â”€ COOL DOWN EXERCISES â”€â”€
const CD_EXERCISES = [
  // â”€â”€ BREATH & SETTLING â”€â”€
  {name:"Diaphragmatic Breathing",muscle:["core","flex"],type:"cooldown",dur:60,reps:null,sets:1,note:"Lie on back, one hand on chest one on belly. Slow full belly breaths. Shifts nervous system to rest mode.",poleLinks:[]},
  {name:"Standing Exhale Shake-Out",muscle:["cardio","shoulder"],type:"cooldown",dur:30,reps:null,sets:1,note:"Shake out hands, arms, legs. Let the effort go. Signal your body it is done.",poleLinks:[]},

  // â”€â”€ NECK & SHOULDERS â”€â”€
  {name:"Neck Side Stretch",muscle:["shoulder","flex"],type:"cooldown",dur:30,reps:null,sets:2,note:"Drop ear to shoulder, hand gently adds weight. 30s each side. Releases tension from gripping.",poleLinks:["Spin","Hold"]},
  {name:"Thread the Needle",muscle:["shoulder","back"],type:"cooldown",dur:30,reps:null,sets:2,note:"On all fours, thread one arm under body and rotate. 30s each side. Thoracic spine relief.",poleLinks:["Invert","Spin","Mount"]},
  {name:"Doorframe Chest Stretch (pole-assisted)",muscle:["shoulder","flex"],type:"cooldown",dur:25,reps:null,sets:2,note:"Use pole to open front of shoulder and chest. Counter-acts all that gripping.",poleLinks:["Spin","Hold","Climb"]},
  {name:"Eagle Arms",muscle:["shoulder","back"],type:"cooldown",dur:30,reps:null,sets:2,note:"Cross arms at elbows, lift and breathe. Opens rhomboids and rear delts. 30s each side.",poleLinks:["Invert","Mount","Climb"]},
  {name:"Prone Shoulder Stretch",muscle:["shoulder","back"],type:"cooldown",dur:30,reps:null,sets:2,note:"Lie face down, one arm extended at 90Â°, roll onto that shoulder. 30s each. Deep rotator cuff release.",poleLinks:["Invert","Mount"]},

  // â”€â”€ WRISTS & FOREARMS â”€â”€
  {name:"Wrist Flexor Stretch",muscle:["grip","flex"],type:"cooldown",dur:25,reps:null,sets:2,note:"Palm up, fingers gently pressed back. 25s each wrist. Do this after every pole session.",poleLinks:["Hold","Climb","Spin"]},
  {name:"Wrist Extensor Stretch",muscle:["grip","flex"],type:"cooldown",dur:25,reps:null,sets:2,note:"Palm down, press hand toward body. 25s each side. Balances the flexors.",poleLinks:["Hold","Climb","Spin"]},
  {name:"Finger and Knuckle Massage",muscle:["grip"],type:"cooldown",dur:40,reps:null,sets:1,note:"Gently rotate each finger, press into knuckles. Releases grip tension and boosts recovery.",poleLinks:["Hold","Climb"]},

  // â”€â”€ BACK & SPINE â”€â”€
  {name:"Cat-Cow (slow, extended)",muscle:["back","core","flex"],type:"cooldown",dur:40,reps:null,sets:2,note:"Hold each end for 3 breaths. Decompress the spine after all the loading.",poleLinks:["Invert","Transition","Floorwork"]},
  {name:"Child's Pose (extended)",muscle:["back","shoulder","hip"],type:"cooldown",dur:45,reps:null,sets:2,note:"Hips to heels, arms long, breathe into lower back. 45s. Classic spine decompressor.",poleLinks:["Invert","Climb","Mount"]},
  {name:"Supine Spinal Twist",muscle:["back","hip","flex"],type:"cooldown",dur:35,reps:null,sets:2,note:"Lie on back, knee drops across body. 35s each side. Relieves spinal compression from climbs and inversions.",poleLinks:["Invert","Floorwork","Spin"]},
  {name:"Seated Forward Fold",muscle:["back","legs","flex"],type:"cooldown",dur:40,reps:null,sets:2,note:"Legs extended, gently walk hands forward. No forcing. Full posterior chain release.",poleLinks:["Floorwork","Invert","Drop"]},
  {name:"Constructive Rest Pose",muscle:["back","core","hip"],type:"cooldown",dur:60,reps:null,sets:1,note:"On back, knees bent, feet flat, arms relaxed. Spine returns to neutral. Great after heavy pole training.",poleLinks:[]},

  // â”€â”€ HIPS & GLUTES â”€â”€
  {name:"Pigeon Pose (held)",muscle:["hip","legs","flex"],type:"cooldown",dur:60,reps:null,sets:2,note:"60s each side. Go deeper than your warm-up pigeon. Glute and hip flexor full release.",poleLinks:["Spin","Floorwork","Pose","Mount"]},
  {name:"Figure-4 Glute Stretch",muscle:["hip","legs"],type:"cooldown",dur:40,reps:null,sets:2,note:"On back â€” cross ankle over knee, pull both toward chest. 40s each. Targets piriformis which works hard in pole.",poleLinks:["Pose","Spin","Floorwork"]},
  {name:"Happy Baby",muscle:["hip","back","flex"],type:"cooldown",dur:45,reps:null,sets:1,note:"On back, hold outside of feet, knees wide. Gently rock. Hip, sacrum, and inner groin release.",poleLinks:["Floorwork","Pose","Mount"]},
  {name:"Low Lunge Hip Flexor Hold",muscle:["hip","legs"],type:"cooldown",dur:40,reps:null,sets:2,note:"Same as warm-up but hold longer â€” 40s each. Hip flexors get compressed from all the climbing and mounting.",poleLinks:["Invert","Mount","Floorwork"]},
  {name:"Seated Butterfly (extended)",muscle:["hip","flex","legs"],type:"cooldown",dur:45,reps:null,sets:1,note:"Feet together, hold for 45s, breathe and sink. Inner thigh release after spins and mounts.",poleLinks:["Floorwork","Pose","Spin"]},

  // â”€â”€ LEGS & HAMSTRINGS â”€â”€
  {name:"Standing Hamstring Stretch",muscle:["legs","flex"],type:"cooldown",dur:30,reps:null,sets:2,note:"Forward fold, soft knees, 30s. Hamstrings work hard in climbs and drops â€” always stretch them after.",poleLinks:["Climb","Drop","Invert"]},
  {name:"Supine Hamstring Stretch (strap or towel)",muscle:["legs","flex"],type:"cooldown",dur:40,reps:null,sets:2,note:"Lie on back, leg up with towel around foot. 40s each. Best way to release hamstrings fully.",poleLinks:["Climb","Drop","Invert"]},
  {name:"Quad Stretch (lying)",muscle:["legs","hip"],type:"cooldown",dur:30,reps:null,sets:2,note:"Lie on side, pull top heel to glute. 30s each side. Quads fire in almost every pole movement.",poleLinks:["Climb","Mount","Floorwork"]},
  {name:"Calf Stretch (wall)",muscle:["legs","flex"],type:"cooldown",dur:30,reps:null,sets:2,note:"Hands on wall, one leg back, heel down. 30s each. Calf and ankle recovery for pointed-toe work.",poleLinks:["Spin","Pose","Floorwork"]},
  {name:"Seated Straddle Stretch",muscle:["legs","hip","flex"],type:"cooldown",dur:50,reps:null,sets:2,note:"Legs wide, slowly walk forward. Hold 50s. Inner thighs work constantly in pole â€” give them time.",poleLinks:["Floorwork","Pose","Spin"]},

  // â”€â”€ FULL BODY / CLOSING â”€â”€
  {name:"Legs Up the Wall",muscle:["legs","back","flex"],type:"cooldown",dur:90,reps:null,sets:1,note:"Lie near wall, legs vertical. 90s. Reverses blood pooling in legs, relieves lower back, calms the system.",poleLinks:[]},
  {name:"Savasana / Full Rest",muscle:["flex","core","back"],type:"cooldown",dur:120,reps:null,sets:1,note:"Lie completely still for 2 min. Let everything settle. This is when the body actually adapts.",poleLinks:[]},
  {name:"Standing Body Scan",muscle:["flex"],type:"cooldown",dur:60,reps:null,sets:1,note:"Stand tall, slowly close eyes, notice where tension remains. Breathe into each area for 3 breaths.",poleLinks:[]},
];

let includeCooldown = true;

// Session presets â€” which muscles to prioritize
const WU_PRESETS = {
  "full":     {label:"Full Body",    muscles:["cardio","shoulder","grip","core","back","legs","hip"],min:0.7},
  "pre-climb":{label:"Pre-Climb",    muscles:["cardio","grip","shoulder","back","legs","hip","core"],min:0.85},
  "pre-invert":{label:"Pre-Invert", muscles:["shoulder","core","back","grip","hip","flex"],min:0.9},
  "pre-spin": {label:"Pre-Spin",     muscles:["cardio","shoulder","grip","core","hip","legs"],min:0.85},
  "pre-flex": {label:"Pre-Flexibility",muscles:["cardio","flex","hip","legs","back","shoulder"],min:0.85},
  "pre-floorwork":{label:"Pre-Floorwork",muscles:["cardio","hip","legs","core","flex","back"],min:0.85},
  "custom":   {label:"Custom",       muscles:["cardio","shoulder","grip","core","back","legs","hip","flex"],min:0.5},
};

// What muscles each PSO move category demands (for routine linking)
const CAT_MUSCLES = {
  "Spin":["shoulder","grip","core","cardio"],
  "Pose":["shoulder","grip","core","flex","back"],
  "Invert":["shoulder","grip","core","back","hip"],
  "Mount":["shoulder","grip","core","back","legs","hip"],
  "Trick":["shoulder","grip","core","back","flex"],
  "Transition":["core","hip","legs","cardio"],
  "Drop":["shoulder","grip","core","back"],
  "Floor":["hip","core","flex","legs"],
  "Hold":["shoulder","grip","core","back"],
  "Climb":["grip","shoulder","back","legs","core"],
};

let wuSession = "full";
let wuIntensity = "moderate";
let wuFocusSet = new Set(["grip","shoulder","core","back","legs","hip","flex","cardio"]);
let wuCurrentPlan = null;
let timerInterval = null;
let timerRemaining = 0;
let timerTotal = 0;
let timerPaused = false;
let timerCurrentExercise = null;

// Setup session type toggle
document.getElementById('wuSessionChips').addEventListener('click', e => {
  const b = e.target.closest('.focus-chip'); if(!b) return;
  document.querySelectorAll('#wuSessionChips .focus-chip').forEach(c => c.classList.remove('active'));
  b.classList.add('active');
  wuSession = b.dataset.s;
  document.getElementById('wuCustomFocus').style.display = wuSession === 'custom' ? 'block' : 'none';
});

document.getElementById('wuIntensityChips').addEventListener('click', e => {
  const b = e.target.closest('.focus-chip'); if(!b) return;
  document.querySelectorAll('#wuIntensityChips .focus-chip').forEach(c => c.classList.remove('active'));
  b.classList.add('active');
  wuIntensity = b.dataset.i;
});

document.getElementById('wuFocusChips').addEventListener('click', e => {
  const b = e.target.closest('.focus-chip'); if(!b) return;
  const f = b.dataset.f;
  wuFocusSet.has(f) ? wuFocusSet.delete(f) : wuFocusSet.add(f);
  b.classList.toggle('active', wuFocusSet.has(f));
});

function getRoutineMuscles() {
  const sel = document.getElementById('wuRoutineLink').value;
  if(!sel) return null;
  const rid = parseInt(sel);
  const r = savedRoutines.find(r => r.id === rid);
  if(!r) return null;
  const cats = new Set();
  r.sections.forEach(sec => sec.moves.forEach(m => cats.add(m.cat)));
  const muscles = new Set();
  cats.forEach(cat => (CAT_MUSCLES[cat]||[]).forEach(m => muscles.add(m)));
  return muscles;
}

function toggleCooldown(btn){
  includeCooldown=!includeCooldown;
  btn.classList.toggle('active',includeCooldown);
  btn.textContent=includeCooldown?'ðŸ§Š Include Cool Down':'ðŸ§Š Cool Down (off)';
}

function generateWarmup() {
  const targetMin = parseInt(document.getElementById('wuDuration').value);
  const targetSec = targetMin * 60;
  const preset = WU_PRESETS[wuSession] || WU_PRESETS.full;

  // Determine focus muscles
  let focusMuscles;
  if(wuSession === 'custom') {
    focusMuscles = [...wuFocusSet];
  } else {
    focusMuscles = [...preset.muscles];
  }

  // Blend in routine muscles if linked
  const routineMuscles = getRoutineMuscles();
  if(routineMuscles) {
    routineMuscles.forEach(m => { if(!focusMuscles.includes(m)) focusMuscles.push(m); });
  }

  // Intensity modifiers
  const intMod = {gentle:0.75, moderate:1.0, activating:1.3}[wuIntensity] || 1;

  // Filter and score exercises
  const pool = WU_EXERCISES.map(ex => {
    const overlap = ex.muscle.filter(m => focusMuscles.includes(m)).length;
    const score = overlap / ex.muscle.length;
    return {...ex, score};
  }).filter(ex => ex.score > 0);

  // Shuffle pool weighted by score
  pool.sort((a,b) => (b.score - a.score) + (Math.random()-0.5)*0.6);

  // Build plan phase by phase
  const plan = { phases: [], totalSec: 0, totalExercises: 0, totalSets: 0 };

  // Phase 1: Cardio warmup (always ~15-20% of time)
  const cardioTarget = targetSec * 0.18;
  const phase1 = buildPhase("Pulse & Warm-Up", pool.filter(e => e.muscle.includes("cardio")), cardioTarget, intMod, targetSec);

  // Phase 2: Mobility & Activation (core of warm-up ~50%)
  const activationTarget = targetSec * 0.50;
  const activationPool = pool.filter(e => e.type === 'mobility' || e.type === 'activation');
  const phase2 = buildPhase("Mobility & Activation", activationPool, activationTarget, intMod, targetSec);

  // Phase 3: Stretching (~25%)
  const stretchTarget = targetSec * 0.25;
  const stretchPool = pool.filter(e => e.type === 'stretch');
  const phase3 = buildPhase("Dynamic Stretch", stretchPool, stretchTarget, intMod, targetSec);

  // Phase 4: Final activation / specific prep (~remaining time)
  const remaining = targetSec - phase1.totalSec - phase2.totalSec - phase3.totalSec;
  const phase4Pool = pool.filter(e => (e.type === 'activation') && !phase2.exercises.find(x=>x.name===e.name));
  const phase4 = buildPhase("Pole-Specific Prep", phase4Pool, Math.max(remaining, 0), intMod, targetSec);

  plan.phases = [phase1, phase2, phase3, phase4].filter(p => p.exercises.length > 0);
  plan.totalSec = plan.phases.reduce((a,p)=>a+p.totalSec,0);
  plan.totalExercises = plan.phases.reduce((a,p)=>a+p.exercises.length,0);
  plan.totalSets = plan.phases.reduce((a,p)=>a+p.exercises.reduce((b,e)=>b+e.sets,0),0);
  plan.focusMuscles = focusMuscles;
  plan.preset = preset.label;
  plan.routineName = document.getElementById('wuRoutineLink').selectedOptions[0]?.text || null;

  // Build cool down plan
  if(includeCooldown) {
    const cdTarget = Math.max(targetSec * 0.6, 300); // at least 5 min
    // Pick exercises relevant to what was worked
    const cdPool = CD_EXERCISES.map(ex => {
      const overlap = ex.muscle.filter(m => focusMuscles.includes(m) || ['flex','back'].includes(m)).length;
      return {...ex, score: overlap / ex.muscle.length};
    });
    cdPool.sort((a,b) => (b.score-a.score)+(Math.random()-0.5)*0.5);

    // Split into phases: Release (stretching worked muscles) + Closing
    const releasePool = cdPool.filter(e => !['Savasana / Full Rest','Legs Up the Wall','Standing Body Scan','Diaphragmatic Breathing','Standing Exhale Shake-Out'].includes(e.name));
    const closingPool = CD_EXERCISES.filter(e => ['Savasana / Full Rest','Legs Up the Wall','Standing Body Scan','Diaphragmatic Breathing','Standing Exhale Shake-Out'].includes(e.name));

    const cdPhase1 = buildPhase('Breath & Shake-Out', closingPool.filter(e=>['Diaphragmatic Breathing','Standing Exhale Shake-Out'].includes(e.name)), cdTarget*0.1, 1, cdTarget);
    const cdPhase2 = buildPhase('Active Release', releasePool.filter(e=>e.muscle.some(m=>['shoulder','grip','back','hip','wrist'].includes(m))), cdTarget*0.45, 1, cdTarget);
    const cdPhase3 = buildPhase('Deep Stretch', releasePool.filter(e=>e.type==='cooldown'&&e.dur>=40&&!cdPhase2.exercises.find(x=>x.name===e.name)), cdTarget*0.35, 1, cdTarget);
    const cdPhase4 = buildPhase('Rest & Close', closingPool.filter(e=>['Savasana / Full Rest','Legs Up the Wall','Standing Body Scan'].includes(e.name)), cdTarget*0.15, 1, cdTarget);

    plan.cooldown = {
      phases: [cdPhase1,cdPhase2,cdPhase3,cdPhase4].filter(p=>p.exercises.length>0),
      totalSec: 0
    };
    plan.cooldown.totalSec = plan.cooldown.phases.reduce((a,p)=>a+p.totalSec,0);
  } else {
    plan.cooldown = null;
  }

  wuCurrentPlan = plan;
  renderWarmup();
}

function buildPhase(name, pool, targetSec, intMod, totalSec) {
  const phase = {name, exercises:[], totalSec:0};
  const used = new Set();
  let elapsed = 0;
  const shuffled = [...pool].sort(()=>Math.random()-0.5);

  for(const ex of shuffled) {
    if(used.has(ex.name)) continue;
    const sets = ex.type === 'activation' ? Math.max(1, Math.round(ex.sets * intMod)) : ex.sets;
    const exDur = (ex.dur || ex.reps * 3) * sets + (sets > 1 ? (sets-1)*10 : 0); // rest between sets
    if(elapsed > 0 && elapsed + exDur > targetSec * 1.3) break;
    phase.exercises.push({...ex, sets});
    phase.totalSec += exDur;
    elapsed += exDur;
    used.add(ex.name);
    if(elapsed >= targetSec) break;
  }
  return phase;
}

function renderWarmup() {
  const plan = wuCurrentPlan; if(!plan) return;
  const body = document.getElementById('wuBody');
  const totalMin = Math.round(plan.totalSec / 60);

  document.getElementById('wuStatExercises').textContent = plan.totalExercises;
  document.getElementById('wuStatTime').textContent = totalMin;
  document.getElementById('wuStatCDTime').textContent = plan.cooldown ? Math.round(plan.cooldown.totalSec/60) : 'â€”';
  document.getElementById('wuStatSets').textContent = plan.totalSets;
  document.getElementById('wuRegenBtn').style.display = '';
  document.getElementById('wuCopyBtn').style.display = '';

  const routineNote = plan.routineName && plan.routineName !== 'â€” None (general warm-up) â€”'
    ? `<div style="background:rgba(201,169,110,0.06);border:1px solid rgba(201,169,110,0.15);padding:9px 14px;margin-bottom:18px;font-size:9px;color:var(--muted);">
        <span style="color:var(--accent);">âŸ¡ Tuned for: </span>${plan.routineName}</div>` : '';

  const muscleTagsHtml = plan.focusMuscles.map(m =>
    `<span class="wu-tag muscle">${m}</span>`).join('');

  let html = routineNote;
  html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:18px;">${muscleTagsHtml}</div>`;

  plan.phases.forEach(phase => {
    const phaseMin = Math.round(phase.totalSec / 60) || 1;
    html += `<div class="wu-section-hdr">
      <div class="wu-section-title">${phase.name}</div>
      <div class="wu-section-line"></div>
      <div class="wu-section-time">~${phaseMin} min</div>
    </div>`;
    html += `<div class="wu-cards">`;
    phase.exercises.forEach((ex, i) => {
      const primaryMuscle = ex.muscle[0];
      const mc = `mc-${primaryMuscle}`;
      const durationStr = ex.dur ? `${ex.dur}s` : `${ex.reps} reps`;
      const setsStr = ex.sets > 1 ? `${ex.sets} sets` : '1 set';
      const poleTagsHtml = ex.poleLinks.slice(0,3).map(p=>
        `<span class="wu-tag pole-link">${p}</span>`).join('');
      const muscleTagsHtml2 = ex.muscle.map(m=>
        `<span class="wu-tag muscle">${m}</span>`).join('');
      const timerData = ex.dur ? `data-dur="${ex.dur}" data-sets="${ex.sets}" data-name="${ex.name.replace(/"/g,'&quot;')}" data-note="${(ex.note||'').replace(/"/g,'&quot;')}"` : '';
      html += `
        <div class="wu-card ${mc}" style="animation-delay:${i*40}ms">
          <button class="wu-card-del" data-exname="${ex.name}" onclick="removeWuExercise(this.dataset.exname)">âœ•</button>
          <div class="wu-card-name">${ex.name}</div>
          <div class="wu-card-tags">${muscleTagsHtml2}${poleTagsHtml}</div>
          <div class="wu-time-row">
            <span class="wu-duration">${durationStr} Â· ${setsStr}</span>
            ${ex.dur ? `<button class="wu-timer-btn" ${timerData} onclick="startExTimer(this)">â± Timer</button>` : `<span class="wu-reps">(count reps)</span>`}
          </div>
          ${ex.note ? `<div class="wu-card-note">${ex.note}</div>` : ''}
        </div>`;
    });
    html += `</div>`;
    // Rest card between phases
    html += `<div class="rest-card"><span class="rest-icon">ðŸ’§</span><span class="rest-txt">Rest / Water Break</span><span class="rest-dur" style="margin-left:auto;">30â€“60s</span></div>`;
  });

  html += `<div class="wu-total-bar">
    <div>
      <div class="wu-total-bar-txt">Total warm-up time</div>
      <div class="wu-total-bar-min">${totalMin} min</div>
    </div>
    <button class="wu-start-all-btn" onclick="startFullWarmup()">â–¶ Start Guided Session</button>
  </div>`;

  // Cool Down block
  if(plan.cooldown && plan.cooldown.phases.length) {
    const cdMin = Math.round(plan.cooldown.totalSec / 60);
    html += `<div style="margin-top:32px;padding-top:22px;border-top:2px solid rgba(110,175,201,0.2);">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
        <div style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--l2);font-style:italic;">ðŸ§Š Cool Down</div>
        <div style="flex:1;height:1px;background:rgba(110,175,201,0.15);"></div>
        <div style="font-size:9px;color:var(--muted);">~${cdMin} min</div>
      </div>
      <div style="font-size:9px;color:var(--dim);margin-bottom:14px;line-height:1.6;border-left:2px solid rgba(110,175,201,0.2);padding-left:9px;">
        Tuned to release the muscles you just worked. Don't skip this â€” it is where the gains actually happen.
      </div>`;

    plan.cooldown.phases.forEach(phase => {
      const phaseMin = Math.round(phase.totalSec / 60) || 1;
      html += `<div class="wu-section-hdr">
        <div class="wu-section-title" style="color:var(--l2);">${phase.name}</div>
        <div class="wu-section-line"></div>
        <div class="wu-section-time">~${phaseMin} min</div>
      </div>`;
      html += `<div class="wu-cards">`;
      phase.exercises.forEach((ex, i) => {
        const durationStr = ex.dur ? `${ex.dur}s` : `${ex.reps} reps`;
        const setsStr = ex.sets > 1 ? `${ex.sets} sets` : '1 set';
        const muscleTagsHtml2 = ex.muscle.map(m=>`<span class="wu-tag muscle">${m}</span>`).join('');
        const timerData = ex.dur ? `data-dur="${ex.dur}" data-sets="${ex.sets}" data-name="${ex.name.replace(/"/g,'&quot;')}" data-note="${(ex.note||'').replace(/"/g,'&quot;')}"` : '';
        html += `
          <div class="wu-card mc-flex" style="animation-delay:${i*40}ms;border-left-color:rgba(110,175,201,0.4);">
            <button class="wu-card-del" data-exname="${ex.name}" onclick="removeCdExercise(this.dataset.exname)">âœ•</button>
            <div class="wu-card-name">${ex.name}</div>
            <div class="wu-card-tags">${muscleTagsHtml2}</div>
            <div class="wu-time-row">
              <span class="wu-duration">${durationStr} Â· ${setsStr}</span>
              ${ex.dur ? `<button class="wu-timer-btn" ${timerData} onclick="startExTimer(this)">â± Timer</button>` : `<span class="wu-reps">(count reps)</span>`}
            </div>
            ${ex.note ? `<div class="wu-card-note">${ex.note}</div>` : ''}
          </div>`;
      });
      html += `</div>`;
      html += `<div class="rest-card" style="border-color:rgba(110,175,201,0.15);"><span class="rest-icon">ðŸŒŠ</span><span class="rest-txt">Breathe &amp; settle</span><span class="rest-dur" style="margin-left:auto;">2â€“3 deep breaths</span></div>`;
    });

    html += `<div class="wu-total-bar" style="background:rgba(110,175,201,0.04);border-color:rgba(110,175,201,0.15);">
      <div>
        <div class="wu-total-bar-txt" style="color:var(--l2);">Total cool down time</div>
        <div class="wu-total-bar-min" style="color:var(--l2);">${cdMin} min</div>
      </div>
    </div></div>`;
  }

  document.getElementById('wuHeadline').textContent = `${plan.preset} Warm-Up`;
  body.innerHTML = html;
}

function removeWuExercise(name) {
  if(!wuCurrentPlan) return;
  wuCurrentPlan.phases.forEach(p => {
    p.exercises = p.exercises.filter(e => e.name !== name);
    p.totalSec = p.exercises.reduce((a,e) => a + (e.dur||e.reps*3)*e.sets + (e.sets>1?(e.sets-1)*10:0), 0);
  });
  wuCurrentPlan.totalExercises = wuCurrentPlan.phases.reduce((a,p)=>a+p.exercises.length,0);
  wuCurrentPlan.totalSets = wuCurrentPlan.phases.reduce((a,p)=>a+p.exercises.reduce((b,e)=>b+e.sets,0),0);
  wuCurrentPlan.totalSec = wuCurrentPlan.phases.reduce((a,p)=>a+p.totalSec,0);
  renderWarmup();
}

function removeCdExercise(name) {
  if(!wuCurrentPlan?.cooldown) return;
  wuCurrentPlan.cooldown.phases.forEach(p => {
    p.exercises = p.exercises.filter(e => e.name !== name);
    p.totalSec = p.exercises.reduce((a,e) => a + (e.dur||e.reps*3)*e.sets + (e.sets>1?(e.sets-1)*10:0), 0);
  });
  wuCurrentPlan.cooldown.totalSec = wuCurrentPlan.cooldown.phases.reduce((a,p)=>a+p.totalSec,0);
  renderWarmup();
}

function clearWarmup() {
  wuCurrentPlan = null;
  document.getElementById('wuBody').innerHTML = `<div class="wu-empty"><div class="wu-empty-icon">â—Ž</div><div class="wu-empty-txt">Choose your session type &amp; hit Generate</div></div>`;
  document.getElementById('wuStatExercises').textContent='â€”';
  document.getElementById('wuStatTime').textContent='â€”';
  document.getElementById('wuStatCDTime').textContent='â€”';
  document.getElementById('wuStatSets').textContent='â€”';
  document.getElementById('wuRegenBtn').style.display='none';
  document.getElementById('wuCopyBtn').style.display='none';
}

function copyWarmup() {
  if(!wuCurrentPlan) return;
  let lines = [`${wuCurrentPlan.preset} Warm-Up â€” ${Math.round(wuCurrentPlan.totalSec/60)} min\n`];
  wuCurrentPlan.phases.forEach(p => {
    lines.push(`â”€â”€ ${p.name} â”€â”€`);
    p.exercises.forEach(e => {
      const dur = e.dur ? `${e.dur}s` : `${e.reps} reps`;
      lines.push(`  ${e.name} â€” ${dur} Ã— ${e.sets} set${e.sets>1?'s':''}`);
      if(e.note) lines.push(`    ${e.note}`);
    });
    lines.push('');
  });
  navigator.clipboard.writeText(lines.join('\n')).then(()=>showToast('Copied!'));
}

// â”€â”€ TIMER â”€â”€
function startExTimer(btn) {
  const dur = parseInt(btn.dataset.dur);
  const sets = parseInt(btn.dataset.sets);
  const name = btn.dataset.name;
  const note = btn.dataset.note;
  timerCurrentExercise = {dur, sets, name, note, currentSet:1};
  showTimer(dur, sets, 1, name, note);
}

function startFullWarmup() {
  if(!wuCurrentPlan) return;
  const allEx = [];
  wuCurrentPlan.phases.forEach(p => p.exercises.forEach(e => { if(e.dur) allEx.push(e); }));
  if(!allEx.length){showToast('No timed exercises in this warm-up');return;}
  // Run them in sequence
  timerCurrentExercise = {queue: allEx, queueIdx: 0, ...allEx[0], currentSet: 1};
  const ex = allEx[0];
  showTimer(ex.dur, ex.sets, 1, ex.name, ex.note);
}

function showTimer(dur, totalSets, currentSet, name, note) {
  const overlay = document.getElementById('timerOverlay');
  overlay.classList.remove('hidden');
  document.getElementById('timerExercise').textContent = name;
  document.getElementById('timerSet').textContent = totalSets > 1 ? `Set ${currentSet} of ${totalSets}` : '';
  document.getElementById('timerNote').textContent = note || '';
  timerRemaining = dur;
  timerTotal = dur;
  timerPaused = false;
  document.getElementById('timerPauseBtn').textContent = 'â¸ Pause';
  updateTimerDisplay();
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if(timerPaused) return;
    timerRemaining--;
    updateTimerDisplay();
    if(timerRemaining <= 0) {
      clearInterval(timerInterval);
      timerDone();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(timerRemaining / 60);
  const s = timerRemaining % 60;
  document.getElementById('timerDigits').textContent = m > 0 ? `${m}:${String(s).padStart(2,'0')}` : String(s);
  document.getElementById('timerLabel').textContent = m > 0 ? 'min:sec' : 'seconds';
  const arc = document.getElementById('timerArc');
  const circumference = 528;
  const progress = timerRemaining / timerTotal;
  arc.style.strokeDashoffset = String(circumference * (1 - progress));
  // Color shift as time runs out
  if(progress < 0.25) arc.style.stroke = 'var(--l4)';
  else if(progress < 0.5) arc.style.stroke = 'var(--accent)';
  else arc.style.stroke = 'var(--l1)';
}

function timerDone() {
  // Check if there is a next set or next exercise
  const ex = timerCurrentExercise;
  if(!ex) { stopTimer(); return; }

  if(ex.currentSet < ex.sets) {
    // Next set â€” show 15s rest
    ex.currentSet++;
    showRestTimer(15, () => showTimer(ex.dur, ex.sets, ex.currentSet, ex.name, ex.note));
  } else if(ex.queue && ex.queueIdx < ex.queue.length - 1) {
    // Next exercise in queue â€” show 30s rest
    ex.queueIdx++;
    const next = ex.queue[ex.queueIdx];
    Object.assign(timerCurrentExercise, {...next, currentSet: 1});
    showRestTimer(30, () => showTimer(next.dur, next.sets, 1, next.name, next.note));
  } else {
    stopTimer();
    showToast('Warm-up complete! ðŸ”¥');
  }
}

function showRestTimer(dur, callback) {
  document.getElementById('timerExercise').textContent = 'Rest';
  document.getElementById('timerSet').textContent = 'Catch your breath';
  document.getElementById('timerNote').textContent = 'Hydrate, shake it out.';
  timerRemaining = dur; timerTotal = dur; timerPaused = false;
  document.getElementById('timerArc').style.stroke = 'var(--l2)';
  updateTimerDisplay();
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if(timerPaused) return;
    timerRemaining--;
    updateTimerDisplay();
    if(timerRemaining <= 0) { clearInterval(timerInterval); callback(); }
  }, 1000);
}

function pauseTimer() {
  timerPaused = !timerPaused;
  document.getElementById('timerPauseBtn').textContent = timerPaused ? 'â–¶ Resume' : 'â¸ Pause';
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  timerCurrentExercise = null;
  document.getElementById('timerOverlay').classList.add('hidden');
}

function timerClickAway(e) {
  if(e.target.id === 'timerOverlay') pauseTimer();
}

function initWuRoutineLink() {
  const sel = document.getElementById('wuRoutineLink');
  sel.innerHTML = '<option value="">â€” None (general warm-up) â€”</option>';
  savedRoutines.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = (r.title || 'Untitled') + (r.level ? ` Â· L${r.level}` : '');
    sel.appendChild(opt);
  });
}


function showToast(msg){
  const old=document.querySelector('.toast');if(old)old.remove();
  const el=document.createElement('div');el.className='toast';el.textContent=msg;
  document.body.appendChild(el);setTimeout(()=>el.remove(),2700);
}

// ============================================================
// VIDEO LIBRARY
// ============================================================

// YouTube search URL builder
const YT = (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q+' pole dance tutorial')}`;
const YTD = (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
// Direct resource links
const PP = (slug) => `https://polepedia.com/move-dictionary/${slug}/`;
const P123 = (slug) => `https://123poling.com/${slug}/`;
const PMB = (slug) => `https://polemovebook.com/moves/${slug}/`;

const VL_DB = [
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WARM-UP: MOBILITY & ACTIVATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'wu1',name:'Wrist Circles & Flexion',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ¤²',
   desc:'Full wrist rotation then flexion/extension. Essential before every pole session to prevent injury.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('wrist warm up pole dance')},
     {type:'search',label:'More Videos',url:YT('wrist warm up')},
   ]},
  {id:'wu2',name:'Shoulder Rolls & Arm Circles',cat:'warmup-mobility',level:'beginner',emoji:'â­•',
   desc:'Forward and backward shoulder rolls, building to full arm circles. Opens rotator cuff before gripping.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('shoulder warm up pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('shoulder mobility warm up')},
   ]},
  {id:'wu3',name:'Hip Circles',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ’«',
   desc:'Slow full hip circles each direction. Opens hip joints for mounts and spins.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('hip circles warm up dance')},
     {type:'search',label:'More Videos',url:YT('hip warm up dance')},
   ]},
  {id:'wu4',name:'Cat-Cow Stretch',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ±',
   desc:'On all fours, alternate spinal flexion and extension. Decompresses spine before inversions.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('cat cow stretch yoga tutorial')},
     {type:'search',label:'More Videos',url:YT('spinal warm up')},
   ]},
  {id:'wu5',name:'Scapular Push-Ups',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ’ª',
   desc:'Activate scapular stabilizers without bending elbows. Critical for safe inversions.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('scapular push ups tutorial pole dance conditioning')},
     {type:'search',label:'More Videos',url:YT('scapular activation')},
   ]},
  {id:'wu6',name:'Dead Bug',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ›',
   desc:'Opposite arm/leg lower slowly. Activates deep core â€” essential for inversions and climbs.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('dead bug exercise tutorial core')},
     {type:'search',label:'More Videos',url:YT('core activation warm up')},
   ]},
  {id:'wu7',name:'Leg Swings',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ¦µ',
   desc:'Front-back and side-to-side leg swings holding the pole. Opens hip flexors and adductors.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('leg swings warm up hip mobility')},
     {type:'search',label:'More Videos',url:YT('hip flexor warm up')},
   ]},
  {id:'wu8',name:'Glute Bridge',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ‘',
   desc:'Lie on back, push hips up, squeeze at top. Activates glutes before climbing and mounting.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('glute bridge tutorial activation')},
     {type:'search',label:'More Videos',url:YT('glute activation warm up')},
   ]},
  {id:'wu9',name:'Hanging Dead Hang',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ‹ï¸',
   desc:'Hang from pole or bar for 20s. Best grip and shoulder opener combined.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('dead hang pole dance shoulder warm up')},
     {type:'search',label:'More Videos',url:YT('grip warm up pole')},
   ]},
  {id:'wu10',name:'Wall Angels',cat:'warmup-mobility',level:'beginner',emoji:'ðŸ‘¼',
   desc:'Back flat on wall, arms slide overhead. Critical for shoulder health and safe inversions.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('wall angels exercise shoulder mobility')},
     {type:'search',label:'More Videos',url:YT('shoulder health warm up')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WARM-UP: STRETCHING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'ws1',name:'Low Lunge Hip Flexor Stretch',cat:'warmup-stretch',level:'beginner',emoji:'ðŸ§Ž',
   desc:'Back knee on floor, push hips forward. 30s each side. Critical before inversions and mounts.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('low lunge hip flexor stretch tutorial')},
     {type:'search',label:'More Videos',url:YT('hip flexor stretch pole dance')},
   ]},
  {id:'ws2',name:'Pigeon Pose',cat:'warmup-stretch',level:'beginner',emoji:'ðŸ•Šï¸',
   desc:'Deep hip opener â€” 40s each side. Essential before spins, floorwork, and pole sits.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('pigeon pose yoga hip stretch tutorial')},
     {type:'search',label:'More Videos',url:YT('hip stretch pole dance warm up')},
   ]},
  {id:'ws3',name:'Seated Straddle Stretch',cat:'warmup-stretch',level:'beginner',emoji:'ðŸ¤¸',
   desc:'Legs wide, slowly walk hands forward. Inner thigh and hamstring opener.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('straddle stretch tutorial flexibility')},
     {type:'search',label:'More Videos',url:YT('split stretch pole dance')},
   ]},
  {id:'ws4',name:'Overhead Reach & Side Bend',cat:'warmup-stretch',level:'beginner',emoji:'ðŸ™†',
   desc:'Full stretch from fingertips to hip. 25s each side. Opens lats for climbs.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('side stretch lat stretch dance warm up')},
     {type:'search',label:'More Videos',url:YT('lat stretch warm up pole')},
   ]},
  {id:'ws5',name:'Standing Forward Fold',cat:'warmup-stretch',level:'beginner',emoji:'ðŸ™‡',
   desc:'Soft knees, hang heavy. Full posterior chain stretch before climbs and drops.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('forward fold stretch hamstrings tutorial')},
     {type:'search',label:'More Videos',url:YT('hamstring stretch dance warm up')},
   ]},
  {id:'ws6',name:'Shoulder Dislocations',cat:'warmup-stretch',level:'beginner',emoji:'ðŸŽ½',
   desc:'Wide grip with band or towel, slowly pass overhead and behind. Full shoulder mobility.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('shoulder dislocations flexibility band tutorial')},
     {type:'search',label:'More Videos',url:YT('shoulder flexibility pole dance')},
   ]},
  {id:'ws7',name:'Back Arch Prep',cat:'warmup-stretch',level:'intermediate',emoji:'ðŸŒ‰',
   desc:'On all fours, slowly lower belly and open chest. Gentle backbend preparation.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('back arch prep flexibility backbend tutorial')},
     {type:'search',label:'More Videos',url:YT('backbend warm up pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WARM-UP: COOL DOWN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'cd1',name:'Thread the Needle',cat:'warmup-cooldown',level:'beginner',emoji:'ðŸ§µ',
   desc:'On all fours, thread one arm under body. 30s each side. Thoracic spine release.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('thread the needle stretch thoracic spine')},
     {type:'search',label:'More Videos',url:YT('cool down pole dance stretch')},
   ]},
  {id:'cd2',name:'Supine Spinal Twist',cat:'warmup-cooldown',level:'beginner',emoji:'ðŸŒ€',
   desc:'Lie on back, knee drops across body. 35s each side. Relieves spinal compression.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('supine spinal twist stretch yoga')},
     {type:'search',label:'More Videos',url:YT('cool down stretches pole dance')},
   ]},
  {id:'cd3',name:"Child's Pose Extended",cat:'warmup-cooldown',level:'beginner',emoji:'ðŸ§¸',
   desc:'Hips to heels, arms long, breathe into lower back. 45s. Classic spine decompressor.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD("child's pose yoga tutorial extended")},
     {type:'search',label:'More Videos',url:YT('restorative cool down stretches')},
   ]},
  {id:'cd4',name:'Pigeon Pose (held)',cat:'warmup-cooldown',level:'beginner',emoji:'ðŸ•Šï¸',
   desc:'60s each side, deeper than your warm-up pigeon. Full glute and hip flexor release.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('yin pigeon pose held deep hip stretch')},
     {type:'search',label:'More Videos',url:YT('deep hip cool down stretch')},
   ]},
  {id:'cd5',name:'Legs Up the Wall',cat:'warmup-cooldown',level:'beginner',emoji:'ðŸ¦µ',
   desc:'90s. Reverses blood pooling in legs, relieves lower back, calms nervous system.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('legs up the wall pose benefits yoga')},
     {type:'search',label:'More Videos',url:YT('recovery cool down after pole dance')},
   ]},
  {id:'cd6',name:'Savasana / Full Rest',cat:'warmup-cooldown',level:'beginner',emoji:'ðŸŒ™',
   desc:'Lie completely still for 2 min. This is when your body actually adapts and repairs.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('savasana guided relaxation yoga')},
     {type:'search',label:'More Videos',url:YT('post workout recovery pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SPINS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'sp1',name:'Fireman Spin',cat:'spin',level:'beginner',psoLevel:'L1',emoji:'ðŸ”¥',
   desc:'The first spin most polers learn. Inside leg hooks, outside leg swings to create momentum. Works on static and spinning pole.',
   sources:[
     {type:'yt',label:'123Poling Tutorial',url:'https://www.youtube.com/results?search_query=fireman+spin+pole+dance+tutorial+123poling'},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('fireman spin')},
   ]},
  {id:'sp2',name:'Chair Spin',cat:'spin',level:'beginner',psoLevel:'L1',emoji:'ðŸª‘',
   desc:'Thighs grip the pole, legs extend out in front like sitting in a chair. Creates a beautiful flowing spin.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('chair spin pole dance tutorial beginner')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('chair spin')},
   ]},
  {id:'sp3',name:'Carousel Spin',cat:'spin',level:'beginner',psoLevel:'L1',emoji:'ðŸŽ ',
   desc:'Body stays extended and parallel to the floor as you spin. Requires strong core engagement.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('carousel spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('carousel spin pole')},
   ]},
  {id:'sp4',name:'Attitude Spin',cat:'spin',level:'beginner',psoLevel:'L1',emoji:'ðŸ’ƒ',
   desc:'One leg bent behind, one extended. Graceful and balletic in appearance.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('attitude spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('attitude spin pole')},
   ]},
  {id:'sp5',name:'Dip Spin',cat:'spin',level:'beginner',psoLevel:'L1',emoji:'ðŸŒŠ',
   desc:'Knees bend into a dip as you spin. Versatile, adds dynamism to any routine.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('dip spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('dip spin pole dance')},
   ]},
  {id:'sp6',name:'Cross Knee Spin',cat:'spin',level:'beginner',psoLevel:'L2',emoji:'âœ‚ï¸',
   desc:'Knees crossed and gripping pole, body spins outward. Transitions well into other moves.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('cross knee release spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('cross knee spin pole')},
   ]},
  {id:'sp7',name:'Back Hook Spin',cat:'spin',level:'intermediate',psoLevel:'L2',emoji:'ðŸª',
   desc:'Back of knee hooks pole, creating an elegant floating appearance.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('back hook spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('back hook spin pole')},
   ]},
  {id:'sp8',name:'Jasmine Spin',cat:'spin',level:'intermediate',psoLevel:'L3',emoji:'ðŸŒ¸',
   desc:'Inside leg bent, outside leg long. Creates a beautiful asymmetrical shape in the spin.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('jasmine spin pole dance tutorial')},
     {type:'site',label:'PoleMovebook',url:'https://polemovebook.com/'},
     {type:'search',label:'More Videos',url:YT('jasmine pole')},
   ]},
  {id:'sp9',name:'Reverse Grab Spin',cat:'spin',level:'intermediate',psoLevel:'L2',emoji:'ðŸ”„',
   desc:'Reverse grip creates a twisted, dramatic spin with great visual impact.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('reverse grab spin pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('reverse grab spin pole')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLIMBS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'cl1',name:'Basic Climb',cat:'climb',level:'beginner',psoLevel:'L1',emoji:'ðŸ§—',
   desc:'Fundamental pole climb using thighs and feet. The gateway to all aerial work.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('pole dance climb tutorial beginner basic climb')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('pole climb tutorial')},
   ]},
  {id:'cl2',name:'Chopper / V-Invert',cat:'climb',level:'intermediate',psoLevel:'L2',emoji:'âœŒï¸',
   desc:'V-shape inversion at the top of a climb. Gateway to all inverted pole work.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('chopper v invert pole dance tutorial')},
     {type:'site',label:'123Poling',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('chopper invert pole')},
   ]},
  {id:'cl3',name:'Superman Climb',cat:'climb',level:'advanced',psoLevel:'L3',emoji:'ðŸ¦¸',
   desc:'Dramatic horizontal pose during climb. Requires serious core and grip strength.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('superman climb pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('superman pole climb')},
   ]},
  {id:'cl4',name:'Side Climb',cat:'climb',level:'intermediate',psoLevel:'L2',emoji:'ðŸ§­',
   desc:'Climb with body turned to the side. Great for accessing jasmine and genie poses.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('side climb pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('side climb pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INVERSIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'inv1',name:'Basic Invert',cat:'invert',level:'intermediate',psoLevel:'L2',emoji:'ðŸ™ƒ',
   desc:'First upside-down position. Hands on pole, kick legs up and over. The foundation of all inverted tricks.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('basic invert pole dance tutorial beginner')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('invert pole dance')},
   ]},
  {id:'inv2',name:'Outside Leg Hang (Gemini)',cat:'invert',level:'intermediate',psoLevel:'L2',emoji:'â™Š',
   desc:'Outside of knee hooks pole while inverted. Also called Gemini. Gateway to Jade Split.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('gemini outside leg hang pole dance tutorial')},
     {type:'site',label:'123Poling',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('gemini pole dance')},
   ]},
  {id:'inv3',name:'Inside Leg Hang (Scorpio)',cat:'invert',level:'intermediate',psoLevel:'L2',emoji:'ðŸ¦‚',
   desc:'Inside of knee hooks, body arches. Creates a dramatic curved shape.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('scorpio inside leg hang pole dance tutorial')},
     {type:'site',label:'PoleMovebook',url:'https://polemovebook.com/'},
     {type:'search',label:'More Videos',url:YT('scorpio pole dance')},
   ]},
  {id:'inv4',name:'Butterfly',cat:'invert',level:'intermediate',psoLevel:'L3',emoji:'ðŸ¦‹',
   desc:'Both thighs grip the pole with body inverted and arched. Prerequisite for Ayesha.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('butterfly pole dance tutorial intermediate')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('butterfly pole')},
   ]},
  {id:'inv5',name:'Jade Split',cat:'invert',level:'intermediate',psoLevel:'L3',emoji:'ðŸ’š',
   desc:'Inverted with legs in a split. Front leg holds the pole, back leg extends behind.',
   sources:[
     {type:'yt',label:'123Poling Tutorial',url:'https://123poling.com/jade-split-free-pole-dance-tutorial/'},
     {type:'site',label:'SuperflyHoney',url:'https://www.superflyhoney.com/blogs/pole-tutorials/'},
     {type:'search',label:'More Videos',url:YT('jade split pole dance')},
   ]},
  {id:'inv6',name:'Brass Monkey',cat:'invert',level:'intermediate',psoLevel:'L3',emoji:'ðŸ’',
   desc:'Inside leg hang with outside leg extended. Beautiful wide shape. Bridge to advanced inverts.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('brass monkey pole dance tutorial')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('brass monkey pole')},
   ]},
  {id:'inv7',name:'Ayesha',cat:'invert',level:'advanced',psoLevel:'L4',emoji:'â­',
   desc:'Body inverted held only by arms, legs split wide. One of the most iconic advanced pole moves.',
   sources:[
     {type:'yt',label:'The Pole Dancer Tutorial',url:'https://thepoledancer.com/tutorials/ayesha-handspring/'},
     {type:'site',label:'SuperflyHoney',url:'https://www.superflyhoney.com/blogs/pole-tutorials/pole-trick-tutorial-ayesha-with-a-forearm-grip'},
     {type:'search',label:'More Videos',url:YT('ayesha pole dance')},
   ]},
  {id:'inv8',name:'Handspring',cat:'invert',level:'advanced',psoLevel:'L4',emoji:'ðŸ¤¸',
   desc:'Arms-only inversion using twisted or true grip. Requires exceptional shoulder strength.',
   sources:[
     {type:'yt',label:'The Pole Dancer Tutorial',url:'https://thepoledancer.com/tutorials/ayesha-handspring/'},
     {type:'site',label:'123Poling',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('handspring pole dance tutorial')},
   ]},
  {id:'inv9',name:'Iron X',cat:'invert',level:'advanced',psoLevel:'L5',emoji:'âœ–ï¸',
   desc:'Body horizontal held only by arms, forming an X shape. Maximum strength required.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('iron x pole dance tutorial advanced')},
     {type:'search',label:'More Videos',url:YT('iron x pole dance')},
   ]},
  {id:'inv10',name:'Inverted Crucifix',cat:'invert',level:'intermediate',psoLevel:'L3',emoji:'âœï¸',
   desc:'Both legs hooked over the pole, arms free. Gateway to Ayesha and elbow grips.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('inverted crucifix pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('inverted crucifix pole')},
   ]},
  {id:'inv11',name:'Flatline Scorpio',cat:'invert',level:'advanced',psoLevel:'L4',emoji:'ðŸ“',
   desc:'Scorpio with body held fully horizontal. Spectacular visual impact.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('flatline scorpio pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('flatline scorpio pole')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MOUNTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'mo1',name:'Shoulder Mount',cat:'mount',level:'intermediate',psoLevel:'L3',emoji:'ðŸ’¼',
   desc:'Mount the pole using the shoulder as the primary contact point. Opens new set of inverted entrances.',
   sources:[
     {type:'yt',label:'EBFit Tutorial',url:'https://www.youtube.com/results?search_query=shoulder+mount+pole+dance+tutorial+EBFit'},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('shoulder mount pole dance')},
   ]},
  {id:'mo2',name:'Forearm Mount',cat:'mount',level:'intermediate',psoLevel:'L3',emoji:'ðŸ’ª',
   desc:'Forearm presses into pole for a different inverted mount position.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('forearm mount pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('forearm mount pole dance')},
   ]},
  {id:'mo3',name:'Twisted Grip Shoulder Mount',cat:'mount',level:'advanced',psoLevel:'L4',emoji:'ðŸ”€',
   desc:'Shoulder mount using twisted grip. More demanding on shoulder â€” requires proper conditioning first.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('twisted grip shoulder mount pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('twisted grip shoulder mount')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // POSES & HOLDS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'po1',name:'Jasmine Pose',cat:'pose',level:'intermediate',psoLevel:'L2',emoji:'ðŸŒ¸',
   desc:'Hold pole at mid-height, one arm overhead, one below waist, legs in split. Classic beautiful shape.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('jasmine pose pole dance tutorial hold')},
     {type:'site',label:'PoleMovebook',url:'https://polemovebook.com/'},
     {type:'search',label:'More Videos',url:YT('jasmine pole hold')},
   ]},
  {id:'po2',name:'Superman Pose',cat:'pose',level:'advanced',psoLevel:'L3',emoji:'ðŸ¦¸',
   desc:'Arms overhead gripping pole, body extended horizontally behind. Flying superhero shape.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('superman pose pole dance tutorial')},
     {type:'site',label:'123Poling',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('superman pole dance pose')},
   ]},
  {id:'po3',name:'Genie Pose',cat:'pose',level:'intermediate',psoLevel:'L3',emoji:'ðŸ§ž',
   desc:'Forearms wrap around pole, legs crossed and lifted. Creates a meditation-like floating shape.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('genie pose pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('genie pole dance')},
   ]},
  {id:'po4',name:'Remi Sit',cat:'pose',level:'intermediate',psoLevel:'L3',emoji:'ðŸ’º',
   desc:'Thigh hooks pole in a seated position at height. Can be upright or inverted.',
   sources:[
     {type:'yt',label:'EBFit Tutorial',url:'https://www.youtube.com/results?search_query=remi+sit+pole+dance+tutorial'},
     {type:'search',label:'More Videos',url:YT('remi sit pole dance')},
   ]},
  {id:'po5',name:'Figurehead',cat:'pose',level:'advanced',psoLevel:'L4',emoji:'âš“',
   desc:'Body held horizontal to the floor using just the arms on the pole. Like the figurehead on a ship.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('figurehead pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('figurehead pole dance')},
   ]},
  {id:'po6',name:'Pole Sit',cat:'pose',level:'beginner',psoLevel:'L1',emoji:'ðŸª‘',
   desc:'Sit on the pole using thigh grip. First static hold most beginners learn.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('pole sit tutorial beginner pole dance')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/move-dictionary/'},
     {type:'search',label:'More Videos',url:YT('pole sit')},
   ]},
  {id:'po7',name:'Crucifix Hold',cat:'pose',level:'intermediate',psoLevel:'L2',emoji:'âœï¸',
   desc:'Arms spread wide, no hands on pole, body upright held by underarms. Arms-free hold.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('crucifix hold pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('crucifix pole hold')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DROPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'dr1',name:'Holly Drop',cat:'drop',level:'advanced',psoLevel:'L4',emoji:'ðŸƒ',
   desc:'From a high hold, drop dramatically while maintaining grip â€” controlled fall into a new position.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('holly drop pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('holly drop pole')},
   ]},
  {id:'dr2',name:'Superman Drop',cat:'drop',level:'advanced',psoLevel:'L4',emoji:'ðŸ’«',
   desc:'From Superman pose, release legs and drop into a spin or lower position.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('superman drop pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('superman drop pole dance')},
   ]},
  {id:'dr3',name:'Martini Drop',cat:'drop',level:'advanced',psoLevel:'L4',emoji:'ðŸ¸',
   desc:'Legs form a Martini glass shape during the drop. Visually dramatic.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('martini drop pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('martini drop pole')},
   ]},
  {id:'dr4',name:'Dead Drop',cat:'drop',level:'advanced',psoLevel:'L5',emoji:'â˜ ï¸',
   desc:'Full release from height into controlled descent. Maximum impact, maximum skill required.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('dead drop pole dance tutorial advanced')},
     {type:'search',label:'More Videos',url:YT('dead drop pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TRANSITIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'tr1',name:'Body Wave / Body Roll',cat:'transition',level:'beginner',psoLevel:'L1',emoji:'ðŸŒŠ',
   desc:'Fluid undulation through the full body against the pole. Foundation of sensual movement.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('body wave body roll pole dance tutorial')},
     {type:'site',label:'PolePedia',url:'https://polepedia.com/10-pole-moves-for-the-absolute-beginner/'},
     {type:'search',label:'More Videos',url:YT('body wave pole dance')},
   ]},
  {id:'tr2',name:'Pole Walk',cat:'transition',level:'beginner',psoLevel:'L1',emoji:'ðŸ‘£',
   desc:'Circling the pole with deliberate, graceful steps. The foundation of all floor-based pole movement.',
   sources:[
     {type:'yt',label:'PolePedia Tutorial',url:'https://polepedia.com/10-pole-moves-for-the-absolute-beginner/'},
     {type:'search',label:'More Videos',url:YT('pole walk beginner')},
   ]},
  {id:'tr3',name:'Spin to Climb Transition',cat:'transition',level:'intermediate',psoLevel:'L2',emoji:'ðŸ”€',
   desc:'After a spin, hook the inside knee to transition directly into a climb.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('spin to climb transition pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('spin to climb transition pole')},
   ]},
  {id:'tr4',name:'Invert to Leg Hang Transition',cat:'transition',level:'intermediate',psoLevel:'L3',emoji:'ðŸ”',
   desc:'From an invert, extend one leg and hook it for a dynamic leg hang entry.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('invert to leg hang transition pole dance')},
     {type:'search',label:'More Videos',url:YT('invert transition pole dance')},
   ]},
  {id:'tr5',name:'Floor to Pole Transition',cat:'transition',level:'beginner',psoLevel:'L1',emoji:'â¬†ï¸',
   desc:'Getting up off the floor and onto the pole elegantly. Critical for routine flow.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('floor to pole transition tutorial dance')},
     {type:'search',label:'More Videos',url:YT('floor to pole transition')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FLOORWORK
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'fl1',name:'Cat Crawl',cat:'floorwork',level:'beginner',psoLevel:'L1',emoji:'ðŸ±',
   desc:'Sensual four-point crawl toward or away from the pole. Works in any style.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('cat crawl floorwork pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('cat crawl floorwork')},
   ]},
  {id:'fl2',name:'Hair Flip',cat:'floorwork',level:'beginner',psoLevel:'L1',emoji:'ðŸ’‡',
   desc:'Floor hair flip â€” dynamic and dramatic transition or ending move.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('hair flip floorwork pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('hair flip pole dance')},
   ]},
  {id:'fl3',name:'Mermaid to Split',cat:'floorwork',level:'intermediate',psoLevel:'L2',emoji:'ðŸ§œ',
   desc:'From a mermaid floor position, slide into a full split. Requires hip flexibility.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('mermaid to split floorwork pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('mermaid floorwork pole')},
   ]},
  {id:'fl4',name:'Heel Clack',cat:'floorwork',level:'beginner',psoLevel:'L1',emoji:'ðŸ‘ ',
   desc:'Heels click together in the air or on the floor. Iconic exotic pole movement.',
   sources:[
     {type:'yt',label:'123Poling Tutorial',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('heel clack exotic pole dance')},
   ]},
  {id:'fl5',name:'Body Roll (Floor)',cat:'floorwork',level:'beginner',psoLevel:'L1',emoji:'ðŸŒŠ',
   desc:'Fluid body roll while on the floor, traveling along the pole.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('floor body roll exotic pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('floorwork body roll pole dance')},
   ]},
  {id:'fl6',name:'Straddle Roll',cat:'floorwork',level:'intermediate',psoLevel:'L2',emoji:'ðŸŽ²',
   desc:'Roll across the floor through a straddle position. Great for transitions between pole work.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('straddle roll floorwork pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('straddle floorwork pole')},
   ]},
  {id:'fl7',name:'Liquid Motion',cat:'floorwork',level:'intermediate',psoLevel:'L2',emoji:'ðŸ’§',
   desc:'Slow, fluid, wave-like movement through the entire body on the floor.',
   sources:[
     {type:'yt',label:'123Poling Tutorial',url:'https://123poling.com/free-pole-dance-tutorials/'},
     {type:'search',label:'More Videos',url:YT('liquid motion pole dance floorwork')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COMBOS â€” BEGINNER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'cb1',name:'Fireman to Chair Combo',cat:'combo-beginner',level:'beginner',emoji:'ðŸ”—',
   desc:'Transition from Fireman Spin directly into Chair Spin. First combo most beginners nail.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('fireman to chair spin combo pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('beginner pole combo fireman chair')},
   ]},
  {id:'cb2',name:'Walk, Dip, Body Roll Combo',cat:'combo-beginner',level:'beginner',emoji:'ðŸŽµ',
   desc:'Pole walk into a deep dip, flow into a body roll. Beautiful beginner routine building block.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('pole walk dip body roll combo tutorial beginner')},
     {type:'search',label:'More Videos',url:YT('beginner pole combo body roll')},
   ]},
  {id:'cb3',name:'Climb to Sit to Pole Walk',cat:'combo-beginner',level:'beginner',emoji:'ðŸ§—',
   desc:'Basic climb, hold a pole sit, slide down, exit into a pole walk. Classic beginner sequence.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('climb pole sit combo beginner tutorial')},
     {type:'search',label:'More Videos',url:YT('beginner pole combo climb sit')},
   ]},
  {id:'cb4',name:'3-Spin Combo',cat:'combo-beginner',level:'beginner',emoji:'ðŸŒ€',
   desc:'Chair, Fireman, and Carousel linked together. Tests spin consistency and transition fluidity.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('3 spin combo pole dance beginner tutorial')},
     {type:'search',label:'More Videos',url:YT('spin combo beginner pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COMBOS â€” INTERMEDIATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'ci1',name:'Climb to Invert to Gemini',cat:'combo-intermediate',level:'intermediate',emoji:'â™Š',
   desc:'Climb, invert, hook outside leg into Gemini. Classic intermediate sequence.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('climb invert gemini combo pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('climb invert combo pole dance')},
   ]},
  {id:'ci2',name:'Shoulder Mount to Jasmine',cat:'combo-intermediate',level:'intermediate',emoji:'ðŸŒ¸',
   desc:'From shoulder mount, transition to Jasmine hold. EBFit staple combo.',
   sources:[
     {type:'yt',label:'EBFit Tutorial',url:'https://elizabethbfit.com/ebfit-pole-library-app/'},
     {type:'search',label:'More Videos',url:YT('shoulder mount jasmine combo')},
   ]},
  {id:'ci3',name:'Side Climb to Jasmine to Genie',cat:'combo-intermediate',level:'intermediate',emoji:'ðŸ§ž',
   desc:'Side climb, settle into Jasmine, transition to Genie. Beautiful intermediate flow.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('side climb jasmine genie combo pole dance')},
     {type:'search',label:'More Videos',url:YT('jasmine genie combo pole')},
   ]},
  {id:'ci4',name:'Invert to Brass Monkey to Jade',cat:'combo-intermediate',level:'intermediate',emoji:'ðŸ’š',
   desc:'Invert, transition to Brass Monkey, extend into Jade Split. Requires hip flexibility.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('brass monkey jade split combo pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('brass monkey jade split combo')},
   ]},
  {id:'ci5',name:'Reverse Grab to Chair to Reiko',cat:'combo-intermediate',level:'intermediate',emoji:'ðŸ”„',
   desc:'Reverse grab spin transitions to chair, exits into Reiko Mount. Dynamic intermediate sequence.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('reverse grab chair spin combo pole dance tutorial')},
     {type:'search',label:'More Videos',url:YT('intermediate spin combo pole dance')},
   ]},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COMBOS â€” ADVANCED
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {id:'ca1',name:'Shoulder Mount to Butterfly to Ayesha',cat:'combo-advanced',level:'advanced',emoji:'â­',
   desc:'Classic advanced progression. Shoulder mount enters butterfly, transitions to Ayesha.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('shoulder mount butterfly ayesha combo pole dance')},
     {type:'search',label:'More Videos',url:YT('ayesha combo pole dance advanced')},
   ]},
  {id:'ca2',name:'Handspring to Flatline Scorpio',cat:'combo-advanced',level:'advanced',emoji:'ðŸ’«',
   desc:'Twisted grip handspring entry, hold, transition to dramatic flatline scorpio.',
   sources:[
     {type:'yt',label:'YouTube Tutorial',url:YTD('handspring flatline scorpio combo pole dance')},
     {type:'search',label:'More Videos',url:YT('handspring combo pole dance advanced')},
   ]},
  {id:'ca3',name:'Spinning Climb to Aerial Invert to Figurehead',cat:'combo-advanced',level:'advanced',emoji:'âš“',
   desc:'Climb on spinning pole, aerial invert, extend into figurehead hold. Elite combination.',
   sources:[
     {type:'yt',label:'PoleFreaks Reference',url:'https://studio.polefreaks.com/'},
     {type:'search',label:'More Videos',url:YT('spinning pole advanced combo tutorial')},
   ]},
  {id:'ca4',name:'Brass Monkey to Reverse Ayesha',cat:'combo-advanced',level:'advanced',emoji:'ðŸ’',
   desc:'From brass monkey, progressively load shoulders into reverse Ayesha.',
   sources:[
     {type:'yt',label:'EBFit Tutorial',url:'https://elizabethbfit.com/ebfit-pole-library-app/'},
     {type:'search',label:'More Videos',url:YT('brass monkey reverse ayesha combo')},
   ]},
];

let vlCurrentCat = 'all';
let vlCurrentFilter = 'all';

function vlSetCat(cat, btn) {
  vlCurrentCat = cat;
  document.querySelectorAll('.vl-cat-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderVidLib();
}

function vlSetFilter(f, btn) {
  vlCurrentFilter = f;
  document.querySelectorAll('.vl-chip').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderVidLib();
}

function renderVidLib() {
  const search = (document.getElementById('vlSearch')?.value || '').toLowerCase().trim();
  const grid = document.getElementById('vlGrid');
  if(!grid) return;

  let items = VL_DB.filter(m => {
    // Category filter
    if(vlCurrentCat !== 'all') {
      if(vlCurrentCat.startsWith('level-')) {
        if(m.psoLevel !== vlCurrentCat.replace('level-','')) return false;
      } else {
        if(m.cat !== vlCurrentCat) return false;
      }
    }
    // Level filter
    if(vlCurrentFilter !== 'all' && m.level !== vlCurrentFilter) return false;
    // Search
    if(search && !m.name.toLowerCase().includes(search) && !m.desc.toLowerCase().includes(search) && !(m.cat||'').toLowerCase().includes(search)) return false;
    return true;
  });

  document.getElementById('vlResultCount').textContent = `${items.length} ${items.length===1?'result':'results'}`;

  if(!items.length) {
    grid.innerHTML = '<div class="vl-empty">No moves found â€” try a different search or filter</div>';
    return;
  }

  const levelColors = {L1:'var(--l1)',L2:'var(--l2)',L3:'var(--l3)',L4:'var(--l4)',L5:'var(--l5)'};
  const levelClass = {L1:'lvl-1',L2:'lvl-2',L3:'lvl-3',L4:'lvl-4',L5:'lvl-5'};
  const catLabel = {
    'warmup-mobility':'Mobility','warmup-stretch':'Stretch','warmup-cooldown':'Cool Down',
    'spin':'Spin','climb':'Climb','invert':'Invert','mount':'Mount',
    'pose':'Pose/Hold','drop':'Drop','transition':'Transition','floorwork':'Floorwork',
    'combo-beginner':'Combo','combo-intermediate':'Combo','combo-advanced':'Combo'
  };
  const srcIcons = {yt:'â–¶', site:'ðŸ”—', search:'ðŸ”'};

  grid.innerHTML = items.map(m => {
    const lc = levelClass[m.psoLevel] || '';
    const lcolor = levelColors[m.psoLevel] || 'var(--muted)';
    const srcBtns = m.sources.map(s =>
      `<a class="vl-src-btn ${s.type}" href="${s.url}" target="_blank" rel="noopener">${srcIcons[s.type]} ${s.label}</a>`
    ).join('');
    const psoTag = m.psoLevel ? `<span class="vl-level-badge ${lc}" style="color:${lcolor};border-color:${lcolor}44;">${m.psoLevel}</span>` : '';
    const levelTag = `<span class="vl-level-badge" style="color:var(--muted);border-color:var(--border);">${m.level}</span>`;
    const catTag = `<span class="vl-cat-tag">${catLabel[m.cat]||m.cat}</span>`;

    return `<div class="vl-card">
      <div class="vl-thumb" onclick="window.open('${m.sources[0].url}','_blank')">
        <div class="vl-thumb-placeholder">${m.emoji}</div>
        <div class="vl-play-overlay"><div class="vl-play-btn">â–¶</div></div>
      </div>
      <div class="vl-body">
        <div class="vl-move-name">${m.name}</div>
        <div class="vl-meta">${psoTag}${levelTag}${catTag}</div>
        <div class="vl-desc">${m.desc}</div>
        <div class="vl-sources">${srcBtns}</div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// CLASS SCHEDULE
// ============================================================
let schedClasses = JSON.parse(localStorage.getItem('pc_schedule') || '[]');
let schedWeekOffset = 0;
let selectedClassType = 'pole';
let selectedRecur = 'none';
let mbSavedUrl = localStorage.getItem('pc_mb_url') || '';

// Class type colors for iCal and badges
const CT_COLORS = {
  pole:'#c96ea8', stretch:'#6ec9b0', conditioning:'#6eafc9',
  floorwork:'#a06ec9', private:'#c9a96e', performance:'#c96e6e', other:'#7a7870'
};

function initSchedule() {
  // Set default date to today
  const today = new Date();
  document.getElementById('scDate').value = today.toISOString().slice(0,10);
  document.getElementById('scTime').value = '10:00';

  // Mindbody URL
  if(mbSavedUrl) document.getElementById('mbStudioUrl').value = mbSavedUrl;

  // Class type chip clicks
  document.getElementById('ctChips').addEventListener('click', e => {
    const c = e.target.closest('.ct-chip'); if(!c) return;
    document.querySelectorAll('.ct-chip').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    selectedClassType = c.dataset.ct;
  });

  // Recur chip clicks
  document.getElementById('recurChips').addEventListener('click', e => {
    const c = e.target.closest('.recur-chip'); if(!c) return;
    document.querySelectorAll('.recur-chip').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    selectedRecur = c.dataset.r;
  });

  // Save MB url on change
  document.getElementById('mbStudioUrl').addEventListener('input', e => {
    mbSavedUrl = e.target.value.trim();
    localStorage.setItem('pc_mb_url', mbSavedUrl);
  });

  renderSchedule();
}

function addSchedClass() {
  const name = document.getElementById('scName').value.trim();
  const date = document.getElementById('scDate').value;
  const time = document.getElementById('scTime').value;
  if(!name || !date || !time) { showToast('Name, date & time required'); return; }

  const dur = parseInt(document.getElementById('scDuration').value);
  const level = document.getElementById('scLevel').value;
  const location = document.getElementById('scLocation').value.trim();
  const instructor = document.getElementById('scInstructor').value.trim();
  const notes = document.getElementById('scNotes').value.trim();
  const recur = selectedRecur;
  const type = selectedClassType;

  const baseClass = { name, type, date, time, dur, level, location, instructor, notes, recur };

  if(recur === 'none') {
    schedClasses.push({ ...baseClass, id: 'sc' + Date.now() });
  } else {
    // Generate recurring instances for 12 weeks
    const intervals = { weekly:7, biweekly:14, monthly:30 };
    const step = intervals[recur] || 7;
    const count = recur === 'monthly' ? 6 : 12;
    const groupId = 'scg' + Date.now();
    let d = new Date(date + 'T' + time);
    for(let i = 0; i < count; i++) {
      schedClasses.push({
        ...baseClass,
        date: d.toISOString().slice(0,10),
        id: 'sc' + Date.now() + i,
        groupId,
        recurLabel: recur
      });
      d.setDate(d.getDate() + step);
    }
  }

  schedClasses.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
  saveSchedule();
  renderSchedule();
  document.getElementById('scName').value = '';
  document.getElementById('scNotes').value = '';
  showToast('Class added!');
}

function deleteSchedClass(id) {
  schedClasses = schedClasses.filter(c => c.id !== id);
  saveSchedule(); renderSchedule();
}

function saveSchedule() {
  localStorage.setItem('pc_schedule', JSON.stringify(schedClasses));
  fbSyncSchedule();
}

function clearPastClasses() {
  const today = new Date().toISOString().slice(0,10);
  schedClasses = schedClasses.filter(c => c.date >= today);
  saveSchedule(); renderSchedule(); showToast('Past classes cleared');
}

function schedChangeWeek(d) { schedWeekOffset += d; renderSchedule(); }
function schedGoToday() { schedWeekOffset = 0; renderSchedule(); }

function renderSchedule() {
  renderSchedWeekGrid();
  renderUpcoming();
}

function getSchedWeekDates() {
  const now = new Date();
  const day = now.getDay();
  const sunday = new Date(now);
  sunday.setDate(now.getDate() - day + (schedWeekOffset * 7));
  sunday.setHours(0,0,0,0);
  return Array.from({length:7}, (_,i) => {
    const d = new Date(sunday); d.setDate(sunday.getDate()+i); return d;
  });
}

function renderSchedWeekGrid() {
  const days = getSchedWeekDates();
  const today = new Date().toISOString().slice(0,10);
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  const ws = days[0], we = days[6];
  const fmt = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  document.getElementById('schedWeekLbl').textContent = `${fmt(ws)} â€“ ${fmt(we)}`;

  let html = '';
  // Headers
  days.forEach((d,i) => {
    const iso = d.toISOString().slice(0,10);
    const isToday = iso === today;
    html += `<div class="wg-day-hdr">
      <div class="wg-day-name">${dayNames[i]}</div>
      <div class="wg-day-num${isToday?' today':''}">${d.getDate()}</div>
    </div>`;
  });
  // Columns
  days.forEach(d => {
    const iso = d.toISOString().slice(0,10);
    const dayClasses = schedClasses.filter(c => c.date === iso).sort((a,b) => a.time.localeCompare(b.time));
    html += `<div class="wg-col">`;
    dayClasses.forEach(c => {
      const [h,m] = c.time.split(':');
      const hr = parseInt(h), ampm = hr >= 12 ? 'pm' : 'am', hr12 = hr % 12 || 12;
      const timeStr = `${hr12}:${m}${ampm}`;
      html += `<div class="wg-class-pill ct-${c.type}">
        <button class="wg-class-del" onclick="deleteSchedClass('${c.id}')">âœ•</button>
        <div class="wg-class-time">${timeStr}</div>
        <div class="wg-class-name">${c.name}</div>
        ${c.location ? `<div class="wg-class-loc">${c.location}</div>` : ''}
      </div>`;
    });
    html += `</div>`;
  });

  document.getElementById('schedWeekGrid').innerHTML = html;
}

function renderUpcoming() {
  const today = new Date().toISOString().slice(0,10);
  const upcoming = schedClasses.filter(c => c.date >= today).slice(0, 20);
  const el = document.getElementById('upcomingList');

  if(!upcoming.length) {
    el.innerHTML = `<div class="empty-state" style="height:120px;"><div class="empty-text">No upcoming classes â€” add one!</div></div>`;
    return;
  }

  el.innerHTML = upcoming.map(c => {
    const d = new Date(c.date + 'T12:00:00');
    const month = d.toLocaleDateString('en-US',{month:'short'});
    const day = d.getDate();
    const dow = d.toLocaleDateString('en-US',{weekday:'short'});
    const [h,m] = c.time.split(':');
    const hr = parseInt(h), ampm = hr>=12?'pm':'am', hr12 = hr%12||12;
    const endMin = parseInt(h)*60+parseInt(m)+c.dur;
    const endH = Math.floor(endMin/60)%12||12, endM = String(endMin%60).padStart(2,'0'), endAmpm = Math.floor(endMin/60)>=12?'pm':'am';
    const timeStr = `${hr12}:${m}${ampm} â€“ ${endH}:${endM}${endAmpm}`;
    const color = CT_COLORS[c.type] || '#7a7870';
    return `<div class="class-card ct-${c.type}" style="border-left-color:${color}" onclick="openClassInGCal('${c.id}')">
      <div class="cc-date-block">
        <div class="cc-month">${month}</div>
        <div class="cc-day" style="color:${color};">${day}</div>
        <div class="cc-dow">${dow}</div>
      </div>
      <div class="cc-info">
        <div class="cc-name">${c.name}</div>
        <div class="cc-meta">
          <span>â± ${timeStr}</span>
          ${c.location ? `<span>ðŸ“ ${c.location}</span>` : ''}
          ${c.instructor ? `<span>ðŸ‘¤ ${c.instructor}</span>` : ''}
          ${c.level ? `<span>ðŸŽ¯ ${c.level}</span>` : ''}
        </div>
        ${c.notes ? `<div style="font-size:9px;color:var(--dim);margin-top:5px;line-height:1.5;">${c.notes}</div>` : ''}
      </div>
      <div class="cc-actions">
        <span class="cc-type-badge" style="color:${color};border-color:${color}33;">${c.type}</span>
        ${c.recurLabel ? `<span class="recur-badge">â†» ${c.recurLabel}</span>` : ''}
        <button class="action-btn" onclick="event.stopPropagation();openClassInGCal('${c.id}')" style="font-size:8px;padding:4px 8px;">
          ðŸ“… GCal
        </button>
        <button class="action-btn" onclick="event.stopPropagation();deleteSchedClass('${c.id}')" style="font-size:8px;padding:4px 8px;color:var(--red);border-color:rgba(224,112,112,0.25);">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ GOOGLE CALENDAR INTEGRATION â”€â”€
function buildGCalUrl(cls) {
  const d = new Date(cls.date + 'T' + cls.time);
  const end = new Date(d.getTime() + cls.dur * 60000);
  const fmt = dt => dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'');
  const start = fmt(d), finish = fmt(end);
  const details = [
    cls.level ? `Level: ${cls.level}` : '',
    cls.instructor ? `Instructor: ${cls.instructor}` : '',
    cls.notes || '',
    '\nAdded via PoleCraft ðŸŽ­'
  ].filter(Boolean).join('\n');
  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: cls.name,
    dates: `${start}/${finish}`,
    details,
    location: cls.location || '',
  });
  return `https://calendar.google.com/calendar/render?${params}`;
}

function openClassInGCal(id) {
  const cls = schedClasses.find(c => c.id === id); if(!cls) return;
  window.open(buildGCalUrl(cls), '_blank');
}

function exportNextToGCal() {
  const today = new Date().toISOString().slice(0,10);
  const next = schedClasses.find(c => c.date >= today);
  if(!next) { showToast('No upcoming classes!'); return; }
  window.open(buildGCalUrl(next), '_blank');
}

function exportAllToGCal() {
  const today = new Date().toISOString().slice(0,10);
  const upcoming = schedClasses.filter(c => c.date >= today).slice(0, 10);
  if(!upcoming.length) { showToast('No upcoming classes!'); return; }
  // Open each in sequence with a small delay
  upcoming.forEach((cls, i) => {
    setTimeout(() => window.open(buildGCalUrl(cls), '_blank'), i * 400);
  });
  showToast(`Opening ${upcoming.length} classes in Google Calendar...`);
}

// â”€â”€ MINDBODY / WELLNESS â”€â”€
function openMindbody() {
  window.open('https://www.mindbodyonline.com/explore/classes', '_blank');
}
function openMindbodySearch() {
  window.open('https://www.mindbodyonline.com/explore/classes/pole-dancing', '_blank');
}
function openMbLink() {
  const url = document.getElementById('mbStudioUrl').value.trim();
  if(!url) { showToast('Paste your studio booking link first'); return; }
  const full = url.startsWith('http') ? url : 'https://' + url;
  window.open(full, '_blank');
}

// â”€â”€ ICAL EXPORT â”€â”€
function buildIcalText() {
  const today = new Date().toISOString().slice(0,10);
  const upcoming = schedClasses.filter(c => c.date >= today);
  if(!upcoming.length) return null;

  const fmt = dt => dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'') + 'Z';
  const escape = s => (s||'').replace(/,/g,'\\,').replace(/;/g,'\\;').replace(/\n/g,'\\n');
  const uid = () => 'pc' + Date.now() + Math.random().toString(36).slice(2) + '@polecraft';

  let lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//PoleCraft//Class Schedule//EN',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
  ];

  upcoming.forEach(cls => {
    const d = new Date(cls.date + 'T' + cls.time);
    const end = new Date(d.getTime() + cls.dur * 60000);
    const desc = [
      cls.level ? 'Level: ' + cls.level : '',
      cls.instructor ? 'Instructor: ' + cls.instructor : '',
      cls.notes || '',
      'Added via PoleCraft'
    ].filter(Boolean).join('\\n');

    lines.push(
      'BEGIN:VEVENT',
      'UID:' + uid(),
      'DTSTAMP:' + fmt(new Date()),
      'DTSTART:' + fmt(d),
      'DTEND:' + fmt(end),
      'SUMMARY:' + escape(cls.name),
      'DESCRIPTION:' + escape(desc),
      'LOCATION:' + escape(cls.location),
      'CATEGORIES:' + cls.type.toUpperCase(),
      'END:VEVENT'
    );
  });

  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

function downloadIcal() {
  const text = buildIcalText();
  if(!text) { showToast('No upcoming classes to export'); return; }
  const blob = new Blob([text], {type:'text/calendar'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'polecraft-schedule.ics';
  a.click();
  showToast('Downloaded polecraft-schedule.ics');
}

function copyIcalText() {
  const text = buildIcalText();
  if(!text) { showToast('No upcoming classes to export'); return; }
  navigator.clipboard.writeText(text).then(() => showToast('iCal text copied!'));
}

// ============================================================
// LANDING PAGE
// ============================================================
function enterApp(pageId){
  const landing = document.getElementById('landingPage');
  landing.classList.add('out');
  setTimeout(()=>{ landing.style.display='none'; }, 500);
  localStorage.setItem('pc_seen_landing', '1');
  if(pageId){
    const btn = document.querySelector('.nav-tab[data-page="'+pageId+'"]');
    if(btn) showPage(pageId, btn);
  }
}

function maybeShowLanding(){
  // Skip landing if user has been here before
  if(localStorage.getItem('pc_seen_landing')) {
    document.getElementById('landingPage').style.display='none';
  }
}

init();
</script>

<!-- ===== JOURNAL & TRACKER ===== -->
<div class="page" id="page-journal">
  <div class="journal-layout">
    <div class="journal-sidebar">
      <div class="journal-nav">
        <button class="jnav-btn active" onclick="showJournalSection('tracker',this)">
          <span class="jnav-icon">â—Ž</span>Consistency
        </button>
        <button class="jnav-btn" onclick="showJournalSection('sessions',this)">
          <span class="jnav-icon">âœ¦</span>Session Journal
        </button>
        <button class="jnav-btn" onclick="showJournalSection('goals',this)">
          <span class="jnav-icon">â—ˆ</span>Pole Goals
        </button>
      </div>
      <div class="journal-streak-card" id="journalStreakCard"></div>
    </div>
    <div class="journal-main">
      <div class="journal-section active" id="jsec-tracker"></div>
      <div class="journal-section" id="jsec-sessions"></div>
      <div class="journal-section" id="jsec-goals"></div>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mbn-inner" id="mbnInner"></div>
  <button class="mbn-sync-btn" id="mbnSyncBtn" onclick="showFbModal()">
    <span style="font-size:18px;line-height:1;">ðŸ‘¤</span>
    <div class="mbn-sync-dot" id="mbnSyncDot"></div>
    <span id="mbnSyncLabel">Sign In</span>
  </button>
</nav>

<!-- FIREBASE AUTH MODAL â€” minimal -->
<div class="fb-modal-overlay" id="fbModalOverlay" style="display:none;" onclick="fbModalBgClick(event)">
  <div class="fb-modal" id="fbModal" style="max-width:340px;width:92%;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px 0;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--accent);" id="fbModalTitle">Sign In to PoleCraft</div>
      <button onclick="hideFbModal()" style="background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;padding:4px;">âœ•</button>
    </div>
    <div style="padding:16px 20px 22px;display:flex;flex-direction:column;gap:11px;">

      <!-- Google Sign In â€” primary option -->
      <button class="fb-google-btn" onclick="fbSignInGoogle()" style="display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:11px 16px;background:#fff;border:1px solid #dadce0;border-radius:4px;cursor:pointer;font-family:'DM Mono',monospace;font-size:11px;color:#3c4043;letter-spacing:0.02em;transition:box-shadow 0.15s;">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.59-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        Continue with Google
      </button>

      <!-- Divider -->
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="flex:1;height:1px;background:var(--border);"></div>
        <span style="font-size:9px;color:var(--dim);letter-spacing:0.1em;">OR</span>
        <div style="flex:1;height:1px;background:var(--border);"></div>
      </div>

      <!-- Email/password fallback -->
      <div class="fb-auth-error" id="fbAuthError"></div>
      <input class="fb-input" type="email" id="fbEmailIn" placeholder="Email" autocomplete="email"
        onkeydown="if(event.key==='Enter')document.getElementById('fbPassIn').focus()" style="margin:0;">
      <input class="fb-input" type="password" id="fbPassIn" placeholder="Password" autocomplete="current-password"
        onkeydown="if(event.key==='Enter')fbSubmitAuth()" style="margin:0;">
      <button class="fb-submit-btn" id="fbSubmitBtn" onclick="fbSubmitAuth()" style="margin:0;">Sign In</button>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-family:'DM Mono',monospace;font-size:8px;color:var(--dim);" id="fbToggleText">No account?</span>
        <span style="font-family:'DM Mono',monospace;font-size:8px;color:var(--accent);cursor:pointer;" onclick="fbToggleMode()" id="fbToggleLink">Create one</span>
      </div>
      <div class="fb-config-box" id="fbConfigBox" style="display:none;">
        <div class="fb-config-label">âš™ Firebase Config</div>
        <textarea class="fb-config-in" id="fbConfigIn" rows="4"></textarea>
        <button class="fb-config-save" onclick="fbSaveConfig()">Save Config</button>
        <div id="fbConfigStatus" style="font-size:8px;color:var(--red);margin-top:4px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- MOVES DATALIST for Class Planner -->
<datalist id="cpMovesList"></datalist>

<!-- ===== TEACH PAGE ===== -->
<div class="page" id="page-teach">
  <div class="teach-layout">
    <div class="teach-sidebar">
      <button class="teach-nav-btn active" onclick="showTeachSection('planner',this)">
        <span class="teach-nav-icon">â—«</span>Class Planner
      </button>
      <button class="teach-nav-btn" onclick="showTeachSection('roster',this)">
        <span class="teach-nav-icon">â—Ž</span>Students
      </button>
      <button class="teach-nav-btn" onclick="showTeachSection('tnotes',this)">
        <span class="teach-nav-icon">âœ¦</span>Teaching Notes
      </button>
    </div>
    <div class="teach-main">
      <div class="teach-section active" id="tsec-planner"></div>
      <div class="teach-section" id="tsec-roster"></div>
      <div class="teach-section" id="tsec-tnotes"></div>
    </div>
  </div>
</div>


<!-- ===== GYM â€” FLEXIBILITY & STRENGTH ===== -->
<div class="page" id="page-flex">
  <div class="gym-page">

    <div class="gym-sidebar">
      <h3>â‹ Gym Builder</h3>

      <div>
        <div class="section-label">Session Type</div>
        <div style="display:flex;flex-direction:column;gap:5px;" id="gymSessionChips">
          <button class="focus-chip active" data-gs="full">Full Body</button>
          <button class="focus-chip" data-gs="strength">Pole Strength</button>
          <button class="focus-chip" data-gs="flex">Flexibility</button>
          <button class="focus-chip" data-gs="splits">Splits Training</button>
          <button class="focus-chip" data-gs="backbend">Back Bends</button>
          <button class="focus-chip" data-gs="shoulder">Shoulder Health</button>
          <button class="focus-chip" data-gs="core">Core & Stability</button>
          <button class="focus-chip" data-gs="skill">Train for a Skill</button>
        </div>
      </div>

      <div id="gymSkillPickerWrap" style="display:none;">
        <div class="section-label">Pick a Skill</div>
        <div class="gym-skill-panel">
          <div class="gym-skill-panel-title">Search your move database</div>
          <input class="gym-skill-search" id="gymSkillSearch" placeholder="e.g. Jade Split, Ayesha..."
            oninput="gymFilterSkills(this.value)">
          <div class="gym-skill-list" id="gymSkillList"></div>
          <div class="gym-sel-move" id="gymSelMovePanel">
            <div class="gym-sel-move-name" id="gymSelMoveName"></div>
            <div class="gym-sel-muscles" id="gymSelMuscles"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="section-label">Duration</div>
        <div class="range-row"><div style="color:var(--muted);font-size:9px;">Minutes</div><div class="range-val" id="gymDurVal">30</div></div>
        <input type="range" id="gymDuration" min="10" max="90" value="30" step="5"
          oninput="document.getElementById('gymDurVal').textContent=this.value">
        <div style="display:flex;justify-content:space-between;color:var(--dim);font-size:8px;margin-top:4px;"><span>10 min</span><span>90 min</span></div>
      </div>

      <div>
        <div class="section-label">Training Style</div>
        <div style="display:flex;flex-direction:column;gap:5px;" id="gymStyleChips">
          <button class="focus-chip active" data-gst="mixed">â—ˆ Mixed â€” strength + flex</button>
          <button class="focus-chip" data-gst="strength">ðŸ’ª Strength focus</button>
          <button class="focus-chip" data-gst="flex">ðŸ§˜ Flexibility focus</button>
          <button class="focus-chip" data-gst="rehab">ðŸ©¹ Rehab & Prehab</button>
        </div>
      </div>

      <div>
        <div class="section-label">Link to Saved Routine</div>
        <select id="gymRoutineLink" style="width:100%;">
          <option value="">â€” None (general session) â€”</option>
        </select>
        <div style="font-size:8px;color:var(--dim);margin-top:5px;line-height:1.6;">Links gym work to moves in your saved routine.</div>
      </div>

      <button class="gym-generate-btn" onclick="generateGym()"><span>â‹</span> Generate Session</button>

    </div>

    <div class="gym-main">
      <div class="gym-controls">
        <h3 id="gymHeadline">Gym Session</h3>
        <button class="action-btn" id="gymRegenBtn" onclick="generateGym()" style="display:none;">â†º Regenerate</button>
        <button class="action-btn" id="gymCopyBtn" onclick="gymCopyPlan()" style="display:none;">â†— Copy Plan</button>
      </div>

      <div class="gym-stats">
        <div class="gym-stat"><div class="gym-stat-n" id="gymStatEx">â€”</div><div class="gym-stat-l">Exercises</div></div>
        <div class="gym-stat"><div class="gym-stat-n" id="gymStatTime">â€”</div><div class="gym-stat-l">Minutes</div></div>
        <div class="gym-stat"><div class="gym-stat-n" id="gymStatSets">â€”</div><div class="gym-stat-l">Total Sets</div></div>
        <div class="gym-stat"><div class="gym-stat-n" id="gymStatSkills">â€”</div><div class="gym-stat-l">Skills Targeted</div></div>
      </div>

      <div class="gym-body" id="gymBody">
        <div class="gym-empty">
          <div class="gym-empty-icon">â‹</div>
          <div class="gym-empty-text">Choose your session type and generate</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase Debug Panel -->
<div id="fbDebug">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
    <div style="color:var(--accent);letter-spacing:0.15em;font-size:8px;">CLOUD SYNC</div>
    <button onclick="toggleFbDebug()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:12px;padding:0 2px;">âœ•</button>
  </div>
  <div style="display:flex;gap:6px;margin-bottom:10px;">
    <button onclick="fbPushAllLocalData()" style="flex:1;padding:8px;border:1px solid var(--l1);background:transparent;color:var(--l1);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:0.08em;">â†‘ Push to Cloud</button>
    <button onclick="fbLoadAllData()" style="flex:1;padding:8px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:0.08em;">â†“ Pull from Cloud</button>
  </div>
  <div class="fbd-row"><span class="fbd-label">SDK loaded</span><span class="fbd-val" id="fbd-sdk">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">App init</span><span class="fbd-val" id="fbd-app">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Auth state</span><span class="fbd-val" id="fbd-auth">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Firestore</span><span class="fbd-val" id="fbd-db">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">User</span><span class="fbd-val" id="fbd-user">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Last read</span><span class="fbd-val" id="fbd-read">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Last write</span><span class="fbd-val" id="fbd-write">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Doc exists</span><span class="fbd-val" id="fbd-doc">â€”</span></div>
  <div class="fbd-row"><span class="fbd-label">Last error</span><span class="fbd-val" id="fbd-error" style="color:var(--red);white-space:normal;">â€”</span></div>

</div>
</body>
</html>
